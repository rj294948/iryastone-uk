<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES - CHECKOUT THEME ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --success-green: #10b981;
    --warning-orange: #f59e0b;
    --error-red: #ef4444;
    --info-blue: #3b82f6;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Order status colors matching checkout */
    --payment-pending: #ef4444;
    --payment-advance: #f59e0b;
    --payment-full: #10b981;
    --processing: #3b82f6;
    --ready-to-ship: #f59e0b;
    --shipped: #8b5cf6;
    --out-for-delivery: #ec4899;
    --delivered: #10b981;
    --cancelled: #dc2626;
    --returned: #6b7280;
    --refunded: #8b5cf6;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
    transition: padding-top 0.3s ease;
}

/* ===== HEADER - CHECKOUT STYLE ===== */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    padding: 8px 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    z-index: 1000;
    gap: 8px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    height: 60px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
}

.header.hide {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    min-width: 120px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 18px;
}

.logo span {
    font-size: 16px;
    font-weight: 700;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
    transform: scale(1.05);
}

/* ===== BOTTOM NAV - CHECKOUT STYLE ===== */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(15px);
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 999;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
    height: 65px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform: translateY(0);
}

.bottom-nav.hide {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    transition: var(--transition);
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 8px;
    min-width: 55px;
    text-decoration: none;
    height: 45px;
    justify-content: center;
    position: relative;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(255, 255, 255, 0.1);
}

.nav-btn.active {
    color: var(--primary-gold);
    background: rgba(255, 255, 255, 0.05);
}

.nav-btn i {
    font-size: 16px;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
    padding: 70px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
    transition: padding-top 0.3s ease;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* ===== PAGE HEADER - CHECKOUT STYLE ===== */
.page-header {
    background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.6));
    padding: 25px 15px;
    margin: 0;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    margin-bottom: 20px;
}

.page-header h1 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.page-header p {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.9);
    max-width: 700px;
    margin: 0 auto;
    line-height: 1.4;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    font-weight: 400;
    opacity: 0.9;
}

/* ===== CONTAINER ===== */
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 15px;
}

/* ===== ORDERS FILTER ===== */
.orders-filter {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: var(--shadow-sm);
    border: 1px solid #f0f0f0;
}

.search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.search-box i {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

/* ===== STATUS FILTER ===== */
.status-filter {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.status-filter-btn {
    padding: 8px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    background: var(--white);
    color: var(--text-light);
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-filter-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.status-filter-btn.active {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

/* ===== ORDERS GRID ===== */
.orders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .orders-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .orders-grid {
        gap: 15px;
    }
}

/* ===== ORDER CARD - CHECKOUT STYLE ===== */
.order-card {
    background: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    border: 1px solid #f0f0f0;
    position: relative;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.order-card.cancelled {
    opacity: 0.8;
    background: #f8f9fa;
}

/* Order Type Badge */
.order-type-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 2;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.order-type-badge.buy-now {
    background: var(--primary-gold);
    color: var(--white);
}

.order-type-badge.cart {
    background: var(--info-blue);
    color: var(--white);
}

.order-header {
    padding: 20px;
    background: linear-gradient(to right, #f7f7f7, var(--white));
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 10px;
}

.order-info h3 {
    font-size: 16px;
    color: var(--stone-dark);
    margin-bottom: 4px;
    font-weight: 600;
}

.order-date {
    font-size: 12px;
    color: var(--text-light);
}

.order-body {
    padding: 20px;
}

.order-item {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid #f0f0f0;
}

.item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-light);
    flex-shrink: 0;
    position: relative;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    color: var(--stone-dark);
}

.item-specs {
    margin: 8px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.spec-badge {
    font-size: 10px;
    padding: 3px 6px;
    background: #f0f0f0;
    border-radius: 4px;
    color: var(--text-dark);
}

.item-meta {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
}

.item-price {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 14px;
}

/* ===== ORDER STATUS BADGES - CHECKOUT STYLE ===== */
.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.status-payment-pending { background: #fff5f5; color: var(--payment-pending); border: 1px solid #ffc9c9; }
.status-payment-advance { background: #fff4e6; color: var(--payment-advance); border: 1px solid #ffd8a8; }
.status-payment-full { background: #ebfbee; color: var(--payment-full); border: 1px solid #b2f2bb; }
.status-processing { background: #e7f5ff; color: var(--processing); border: 1px solid #a5d8ff; }
.status-ready-to-ship { background: #fff4e6; color: var(--ready-to-ship); border: 1px solid #ffd8a8; }
.status-shipped { background: #edf2ff; color: var(--shipped); border: 1px solid #bac8ff; }
.status-out-for-delivery { background: #f8f0fc; color: var(--out-for-delivery); border: 1px solid #eebefa; }
.status-delivered { background: #d3f9d8; color: var(--delivered); border: 1px solid #8ce99a; }
.status-cancelled { background: #ffe3e3; color: var(--cancelled); border: 1px solid #ffa8a8; }
.status-returned { background: #e9ecef; color: var(--returned); border: 1px solid #ced4da; }
.status-refunded { background: #f3f0ff; color: var(--refunded); border: 1px solid #ddd6fe; }

/* ===== PAYMENT STATUS ===== */
.payment-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.payment-status.pending {
    background: #fff5f5;
    color: var(--payment-pending);
    border: 1px solid #ffc9c9;
}

.payment-status.advance {
    background: #fff4e6;
    color: var(--payment-advance);
    border: 1px solid #ffd8a8;
}

.payment-status.full {
    background: #ebfbee;
    color: var(--payment-full);
    border: 1px solid #b2f2bb;
}

.payment-status.confirmed {
    background: #d1fae5;
    color: #059669;
    border: 1px solid #a7f3d0;
}

/* ===== ORDER SUMMARY - CHECKOUT STYLE ===== */
.order-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.summary-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.summary-label {
    font-size: 12px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-value {
    font-weight: 600;
    font-size: 14px;
    color: var(--text-dark);
}

.summary-value.paid { color: var(--payment-full); }
.summary-value.remaining { color: var(--payment-pending); }
.summary-value.total { color: var(--primary-gold); }

/* ===== PLATFORM FEES SECTION ===== */
.platform-fees {
    background: rgba(245, 158, 11, 0.1);
    border-left: 4px solid var(--warning-orange);
    padding: 12px 15px;
    border-radius: 6px;
    margin: 15px 0;
    font-size: 13px;
}

.platform-fees-header {
    font-weight: 600;
    color: var(--warning-orange);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.platform-fee-item {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 4px;
}

.platform-fee-total {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
    color: var(--text-dark);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #f59e0b;
}

/* ===== DELIVERY ESTIMATE ===== */
.delivery-estimate {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 12px 15px;
    border-radius: 6px;
    margin: 15px 0;
    font-size: 13px;
}

.delivery-estimate .label {
    font-weight: 600;
    color: #1565c0;
    margin-bottom: 5px;
}

.delivery-estimate .date {
    font-weight: 600;
    color: #0d47a1;
}

/* ===== ADDRESS SECTION - UPDATED ===== */
.address-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    border: 1px solid #e9ecef;
}

.address-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    font-weight: 600;
}

.address-details {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.6;
}

.address-line {
    margin-bottom: 4px;
}

/* ===== ORDER ACTIONS - CHECKOUT STYLE ===== */
.order-actions {
    display: flex;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid #f0f0f0;
    background: var(--bg-light);
    flex-wrap: wrap;
}

.btn {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: var(--transition);
    flex: 1;
    min-width: 120px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
}

.btn-primary:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-secondary {
    background: var(--white);
    color: var(--text-dark);
    border: 1px solid #e0e0e0;
}

.btn-secondary:hover {
    background: var(--bg-light);
}

.btn-outline {
    background: transparent;
    color: var(--primary-gold);
    border: 1px solid var(--primary-gold);
}

.btn-outline:hover {
    background: rgba(201, 162, 39, 0.1);
}

.btn-success {
    background: var(--payment-full);
    color: white;
}

.btn-success:hover {
    background: #10b981;
}

.btn-danger {
    background: var(--payment-pending);
    color: white;
}

.btn-danger:hover {
    background: #ef4444;
}

.btn-warning {
    background: var(--warning-orange);
    color: white;
}

.btn-warning:hover {
    background: #d97706;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* ===== PAYMENT REMINDER ===== */
.payment-reminder {
    background: linear-gradient(135deg, #fef3c7, #fef9c3);
    border: 1px solid #fbbf24;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
    0% { border-color: #fbbf24; }
    50% { border-color: #f59e0b; }
    100% { border-color: #fbbf24; }
}

.payment-reminder-header {
    font-weight: 600;
    color: #d97706;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.payment-reminder-content {
    font-size: 12px;
    color: #92400e;
    line-height: 1.5;
}

/* ===== PAY NOW BUTTON SPECIAL ===== */
.pay-now-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    width: 100%;
    margin-top: 10px;
}

.pay-now-btn:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

.pay-now-btn:active {
    transform: translateY(0);
}

.pay-now-btn i {
    font-size: 14px;
}

/* ===== CANCELLATION SECTION ===== */
.cancellation-section {
    background: #fff5f5;
    border: 1px solid #ffcccc;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.cancellation-reason {
    font-weight: 600;
    color: #c92a2a;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.cancellation-date {
    font-size: 12px;
    color: #868e96;
}

/* ===== MODAL STYLES ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 30px;
    text-align: center;
    max-width: 500px;
    width: 100%;
    box-shadow: var(--shadow-lg);
}

.modal-icon {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin: 0 auto 20px;
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-bottom: 10px;
    font-family: 'Roboto Slab', serif;
}

.modal-message {
    color: var(--text-light);
    margin-bottom: 25px;
    line-height: 1.5;
}

/* ===== TRACKING MODAL ===== */
.tracking-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.tracking-modal-content {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    width: 100%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tracking-modal-header {
    background: linear-gradient(135deg, var(--stone-dark), #2d2d2d);
    color: var(--white);
    padding: 25px 30px;
    border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tracking-modal-header h2 {
    font-size: 22px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.tracking-modal-header h2 i {
    color: var(--primary-gold);
}

.close-tracking-modal {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--white);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 18px;
    transition: var(--transition);
}

.close-tracking-modal:hover {
    background: rgba(255,255,255,0.2);
    transform: rotate(90deg);
}

.tracking-modal-body {
    padding: 30px;
}

/* ===== TRACKING TIMELINE ===== */
.tracking-timeline {
    position: relative;
    padding: 20px 0;
}

.tracking-timeline::before {
    content: '';
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, var(--primary-gold), #e0e0e0);
    border-radius: 3px;
}

.timeline-step {
    display: flex;
    margin-bottom: 30px;
    position: relative;
    padding-left: 60px;
}

.timeline-step:last-child {
    margin-bottom: 0;
}

.timeline-icon {
    position: absolute;
    left: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    border: 3px solid var(--white);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 2;
}

.timeline-step.completed .timeline-icon {
    background: var(--delivered);
    color: var(--white);
}

.timeline-step.active .timeline-icon {
    background: var(--primary-gold);
    color: var(--white);
    animation: pulse 2s infinite;
}

.timeline-step.pending .timeline-icon {
    background: #f0f0f0;
    color: #999;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(201, 162, 39, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(201, 162, 39, 0); }
    100% { box-shadow: 0 0 0 0 rgba(201, 162, 39, 0); }
}

.timeline-content {
    background: var(--bg-light);
    border-radius: 12px;
    padding: 15px 20px;
    flex: 1;
    border-left: 4px solid;
}

.timeline-step.completed .timeline-content {
    border-left-color: var(--delivered);
    background: #f0fff4;
}

.timeline-step.active .timeline-content {
    border-left-color: var(--primary-gold);
    background: #fff9e6;
}

.timeline-step.pending .timeline-content {
    border-left-color: #e0e0e0;
}

.timeline-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.timeline-desc {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.timeline-date {
    font-size: 12px;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 5px;
}

.timeline-date i {
    font-size: 11px;
}

/* ===== CANCEL MODAL ===== */
.cancel-modal-content {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 30px;
    max-width: 500px;
    width: 100%;
    box-shadow: var(--shadow-lg);
}

.cancel-reason-select {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin: 15px 0;
    font-size: 14px;
    background: var(--bg-light);
}

.cancel-reason-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin: 15px 0;
    font-size: 14px;
    background: var(--bg-light);
    min-height: 100px;
    resize: vertical;
    font-family: 'Poppins', sans-serif;
}

.cancel-modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* ===== LOADING STATE ===== */
.loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
    grid-column: 1 / -1;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201, 162, 39, 0.1);
    border-top-color: var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #f0f0f0;
    grid-column: 1 / -1;
}

.empty-state i {
    font-size: 48px;
    color: #e0e0e0;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: var(--text-light);
    margin-bottom: 10px;
    font-weight: 600;
}

/* ===== CART BADGE ===== */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== TOAST MESSAGE ===== */
.message-toast {
    position: fixed;
    top: 80px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
    max-width: 90%;
    word-wrap: break-word;
    display: flex;
    align-items: center;
    gap: 10px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (min-width: 768px) {
    .header {
        padding: 10px 20px;
        height: 65px;
    }
    
    .logo {
        min-width: 140px;
    }
    
    .logo i {
        font-size: 20px;
    }
    
    .logo span {
        font-size: 18px;
    }
    
    .action-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
    
    .breadcrumb {
        padding: 85px 20px 20px;
    }
    
    .page-header {
        padding: 25px 20px;
    }
    
    .page-header h1 {
        font-size: 20px;
    }
    
    .page-header p {
        font-size: 13px;
    }
    
    .bottom-nav {
        height: 70px;
        padding: 12px 0;
    }
    
    .nav-btn {
        min-width: 65px;
        font-size: 11px;
    }
    
    .nav-btn i {
        font-size: 18px;
    }
    
    .container {
        padding: 0 20px;
    }
    
    .pay-now-btn {
        padding: 12px 24px;
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 6px 10px;
        height: 55px;
        gap: 5px;
    }
    
    .logo {
        min-width: 100px;
    }
    
    .logo i {
        font-size: 16px;
    }
    
    .logo span {
        font-size: 14px;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        font-size: 13px;
    }
    
    .breadcrumb {
        padding: 55px 12px 15px;
    }
    
    .page-header {
        min-height: 80px;
        padding: 15px 12px;
        margin-bottom: 15px;
    }
    
    .page-header h1 {
        font-size: 16px;
    }
    
    .page-header p {
        font-size: 11px;
    }
    
    .orders-grid {
        gap: 12px;
    }
    
    .order-header {
        padding: 15px;
    }
    
    .order-body {
        padding: 15px;
    }
    
    .order-actions {
        padding: 15px;
    }
    
    .btn {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 100px;
    }
    
    .bottom-nav {
        height: 60px;
        padding: 8px 0;
    }
    
    .nav-btn {
        min-width: 50px;
        font-size: 9px;
        padding: 4px 6px;
    }
    
    .nav-btn i {
        font-size: 14px;
    }
    
    .orders-filter {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: 100%;
    }
    
    .order-card {
        margin: 0 -8px;
        border-radius: 0;
        border-left: none;
        border-right: none;
    }
    
    .pay-now-btn {
        padding: 10px 16px;
        font-size: 12px;
    }
}
</style>
</head>

<body>

<!-- Success Modal -->
<div class="modal" id="successModal">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fas fa-check"></i>
        </div>
        <h3 class="modal-title" id="successTitle">Success!</h3>
        <p class="modal-message" id="successMessage">Operation completed successfully.</p>
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button class="btn btn-primary" style="flex: 1;" onclick="window.location.href='orders.html'">
                <i class="fas fa-box"></i> View Orders
            </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeSuccessModal()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<!-- Cancel Modal -->
<div class="modal" id="cancelModal">
    <div class="cancel-modal-content">
        <div class="modal-icon" style="background: var(--error-red);">
            <i class="fas fa-times-circle"></i>
        </div>
        <h3 class="modal-title">Cancel Order</h3>
        <p class="modal-message">Are you sure you want to cancel this order?</p>
        
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Reason for cancellation:</label>
            <select class="cancel-reason-select" id="cancelReason">
                <option value="">Select a reason</option>
                <option value="found_better_price">Found better price elsewhere</option>
                <option value="change_of_mind">Changed my mind</option>
                <option value="shipping_too_long">Shipping takes too long</option>
                <option value="ordered_by_mistake">Ordered by mistake</option>
                <option value="financial_reasons">Financial reasons</option>
                <option value="other">Other reason</option>
            </select>
            
            <div id="otherReasonContainer" style="display: none; margin-top: 10px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Please specify:</label>
                <textarea class="cancel-reason-textarea" id="otherReason" placeholder="Please explain your reason..."></textarea>
            </div>
        </div>
        
        <div class="cancel-modal-actions">
            <button class="btn btn-danger" style="flex: 1;" onclick="confirmCancelOrder()">
                <i class="fas fa-check"></i> Confirm Cancel
            </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeCancelModal()">
                <i class="fas fa-times"></i> Go Back
            </button>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal" id="errorModal">
    <div class="modal-content">
        <div class="modal-icon" style="background: var(--error-red);">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 class="modal-title">Error</h3>
        <p class="modal-message" id="errorMessage">Something went wrong.</p>
        <button class="btn btn-primary" onclick="closeErrorModal()" style="margin-top: 20px;">
            <i class="fas fa-times"></i> Close
        </button>
    </div>
</div>

<!-- Tracking Modal -->
<div class="tracking-modal" id="trackingModal">
    <div class="tracking-modal-content">
        <div class="tracking-modal-header">
            <h2><i class="fas fa-truck"></i> Order Tracking</h2>
            <button class="close-tracking-modal" onclick="closeTrackingModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="tracking-modal-body" id="trackingModalContent">
            <!-- Tracking content will be loaded here -->
        </div>
    </div>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <div class="logo">
    <i class="fa-solid fa-gem"></i>
    <span>IRYA STONE</span>
  </div>
  
  <div class="header-actions">
    <a href="account.html" class="action-btn" title="Account">
      <i class="fas fa-user"></i>
    </a>
    <!-- Notification Icon - Direct Link to notification.html -->
    <a href="notification.html" class="action-btn" title="Notifications" style="position: relative;">
      <i class="fas fa-bell"></i>
      <span class="cart-badge" id="notificationBadge">0</span>
    </a>
    <a href="cart.html" class="action-btn" title="Cart" style="position: relative;">
      <i class="fas fa-shopping-cart"></i>
      <span class="cart-badge" id="cartBadge">0</span>
    </a>
  </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
  <div class="breadcrumb-content">
    <div class="breadcrumb-item">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
    </div>
    <div class="breadcrumb-divider">
      <i class="fas fa-chevron-right"></i>
    </div>
    <div class="breadcrumb-item active">
      My Orders
    </div>
  </div>
</section>

<!-- Main Container -->
<main class="container">
  <div class="page-header">
    <h1><i class="fas fa-box"></i> My Orders</h1>
    <p>Track and manage all your orders</p>
  </div>
  
  <!-- Orders Filter -->
  <div class="orders-filter">
    <div class="search-box" style="flex: 1;">
      <input type="text" id="searchInput" placeholder="Search by order number, product name..." onkeyup="searchOrders()">
      <i class="fas fa-search"></i>
    </div>
    <div class="status-filter" id="statusFilter">
      <button class="status-filter-btn active" onclick="filterOrders('all')">
        <i class="fas fa-list"></i> All
      </button>
      <button class="status-filter-btn" onclick="filterOrders('pending')">
        <i class="fas fa-clock"></i> Pending
      </button>
      <button class="status-filter-btn" onclick="filterOrders('processing')">
        <i class="fas fa-cogs"></i> Processing
      </button>
      <button class="status-filter-btn" onclick="filterOrders('shipped')">
        <i class="fas fa-truck"></i> Shipped
      </button>
      <button class="status-filter-btn" onclick="filterOrders('delivered')">
        <i class="fas fa-check-circle"></i> Delivered
      </button>
    </div>
  </div>
  
  <!-- Orders Grid -->
  <div class="orders-grid" id="orders">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your orders...</p>
    </div>
  </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="bottomNav">
  <a href="index.html" class="nav-btn">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="products.html" class="nav-btn">
    <i class="fas fa-th-large"></i>
    <span>Products</span>
  </a>
  <a href="orders.html" class="nav-btn active">
    <i class="fas fa-box"></i>
    <span>Orders</span>
  </a>
  <a href="account.html" class="nav-btn">
    <i class="fas fa-user"></i>
    <span>Account</span>
  </a>
  <!-- Add Notification Link in Bottom Nav -->
  <a href="notification.html" class="nav-btn" style="position: relative;">
    <i class="fas fa-bell"></i>
    <span>Alerts</span>
    <span class="cart-badge" id="bottomNavNotificationBadge" style="display: none;"></span>
  </a>
</nav>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  where,
  limit,
  getDoc,
  addDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// GLOBAL VARIABLES
// ============================================

let currentUserId = null;
let userEmail = null;
let userName = null;
let orders = [];
let notifications = [];
let ordersUnsubscribe = null;
let notificationsUnsubscribe = null;
let cancelOrderId = null;

// ============================================
// SCROLL HIDE/SHOW HEADER & FOOTER
// ============================================

let lastScrollTop = 0;
const header = document.getElementById('mainHeader');
const bottomNav = document.getElementById('bottomNav');
const SCROLL_THRESHOLD = 50;

function handleScroll() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  if (scrollTop > lastScrollTop && scrollTop > SCROLL_THRESHOLD) {
    header.classList.add('hide');
    bottomNav.classList.add('hide');
  } else {
    header.classList.remove('hide');
    bottomNav.classList.remove('hide');
  }
  
  lastScrollTop = scrollTop;
}

window.addEventListener('scroll', handleScroll, { passive: true });

// ============================================
// USER ID MANAGEMENT - CHECKOUT COMPATIBLE
// ============================================

async function getUserId() {
  try {
    const savedUser = localStorage.getItem('irya_stone_user');
    if (savedUser) {
      const user = JSON.parse(savedUser);
      currentUserId = user.uid;
      userEmail = user.email;
      userName = user.displayName || user.name || userEmail?.split('@')[0];
      console.log("‚úÖ Authenticated user detected:", currentUserId);
      return currentUserId;
    }

    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
      guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('irya_guest_id', guestId);
    }
    
    currentUserId = guestId;
    console.log("üë§ Guest user detected:", currentUserId);
    
    return currentUserId;
    
  } catch (error) {
    console.error("‚ùå Error getting user ID:", error);
    currentUserId = 'guest_' + Date.now();
    return currentUserId;
  }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log("üì± Orders page initializing...");
    
    const userId = await getUserId();
    console.log("üìã User Info:", { userId: userId, email: userEmail, name: userName });
    
    setupOrdersListener();
    setupNotificationsListener();
    updateCartBadge();
    setupCancelReasonHandler();
    
    checkNotificationRedirect();
    checkPaymentSuccess();
    
    console.log("‚úÖ Orders page initialized successfully");
    
  } catch (error) {
    console.error("‚ùå Error initializing:", error);
    showMessage("Failed to load orders. Please try again.", 'error');
  }
});

// ============================================
// SETUP CANCEL REASON HANDLER
// ============================================

function setupCancelReasonHandler() {
  const cancelReasonSelect = document.getElementById('cancelReason');
  const otherReasonContainer = document.getElementById('otherReasonContainer');
  
  if (cancelReasonSelect) {
    cancelReasonSelect.addEventListener('change', function() {
      if (this.value === 'other') {
        otherReasonContainer.style.display = 'block';
        document.getElementById('otherReason').focus();
      } else {
        otherReasonContainer.style.display = 'none';
        document.getElementById('otherReason').value = '';
      }
    });
  }
}

// ============================================
// ORDERS MANAGEMENT - REAL-TIME
// ============================================

async function setupOrdersListener() {
  const ordersDiv = document.getElementById("orders");
  
  if (ordersUnsubscribe) ordersUnsubscribe();
  
  ordersDiv.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your orders...</p>
    </div>
  `;
  
  try {
    let ordersQuery;
    
    try {
      const userOrdersRef = collection(db, "users", currentUserId, "orders");
      ordersQuery = query(userOrdersRef, orderBy("createdAt", "desc"));
      console.log("‚úÖ Setting up user-specific orders listener");
    } catch (error) {
      console.log("‚ö†Ô∏è Trying universal orders collection");
      const ordersRef = collection(db, "orders");
      ordersQuery = query(
        ordersRef, 
        where("userId", "==", currentUserId),
        orderBy("createdAt", "desc")
      );
    }
    
    ordersUnsubscribe = onSnapshot(ordersQuery, 
      async (snapshot) => {
        orders = [];
        
        if (snapshot.empty) {
          showEmptyState("You haven't placed any orders yet.");
          return;
        }
        
        for (const docSnapshot of snapshot.docs) {
          const orderData = docSnapshot.data();
          orderData.id = docSnapshot.id;
          
          if (!orderData.userId) {
            orderData.userId = currentUserId;
          }
          
          if (orderData.items && Array.isArray(orderData.items)) {
            for (const item of orderData.items) {
              await fetchProductImage(item);
            }
          }
          
          orders.push(orderData);
        }
        
        console.log(`‚úÖ Loaded ${orders.length} orders for user: ${currentUserId}`);
        displayOrders(orders);
        
      }, 
      (error) => {
        console.error("‚ùå Error in orders listener:", error);
        ordersDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Connection Error</h3>
            <p>Please check your internet connection</p>
            <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    );
    
  } catch (error) {
    console.error("‚ùå Setup error:", error);
    showEmptyState("Failed to setup orders. Please refresh.");
  }
}

async function fetchProductImage(item) {
  if (!item) return;
  
  if (item.image && item.image.trim() !== '') {
    return;
  }
  
  const productId = item.productId || item.id || item.stoneId;
  if (!productId) {
    item.image = getDefaultImage(item.category);
    return;
  }
  
  try {
    try {
      const productDoc = await getDoc(doc(db, "products", productId));
      if (productDoc.exists()) {
        const productData = productDoc.data();
        setProductImage(item, productData);
        return;
      }
    } catch (error) {
      console.log("‚ö†Ô∏è Products collection not found");
    }
    
    try {
      const stoneDoc = await getDoc(doc(db, "stone", productId));
      if (stoneDoc.exists()) {
        const stoneData = stoneDoc.data();
        setStoneImage(item, stoneData);
        return;
      }
    } catch (error) {
      console.log("‚ö†Ô∏è Stone collection not found");
    }
    
    try {
      const stoneQuery = query(
        collection(db, "stone"),
        where("stoneId", "==", productId),
        limit(1)
      );
      const stoneSnapshot = await getDocs(stoneQuery);
      if (!stoneSnapshot.empty) {
        const stoneData = stoneSnapshot.docs[0].data();
        setStoneImage(item, stoneData);
        return;
      }
    } catch (error) {
      console.log("‚ö†Ô∏è Stone query failed");
    }
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Product image fetch error:", error);
  }
  
  item.image = getDefaultImage(item.category);
}

function setProductImage(item, productData) {
  if (productData.images && Array.isArray(productData.images) && productData.images.length > 0) {
    if (typeof productData.images[0] === 'string') {
      item.image = productData.images[0];
    } else if (productData.images[0].url) {
      item.image = productData.images[0].url;
    }
  } else if (productData.imageUrl) {
    item.image = productData.imageUrl;
  } else if (productData.image) {
    item.image = productData.image;
  }
  
  item.name = item.name || productData.name || productData.title || productData.stoneName || "Stone Product";
  item.category = item.category || productData.category || "Stone";
}

function setStoneImage(item, stoneData) {
  if (stoneData.images && Array.isArray(stoneData.images) && stoneData.images.length > 0) {
    if (typeof stoneData.images[0] === 'string') {
      item.image = stoneData.images[0];
    } else if (stoneData.images[0].url) {
      item.image = stoneData.images[0].url;
    }
  } else if (stoneData.imageUrl) {
    item.image = stoneData.imageUrl;
  } else if (stoneData.image) {
    item.image = stoneData.image;
  } else if (stoneData.imgUrl) {
    item.image = stoneData.imgUrl;
  }
  
  item.name = item.name || stoneData.stoneName || stoneData.name || "Stone Product";
  item.category = stoneData.category || "Stone";
}

function getDefaultImage(category) {
  const categoryLower = (category || '').toLowerCase();
  
  if (categoryLower.includes('sand')) {
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('kota')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('granite')) {
    return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('marble')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  }
  
  return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
}

// ============================================
// PAY REMAINING AMOUNT - ADMIN CONFIRMATION SYSTEM
// ============================================

async function payRemainingAmount(orderId) {
  try {
    console.log("üöÄ Processing remaining payment for order:", orderId);
    
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      showMessage("Order not found", "error");
      return;
    }
    
    // Calculate remaining payment
    const total = order.total || 0;
    const advancePayment = order.advancePayment || order.submittedAmount || 0;
    const remainingPayment = order.remainingPayment || (total - advancePayment);
    
    console.log("üí∞ Payment Details:", {
      total: total,
      advance: advancePayment,
      remaining: remainingPayment
    });
    
    if (remainingPayment <= 0) {
      showMessage("This order is already fully paid", "info");
      return;
    }
    
    // Check if order can accept payment
    const orderStatus = order.orderStatus || order.status || '';
    if (['cancelled', 'returned', 'refunded'].includes(orderStatus)) {
      showMessage("This order cannot accept payments as it has been cancelled or returned.", "error");
      return;
    }
    
    // Calculate platform fees (same as advance payment)
    const platformFee = (remainingPayment * 0.025) + 0.30; // 2.5% + ¬£0.30
    const netAmount = remainingPayment - platformFee;
    
    // Determine if this is a buy-now or cart order
    const orderType = order.isBuyNow ? 'buy_now' : 'cart_order';
    
    // Create comprehensive payment data
    const paymentData = {
      // Order Information
      orderId: order.id,
      orderNumber: order.orderNumber || 'ORDER-' + order.id.substring(0, 8),
      orderType: orderType,
      
      // Payment Amounts
      amount: remainingPayment,
      platformFee: platformFee,
      netAmount: netAmount,
      originalTotal: total,
      advancePaid: advancePayment,
      remainingAmount: remainingPayment,
      
      // User Information
      userId: currentUserId,
      userEmail: userEmail || order.userEmail,
      userName: userName || order.userName || 'Customer',
      
      // Order Details
      items: order.items || [],
      shippingDetails: order.shippingDetails || order.shippingAddress || {},
      paymentMethod: order.paymentMethod || 'stripe',
      shippingCost: order.shipping || 0,
      taxAmount: order.tax || 0,
      subtotal: order.subtotal || 0,
      orderStatus: order.orderStatus,
      
      // Payment Type & Source
      type: 'remaining_payment',
      source: 'orders_page',
      createdAt: new Date().toISOString(),
      paymentConfirmDeadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 hours
      
      // Additional Info
      estimatedDelivery: order.estimatedDelivery || order.deliveryDate,
      refundPolicy: "If payment not confirmed within 24 hours, order will be cancelled and refund processed after deducting platform fees (2.5% + ¬£0.30) and bank charges (¬£0.50)",
      notes: order.notes || ""
    };
    
    console.log("üíæ Saving payment data to localStorage:", paymentData);
    
    // Save to localStorage for checkout page
    localStorage.setItem('irya_remaining_payment', JSON.stringify(paymentData));
    
    // Also save for checkout compatibility (notification-checkout style)
    localStorage.setItem('irya_pending_payment_order', JSON.stringify({
      orderId: order.id,
      orderNumber: order.orderNumber,
      amount: remainingPayment,
      totalAmount: total,
      paidAmount: advancePayment,
      remainingAmount: remainingPayment,
      notificationType: 'payment_pending',
      source: 'orders_page',
      timestamp: new Date().toISOString(),
      userId: currentUserId,
      paymentMethod: order.paymentMethod,
      items: order.items,
      shippingDetails: order.shippingDetails,
      autoCancelTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    }));
    
    // Redirect to notification checkout page (which has admin confirmation system)
    const checkoutUrl = `notification-checkout.html?order_id=${order.id}&type=remaining_payment&amount=${remainingPayment}&source=orders_page&order_type=${orderType}`;
    
    showMessage(`Redirecting to payment page for ¬£${remainingPayment.toFixed(2)}...`, "info");
    
    setTimeout(() => {
      window.location.href = checkoutUrl;
    }, 800);
    
  } catch (error) {
    console.error("‚ùå Error processing remaining payment:", error);
    showMessage("Failed to process payment: " + error.message, "error");
  }
}

// ============================================
// DISPLAY ORDERS - UPDATED WITH CART/BUY NOW TAGS
// ============================================

function displayOrders(ordersList) {
  const ordersDiv = document.getElementById("orders");
  
  if (!ordersList || ordersList.length === 0) {
    showEmptyState("You haven't placed any orders yet.");
    return;
  }
  
  let ordersHTML = '';
  
  ordersList.forEach((order) => {
    const orderDate = formatDate(order.createdAt);
    const paymentStatus = getActualPaymentStatus(order);
    const orderStatus = order.orderStatus || order.status || 'payment_pending';
    const statusClass = getStatusClass(orderStatus);
    const statusText = getStatusText(orderStatus);
    
    const subtotal = order.subtotal || 0;
    const shipping = order.shipping || 0;
    const tax = order.tax || 0;
    const total = order.total || 0;
    const advancePayment = order.advancePayment || order.submittedAmount || 0;
    const remainingPayment = order.remainingPayment || (total - advancePayment);
    const platformFee = order.platformFee || 0;
    const netAdvance = order.netAdvance || (advancePayment - platformFee);
    
    // Payment badge logic
    let paymentBadgeClass = 'pending';
    let paymentBadgeText = 'Payment Pending';
    let paymentIcon = 'fa-clock';
    
    if (paymentStatus === 'fully_paid' || remainingPayment <= 0) {
      paymentBadgeClass = 'full';
      paymentBadgeText = 'Fully Paid';
      paymentIcon = 'fa-check-circle';
    } else if (paymentStatus === 'advance_paid' || advancePayment > 0) {
      paymentBadgeClass = 'advance';
      paymentBadgeText = 'Advance Paid';
      paymentIcon = 'fa-money-bill-wave';
    } else if (paymentStatus === 'confirmed') {
      paymentBadgeClass = 'confirmed';
      paymentBadgeText = 'Payment Confirmed';
      paymentIcon = 'fa-check-circle';
    }
    
    const isCancelled = orderStatus === 'cancelled' || orderStatus === 'returned' || orderStatus === 'refunded';
    const cardClass = isCancelled ? 'order-card cancelled' : 'order-card';
    
    // Determine order type - IMPORTANT FIX
    const orderType = order.isBuyNow ? 'buy-now' : 'cart';
    const orderTypeText = order.isBuyNow ? 'BUY NOW' : 'CART ORDER';
    
    // Calculate platform fees if not available
    const calculatedPlatformFee = platformFee || (advancePayment * 0.025) + 0.30;
    const calculatedNetAdvance = netAdvance || (advancePayment - calculatedPlatformFee);
    
    // Check if payment is due
    const showPaymentReminder = remainingPayment > 0;
    
    // Check if order can still accept payment
    const canMakePayment = !isCancelled && 
                          !['cancelled', 'returned', 'refunded'].includes(orderStatus) &&
                          remainingPayment > 0;
    
    // Check if order can be cancelled
    const canCancelOrder = !isCancelled && 
                          !['delivered', 'returned', 'shipped', 'out_for_delivery'].includes(orderStatus) &&
                          ['payment_pending', 'processing', 'ready_to_ship'].includes(orderStatus);
    
    ordersHTML += `
      <div class="${cardClass}" data-order-id="${order.id}" data-order-number="${order.orderNumber || ''}">
        <div class="order-type-badge ${orderType}">
          ${orderTypeText}
        </div>
        
        <div class="order-header">
          <div class="order-info">
            <h3>${order.orderNumber || 'Order #' + order.id.substring(0, 8)}</h3>
            <div class="order-date">Placed on ${orderDate}</div>
            ${order.userEmail ? `<div class="order-date" style="font-size: 11px; color: #666;">${order.userEmail}</div>` : ''}
          </div>
          <div>
            <div class="status-badge ${statusClass}" style="margin-bottom: 8px;">
              <i class="fas ${getStatusIcon(orderStatus)}"></i>
              ${statusText}
            </div>
            <div class="payment-status ${paymentBadgeClass}">
              <i class="fas ${paymentIcon}"></i>
              ${paymentBadgeText}
            </div>
          </div>
        </div>
        
        <div class="order-body">
          ${order.items && order.items.map(item => `
            <div class="order-item">
              <div class="item-image">
                <img src="${item.image || getDefaultImage(item.category)}" 
                     alt="${item.name || 'Product'}" 
                     loading="lazy"
                     onerror="this.src='${getDefaultImage(item.category)}'">
              </div>
              <div class="item-details">
                <div class="item-name">${item.name || 'Product'}</div>
                
                <div class="item-specs">
                  ${item.category ? `<span class="spec-badge">${item.category}</span>` : ''}
                  ${item.isBuyNow ? `<span class="spec-badge" style="background: var(--primary-gold); color: white;">Buy Now</span>` : ''}
                  ${item.calculationData && item.calculationData.mode === 'area' ? 
                    `<span class="spec-badge">Size: ${item.calculationData.length || 1} √ó ${item.calculationData.width || 1} ft</span>` : ''}
                  ${item.calculationData && item.calculationData.mode === 'weight' ? 
                    `<span class="spec-badge">Weight: ${item.calculationData.weight || 1} kg</span>` : ''}
                </div>
                
                <div class="item-meta">
                  Quantity: ${item.quantity || 1} ‚Ä¢ 
                  Price: ¬£${(item.price || 0).toFixed(2)}
                </div>
                <div class="item-price">Total: ¬£${(item.totalPrice || (item.price * (item.quantity || 1)) || 0).toFixed(2)}</div>
              </div>
            </div>
          `).join('')}
          
          <div class="order-summary">
            <div class="summary-item">
              <span class="summary-label">Subtotal</span>
              <span class="summary-value">¬£${subtotal.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Shipping</span>
              <span class="summary-value">${shipping === 0 ? 'FREE' : '¬£' + shipping.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Tax (20%)</span>
              <span class="summary-value">¬£${tax.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Total</span>
              <span class="summary-value total">¬£${total.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Paid</span>
              <span class="summary-value paid">¬£${advancePayment.toFixed(2)}</span>
            </div>
            <div class="summary-item">
              <span class="summary-label">Remaining</span>
              <span class="summary-value remaining">¬£${remainingPayment.toFixed(2)}</span>
            </div>
          </div>
          
          ${showPaymentReminder && canMakePayment ? `
          <div class="payment-reminder">
            <div class="payment-reminder-header">
              <i class="fas fa-exclamation-circle"></i> Payment Required
            </div>
            <div class="payment-reminder-content">
              Your order has a remaining balance of ¬£${remainingPayment.toFixed(2)}. 
              ${order.paymentMethod === 'bank' ? 'This is a bank transfer - payment requires admin confirmation.' : 'Please complete the payment to proceed.'}
              
              ${order.autoCancelTime ? `
              <div style="margin-top: 8px; padding: 6px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; font-size: 11px;">
                <i class="fas fa-clock"></i> 
                <strong>Deadline:</strong> ${formatDateTime(order.autoCancelTime)}
              </div>
              ` : ''}
            </div>
            <button class="pay-now-btn" onclick="payRemainingAmount('${order.id}')">
              <i class="fas fa-bolt"></i> PAY REMAINING AMOUNT - ¬£${remainingPayment.toFixed(2)}
            </button>
          </div>
          ` : ''}
          
          ${advancePayment > 0 ? `
          <div class="platform-fees">
            <div class="platform-fees-header">
              <i class="fas fa-info-circle"></i> Advance Payment Details
            </div>
            <div class="platform-fee-item">
              <span>Advance Amount:</span>
              <span>¬£${advancePayment.toFixed(2)}</span>
            </div>
            <div class="platform-fee-item">
              <span>Platform Fee (2.5% + ¬£0.30):</span>
              <span>¬£${calculatedPlatformFee.toFixed(2)}</span>
            </div>
            ${order.paymentMethod === 'bank' ? `
            <div class="platform-fee-item">
              <span>Bank Charges:</span>
              <span>¬£0.50</span>
            </div>
            ` : ''}
            <div class="platform-fee-total">
              <span>Net Advance:</span>
              <span>¬£${calculatedNetAdvance.toFixed(2)}</span>
            </div>
          </div>
          ` : ''}
          
          ${order.paymentMethod === 'bank' && order.paymentReference ? `
          <div class="platform-fees" style="background: rgba(245, 158, 11, 0.1);">
            <div class="platform-fees-header">
              <i class="fas fa-university"></i> Bank Transfer Details
            </div>
            <div class="platform-fee-item">
              <span>Reference:</span>
              <span>${order.paymentReference}</span>
            </div>
            <div class="platform-fee-item">
              <span>Status:</span>
              <span>${order.paymentStatus === 'pending' ? '‚è≥ Pending Admin Confirmation' : '‚úÖ Confirmed by Admin'}</span>
            </div>
            ${order.paymentConfirmDeadline ? `
            <div class="platform-fee-item">
              <span>Confirm By:</span>
              <span>${formatDate(order.paymentConfirmDeadline)}</span>
            </div>
            ` : ''}
          </div>
          ` : ''}
          
          ${order.estimatedDelivery || order.deliveryDate ? `
          <div class="delivery-estimate">
            <div class="label">Estimated Delivery</div>
            <div class="date">${formatDate(order.estimatedDelivery || order.deliveryDate)}</div>
          </div>
          ` : ''}
          
          ${order.shippingDetails || order.shippingAddress ? `
          <div class="address-section">
            <div class="address-header">
              <i class="fas fa-map-marker-alt"></i>
              <span>Shipping Address</span>
            </div>
            <div class="address-details">
              ${getAddressHTML(order.shippingDetails || order.shippingAddress)}
            </div>
          </div>
          ` : ''}
          
          ${isCancelled && order.cancellationDetails ? `
          <div class="cancellation-section">
            <div class="cancellation-reason">
              <i class="fas fa-times-circle"></i> ${order.cancellationDetails.reason || 'Order Cancelled'}
            </div>
            <div class="cancellation-date">
              Cancelled on ${formatDate(order.cancellationDetails.date)}
              ${order.cancellationDetails.cancelledBy ? `by ${order.cancellationDetails.cancelledBy}` : ''}
            </div>
            ${order.cancellationDetails.refundAmount ? `
            <div class="cancellation-date" style="color: var(--refunded); font-weight: 600;">
              Refund Amount: ¬£${order.cancellationDetails.refundAmount.toFixed(2)}
            </div>
            ` : ''}
          </div>
          ` : ''}
          
          ${order.refundPolicy ? `
          <div style="margin-top: 15px; padding: 10px; background: #fff8e1; border-radius: 6px; border-left: 4px solid var(--warning-orange); font-size: 11px; color: #92400e;">
            <i class="fas fa-info-circle"></i> 
            <strong>Refund Policy:</strong> ${order.refundPolicy}
          </div>
          ` : ''}
        </div>
        
        <div class="order-actions">
          <button class="btn btn-primary" onclick="showTrackingModal('${order.id}')">
            <i class="fas fa-truck"></i> Track Order
          </button>
          <button class="btn btn-success" onclick="downloadInvoice('${order.id}')">
            <i class="fas fa-file-invoice"></i> Invoice
          </button>
          ${canMakePayment ? `
          <button class="btn btn-warning" onclick="payRemainingAmount('${order.id}')">
            <i class="fas fa-money-bill-wave"></i> Pay Remaining
          </button>
          ` : ''}
          ${canCancelOrder ? `
          <button class="btn btn-danger" onclick="cancelOrder('${order.id}')">
            <i class="fas fa-times"></i> Cancel Order
          </button>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  ordersDiv.innerHTML = ordersHTML;
}

// ============================================
// HELPER FUNCTIONS UPDATE
// ============================================

function getActualPaymentStatus(order) {
  const total = order.total || 0;
  const advancePayment = order.advancePayment || order.submittedAmount || 0;
  const remainingPayment = order.remainingPayment || (total - advancePayment);
  
  // Bank transfer requires admin confirmation
  if (order.paymentMethod === 'bank' && order.paymentStatus === 'pending') {
    return 'pending';
  }
  
  // Agar order shipped/delivered hai to payment confirm consider karo
  const orderStatus = order.orderStatus || order.status || '';
  if (orderStatus === 'shipped' || orderStatus === 'out_for_delivery' || orderStatus === 'delivered') {
    if (remainingPayment <= 0) {
      return 'fully_paid';
    } else if (advancePayment > 0) {
      return 'advance_paid';
    }
  }
  
  // Regular logic
  if (remainingPayment <= 0) {
    return 'fully_paid';
  } else if (advancePayment > 0) {
    if (order.paymentStatus === 'confirmed') {
      return 'confirmed';
    }
    return 'advance_paid';
  }
  
  return 'pending';
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = date - now;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffHours < 0) {
      return 'Expired';
    } else if (diffHours < 24) {
      return `in ${diffHours} hours`;
    } else if (diffDays < 7) {
      return `in ${diffDays} days`;
    } else {
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  } catch (error) {
    return dateString;
  }
}
// ============================================
// ORDER CANCEL - COMPLETE IMPLEMENTATION
// ============================================

async function cancelOrder(orderId) {
  try {
    console.log("üõë Initiating order cancellation for:", orderId);
    
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      showMessage("Order not found", "error");
      return;
    }
    
    const orderStatus = order.orderStatus || order.status || '';
    
    // Check if order can be cancelled
    if (['shipped', 'out_for_delivery', 'delivered'].includes(orderStatus)) {
      showMessage("This order cannot be cancelled as it has already been shipped.", "error");
      return;
    }
    
    if (['cancelled', 'returned', 'refunded'].includes(orderStatus)) {
      showMessage("This order is already cancelled or processed.", "info");
      return;
    }
    
    // Save order ID for cancellation
    cancelOrderId = orderId;
    
    // Reset form
    document.getElementById('cancelReason').value = '';
    document.getElementById('otherReason').value = '';
    document.getElementById('otherReasonContainer').style.display = 'none';
    
    // Show cancel modal
    document.getElementById('cancelModal').style.display = 'flex';
    
    console.log("‚úÖ Cancel modal opened for order:", orderId);
    
  } catch (error) {
    console.error("‚ùå Error in cancel order:", error);
    showMessage("Failed to initiate cancellation", "error");
  }
}

async function confirmCancelOrder() {
  try {
    if (!cancelOrderId) {
      showMessage("No order selected for cancellation", "error");
      return;
    }
    
    const order = orders.find(o => o.id === cancelOrderId);
    if (!order) {
      showMessage("Order not found", "error");
      return;
    }
    
    const reason = document.getElementById('cancelReason').value;
    const otherReason = document.getElementById('otherReason').value;
    
    if (!reason) {
      showMessage("Please select a cancellation reason", "error");
      return;
    }
    
    const finalReason = reason === 'other' ? otherReason : 
      document.getElementById('cancelReason').options[document.getElementById('cancelReason').selectedIndex].text;
    
    if (reason === 'other' && !otherReason.trim()) {
      showMessage("Please specify the cancellation reason", "error");
      return;
    }
    
    console.log("üìù Cancelling order:", {
      orderId: cancelOrderId,
      reason: finalReason
    });
    
    // Calculate refund amount
    const advancePayment = order.advancePayment || order.submittedAmount || 0;
    const platformFee = order.platformFee || (advancePayment * 0.025) + 0.30;
    const bankCharges = order.paymentMethod === 'bank' ? 0.50 : 0;
    const refundAmount = Math.max(0, advancePayment - platformFee - bankCharges);
    
    // Update order in Firebase
    let firebaseSuccess = false;
    
    if (db) {
      try {
        // Try user-specific orders collection first
        try {
          const orderRef = doc(db, "users", currentUserId, "orders", cancelOrderId);
          await updateDoc(orderRef, {
            orderStatus: 'cancelled',
            status: 'cancelled',
            cancellationDetails: {
              reason: finalReason,
              date: new Date().toISOString(),
              refundAmount: refundAmount,
              platformFeeDeducted: platformFee,
              bankChargesDeducted: bankCharges,
              cancelledBy: 'customer',
              cancelledAt: new Date().toISOString()
            },
            updatedAt: new Date().toISOString()
          });
          firebaseSuccess = true;
          console.log("‚úÖ Order cancelled in user-specific collection");
        } catch (userError) {
          console.log("‚ö†Ô∏è Trying universal orders collection");
          
          // Try universal orders collection
          const orderRef = doc(db, "orders", cancelOrderId);
          await updateDoc(orderRef, {
            orderStatus: 'cancelled',
            status: 'cancelled',
            cancellationDetails: {
              reason: finalReason,
              date: new Date().toISOString(),
              refundAmount: refundAmount,
              platformFeeDeducted: platformFee,
              bankChargesDeducted: bankCharges,
              cancelledBy: 'customer',
              cancelledAt: new Date().toISOString()
            },
            updatedAt: new Date().toISOString()
          });
          firebaseSuccess = true;
          console.log("‚úÖ Order cancelled in universal collection");
        }
        
        // Create notification
        const notificationData = {
          title: "Order Cancelled",
          message: `Your order ${order.orderNumber || cancelOrderId.substring(0, 8)} has been cancelled. Refund amount: ¬£${refundAmount.toFixed(2)} will be processed within 5-7 business days.`,
          type: "order_cancelled",
          orderId: cancelOrderId,
          orderNumber: order.orderNumber,
          refundAmount: refundAmount,
          reason: finalReason,
          read: false,
          createdAt: new Date().toISOString(),
          userId: currentUserId,
          userEmail: userEmail,
          userName: userName
        };
        
        try {
          const notificationsRef = collection(db, "users", currentUserId, "notifications");
          await addDoc(notificationsRef, notificationData);
          console.log("‚úÖ Cancellation notification created");
        } catch (notificationError) {
          console.error("‚ö†Ô∏è Failed to create notification:", notificationError);
        }
        
      } catch (firebaseError) {
        console.error("‚ùå Firebase update error:", firebaseError);
        firebaseSuccess = false;
      }
    }
    
    // Update local order state
    const orderIndex = orders.findIndex(o => o.id === cancelOrderId);
    if (orderIndex !== -1) {
      orders[orderIndex].orderStatus = 'cancelled';
      orders[orderIndex].status = 'cancelled';
      orders[orderIndex].cancellationDetails = {
        reason: finalReason,
        date: new Date().toISOString(),
        refundAmount: refundAmount,
        platformFeeDeducted: platformFee,
        bankChargesDeducted: bankCharges,
        cancelledBy: 'customer'
      };
    }
    
    // Close modal
    closeCancelModal();
    
    // Show success message
    if (firebaseSuccess) {
      document.getElementById('successTitle').textContent = "Order Cancelled Successfully";
      document.getElementById('successMessage').innerHTML = `
        Your order has been cancelled successfully.<br><br>
        <strong>Refund Amount:</strong> ¬£${refundAmount.toFixed(2)}<br>
        <strong>Reason:</strong> ${finalReason}<br><br>
        Refund will be processed within 5-7 business days.
      `;
    } else {
      document.getElementById('successTitle').textContent = "Order Cancelled (Local)";
      document.getElementById('successMessage').innerHTML = `
        Your order has been marked as cancelled locally.<br><br>
        <strong>Refund Amount:</strong> ¬£${refundAmount.toFixed(2)}<br>
        <strong>Reason:</strong> ${finalReason}<br><br>
        Note: Please contact support for official cancellation.
      `;
    }
    
    document.getElementById('successModal').style.display = 'flex';
    
    // Refresh display after delay
    setTimeout(() => {
      displayOrders(orders);
      console.log("üîÑ Orders display refreshed after cancellation");
    }, 200);
    
  } catch (error) {
    console.error("‚ùå Error confirming cancellation:", error);
    showMessage("Failed to cancel order: " + error.message, "error");
    closeCancelModal();
  }
}

function closeCancelModal() {
  document.getElementById('cancelModal').style.display = 'none';
  cancelOrderId = null;
}


function getActualPaymentStatus(order) {
  const total = order.total || 0;
  const advancePayment = order.advancePayment || order.submittedAmount || 0;
  const remainingPayment = order.remainingPayment || (total - advancePayment);
  
  // Agar order shipped/delivered hai to payment confirm consider karo
  const orderStatus = order.orderStatus || order.status || '';
  if (orderStatus === 'shipped' || orderStatus === 'out_for_delivery' || orderStatus === 'delivered') {
    if (remainingPayment <= 0) {
      return 'fully_paid';
    } else if (advancePayment > 0) {
      return 'advance_paid';
    }
  }
  
  // Regular logic
  if (remainingPayment <= 0) {
    return 'fully_paid';
  } else if (advancePayment > 0) {
    return 'advance_paid';
  } else if (order.paymentStatus === 'confirmed') {
    return 'confirmed';
  }
  
  return 'pending';
}

function getAddressHTML(address) {
  if (!address) return '';
  
  let html = '';
  
  if (typeof address === 'string') {
    html += `<div class="address-line">${address}</div>`;
    return html;
  }
  
  if (address.name || address.fullName) {
    html += `<div class="address-line"><strong>${address.fullName || address.name}</strong></div>`;
  }
  if (address.email) html += `<div class="address-line">${address.email}</div>`;
  if (address.phone) html += `<div class="address-line">Phone: ${address.phone}</div>`;
  if (address.address) html += `<div class="address-line">${address.address}</div>`;
  if (address.address1) html += `<div class="address-line">${address.address1}</div>`;
  if (address.address2) html += `<div class="address-line">${address.address2}</div>`;
  if (address.city || address.state) {
    html += `<div class="address-line">`;
    if (address.city) html += `${address.city}`;
    if (address.city && address.state) html += `, `;
    if (address.state) html += `${address.state}`;
    html += `</div>`;
  }
  if (address.postalCode) html += `<div class="address-line">Postal Code: ${address.postalCode}</div>`;
  if (address.country) html += `<div class="address-line">${address.country}</div>`;
  
  return html;
}

// ============================================
// NOTIFICATIONS LISTENER - FOR BADGE UPDATES ONLY
// ============================================

async function setupNotificationsListener() {
  try {
    if (!db || !currentUserId) return;
    
    const notificationsRef = collection(db, "users", currentUserId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"));
    
    if (notificationsUnsubscribe) notificationsUnsubscribe();
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery,
      (snapshot) => {
        notifications = [];
        let unreadCount = 0;
        
        snapshot.forEach((doc) => {
          const note = doc.data();
          note.id = doc.id;
          notifications.push(note);
          
          if (!note.read) unreadCount++;
        });
        
        updateNotificationBadge(unreadCount);
        updateBottomNavNotificationBadge(unreadCount);
        
      },
      (error) => {
        console.error("‚ùå Error in notifications listener:", error);
      }
    );
    
  } catch (error) {
    console.error("‚ùå Error loading notifications:", error);
  }
}

function updateNotificationBadge(count = null) {
  const badge = document.getElementById("notificationBadge");
  if (!badge) return;
  
  const unreadCount = count !== null ? count : notifications.filter(n => !n.read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

function updateBottomNavNotificationBadge(count = null) {
  const badge = document.getElementById("bottomNavNotificationBadge");
  if (!badge) return;
  
  const unreadCount = count !== null ? count : notifications.filter(n => !n.read).length;
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

// ============================================
// ORDER FILTERING
// ============================================

function filterOrders(status) {
  const buttons = document.querySelectorAll('.status-filter-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.currentTarget.classList.add('active');
  
  let filteredOrders = orders;
  
  if (status !== 'all') {
    filteredOrders = orders.filter(order => {
      const orderStatus = order.orderStatus || order.status || 'payment_pending';
      const orderStatusLower = orderStatus.toLowerCase();
      const statusLower = status.toLowerCase();
      
      if (statusLower === 'pending') {
        return orderStatusLower.includes('pending') || 
               orderStatusLower === 'payment_pending' ||
               orderStatusLower === 'advance_paid' ||
               orderStatusLower === 'processing';
      }
      
      if (statusLower === 'processing') {
        return orderStatusLower.includes('processing') || 
               orderStatusLower === 'ready_to_ship';
      }
      
      if (statusLower === 'shipped') {
        return orderStatusLower.includes('shipped') || 
               orderStatusLower === 'out_for_delivery';
      }
      
      if (statusLower === 'delivered') {
        return orderStatusLower === 'delivered';
      }
      
      return orderStatusLower === statusLower;
    });
  }
  
  displayOrders(filteredOrders);
}

function searchOrders() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  
  if (!searchTerm) {
    const activeFilter = document.querySelector('.status-filter-btn.active');
    if (activeFilter) {
      const status = activeFilter.getAttribute('onclick').match(/'([^']+)'/)[1];
      filterOrders(status);
      return;
    }
    displayOrders(orders);
    return;
  }
  
  const filteredOrders = orders.filter(order => {
    if (order.orderNumber && order.orderNumber.toLowerCase().includes(searchTerm)) {
      return true;
    }
    
    if (order.id && order.id.toLowerCase().includes(searchTerm)) {
      return true;
    }
    
    if (order.items && order.items.some(item => {
      const itemName = (item.name || '').toLowerCase();
      return itemName.includes(searchTerm);
    })) {
      return true;
    }
    
    if (order.shippingDetails) {
      const name = (order.shippingDetails.name || order.shippingDetails.fullName || '').toLowerCase();
      if (name.includes(searchTerm)) return true;
    }
    
    const statusText = getStatusText(order.orderStatus || order.status).toLowerCase();
    if (statusText.includes(searchTerm)) {
      return true;
    }
    
    return false;
  });
  
  displayOrders(filteredOrders);
}

// ============================================
// CHECK REDIRECTS
// ============================================

function checkNotificationRedirect() {
  const notificationRedirect = localStorage.getItem('irya_notification_redirect');
  if (notificationRedirect) {
    try {
      const redirectData = JSON.parse(notificationRedirect);
      console.log("üìå Processing notification redirect:", redirectData);
      
      const { orderId, orderNumber } = redirectData;
      
      if (orderId || orderNumber) {
        setTimeout(() => {
          let orderElement;
          
          if (orderId) {
            orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
          }
          
          if (!orderElement && orderNumber) {
            orderElement = document.querySelector(`[data-order-number="${orderNumber}"]`);
          }
          
          if (orderElement) {
            orderElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            orderElement.style.boxShadow = '0 0 0 3px var(--primary-gold)';
            setTimeout(() => {
              orderElement.style.boxShadow = '';
            }, 3000);
          }
        }, 1000);
      }
      
      localStorage.removeItem('irya_notification_redirect');
      
    } catch (error) {
      console.error("‚ùå Error processing notification redirect:", error);
      localStorage.removeItem('irya_notification_redirect');
    }
  }
}

function checkPaymentSuccess() {
  const urlParams = new URLSearchParams(window.location.search);
  const paymentSuccess = urlParams.get('payment_success');
  
  if (paymentSuccess === 'true') {
    const orderId = urlParams.get('order_id');
    const orderNumber = urlParams.get('order_number');
    
    if (orderId || orderNumber) {
      setTimeout(() => {
        let orderElement;
        
        if (orderId) {
          orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
        }
        
        if (!orderElement && orderNumber) {
          orderElement = document.querySelector(`[data-order-number="${orderNumber}"]`);
        }
        
        if (orderElement) {
          orderElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          orderElement.style.boxShadow = '0 0 0 3px var(--primary-gold)';
          setTimeout(() => {
            orderElement.style.boxShadow = '';
          }, 3000);
        }
      }, 500);
    }
    
    // Clean URL
    const newUrl = window.location.pathname;
    window.history.replaceState({}, document.title, newUrl);
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function getStatusClass(status) {
  if (!status) return 'status-payment-pending';
  
  const statusMap = {
    'payment_pending': 'status-payment-pending',
    'advance_paid': 'status-payment-advance',
    'fully_paid': 'status-payment-full',
    'processing': 'status-processing',
    'ready_to_ship': 'status-ready-to-ship',
    'shipped': 'status-shipped',
    'out_for_delivery': 'status-out-for-delivery',
    'delivered': 'status-delivered',
    'cancelled': 'status-cancelled',
    'returned': 'status-returned',
    'refunded': 'status-refunded'
  };
  
  return statusMap[status] || 'status-payment-pending';
}

function getStatusText(status) {
  if (!status) return 'Payment Pending';
  
  const statusMap = {
    'payment_pending': 'Payment Pending',
    'advance_paid': 'Advance Paid',
    'fully_paid': 'Full Payment',
    'processing': 'Processing',
    'ready_to_ship': 'Ready to Ship',
    'shipped': 'Shipped',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled',
    'returned': 'Returned',
    'refunded': 'Refunded'
  };
  
  return statusMap[status] || status;
}

function getStatusIcon(status) {
  if (!status) return 'fa-clock';
  
  const iconMap = {
    'payment_pending': 'fa-clock',
    'advance_paid': 'fa-money-bill-wave',
    'fully_paid': 'fa-check-circle',
    'processing': 'fa-cogs',
    'ready_to_ship': 'fa-box',
    'shipped': 'fa-shipping-fast',
    'out_for_delivery': 'fa-truck',
    'delivered': 'fa-check-circle',
    'cancelled': 'fa-times-circle',
    'returned': 'fa-undo',
    'refunded': 'fa-money-bill-wave'
  };
  
  return iconMap[status] || 'fa-clock';
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    return dateString;
  }
}

function showEmptyState(message) {
  const ordersDiv = document.getElementById("orders");
  ordersDiv.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-box-open"></i>
      <h3>${message}</h3>
      <p>Start shopping to see your orders here</p>
      <button class="btn btn-primary" onclick="window.location.href='products.html'" style="margin-top: 20px;">
        <i class="fas fa-shopping-bag"></i> Shop Now
      </button>
    </div>
  `;
}

function showMessage(message, type = 'info') {
  // Remove existing messages
  const existingMessages = document.querySelectorAll('.message-toast');
  existingMessages.forEach(msg => msg.remove());
  
  const toast = document.createElement('div');
  toast.className = 'message-toast';
  
  let backgroundColor = '#3b82f6';
  let icon = 'fa-info-circle';
  
  if (type === 'success') {
    backgroundColor = '#10b981';
    icon = 'fa-check-circle';
  } else if (type === 'error') {
    backgroundColor = '#ef4444';
    icon = 'fa-exclamation-triangle';
  } else if (type === 'warning') {
    backgroundColor = '#f59e0b';
    icon = 'fa-exclamation-circle';
  }
  
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${backgroundColor};
    color: white;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 10000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
    max-width: 90%;
    word-wrap: break-word;
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  
  toast.innerHTML = `
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
    <i class="fas ${icon}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function closeSuccessModal() {
  document.getElementById('successModal').style.display = 'none';
}

function closeErrorModal() {
  document.getElementById('errorModal').style.display = 'none';
}

// ============================================
// TRACKING MODAL FUNCTIONS
// ============================================

async function showTrackingModal(orderId) {
  try {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      showMessage("Order not found", "error");
      return;
    }
    
    const trackingModal = document.getElementById('trackingModal');
    const modalContent = document.getElementById('trackingModalContent');
    
    const timelineHTML = createTrackingTimeline(order);
    
    modalContent.innerHTML = `
      <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: var(--border-radius); margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
          <div>
            <div style="font-size: 12px; opacity: 0.9;">Order Number</div>
            <div style="font-family: monospace; font-size: 18px; font-weight: 600;">${order.orderNumber || order.id.substring(0, 8)}</div>
          </div>
          <div>
            <div style="font-size: 12px; opacity: 0.9;">Current Status</div>
            <div class="status-badge ${getStatusClass(order.orderStatus || order.status)}" style="margin-top: 5px; background: white;">
              ${getStatusText(order.orderStatus || order.status)}
            </div>
          </div>
          ${order.trackingNumber ? `
          <div>
            <div style="font-size: 12px; opacity: 0.9;">Tracking Number</div>
            <div style="font-family: monospace; font-size: 18px; font-weight: 600;">${order.trackingNumber}</div>
          </div>
          ` : ''}
        </div>
      </div>
      
      <div class="tracking-timeline">
        <h3 style="margin-bottom: 20px; color: var(--stone-dark); font-size: 18px;">
          <i class="fas fa-shipping-fast"></i> Order Journey
        </h3>
        ${timelineHTML}
      </div>
      
      ${order.shippingDetails || order.shippingAddress ? `
      <div class="address-section" style="margin-top: 20px;">
        <div class="address-header">
          <i class="fas fa-map-marker-alt"></i>
          <span>Delivery Address</span>
        </div>
        <div class="address-details">
          ${getAddressHTML(order.shippingDetails || order.shippingAddress)}
        </div>
      </div>
      ` : ''}
      
      <div style="margin-top: 30px;">
        ${order.trackingNumber ? `
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <button class="btn btn-primary" onclick="copyTrackingNumber('${order.trackingNumber}')">
            <i class="fas fa-copy"></i> Copy Tracking
          </button>
          <button class="btn btn-outline" onclick="trackOnWebsite('${order.trackingNumber}')">
            <i class="fas fa-external-link-alt"></i> Track Online
          </button>
        </div>
        ` : ''}
        <button class="btn btn-secondary" onclick="closeTrackingModal()" style="width: 100%;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    `;
    
    trackingModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
  } catch (error) {
    console.error("‚ùå Error showing tracking modal:", error);
    showMessage("Failed to load tracking information", "error");
  }
}

function createTrackingTimeline(order) {
  const status = order.orderStatus || order.status || 'payment_pending';
  const statusHistory = order.statusHistory || [];
  
  const timelineSteps = [
    {
      id: 'order_placed',
      title: 'Order Placed',
      description: 'Your order has been successfully placed',
      icon: 'fa-shopping-cart',
      date: order.createdAt,
      statusCheck: () => true
    },
    {
      id: 'payment_confirmed',
      title: 'Payment Confirmed',
      description: order.paymentMethod === 'bank' ? 'Bank transfer confirmed' : 'Payment confirmed',
      icon: 'fa-credit-card',
      date: order.paymentConfirmedAt,
      statusCheck: () => order.advancePayment > 0 || order.submittedAmount > 0
    },
    {
      id: 'order_confirmed',
      title: 'Order Confirmed',
      description: 'Order has been confirmed by our team',
      icon: 'fa-check-circle',
      date: order.confirmedAt,
      statusCheck: () => status !== 'payment_pending'
    },
    {
      id: 'processing',
      title: 'Processing',
      description: 'Your order is being processed',
      icon: 'fa-cogs',
      date: order.processingAt,
      statusCheck: () => ['processing', 'ready_to_ship', 'shipped', 'out_for_delivery', 'delivered'].includes(status)
    },
    {
      id: 'ready_to_ship',
      title: 'Ready to Ship',
      description: 'Order is packed and ready for shipping',
      icon: 'fa-box',
      date: order.readyToShipAt,
      statusCheck: () => ['ready_to_ship', 'shipped', 'out_for_delivery', 'delivered'].includes(status)
    },
    {
      id: 'shipped',
      title: 'Shipped',
      description: order.trackingNumber ? `Shipped via courier` : 'Order has been shipped',
      icon: 'fa-shipping-fast',
      date: order.shippedAt,
      statusCheck: () => ['shipped', 'out_for_delivery', 'delivered'].includes(status)
    },
    {
      id: 'out_for_delivery',
      title: 'Out for Delivery',
      description: 'Order is out for delivery',
      icon: 'fa-truck',
      date: order.outForDeliveryAt,
      statusCheck: () => ['out_for_delivery', 'delivered'].includes(status)
    },
    {
      id: 'delivered',
      title: 'Delivered',
      description: 'Order has been delivered successfully',
      icon: 'fa-check-double',
      date: order.deliveredAt,
      statusCheck: () => status === 'delivered'
    }
  ];
  
  let html = '';
  
  let currentStepIndex = 0;
  for (let i = 0; i < timelineSteps.length; i++) {
    const step = timelineSteps[i];
    if (step.statusCheck()) {
      currentStepIndex = i;
    } else {
      break;
    }
  }
  
  timelineSteps.forEach((step, index) => {
    let stepClass = 'pending';
    let icon = step.icon;
    
    if (index < currentStepIndex) {
      stepClass = 'completed';
    } else if (index === currentStepIndex) {
      stepClass = 'active';
    }
    
    let actualDate = step.date;
    if (statusHistory && statusHistory.length > 0) {
      const historyItem = statusHistory.find(h => 
        h.status.toLowerCase() === step.title.toLowerCase()
      );
      if (historyItem) {
        actualDate = historyItem.at;
      }
    }
    
    html += `
      <div class="timeline-step ${stepClass}">
        <div class="timeline-icon">
          <i class="fas ${icon}"></i>
        </div>
        <div class="timeline-content">
          <div class="timeline-title">
            ${step.title}
            ${stepClass === 'active' ? '<span style="color: var(--primary-gold); font-size: 10px; margin-left: 5px;">‚óè</span>' : ''}
          </div>
          <div class="timeline-desc">${step.description}</div>
          ${actualDate ? `
          <div class="timeline-date">
            <i class="far fa-clock"></i> ${formatDateTime(actualDate)}
          </div>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  return html;
}

function closeTrackingModal() {
  const trackingModal = document.getElementById('trackingModal');
  trackingModal.style.display = 'none';
  document.body.style.overflow = 'auto';
}

function copyTrackingNumber(trackingNumber) {
  if (!trackingNumber) {
    showMessage("No tracking number available", "info");
    return;
  }
  
  navigator.clipboard.writeText(trackingNumber).then(() => {
    showMessage("Tracking number copied to clipboard", "success");
  }).catch(err => {
    console.error('‚ùå Failed to copy tracking number:', err);
    showMessage("Failed to copy tracking number", "error");
  });
}

function trackOnWebsite(trackingNumber) {
  if (!trackingNumber) {
    showMessage("No tracking number available", "info");
    return;
  }
  
  showMessage(`Tracking number: ${trackingNumber}`, "info");
}

// ============================================
// CART BADGE UPDATE
// ============================================

function updateCartBadge() {
  try {
    const userId = localStorage.getItem('irya_guest_id') || 'guest';
    const cartKey = 'irya_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  } catch (error) {
    console.error('‚ùå Error updating cart badge:', error);
  }
}

// ============================================
// INVOICE FUNCTION
// ============================================

async function downloadInvoice(orderId) {
  try {
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      showMessage("Order not found", "error");
      return;
    }
    
    // Open invoice in new window
    const win = window.open("", "_blank");
    const invoiceHTML = generateInvoiceHTML(order);
    win.document.write(invoiceHTML);
    win.document.close();
    
    showMessage("Invoice generated successfully", "success");
    
  } catch (error) {
    console.error("‚ùå Error generating invoice:", error);
    showMessage("Failed to generate invoice", "error");
  }
}

function generateInvoiceHTML(order) {
  const invoiceDate = formatDate(order.createdAt);
  const total = order.total || 0;
  const advancePayment = order.advancePayment || order.submittedAmount || 0;
  const remainingPayment = order.remainingPayment || (total - advancePayment);
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice - ${order.orderNumber || order.id}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .invoice-container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 30px; }
        .header { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .company-info h1 { color: #c9a227; margin: 0; }
        .invoice-details { margin-bottom: 30px; }
        .items-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .items-table th, .items-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .items-table th { background: #f5f5f5; }
        .total-section { text-align: right; margin-top: 30px; }
        .footer { margin-top: 50px; text-align: center; color: #666; font-size: 12px; }
      </style>
    </head>
    <body>
      <div class="invoice-container">
        <div class="header">
          <div class="company-info">
            <h1>IRYA STONE</h1>
            <p>Stone Products Supplier</p>
            <p>United Kingdom</p>
          </div>
          <div class="invoice-info">
            <h2>INVOICE</h2>
            <p><strong>Invoice No:</strong> ${order.orderNumber || order.id}</p>
            <p><strong>Date:</strong> ${invoiceDate}</p>
          </div>
        </div>
        
        <div class="invoice-details">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
              <h3>Bill To:</h3>
              ${order.shippingDetails ? `
                <p>${order.shippingDetails.name || ''}</p>
                <p>${order.shippingDetails.email || ''}</p>
                <p>${order.shippingDetails.phone || ''}</p>
                <p>${order.shippingDetails.address || ''}</p>
              ` : '<p>Customer Information</p>'}
            </div>
            <div>
              <h3>Payment Details:</h3>
              <p><strong>Status:</strong> ${order.orderStatus || 'Processing'}</p>
              <p><strong>Payment Method:</strong> ${order.paymentMethod || 'Stripe'}</p>
              ${order.paymentReference ? `<p><strong>Reference:</strong> ${order.paymentReference}</p>` : ''}
            </div>
          </div>
        </div>
        
        <table class="items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${order.items ? order.items.map(item => `
              <tr>
                <td>${item.name || 'Stone Product'}</td>
                <td>${item.quantity || 1}</td>
                <td>¬£${(item.price || 0).toFixed(2)}</td>
                <td>¬£${(item.totalPrice || (item.price * (item.quantity || 1)) || 0).toFixed(2)}</td>
              </tr>
            `).join('') : ''}
          </tbody>
        </table>
        
        <div class="total-section">
          <p><strong>Subtotal:</strong> ¬£${(order.subtotal || 0).toFixed(2)}</p>
          <p><strong>Shipping:</strong> ¬£${(order.shipping || 0).toFixed(2)}</p>
          <p><strong>Tax (20%):</strong> ¬£${(order.tax || 0).toFixed(2)}</p>
          <h3>Total: ¬£${total.toFixed(2)}</h3>
          <p><strong>Paid Amount:</strong> ¬£${advancePayment.toFixed(2)}</p>
          <p><strong>Remaining:</strong> ¬£${remainingPayment.toFixed(2)}</p>
        </div>
        
        <div class="footer">
          <p>Thank you for your business!</p>
          <p>IRYA STONE | United Kingdom | www.iryastone.com</p>
          <p>This is a computer-generated invoice. No signature required.</p>
        </div>
      </div>
    </body>
    </html>
  `;
}

// ============================================
// CLEANUP
// ============================================

window.addEventListener('beforeunload', () => {
  if (ordersUnsubscribe) ordersUnsubscribe();
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

// ============================================
// GLOBAL FUNCTIONS
// ============================================

window.filterOrders = filterOrders;
window.searchOrders = searchOrders;
window.showTrackingModal = showTrackingModal;
window.closeTrackingModal = closeTrackingModal;
window.downloadInvoice = downloadInvoice;
window.copyTrackingNumber = copyTrackingNumber;
window.trackOnWebsite = trackOnWebsite;
window.cancelOrder = cancelOrder;
window.payRemainingAmount = payRemainingAmount;
window.confirmCancelOrder = confirmCancelOrder;
window.closeCancelModal = closeCancelModal;
window.closeSuccessModal = closeSuccessModal;
window.closeErrorModal = closeErrorModal;
</script>

</body>
</html>
