<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* All CSS remains same as before until the JavaScript section */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Orders Container */
.orders-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

/* Orders Tabs */
.orders-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.order-tab {
    padding: 12px 24px;
    border-radius: 25px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
}

.order-tab:hover {
    border-color: var(--primary-gold);
}

.order-tab.active {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

/* Orders List */
.orders-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.order-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    border: 1px solid #f0f0f0;
}

.order-card:hover {
    border-color: var(--primary-gold);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.order-info h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.order-number {
    font-size: 14px;
    color: var(--text-light);
    font-weight: 500;
}

.order-date {
    font-size: 13px;
    color: var(--text-light);
}

.order-status {
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-processing {
    background: #cce5ff;
    color: #004085;
}

.status-shipped {
    background: #d4edda;
    color: #155724;
}

.status-delivered {
    background: #d1ecf1;
    color: #0c5460;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.status-pending_bank_transfer {
    background: #ffeaa7;
    color: #856404;
}

/* Order Items */
.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
}

.order-item-name {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 15px;
}

.order-item-info {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
}

.order-item-quantity {
    font-size: 13px;
    color: var(--text-light);
}

/* Order Summary */
.order-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 10px;
}

.summary-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.summary-label {
    font-size: 12px;
    color: var(--text-light);
}

.summary-value {
    font-weight: 600;
    color: var(--stone-dark);
}

/* Payment Info */
.payment-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-gold);
}

.payment-info h5 {
    font-size: 14px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.payment-info h5 i {
    color: var(--primary-gold);
}

.payment-details {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.5;
    background: var(--white);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.payment-details p {
    margin: 5px 0;
}

.payment-details strong {
    color: var(--stone-dark);
}

/* Tracking Timeline */
.tracking-timeline {
    margin: 25px 0;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 10px;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.timeline-header h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.timeline-header h4 i {
    color: var(--primary-gold);
}

.tracking-id {
    font-size: 13px;
    color: var(--text-light);
}

.timeline-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    padding: 20px 0;
}

.timeline-steps::before {
    content: '';
    position: absolute;
    top: 30px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e0e0e0;
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--white);
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 16px;
    transition: var(--transition);
}

.step-icon.completed {
    background: var(--primary-gold);
    border-color: var(--primary-gold);
    color: white;
}

.step-icon.active {
    background: var(--white);
    border-color: var(--primary-gold);
    color: var(--primary-gold);
    box-shadow: 0 0 0 5px rgba(201, 162, 39, 0.1);
}

.step-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dark);
    text-align: center;
}

.step-date {
    font-size: 11px;
    color: var(--text-light);
    text-align: center;
}

/* Order Actions */
.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.order-action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.order-action-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.order-action-btn.primary {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.order-action-btn.primary:hover {
    background: var(--gold-dark);
}

/* No Orders Message */
.no-orders {
    text-align: center;
    padding: 60px 20px;
}

.no-orders i {
    font-size: 48px;
    color: var(--text-light);
    opacity: 0.5;
    margin-bottom: 20px;
}

.no-orders h3 {
    font-size: 20px;
    color: var(--stone-dark);
    margin-bottom: 10px;
}

.no-orders p {
    color: var(--text-light);
    max-width: 400px;
    margin: 0 auto 20px;
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive */
@media (max-width: 768px) {
    .order-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .timeline-steps {
        flex-direction: column;
        gap: 30px;
    }
    
    .timeline-steps::before {
        display: none;
    }
    
    .timeline-step {
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: 15px;
    }
    
    .step-label, .step-date {
        text-align: left;
    }
}

@media (max-width: 480px) {
    .orders-container {
        padding: 20px 12px;
    }
    
    .order-tab {
        padding: 10px 15px;
        font-size: 13px;
    }
    
    .order-summary {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Header -->
<header>
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="products.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active">
            My Orders
        </div>
    </div>
</section>

<!-- Orders Container -->
<section class="orders-container">
    <div class="orders-tabs">
        <button class="order-tab active" onclick="filterOrders('all')">All Orders</button>
        <button class="order-tab" onclick="filterOrders('pending')">Pending</button>
        <button class="order-tab" onclick="filterOrders('processing')">Processing</button>
        <button class="order-tab" onclick="filterOrders('shipped')">Shipped</button>
        <button class="order-tab" onclick="filterOrders('delivered')">Delivered</button>
    </div>
    
    <div class="orders-list" id="ordersList">
        <!-- Orders will be loaded here -->
    </div>
    
    <div class="no-orders" id="noOrdersMessage" style="display: none;">
        <i class="fas fa-box-open"></i>
        <h3>No Orders Found</h3>
        <p>You haven't placed any orders yet</p>
        <a href="products.html" class="order-action-btn primary">
            <i class="fas fa-shopping-bag"></i>
            Start Shopping
        </a>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn active">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION (Checkout ke saath match)
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let userOrders = [];
let currentFilter = 'all';
let authSystem = null;

// ============================================
// AUTHENTICATION SYSTEM (Checkout ke saath match)
// ============================================

class OrdersAuthSystem {
    constructor() {
        this.currentUser = null;
        this.authKey = 'irya_stone_auth_user';
        this.guestIdKey = 'irya_guest_id';
    }
    
    async init() {
        try {
            await this.initializeFirebase();
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged((user) => {
                    console.log("Auth State Changed:", user ? user.uid : "No user");
                    
                    if (user) {
                        // Firebase authenticated user
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL,
                            providerId: user.providerId,
                            isFirebaseUser: true
                        };
                        
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        
                    } else {
                        // No Firebase user, check localStorage
                        const storedUser = this.getUserFromStorage();
                        
                        if (storedUser && storedUser.isFirebaseUser) {
                            this.currentUser = storedUser;
                        } else {
                            // Create guest user
                            this.currentUser = this.createGuestUser();
                            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        }
                    }
                    
                    resolve(this.currentUser);
                });
            });
            
        } catch (error) {
            console.error('Auth init error:', error);
            this.currentUser = this.getUserFromStorage() || this.createGuestUser();
            return this.currentUser;
        }
    }
    
    async initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            console.log('Firebase initialized for orders');
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            throw error;
        }
    }
    
    getUserFromStorage() {
        const userData = localStorage.getItem(this.authKey);
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error parsing user data:', e);
                return null;
            }
        }
        return null;
    }
    
    createGuestUser() {
        let guestId = localStorage.getItem(this.guestIdKey);
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(this.guestIdKey, guestId);
        }
        
        return {
            uid: guestId,
            displayName: 'Guest',
            email: '',
            photoURL: '',
            providerId: 'guest',
            isFirebaseUser: false,
            isGuest: true
        };
    }
    
    isLoggedIn() {
        return this.currentUser && this.currentUser.isFirebaseUser === true;
    }
    
    getUserId() {
        if (!this.currentUser) {
            return this.createGuestUser().uid;
        }
        return this.currentUser.uid;
    }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("Orders page loaded");
    
    // Initialize Auth System
    authSystem = new OrdersAuthSystem();
    await authSystem.init();
    
    console.log("Auth initialized. User ID:", authSystem.getUserId());
    
    // Load user orders
    await loadUserOrders();
    
    // Update cart badge
    updateCartBadge();
});

// ============================================
// LOAD USER ORDERS (Checkout se compatible)
// ============================================

async function loadUserOrders() {
    try {
        showLoading(true);
        
        if (!firebaseDB) {
            await initializeFirebase();
        }
        
        const userId = authSystem.getUserId();
        
        if (!firebaseDB) {
            showError('Database not available');
            return;
        }
        
        console.log("Loading orders for user:", userId);
        
        // Try main orders collection (checkout se same structure)
        const ordersSnapshot = await firebaseDB.collection('orders')
            .where('userId', '==', userId)
            .orderBy('createdAt', 'desc')
            .get();
        
        if (!ordersSnapshot.empty) {
            userOrders = [];
            
            ordersSnapshot.forEach(doc => {
                const orderData = doc.data();
                userOrders.push({
                    id: doc.id,
                    ...orderData
                });
            });
            
            console.log("Orders loaded from main collection:", userOrders.length);
            displayOrders();
        } else {
            // Check user's orders collection
            try {
                const userOrdersRef = firebaseDB.collection('userOrders').doc(userId);
                const userOrdersSnapshot = await userOrdersRef.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (!userOrdersSnapshot.empty) {
                    userOrders = [];
                    
                    userOrdersSnapshot.forEach(doc => {
                        const orderData = doc.data();
                        userOrders.push({
                            id: doc.id,
                            ...orderData
                        });
                    });
                    
                    console.log("Orders loaded from user collection:", userOrders.length);
                    displayOrders();
                } else {
                    showNoOrders();
                }
            } catch (error) {
                console.log("User collection error, showing no orders");
                showNoOrders();
            }
        }
        
    } catch (error) {
        console.error('Error loading orders:', error);
        showNoOrders();
    } finally {
        showLoading(false);
    }
}

async function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            showError('Firebase not loaded');
            return false;
        }
        
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        
        firebaseDB = firebase.firestore();
        firebaseAuth = firebase.auth();
        
        return true;
    } catch (error) {
        console.error('Firebase initialization error:', error);
        return false;
    }
}

// ============================================
// DISPLAY ORDERS (Checkout ke order structure ke saath match)
// ============================================

function displayOrders() {
    const ordersList = document.getElementById('ordersList');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    
    // Filter orders
    const filteredOrders = userOrders.filter(order => {
        if (currentFilter === 'all') return true;
        if (order.status === 'pending_bank_transfer' && currentFilter === 'pending') return true;
        return order.status === currentFilter;
    });
    
    if (filteredOrders.length === 0) {
        showNoOrders();
        return;
    }
    
    noOrdersMessage.style.display = 'none';
    
    const ordersHTML = filteredOrders.map(order => `
        <div class="order-card">
            <div class="order-header">
                <div class="order-info">
                    <h3>Order #${order.orderNumber || order.id}</h3>
                    <div class="order-date">Placed on ${formatDate(order.createdAt)}</div>
                    <div class="order-number">Order ID: ${order.id}</div>
                </div>
                <div class="order-status status-${order.status || 'pending'}">
                    ${getStatusText(order.status || 'pending')}
                </div>
            </div>
            
            <div class="order-items">
                ${(order.items || []).slice(0, 2).map(item => `
                    <div class="order-item">
                        <div class="order-item-image">
                            <img src="${item.image || getDefaultImage(item.category)}" 
                                 alt="${item.name}" 
                                 onerror="this.src='${getDefaultImage(item.category)}'">
                        </div>
                        <div class="order-item-details">
                            <div class="order-item-name">${item.name || 'Product'}</div>
                            <div class="order-item-info">${item.category || 'General'}</div>
                            ${item.calculationData ? `
                                <div class="order-item-info">
                                    ${getCalculationInfo(item)}
                                </div>
                            ` : `
                                <div class="order-item-info">Quantity: ${item.quantity || 1} ${item.priceUnit || 'pieces'}</div>
                            `}
                            <div class="order-item-price">£${item.calculatedPrice ? parseFloat(item.calculatedPrice).toFixed(2) : ((item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                        </div>
                    </div>
                `).join('')}
                
                ${(order.items || []).length > 2 ? `
                    <div style="text-align: center; padding: 10px; color: var(--text-light); font-size: 13px;">
                        + ${(order.items || []).length - 2} more items
                    </div>
                ` : ''}
            </div>
            
            <!-- Payment Information (Checkout se same) -->
            ${order.paymentMethod === 'bank' && order.paymentStatus === 'pending_bank_transfer' ? `
                <div class="payment-info">
                    <h5><i class="fas fa-university"></i> Bank Transfer Details</h5>
                    <div class="payment-details">
                        <p><strong>Account Name:</strong> ${order.bankTransferDetails?.accountName || 'IRYA STONE LTD'}</p>
                        <p><strong>Account Number:</strong> ${order.bankTransferDetails?.accountNumber || '12345678'}</p>
                        <p><strong>Sort Code:</strong> ${order.bankTransferDetails?.sortCode || '04-00-04'}</p>
                        <p><strong>Reference:</strong> ${order.bankTransferDetails?.reference || order.orderNumber}</p>
                        <p><strong>Amount:</strong> £${order.amountToPay?.toFixed(2) || order.advancePayment?.toFixed(2) || '0.00'}</p>
                        ${order.paymentType === 'advance' ? `
                            <p><strong>Payment Type:</strong> 30% Advance Payment</p>
                            <p><strong>Remaining Payment:</strong> £${order.remainingPayment?.toFixed(2) || '0.00'} (70% after shipping)</p>
                        ` : `
                            <p><strong>Payment Type:</strong> Full Payment (5% discount applied)</p>
                        `}
                    </div>
                </div>
            ` : ''}
            
            <div class="order-summary">
                <div class="summary-item">
                    <div class="summary-label">Subtotal</div>
                    <div class="summary-value">£${order.subtotal?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Shipping</div>
                    <div class="summary-value">${order.shipping === 0 ? 'FREE' : `£${order.shipping?.toFixed(2) || '0.00'}`}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Tax</div>
                    <div class="summary-value">£${order.tax?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">£${order.total?.toFixed(2) || '0.00'}</div>
                </div>
            </div>
            
            ${order.tracking || order.shippingAddress ? `
                <div class="tracking-timeline">
                    <div class="timeline-header">
                        <h4><i class="fas fa-shipping-fast"></i> Shipping Information</h4>
                        ${order.tracking?.id ? `<div class="tracking-id">Tracking ID: ${order.tracking.id}</div>` : ''}
                    </div>
                    ${getTrackingTimeline(order)}
                </div>
            ` : ''}
            
            <div class="order-actions">
                <button class="order-action-btn primary" onclick="viewOrderDetails('${order.id}')">
                    <i class="fas fa-eye"></i>
                    View Details
                </button>
                ${order.tracking?.url ? `
                    <button class="order-action-btn" onclick="trackOrder('${order.id}')">
                        <i class="fas fa-map-marker-alt"></i>
                        Track Order
                    </button>
                ` : ''}
                ${order.status === 'delivered' || order.status === 'shipped' ? `
                    <button class="order-action-btn" onclick="downloadInvoice('${order.id}')">
                        <i class="fas fa-file-invoice"></i>
                        Download Invoice
                    </button>
                ` : ''}
                ${order.status === 'pending' || order.status === 'pending_bank_transfer' ? `
                    <button class="order-action-btn" onclick="cancelOrder('${order.id}')" style="color: #ff4757; border-color: #ff4757;">
                        <i class="fas fa-times"></i>
                        Cancel Order
                    </button>
                ` : ''}
                ${order.paymentMethod === 'bank' && order.paymentStatus === 'pending_bank_transfer' ? `
                    <button class="order-action-btn primary" onclick="markPaymentComplete('${order.id}')">
                        <i class="fas fa-check-circle"></i>
                        Mark Payment Sent
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
    
    ordersList.innerHTML = ordersHTML;
}

function getCalculationInfo(item) {
    if (!item.calculationData) return `Quantity: ${item.quantity || 1} pieces`;
    
    const unit = item.calculationData.unit || 'piece';
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1}kg`;
    } else {
        return `Quantity: ${item.quantity || 1} pieces`;
    }
}

function getTrackingTimeline(order) {
    const statuses = [
        { id: 'pending', label: 'Order Placed', icon: 'fa-shopping-cart', date: order.createdAt },
        { id: 'processing', label: 'Processing', icon: 'fa-cogs', date: order.processingAt || order.confirmedAt },
        { id: 'shipped', label: 'Shipped', icon: 'fa-shipping-fast', date: order.shippedAt },
        { id: 'delivered', label: 'Delivered', icon: 'fa-home', date: order.deliveredAt }
    ];
    
    // For bank transfer orders
    if (order.paymentStatus === 'pending_bank_transfer') {
        statuses.unshift({ 
            id: 'pending_bank_transfer', 
            label: 'Awaiting Payment', 
            icon: 'fa-clock', 
            date: order.createdAt 
        });
    }
    
    // Get current status index
    const currentStatus = order.paymentStatus === 'pending_bank_transfer' ? 'pending_bank_transfer' : order.status;
    const statusIndex = statuses.findIndex(s => s.id === currentStatus);
    
    return `
        <div class="timeline-steps">
            ${statuses.map((status, index) => {
                const isCompleted = index <= statusIndex;
                const isActive = index === statusIndex;
                
                return `
                    <div class="timeline-step">
                        <div class="step-icon ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
                            <i class="fas ${status.icon}"></i>
                        </div>
                        <div class="step-label">${status.label}</div>
                        ${status.date ? `<div class="step-date">${formatDate(status.date)}</div>` : ''}
                    </div>
                `;
            }).join('')}
        </div>
        
        ${order.shippingAddress ? `
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <div style="font-size: 13px; color: var(--text-light); margin-bottom: 5px;">Shipping to:</div>
                <div style="font-size: 14px; color: var(--text-dark);">
                    ${order.shippingAddress.fullName}<br>
                    ${order.shippingAddress.address1}<br>
                    ${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.postalCode}<br>
                    ${order.shippingAddress.country}
                </div>
            </div>
        ` : ''}
    `;
}

// ============================================
// ORDER ACTIONS (Checkout se compatible)
// ============================================

function filterOrders(status) {
    currentFilter = status;
    
    // Update active tab
    document.querySelectorAll('.order-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Display filtered orders
    displayOrders();
}

function viewOrderDetails(orderId) {
    window.location.href = `order-details.html?id=${orderId}`;
}

function trackOrder(orderId) {
    const order = userOrders.find(o => o.id === orderId);
    if (order && order.tracking && order.tracking.url) {
        window.open(order.tracking.url, '_blank');
    } else if (order && order.tracking && order.tracking.id) {
        alert(`Tracking ID: ${order.tracking.id}\nCarrier: ${order.tracking.carrier || 'Not specified'}`);
    } else {
        alert('Tracking information will be available once the order is shipped.');
    }
}

async function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) return;
    
    try {
        showLoading(true);
        
        // Update order status in Firebase
        await firebaseDB.collection('orders').doc(orderId).update({
            status: 'cancelled',
            paymentStatus: 'cancelled',
            cancelledAt: new Date().toISOString()
        });
        
        // Also update in user's orders collection if exists
        try {
            const userId = authSystem.getUserId();
            await firebaseDB.collection('userOrders').doc(userId)
                .collection('orders').doc(orderId).update({
                    status: 'cancelled',
                    paymentStatus: 'cancelled',
                    cancelledAt: new Date().toISOString()
                });
        } catch (error) {
            console.log("User collection update skipped:", error.message);
        }
        
        // Update local data
        const orderIndex = userOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            userOrders[orderIndex].status = 'cancelled';
            userOrders[orderIndex].paymentStatus = 'cancelled';
            userOrders[orderIndex].cancelledAt = new Date().toISOString();
        }
        
        // Refresh display
        displayOrders();
        
        showNotification('Order cancelled successfully');
        
    } catch (error) {
        console.error('Error cancelling order:', error);
        showError('Failed to cancel order');
    } finally {
        showLoading(false);
    }
}

async function markPaymentComplete(orderId) {
    if (!confirm('Have you successfully transferred the payment? This will notify the admin to process your order.')) return;
    
    try {
        showLoading(true);
        
        const order = userOrders.find(o => o.id === orderId);
        if (!order) {
            showError('Order not found');
            return;
        }
        
        // Update order status
        await firebaseDB.collection('orders').doc(orderId).update({
            paymentStatus: 'payment_received',
            updatedAt: new Date().toISOString()
        });
        
        // Update local data
        const orderIndex = userOrders.findIndex(o => o.id === orderId);
        if (orderIndex !== -1) {
            userOrders[orderIndex].paymentStatus = 'payment_received';
            userOrders[orderIndex].updatedAt = new Date().toISOString();
        }
        
        // Refresh display
        displayOrders();
        
        showNotification('Payment status updated. Admin will now process your order.');
        
    } catch (error) {
        console.error('Error updating payment status:', error);
        showError('Failed to update payment status');
    } finally {
        showLoading(false);
    }
}

function downloadInvoice(orderId) {
    const order = userOrders.find(o => o.id === orderId);
    if (!order) {
        showError('Order not found');
        return;
    }
    
    // Create invoice content
    const invoiceContent = `
        IRYA STONE - INVOICE
        =====================
        
        Invoice Number: ${order.orderNumber || order.id}
        Date: ${formatDate(order.createdAt)}
        Order ID: ${order.id}
        
        BILL TO:
        ${order.shippingAddress?.fullName || 'Customer'}
        ${order.shippingAddress?.address1 || ''}
        ${order.shippingAddress?.address2 || ''}
        ${order.shippingAddress?.city || ''}, ${order.shippingAddress?.state || ''} ${order.shippingAddress?.postalCode || ''}
        ${order.shippingAddress?.country || ''}
        Phone: ${order.shippingAddress?.phone || ''}
        Email: ${order.userEmail || ''}
        
        ORDER DETAILS:
        ${(order.items || []).map(item => `
        • ${item.name || 'Product'}
          ${getCalculationInfo(item)}
          Price: £${item.calculatedPrice ? parseFloat(item.calculatedPrice).toFixed(2) : ((item.price || 0) * (item.quantity || 1)).toFixed(2)}
        `).join('')}
        
        ${order.customRequirements ? `
        CUSTOM REQUIREMENTS:
        ${order.customRequirements}
        ` : ''}
        
        SUMMARY:
        Subtotal: £${order.subtotal?.toFixed(2) || '0.00'}
        Shipping: ${order.shipping === 0 ? 'FREE' : `£${order.shipping?.toFixed(2) || '0.00'}`}
        Tax: £${order.tax?.toFixed(2) || '0.00'}
        Total: £${order.total?.toFixed(2) || '0.00'}
        
        PAYMENT DETAILS:
        Payment Method: ${order.paymentMethod || 'Bank Transfer'}
        Payment Type: ${order.paymentType === 'advance' ? '30% Advance Payment' : 'Full Payment'}
        ${order.paymentType === 'advance' ? `
        Advance Paid: £${order.advancePayment?.toFixed(2) || '0.00'}
        Remaining: £${order.remainingPayment?.toFixed(2) || '0.00'}
        ` : ''}
        Payment Status: ${getStatusText(order.paymentStatus || order.status)}
        
        ORDER STATUS: ${getStatusText(order.status)}
        
        Thank you for your business!
        IRYA STONE - Premium Natural Stone Products
        www.iryastone.com
    `;
    
    // Create download link
    const blob = new Blob([invoiceContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `IRYA-INVOICE-${order.orderNumber || order.id}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============================================
// UTILITY FUNCTIONS (Checkout se same)
// ============================================

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_received': 'Payment Received',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
    }) + ' ' + date.toLocaleTimeString('en-GB', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getDefaultImage(category) {
    const categoryLower = (category || '').toLowerCase();
    
    if (categoryLower.includes('sand')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('kota')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('granite')) {
        return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800';
    }
    
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
}

function showNoOrders() {
    const ordersList = document.getElementById('ordersList');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    
    ordersList.innerHTML = '';
    noOrdersMessage.style.display = 'block';
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-gold);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        </style>
        <div>${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

function showError(message) {
    alert(message);
}

function updateCartBadge() {
    const userId = authSystem.getUserId();
    
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

// Make functions available globally
window.filterOrders = filterOrders;
window.viewOrderDetails = viewOrderDetails;
window.trackOrder = trackOrder;
window.cancelOrder = cancelOrder;
window.markPaymentComplete = markPaymentComplete;
window.downloadInvoice = downloadInvoice;
</script>
</body>
</html>
