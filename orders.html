<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Orders Container */
.orders-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

/* Orders Tabs */
.orders-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.order-tab {
    padding: 12px 24px;
    border-radius: 25px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
}

.order-tab:hover {
    border-color: var(--primary-gold);
}

.order-tab.active {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

/* Orders List */
.orders-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.order-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    border: 1px solid #f0f0f0;
}

.order-card:hover {
    border-color: var(--primary-gold);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
}

.order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.order-info h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.order-number {
    font-size: 14px;
    color: var(--text-light);
    font-weight: 500;
}

.order-date {
    font-size: 13px;
    color: var(--text-light);
}

.order-status {
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-processing {
    background: #cce5ff;
    color: #004085;
}

.status-shipped {
    background: #d4edda;
    color: #155724;
}

.status-delivered {
    background: #d1ecf1;
    color: #0c5460;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.status-pending_bank_transfer {
    background: #ffeaa7;
    color: #856404;
}

/* Order Items */
.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
}

.order-item-name {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 15px;
}

.order-item-info {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
}

.order-item-quantity {
    font-size: 13px;
    color: var(--text-light);
}

/* Order Summary */
.order-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 10px;
}

.summary-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.summary-label {
    font-size: 12px;
    color: var(--text-light);
}

.summary-value {
    font-weight: 600;
    color: var(--stone-dark);
}

/* Payment Info */
.payment-info {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-gold);
}

.payment-info h5 {
    font-size: 14px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.payment-info h5 i {
    color: var(--primary-gold);
}

.payment-details {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.5;
    background: var(--white);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

.payment-details p {
    margin: 5px 0;
}

.payment-details strong {
    color: var(--stone-dark);
}

/* Tracking Timeline */
.tracking-timeline {
    margin: 25px 0;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 10px;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.timeline-header h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.timeline-header h4 i {
    color: var(--primary-gold);
}

.tracking-id {
    font-size: 13px;
    color: var(--text-light);
}

.timeline-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    padding: 20px 0;
}

.timeline-steps::before {
    content: '';
    position: absolute;
    top: 30px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e0e0e0;
    z-index: 1;
}

.timeline-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--white);
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    font-size: 16px;
    transition: var(--transition);
}

.step-icon.completed {
    background: var(--primary-gold);
    border-color: var(--primary-gold);
    color: white;
}

.step-icon.active {
    background: var(--white);
    border-color: var(--primary-gold);
    color: var(--primary-gold);
    box-shadow: 0 0 0 5px rgba(201, 162, 39, 0.1);
}

.step-label {
    font-size: 12px;
    font-weight: 500;
    color: var(--text-dark);
    text-align: center;
}

.step-date {
    font-size: 11px;
    color: var(--text-light);
    text-align: center;
}

/* Order Actions */
.order-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.order-action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.order-action-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.order-action-btn.primary {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.order-action-btn.primary:hover {
    background: var(--gold-dark);
}

/* No Orders Message */
.no-orders {
    text-align: center;
    padding: 60px 20px;
}

.no-orders i {
    font-size: 48px;
    color: var(--text-light);
    opacity: 0.5;
    margin-bottom: 20px;
}

.no-orders h3 {
    font-size: 20px;
    color: var(--stone-dark);
    margin-bottom: 10px;
}

.no-orders p {
    color: var(--text-light);
    max-width: 400px;
    margin: 0 auto 20px;
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Real-time Indicator */
.realtime-indicator {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 998;
    box-shadow: var(--shadow-sm);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .order-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .timeline-steps {
        flex-direction: column;
        gap: 30px;
    }
    
    .timeline-steps::before {
        display: none;
    }
    
    .timeline-step {
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: 15px;
    }
    
    .step-label, .step-date {
        text-align: left;
    }
    
    .realtime-indicator {
        top: 60px;
        right: 10px;
        padding: 6px 12px;
        font-size: 11px;
    }
}

@media (max-width: 480px) {
    .orders-container {
        padding: 20px 12px;
    }
    
    .order-tab {
        padding: 10px 15px;
        font-size: 13px;
    }
    
    .order-summary {
        grid-template-columns: 1fr;
    }

/* Admin Verification Modal */
.admin-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.admin-modal {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
    font-size: 20px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-header h3 i {
    color: var(--primary-gold);
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-light);
    cursor: pointer;
    transition: var(--transition);
}

.close-modal:hover {
    color: var(--primary-gold);
}

/* Verification Form */
.verification-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* Payment Details Display */
.payment-details-display {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
}

.payment-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e0e0e0;
}

.payment-row:last-child {
    border-bottom: none;
}

.payment-label {
    font-weight: 500;
    color: var(--text-dark);
}

.payment-value {
    font-weight: 600;
    color: var(--primary-gold);
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-pending {
    background: #fff3cd;
    color: #856404;
}

.badge-verified {
    background: #d4edda;
    color: #155724;
}

.badge-rejected {
    background: #f8d7da;
    color: #721c24;
}

/* Admin Actions */
.admin-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

.admin-btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.admin-btn-primary {
    background: var(--primary-gold);
    color: white;
}

.admin-btn-primary:hover {
    background: var(--gold-dark);
}

.admin-btn-secondary {
    background: #6c757d;
    color: white;
}

.admin-btn-secondary:hover {
    background: #5a6268;
}

.admin-btn-danger {
    background: #dc3545;
    color: white;
}

.admin-btn-danger:hover {
    background: #c82333;
}

/* Search and Filter */
.search-filter {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 12px 15px 12px 40px;
    border-radius: 25px;
    border: 2px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
}

.search-box input:focus {
    outline: none;
    border-color: var(--primary-gold);
}

.search-box i {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
}

.filter-select {
    padding: 12px 20px;
    border-radius: 25px;
    border: 2px solid #e0e0e0;
    background: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    min-width: 150px;
}

/* Stats Cards */
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    border-left: 4px solid var(--primary-gold);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: var(--text-light);
}

/* Real-time Updates */
.realtime-updates {
    position: fixed;
    bottom: 80px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 10px 15px;
    border-radius: 10px;
    box-shadow: var(--shadow-md);
    z-index: 998;
    animation: slideIn 0.3s ease;
    max-width: 300px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .stats-cards {
        grid-template-columns: 1fr 1fr;
    }
    
    .search-filter {
        flex-direction: column;
    }
    
    .admin-actions {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .admin-modal {
        padding: 20px;
    }
    
    .stats-cards {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Admin Verification Modal -->
<div class="admin-modal-overlay" id="adminModal">
    <div class="admin-modal">
        <div class="modal-header">
            <h3><i class="fas fa-user-shield"></i> Payment Verification</h3>
            <button class="close-modal" onclick="closeAdminModal()">&times;</button>
        </div>
        
        <div id="verificationContent">
            <!-- Content will be loaded dynamically -->
        </div>
        
        <div class="admin-actions" id="adminActions">
            <!-- Actions will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Real-time Updates -->
<div class="realtime-updates" id="realtimeUpdates" style="display: none;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-sync fa-spin"></i>
        <span id="updateMessage">New order received</span>
    </div>
</div>

<!-- Header (same as before) -->
<header>
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="products.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb (same as before) -->
<section class="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active">
            My Orders
        </div>
    </div>
</section>

<!-- Admin Controls (only visible to admin) -->
<div id="adminControls" style="display: none;">
    <div class="orders-container">
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingPayments">0</div>
                <div class="stat-label">Pending Payments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingVerification">0</div>
                <div class="stat-label">Pending Verification</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todaysOrders">0</div>
                <div class="stat-label">Today's Orders</div>
            </div>
        </div>
        
        <div class="search-filter">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchOrders" placeholder="Search orders by ID, name, email..." onkeyup="searchOrders()">
            </div>
            <select class="filter-select" id="adminFilter" onchange="filterAdminOrders()">
                <option value="all">All Orders</option>
                <option value="pending_verification">Pending Verification</option>
                <option value="pending_bank_transfer">Awaiting Bank Transfer</option>
                <option value="payment_submitted">Payment Submitted</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
    </div>
</div>

<!-- Orders Container -->
<section class="orders-container">
    <div class="orders-tabs">
        <button class="order-tab active" onclick="filterOrders('all')">All Orders</button>
        <button class="order-tab" onclick="filterOrders('pending')">Pending</button>
        <button class="order-tab" onclick="filterOrders('processing')">Processing</button>
        <button class="order-tab" onclick="filterOrders('shipped')">Shipped</button>
        <button class="order-tab" onclick="filterOrders('delivered')">Delivered</button>
    </div>
    
    <div class="orders-list" id="ordersList">
        <!-- Orders will be loaded here -->
    </div>
    
    <div class="no-orders" id="noOrdersMessage" style="display: none;">
        <i class="fas fa-box-open"></i>
        <h3>No Orders Found</h3>
        <p>You haven't placed any orders yet</p>
        <a href="products.html" class="order-action-btn primary">
            <i class="fas fa-shopping-bag"></i>
            Start Shopping
        </a>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn active">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// ENHANCED FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let userOrders = [];
let allOrders = []; // For admin view
let currentFilter = 'all';
let authSystem = null;
let realtimeUnsubscribe = null;
let isAdmin = false;
let adminId = null;

// ============================================
// ENHANCED AUTHENTICATION SYSTEM
// ============================================

class EnhancedAuthSystem {
    constructor() {
        this.currentUser = null;
        this.authKey = 'irya_stone_auth_user';
        this.guestIdKey = 'irya_guest_id';
        this.adminKey = 'irya_admin_user';
    }
    
    async init() {
        try {
            await this.initializeFirebase();
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL,
                            providerId: user.providerId,
                            isFirebaseUser: true
                        };
                        
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        
                        // Check if user is admin
                        await this.checkAdminStatus(user.uid);
                        
                    } else {
                        const storedUser = this.getUserFromStorage();
                        
                        if (storedUser && storedUser.isFirebaseUser) {
                            this.currentUser = storedUser;
                            await this.checkAdminStatus(storedUser.uid);
                        } else {
                            this.currentUser = this.createGuestUser();
                            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        }
                    }
                    
                    resolve(this.currentUser);
                });
            });
            
        } catch (error) {
            console.error('Auth init error:', error);
            this.currentUser = this.getUserFromStorage() || this.createGuestUser();
            return this.currentUser;
        }
    }
    
    async initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            throw error;
        }
    }
    
    async checkAdminStatus(userId) {
        try {
            if (!firebaseDB) return false;
            
            const adminDoc = await firebaseDB.collection('admins').doc(userId).get();
            if (adminDoc.exists) {
                isAdmin = true;
                adminId = userId;
                localStorage.setItem(this.adminKey, 'true');
                return true;
            }
        } catch (error) {
            console.error('Error checking admin status:', error);
        }
        
        isAdmin = false;
        localStorage.removeItem(this.adminKey);
        return false;
    }
    
    getUserFromStorage() {
        const userData = localStorage.getItem(this.authKey);
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error parsing user data:', e);
                return null;
            }
        }
        return null;
    }
    
    createGuestUser() {
        let guestId = localStorage.getItem(this.guestIdKey);
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(this.guestIdKey, guestId);
        }
        
        return {
            uid: guestId,
            displayName: 'Guest',
            email: '',
            photoURL: '',
            providerId: 'guest',
            isFirebaseUser: false,
            isGuest: true
        };
    }
    
    isLoggedIn() {
        return this.currentUser && this.currentUser.isFirebaseUser === true;
    }
    
    getUserId() {
        if (!this.currentUser) {
            return this.createGuestUser().uid;
        }
        return this.currentUser.uid;
    }
    
    getUserEmail() {
        return this.currentUser ? this.currentUser.email : '';
    }
    
    getUserName() {
        return this.currentUser ? this.currentUser.displayName : 'Guest';
    }
}

// ============================================
// ENHANCED INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("ðŸ“± Orders page loaded");
    
    // Initialize Auth System
    authSystem = new EnhancedAuthSystem();
    await authSystem.init();
    
    const userId = authSystem.getUserId();
    console.log("âœ… Auth initialized. User ID:", userId, "Logged in:", authSystem.isLoggedIn(), "Is Admin:", isAdmin);
    
    // Show admin controls if admin
    if (isAdmin) {
        document.getElementById('adminControls').style.display = 'block';
        await loadAllOrders(); // Load all orders for admin
        setupAdminRealtimeUpdates();
    } else {
        await loadUserOrders();
    }
    
    // Setup real-time updates
    setupRealtimeUpdates();
    
    // Update cart badge
    updateCartBadge();
    
    // Setup search functionality
    setupSearch();
});

// ============================================
// ADMIN FUNCTIONS
// ============================================

async function loadAllOrders() {
    try {
        showLoading(true);
        
        if (!firebaseDB) {
            await authSystem.initializeFirebase();
        }
        
        // Load from main orders collection
        const ordersSnapshot = await firebaseDB.collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(100)
            .get();
        
        allOrders = [];
        ordersSnapshot.forEach(doc => {
            allOrders.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        console.log(`âœ… Admin: Loaded ${allOrders.length} orders`);
        displayOrders();
        updateStats();
        
    } catch (error) {
        console.error('âŒ Error loading all orders:', error);
    } finally {
        showLoading(false);
    }
}

function setupAdminRealtimeUpdates() {
    if (!firebaseDB) return;
    
    realtimeUnsubscribe = firebaseDB.collection('orders')
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
            allOrders = [];
            snapshot.forEach(doc => {
                allOrders.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            displayOrders();
            updateStats();
            
            // Show notification for new orders
            const changes = snapshot.docChanges();
            changes.forEach(change => {
                if (change.type === 'added') {
                    const order = change.doc.data();
                    showRealtimeUpdate(`New order #${order.orderNumber} received`);
                }
            });
        });
}

function updateStats() {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    const totalOrders = allOrders.length;
    const pendingPayments = allOrders.filter(o => 
        o.paymentStatus === 'pending_bank_transfer' || 
        o.paymentStatus === 'payment_submitted'
    ).length;
    const pendingVerification = allOrders.filter(o => 
        o.paymentStatus === 'payment_submitted'
    ).length;
    const todaysOrders = allOrders.filter(o => 
        new Date(o.createdAt) >= today
    ).length;
    
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('pendingPayments').textContent = pendingPayments;
    document.getElementById('pendingVerification').textContent = pendingVerification;
    document.getElementById('todaysOrders').textContent = todaysOrders;
}

function searchOrders() {
    const searchTerm = document.getElementById('searchOrders').value.toLowerCase();
    
    if (searchTerm === '') {
        displayOrders();
        return;
    }
    
    let filteredOrders = isAdmin ? allOrders : userOrders;
    
    filteredOrders = filteredOrders.filter(order => 
        order.orderNumber?.toLowerCase().includes(searchTerm) ||
        order.userName?.toLowerCase().includes(searchTerm) ||
        order.userEmail?.toLowerCase().includes(searchTerm) ||
        order.id?.toLowerCase().includes(searchTerm) ||
        order.shippingAddress?.fullName?.toLowerCase().includes(searchTerm)
    );
    
    displayFilteredOrders(filteredOrders);
}

function filterAdminOrders() {
    const filter = document.getElementById('adminFilter').value;
    currentFilter = filter;
    displayOrders();
}

// ============================================
// PAYMENT VERIFICATION FUNCTIONS
// ============================================

function openVerificationModal(orderId) {
    const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
    if (!order) return;
    
    const modal = document.getElementById('adminModal');
    const content = document.getElementById('verificationContent');
    const actions = document.getElementById('adminActions');
    
    // Content HTML
    content.innerHTML = `
        <div class="payment-details-display">
            <h4 style="margin-bottom: 15px; color: var(--stone-dark);">
                <i class="fas fa-file-invoice-dollar"></i> Order Details
            </h4>
            <div class="payment-row">
                <span class="payment-label">Order Number:</span>
                <span class="payment-value">${order.orderNumber}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Customer:</span>
                <span class="payment-value">${order.userName}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Email:</span>
                <span class="payment-value">${order.userEmail}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Total Amount:</span>
                <span class="payment-value">Â£${order.total?.toFixed(2)}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Payment Type:</span>
                <span class="payment-value">${order.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Amount to Verify:</span>
                <span class="payment-value">Â£${order.amountToPay?.toFixed(2)}</span>
            </div>
            <div class="payment-row">
                <span class="payment-label">Current Status:</span>
                <span class="payment-value">
                    <span class="status-badge ${getStatusClass(order.paymentStatus)}">
                        ${getStatusText(order.paymentStatus)}
                    </span>
                </span>
            </div>
        </div>
        
        <div class="verification-form">
            <div class="form-group">
                <label>Verification Notes</label>
                <textarea id="verificationNotes" placeholder="Enter verification details..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Transaction Reference</label>
                <input type="text" id="transactionRef" placeholder="Bank transaction reference">
            </div>
            
            <div class="form-group">
                <label>Verified Amount (GBP)</label>
                <input type="number" id="verifiedAmount" value="${order.amountToPay}" step="0.01">
            </div>
        </div>
    `;
    
    // Actions HTML based on current status
    if (order.paymentStatus === 'payment_submitted') {
        actions.innerHTML = `
            <button class="admin-btn admin-btn-primary" onclick="verifyPayment('${orderId}', 'verified')">
                <i class="fas fa-check-circle"></i> Verify Payment
            </button>
            <button class="admin-btn admin-btn-danger" onclick="verifyPayment('${orderId}', 'rejected')">
                <i class="fas fa-times-circle"></i> Reject Payment
            </button>
        `;
    } else if (order.paymentStatus === 'pending_bank_transfer') {
        actions.innerHTML = `
            <button class="admin-btn admin-btn-primary" onclick="updatePaymentStatus('${orderId}', 'payment_submitted')">
                <i class="fas fa-clock"></i> Mark as Submitted
            </button>
            <button class="admin-btn admin-btn-secondary" onclick="sendReminder('${orderId}')">
                <i class="fas fa-bell"></i> Send Reminder
            </button>
        `;
    } else {
        actions.innerHTML = `
            <button class="admin-btn admin-btn-secondary" onclick="updateOrderStatus('${orderId}')">
                <i class="fas fa-edit"></i> Update Status
            </button>
        `;
    }
    
    modal.style.display = 'flex';
}

function closeAdminModal() {
    document.getElementById('adminModal').style.display = 'none';
}

async function verifyPayment(orderId, status) {
    try {
        const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
        if (!order) return;
        
        const verificationNotes = document.getElementById('verificationNotes').value;
        const transactionRef = document.getElementById('transactionRef').value;
        const verifiedAmount = parseFloat(document.getElementById('verifiedAmount').value) || order.amountToPay;
        
        const updateData = {
            paymentStatus: status === 'verified' ? 'payment_verified' : 'cancelled',
            paymentVerifiedAt: new Date().toISOString(),
            paymentVerifiedBy: authSystem.getUserName(),
            verificationNotes: verificationNotes,
            transactionReference: transactionRef,
            verifiedAmount: verifiedAmount,
            updatedAt: new Date().toISOString(),
            adminNotes: verificationNotes
        };
        
        // Update in Firebase
        await firebaseDB.collection('orders').doc(orderId).update(updateData);
        
        // Also update in user's orders collection
        try {
            await firebaseDB.collection('users').doc(order.userId)
                .collection('orders').doc(orderId).update(updateData);
        } catch (error) {
            console.log("Note: Could not update user's order");
        }
        
        // Send notification to user
        await sendNotificationToUser(order.userId, {
            type: 'payment_verification',
            title: status === 'verified' ? 'Payment Verified!' : 'Payment Rejected',
            message: status === 'verified' 
                ? `Your payment for order #${order.orderNumber} has been verified. Your order is now being processed.`
                : `Your payment for order #${order.orderNumber} was rejected. Please contact support.`,
            orderId: orderId
        });
        
        closeAdminModal();
        showNotification(`Payment ${status === 'verified' ? 'verified' : 'rejected'} successfully`);
        
    } catch (error) {
        console.error('Error verifying payment:', error);
        showError('Failed to verify payment: ' + error.message);
    }
}

async function updatePaymentStatus(orderId, status) {
    try {
        const updateData = {
            paymentStatus: status,
            updatedAt: new Date().toISOString(),
            updatedByAdmin: authSystem.getUserName()
        };
        
        const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
        
        await firebaseDB.collection('orders').doc(orderId).update(updateData);
        
        // Update in user's orders collection
        try {
            await firebaseDB.collection('users').doc(order.userId)
                .collection('orders').doc(orderId).update(updateData);
        } catch (error) {
            console.log("Note: Could not update user's order");
        }
        
        closeAdminModal();
        showNotification(`Payment status updated to ${getStatusText(status)}`);
        
    } catch (error) {
        console.error('Error updating payment status:', error);
        showError('Failed to update status: ' + error.message);
    }
}

async function updateOrderStatus(orderId) {
    try {
        const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
        const newStatus = prompt('Enter new status (processing, shipped, delivered, cancelled):', order.status);
        
        if (!newStatus || !['processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus)) {
            return;
        }
        
        const updateData = {
            status: newStatus,
            updatedAt: new Date().toISOString(),
            updatedByAdmin: authSystem.getUserName()
        };
        
        // Add timestamps for specific statuses
        if (newStatus === 'shipped') {
            updateData.shippedAt = new Date().toISOString();
        } else if (newStatus === 'delivered') {
            updateData.deliveredAt = new Date().toISOString();
        } else if (newStatus === 'cancelled') {
            updateData.cancelledAt = new Date().toISOString();
        }
        
        await firebaseDB.collection('orders').doc(orderId).update(updateData);
        
        // Update in user's orders collection
        try {
            await firebaseDB.collection('users').doc(order.userId)
                .collection('orders').doc(orderId).update(updateData);
        } catch (error) {
            console.log("Note: Could not update user's order");
        }
        
        // Send notification to user
        await sendNotificationToUser(order.userId, {
            type: 'order_status_update',
            title: 'Order Status Updated',
            message: `Your order #${order.orderNumber} status has been updated to ${getStatusText(newStatus)}`,
            orderId: orderId
        });
        
        closeAdminModal();
        showNotification(`Order status updated to ${getStatusText(newStatus)}`);
        
    } catch (error) {
        console.error('Error updating order status:', error);
        showError('Failed to update order status: ' + error.message);
    }
}

async function sendReminder(orderId) {
    try {
        const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
        
        // Send email reminder (you would implement this with your email service)
        // For now, we'll just update the order with a reminder sent timestamp
        
        const updateData = {
            reminderSentAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            updatedByAdmin: authSystem.getUserName()
        };
        
        await firebaseDB.collection('orders').doc(orderId).update(updateData);
        
        // Send notification to user
        await sendNotificationToUser(order.userId, {
            type: 'payment_reminder',
            title: 'Payment Reminder',
            message: `Please complete payment for order #${order.orderNumber} to confirm your order.`,
            orderId: orderId
        });
        
        closeAdminModal();
        showNotification('Reminder sent to customer');
        
    } catch (error) {
        console.error('Error sending reminder:', error);
        showError('Failed to send reminder: ' + error.message);
    }
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

async function sendNotificationToUser(userId, notification) {
    try {
        if (!firebaseDB) return;
        
        const notificationRef = firebaseDB.collection('users').doc(userId)
            .collection('notifications').doc();
        
        const fullNotification = {
            ...notification,
            id: notificationRef.id,
            createdAt: new Date().toISOString(),
            isRead: false
        };
        
        await notificationRef.set(fullNotification);
        
        console.log(`âœ… Notification sent to user ${userId}`);
        
    } catch (error) {
        console.error('âŒ Error sending notification:', error);
    }
}

// ============================================
// ENHANCED DISPLAY FUNCTIONS
// ============================================

function displayOrders() {
    const ordersToDisplay = isAdmin ? allOrders : userOrders;
    const filteredOrders = filterOrdersByStatus(ordersToDisplay, currentFilter);
    
    if (filteredOrders.length === 0) {
        showNoOrders();
        return;
    }
    
    displayFilteredOrders(filteredOrders);
}

function displayFilteredOrders(orders) {
    const ordersList = document.getElementById('ordersList');
    const noOrdersMessage = document.getElementById('noOrdersMessage');
    
    noOrdersMessage.style.display = 'none';
    
    const ordersHTML = orders.map(order => {
        const isEditable = isAdmin || 
            (order.status === 'pending' || 
             order.paymentStatus === 'pending_bank_transfer' ||
             order.paymentStatus === 'payment_submitted');
        
        const adminButtons = isAdmin ? `
            <button class="order-action-btn" onclick="openVerificationModal('${order.id}')" style="background: #17a2b8; color: white; border-color: #17a2b8;">
                <i class="fas fa-user-shield"></i>
                Verify Payment
            </button>
            <button class="order-action-btn" onclick="editOrder('${order.id}')">
                <i class="fas fa-edit"></i>
                Edit Order
            </button>
            <button class="order-action-btn" onclick="deleteOrder('${order.id}')" style="color: #ff4757; border-color: #ff4757;">
                <i class="fas fa-trash"></i>
                Delete
            </button>
        ` : '';
        
        return `
        <div class="order-card">
            ${isAdmin ? `
                <div style="background: var(--primary-gold); color: white; padding: 10px 15px; border-radius: 8px 8px 0 0; margin: -25px -25px 15px -25px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>Customer:</strong> ${order.userName}
                            <span style="margin-left: 15px;">
                                <strong>Email:</strong> ${order.userEmail}
                            </span>
                        </div>
                        <button class="action-btn" style="width: 30px; height: 30px; background: rgba(255,255,255,0.2);" 
                                onclick="openCustomerDetails('${order.userId}')">
                            <i class="fas fa-user"></i>
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <div class="order-header">
                <div class="order-info">
                    <h3>Order #${order.orderNumber || order.id.substring(0, 8)}</h3>
                    <div class="order-date">Placed on ${formatDate(order.createdAt)}</div>
                    <div class="order-number">Order ID: ${order.id}</div>
                    ${isAdmin ? `<div style="font-size: 12px; color: var(--text-light);">User ID: ${order.userId}</div>` : ''}
                </div>
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div class="order-status status-${order.status || 'pending'}">
                        ${getStatusText(order.status || 'pending')}
                    </div>
                    <div class="order-status ${getPaymentStatusClass(order.paymentStatus)}">
                        ${getStatusText(order.paymentStatus || 'pending')}
                    </div>
                </div>
            </div>
            
            <!-- Order Items -->
            <div class="order-items">
                ${(order.items || []).slice(0, 3).map(item => `
                    <div class="order-item">
                        <div class="order-item-image">
                            <img src="${item.image || getDefaultImage(item.category)}" 
                                 alt="${item.name}" 
                                 onerror="this.src='${getDefaultImage(item.category)}'">
                        </div>
                        <div class="order-item-details">
                            <div class="order-item-name">${item.name || 'Product'}</div>
                            <div class="order-item-info">${item.category || 'General'}</div>
                            ${item.calculationData ? `
                                <div class="order-item-info">
                                    ${getCalculationInfo(item)}
                                </div>
                            ` : `
                                <div class="order-item-info">Quantity: ${item.quantity || 1} ${item.priceUnit || 'pieces'}</div>
                            `}
                            <div class="order-item-price">Â£${item.calculatedPrice?.toFixed(2) || '0.00'}</div>
                        </div>
                    </div>
                `).join('')}
                
                ${(order.items || []).length > 3 ? `
                    <div style="text-align: center; padding: 10px; color: var(--text-light); font-size: 13px;">
                        + ${(order.items || []).length - 3} more items
                    </div>
                ` : ''}
            </div>
            
            <!-- Payment and Tracking Information -->
            ${getPaymentInfoHTML(order)}
            ${getTrackingHTML(order)}
            
            <!-- Order Summary -->
            <div class="order-summary">
                <div class="summary-item">
                    <div class="summary-label">Subtotal</div>
                    <div class="summary-value">Â£${order.subtotal?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Shipping</div>
                    <div class="summary-value">${order.shipping === 0 ? 'FREE' : `Â£${order.shipping?.toFixed(2) || '0.00'}`}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Tax</div>
                    <div class="summary-value">Â£${order.tax?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total</div>
                    <div class="summary-value">Â£${order.total?.toFixed(2) || '0.00'}</div>
                </div>
            </div>
            
            <!-- Order Actions -->
            <div class="order-actions">
                <button class="order-action-btn primary" onclick="viewOrderDetails('${order.id}')">
                    <i class="fas fa-eye"></i>
                    View Details
                </button>
                
                ${isEditable ? `
                    <button class="order-action-btn" onclick="editOrder('${order.id}')">
                        <i class="fas fa-edit"></i>
                        Edit Order
                    </button>
                ` : ''}
                
                ${order.tracking?.url ? `
                    <button class="order-action-btn" onclick="trackOrder('${order.id}')">
                        <i class="fas fa-map-marker-alt"></i>
                        Track Order
                    </button>
                ` : ''}
                
                ${order.status === 'delivered' || order.status === 'shipped' ? `
                    <button class="order-action-btn" onclick="downloadInvoice('${order.id}')">
                        <i class="fas fa-file-invoice"></i>
                        Download Invoice
                    </button>
                ` : ''}
                
                ${isEditable ? `
                    <button class="order-action-btn" onclick="cancelOrder('${order.id}')" style="color: #ff4757; border-color: #ff4757;">
                        <i class="fas fa-times"></i>
                        Cancel Order
                    </button>
                ` : ''}
                
                ${order.paymentMethod === 'bank' && order.paymentStatus === 'pending_bank_transfer' && !isAdmin ? `
                    <button class="order-action-btn primary" onclick="markPaymentComplete('${order.id}')">
                        <i class="fas fa-check-circle"></i>
                        Mark Payment Sent
                    </button>
                ` : ''}
                
                ${adminButtons}
            </div>
        </div>
        `;
    }).join('');
    
    ordersList.innerHTML = ordersHTML;
}

function filterOrdersByStatus(orders, filter) {
    if (filter === 'all') return orders;
    
    return orders.filter(order => {
        if (filter === 'pending') {
            return order.status === 'pending' || 
                   order.paymentStatus === 'pending_bank_transfer' ||
                   order.paymentStatus === 'payment_submitted';
        }
        return order.status === filter || order.paymentStatus === filter;
    });
}

function getPaymentStatusClass(status) {
    const classMap = {
        'pending_bank_transfer': 'status-pending_bank_transfer',
        'payment_submitted': 'status-processing',
        'payment_verified': 'status-shipped',
        'paid': 'status-delivered',
        'cancelled': 'status-cancelled'
    };
    return classMap[status] || 'status-pending';
}

// ============================================
// ORDER MANAGEMENT FUNCTIONS
// ============================================

async function editOrder(orderId) {
    const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
    if (!order) return;
    
    // For admin, show advanced edit modal
    if (isAdmin) {
        openAdminEditModal(order);
        return;
    }
    
    // For users, only allow editing certain fields if order is in editable state
    if (order.status !== 'pending' && order.paymentStatus !== 'pending_bank_transfer') {
        showError('This order can no longer be edited');
        return;
    }
    
    // Simple edit for users - could be expanded
    const newRequirements = prompt('Update your custom requirements:', order.customRequirements || '');
    if (newRequirements === null) return;
    
    try {
        const updateData = {
            customRequirements: newRequirements,
            updatedAt: new Date().toISOString()
        };
        
        await firebaseDB.collection('orders').doc(orderId).update(updateData);
        
        if (order.userId) {
            await firebaseDB.collection('users').doc(order.userId)
                .collection('orders').doc(orderId).update(updateData);
        }
        
        showNotification('Order updated successfully');
        
    } catch (error) {
        console.error('Error editing order:', error);
        showError('Failed to update order');
    }
}

function openAdminEditModal(order) {
    // Create a comprehensive edit modal for admin
    const modalContent = `
        <h3>Edit Order #${order.orderNumber}</h3>
        <form id="editOrderForm">
            <div class="form-group">
                <label>Status</label>
                <select id="editStatus" class="form-control">
                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                    <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                    <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                    <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Payment Status</label>
                <select id="editPaymentStatus" class="form-control">
                    <option value="pending_bank_transfer" ${order.paymentStatus === 'pending_bank_transfer' ? 'selected' : ''}>Awaiting Bank Transfer</option>
                    <option value="payment_submitted" ${order.paymentStatus === 'payment_submitted' ? 'selected' : ''}>Payment Submitted</option>
                    <option value="payment_verified" ${order.paymentStatus === 'payment_verified' ? 'selected' : ''}>Payment Verified</option>
                    <option value="paid" ${order.paymentStatus === 'paid' ? 'selected' : ''}>Paid</option>
                    <option value="cancelled" ${order.paymentStatus === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Total Amount</label>
                <input type="number" id="editTotal" value="${order.total}" step="0.01" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Shipping Cost</label>
                <input type="number" id="editShipping" value="${order.shipping}" step="0.01" class="form-control">
            </div>
            
            <div class="form-group">
                <label>Admin Notes</label>
                <textarea id="editAdminNotes" class="form-control">${order.adminNotes || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label>Tracking Info (JSON)</label>
                <textarea id="editTracking" class="form-control">${JSON.stringify(order.tracking || {}, null, 2)}</textarea>
            </div>
        </form>
    `;
    
    // You would implement a modal to show this content
    // For now, we'll use confirm and prompt
    const newStatus = prompt('Enter new status:', order.status);
    if (newStatus) {
        updateOrderStatus(order.id, newStatus);
    }
}

async function deleteOrder(orderId) {
    if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) return;
    
    try {
        const order = (isAdmin ? allOrders : userOrders).find(o => o.id === orderId);
        
        // Only admin can delete, users can only cancel
        if (!isAdmin) {
            showError('You do not have permission to delete orders');
            return;
        }
        
        // Delete from main orders collection
        await firebaseDB.collection('orders').doc(orderId).delete();
        
        // Delete from user's orders collection
        if (order.userId) {
            await firebaseDB.collection('users').doc(order.userId)
                .collection('orders').doc(orderId).delete();
        }
        
        // Remove from local arrays
        if (isAdmin) {
            allOrders = allOrders.filter(o => o.id !== orderId);
        } else {
            userOrders = userOrders.filter(o => o.id !== orderId);
        }
        
        displayOrders();
        showNotification('Order deleted successfully');
        
    } catch (error) {
        console.error('Error deleting order:', error);
        showError('Failed to delete order: ' + error.message);
    }
}

async function openCustomerDetails(userId) {
    if (!isAdmin) return;
    
    try {
        // Get user details
        const userDoc = await firebaseDB.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        // Get user's orders
        const ordersSnapshot = await firebaseDB.collection('orders')
            .where('userId', '==', userId)
            .get();
        
        const userOrders = [];
        ordersSnapshot.forEach(doc => {
            userOrders.push(doc.data());
        });
        
        // Show user details modal
        const modalContent = `
            <div class="modal-header">
                <h3><i class="fas fa-user"></i> Customer Details</h3>
            </div>
            <div style="padding: 20px;">
                <h4>User Information</h4>
                <p><strong>Name:</strong> ${userData?.displayName || 'N/A'}</p>
                <p><strong>Email:</strong> ${userData?.email || 'N/A'}</p>
                <p><strong>User ID:</strong> ${userId}</p>
                
                <h4 style="margin-top: 20px;">Order History</h4>
                <p><strong>Total Orders:</strong> ${userOrders.length}</p>
                <p><strong>Total Spent:</strong> Â£${userOrders.reduce((sum, order) => sum + (order.total || 0), 0).toFixed(2)}</p>
                
                <div style="margin-top: 20px;">
                    <button onclick="sendMessageToCustomer('${userId}')" class="admin-btn admin-btn-primary">
                        <i class="fas fa-envelope"></i> Send Message
                    </button>
                </div>
            </div>
        `;
        
        // You would implement a modal to show this content
        alert(`Customer: ${userData?.displayName || 'N/A'}\nEmail: ${userData?.email || 'N/A'}\nTotal Orders: ${userOrders.length}`);
        
    } catch (error) {
        console.error('Error getting customer details:', error);
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function setupSearch() {
    const searchInput = document.getElementById('searchOrders');
    if (searchInput) {
        searchInput.addEventListener('keyup', debounce(searchOrders, 300));
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showRealtimeUpdate(message) {
    const updateDiv = document.getElementById('realtimeUpdates');
    const messageSpan = document.getElementById('updateMessage');
    
    if (!updateDiv || !messageSpan) return;
    
    messageSpan.textContent = message;
    updateDiv.style.display = 'block';
    
    setTimeout(() => {
        updateDiv.style.display = 'none';
    }, 5000);
}

// ============================================
// INITIALIZE WHEN READY
// ============================================

// Keep existing functions from your original code, but enhance them with admin features
// The functions above integrate with your existing system

// Make sure to add these functions to your global scope
window.openVerificationModal = openVerificationModal;
window.closeAdminModal = closeAdminModal;
window.verifyPayment = verifyPayment;
window.updatePaymentStatus = updatePaymentStatus;
window.updateOrderStatus = updateOrderStatus;
window.sendReminder = sendReminder;
window.editOrder = editOrder;
window.deleteOrder = deleteOrder;
window.openCustomerDetails = openCustomerDetails;
window.searchOrders = searchOrders;
window.filterAdminOrders = filterAdminOrders;

// Your existing functions remain the same...
</script>
</body>
</html>
