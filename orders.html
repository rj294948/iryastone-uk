<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Details | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Base CSS */
:root {
    --primary-gold: #D4AF37;
    --stone-dark: #2C3E50;
    --stone-medium: #7F8C8D;
    --stone-light: #ECF0F1;
    --text-dark: #333333;
    --text-light: #666666;
    --success: #28A745;
    --warning: #FFC107;
    --danger: #DC3545;
    --info: #17A2B8;
    --border-color: #E0E0E0;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: #f5f7fa;
    color: var(--text-dark);
    line-height: 1.6;
}

/* Order Details Container */
.order-details-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 20px;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #f8f9fa;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-dark);
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.detail-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.detail-section h2 {
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Roboto Slab', serif;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-label {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-value {
    font-size: 15px;
    color: var(--text-dark);
    font-weight: 600;
}

.detail-value.gold {
    color: var(--primary-gold);
}

.detail-value.success {
    color: var(--success);
}

.detail-value.warning {
    color: var(--warning);
}

.detail-value.danger {
    color: var(--danger);
}

/* Items Table */
.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.items-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: var(--stone-dark);
    border-bottom: 2px solid var(--border-color);
    font-family: 'Roboto Slab', serif;
}

.items-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: top;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Timeline */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--primary-gold);
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -36px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-gold);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--primary-gold);
}

/* Status Badges */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-badge.pending {
    background: rgba(255, 193, 7, 0.1);
    color: var(--warning);
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.status-badge.processing {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success);
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.status-badge.shipped {
    background: rgba(23, 162, 184, 0.1);
    color: var(--info);
    border: 1px solid rgba(23, 162, 184, 0.3);
}

.status-badge.delivered {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
    border: 1px solid rgba(108, 117, 125, 0.3);
}

.status-badge.cancelled {
    background: rgba(220, 53, 69, 0.1);
    color: var(--danger);
    border: 1px solid rgba(220, 53, 69, 0.3);
}

/* Payment Status */
.payment-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.payment-status.pending {
    background: rgba(255, 193, 7, 0.1);
    color: var(--warning);
    border: 1px solid rgba(255, 193, 7, 0.3);
}

.payment-status.fully_paid {
    background: rgba(40, 167, 69, 0.1);
    color: var(--success);
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.payment-status.advance_paid {
    background: rgba(0, 123, 255, 0.1);
    color: #007BFF;
    border: 1px solid rgba(0, 123, 255, 0.3);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 15px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Poppins', sans-serif;
    transition: all 0.3s ease;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-gold);
    color: white;
}

.btn-primary:hover {
    background: #b8941f;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover {
    background: #138496;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
}

/* Responsive */
@media (max-width: 768px) {
    .order-details-container {
        padding: 15px;
    }
    
    .detail-section {
        padding: 20px;
    }
    
    .detail-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .items-table {
        display: block;
        overflow-x: auto;
    }
}

/* Loading Animation */
.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 50px;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Notification Icon */
.notification-icon {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--danger);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.notification-dropdown {
    position: absolute;
    top: 40px;
    right: 0;
    width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    display: none;
}

.notification-dropdown.active {
    display: block;
}

.notification-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-item {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.3s;
}

.notification-item:hover {
    background: #f8f9fa;
}

.notification-item.unread {
    background: rgba(212, 175, 55, 0.05);
    border-left: 3px solid var(--primary-gold);
}

.notification-item.read {
    opacity: 0.7;
}
</style>
</head>
<body>

<!-- Notification Icon -->
<div class="notification-icon">
    <div style="position: relative; cursor: pointer;" onclick="toggleNotifications()">
        <i class="fas fa-bell" style="font-size: 24px; color: var(--stone-dark);"></i>
        <div id="notificationBadge" class="notification-badge" style="display: none;">0</div>
    </div>
    <div id="notificationDropdown" class="notification-dropdown">
        <div class="notification-header">
            <h4 style="margin: 0;">Notifications</h4>
            <button onclick="markAllAsRead()" style="background: none; border: none; color: var(--primary-gold); cursor: pointer; font-size: 12px;">
                Mark all as read
            </button>
        </div>
        <div id="notificationList" class="notification-list">
            <!-- Notifications will be loaded here -->
        </div>
    </div>
</div>

<div class="order-details-container">
    <a href="orders.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Orders
    </a>
    
    <div id="orderDetailsContent">
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading order details...</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
const auth = firebase.auth();

// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    window.location.href = 'orders.html';
}

// Load order details
async function loadOrderDetails() {
    try {
        // Get current user
        let userId = null;
        const user = auth.currentUser;
        
        if (user) {
            userId = user.uid;
        } else {
            // Try to get from localStorage for guest users
            userId = localStorage.getItem('irya_guest_id');
        }
        
        if (!userId) {
            throw new Error('User not authenticated');
        }
        
        // Fetch order details
        let order = null;
        
        // Try from user's orders collection first
        const userOrderRef = db.collection('users').doc(userId).collection('orders').doc(orderId);
        const userOrderDoc = await userOrderRef.get();
        
        if (userOrderDoc.exists) {
            order = userOrderDoc.data();
            order.id = userOrderDoc.id;
        } else {
            // Try from main orders collection
            const orderRef = db.collection('orders').doc(orderId);
            const orderDoc = await orderRef.get();
            
            if (orderDoc.exists) {
                order = orderDoc.data();
                order.id = orderDoc.id;
                
                // Check if user has permission to view this order
                if (order.userId !== userId) {
                    throw new Error('You do not have permission to view this order');
                }
            } else {
                throw new Error('Order not found');
            }
        }
        
        // Fetch product images for items
        await fetchProductImages(order);
        
        // Display order details
        displayOrderDetails(order);
        
        // Load notifications for this user
        loadNotifications(userId);
        
    } catch (error) {
        console.error('Error loading order details:', error);
        document.getElementById('orderDetailsContent').innerHTML = `
            <div class="detail-section" style="text-align: center; padding: 50px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
                <h2>Error Loading Order</h2>
                <p style="margin-bottom: 20px;">${error.message}</p>
                <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                    <i class="fas fa-arrow-left"></i>
                    Back to Orders
                </a>
            </div>
        `;
    }
}

// Fetch product images from products collection
async function fetchProductImages(order) {
    try {
        const items = order.items || [];
        
        for (let item of items) {
            if (item.stoneName || item.name) {
                try {
                    // Try to get product from products collection
                    const productName = item.stoneName || item.name;
                    const productsRef = db.collection('products');
                    const snapshot = await productsRef
                        .where('name', '==', productName)
                        .limit(1)
                        .get();
                    
                    if (!snapshot.empty) {
                        const productData = snapshot.docs[0].data();
                        if (productData.images && productData.images.length > 0) {
                            item.image = productData.images[0];
                        } else if (productData.image) {
                            item.image = productData.image;
                        }
                    }
                } catch (error) {
                    console.log(`Could not fetch image for ${item.name}:`, error);
                }
            }
        }
    } catch (error) {
        console.error('Error fetching product images:', error);
    }
}

// Load notifications for user
async function loadNotifications(userId) {
    try {
        const notificationsRef = db.collection('users').doc(userId).collection('notifications');
        const snapshot = await notificationsRef
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        const notifications = [];
        let unreadCount = 0;
        
        snapshot.forEach(doc => {
            const notification = {
                id: doc.id,
                ...doc.data()
            };
            notifications.push(notification);
            
            if (!notification.read) {
                unreadCount++;
            }
        });
        
        displayNotifications(notifications);
        
        // Update badge
        const badge = document.getElementById('notificationBadge');
        if (unreadCount > 0) {
            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

// Display notifications in dropdown
function displayNotifications(notifications) {
    const notificationList = document.getElementById('notificationList');
    
    if (notifications.length === 0) {
        notificationList.innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-bell-slash" style="font-size: 40px; color: var(--text-light); margin-bottom: 15px;"></i>
                <p style="color: var(--text-light);">No notifications yet</p>
            </div>
        `;
        return;
    }
    
    notificationList.innerHTML = notifications.map(notification => `
        <div class="notification-item ${notification.read ? 'read' : 'unread'}" 
             onclick="viewNotification('${notification.id}', '${notification.orderId || ''}')">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <strong style="color: var(--stone-dark);">${notification.title || 'Notification'}</strong>
                <small style="color: var(--text-light);">${formatDate(notification.createdAt)}</small>
            </div>
            <p style="margin: 0; font-size: 14px; color: var(--text-dark);">
                ${notification.message || ''}
                ${notification.orderNumber ? `<br><small style="color: var(--primary-gold);">Order: ${notification.orderNumber}</small>` : ''}
            </p>
            ${notification.type ? `<span class="status-badge" style="margin-top: 5px; font-size: 10px;">${notification.type}</span>` : ''}
        </div>
    `).join('');
}

// Toggle notifications dropdown
function toggleNotifications() {
    const dropdown = document.getElementById('notificationDropdown');
    dropdown.classList.toggle('active');
}

// Mark all notifications as read
async function markAllAsRead() {
    try {
        const user = auth.currentUser;
        if (!user) return;
        
        const notificationsRef = db.collection('users').doc(user.uid).collection('notifications');
        const snapshot = await notificationsRef.where('read', '==', false).get();
        
        const batch = db.batch();
        snapshot.forEach(doc => {
            batch.update(doc.ref, { read: true });
        });
        
        await batch.commit();
        
        // Reload notifications
        loadNotifications(user.uid);
        
    } catch (error) {
        console.error('Error marking notifications as read:', error);
    }
}

// View notification and mark as read
async function viewNotification(notificationId, orderId) {
    try {
        const user = auth.currentUser;
        if (!user) return;
        
        // Mark as read
        const notificationRef = db.collection('users').doc(user.uid).collection('notifications').doc(notificationId);
        await notificationRef.update({ read: true });
        
        // If notification is for an order, navigate to it
        if (orderId) {
            window.location.href = `order-details.html?id=${orderId}`;
        }
        
        // Reload notifications
        loadNotifications(user.uid);
        
    } catch (error) {
        console.error('Error viewing notification:', error);
    }
}

function displayOrderDetails(order) {
    const content = document.getElementById('orderDetailsContent');
    
    // Determine status badge class
    let statusClass = 'pending';
    if (order.status === 'processing' || order.status === 'payment_verified') statusClass = 'processing';
    else if (order.status === 'shipped') statusClass = 'shipped';
    else if (order.status === 'delivered') statusClass = 'delivered';
    else if (order.status === 'cancelled') statusClass = 'cancelled';
    
    // Determine payment status
    let paymentStatusClass = 'pending';
    let paymentStatusText = getPaymentStatusText(order.paymentStatus || 'pending');
    if (order.paymentStatus === 'fully_paid') paymentStatusClass = 'fully_paid';
    else if (order.paymentStatus === 'advance_paid') paymentStatusClass = 'advance_paid';
    
    content.innerHTML = `
        <!-- Order Summary -->
        <div class="detail-section">
            <h2><i class="fas fa-receipt"></i> Order Summary</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Order Number</div>
                    <div class="detail-value gold">${order.orderNumber || order.id}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Date</div>
                    <div class="detail-value">${formatDate(order.createdAt)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Status</div>
                    <div class="detail-value">
                        <span class="status-badge ${statusClass}">
                            ${getStatusText(order.status)}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">
                        <span class="payment-status ${paymentStatusClass}">
                            <i class="fas ${paymentStatusClass === 'fully_paid' ? 'fa-check-circle' : 
                                          paymentStatusClass === 'advance_paid' ? 'fa-money-check-alt' : 
                                          'fa-clock'}"></i>
                            ${paymentStatusText}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Shipping Status</div>
                    <div class="detail-value">
                        <span class="status-badge ${order.shippingStatus || 'pending'}">
                            ${getShippingStatusText(order.shippingStatus)}
                        </span>
                    </div>
                </div>
                ${order.trackingNumber ? `
                    <div class="detail-item">
                        <div class="detail-label">Tracking Number</div>
                        <div class="detail-value">${order.trackingNumber}</div>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Customer Information -->
        <div class="detail-section">
            <h2><i class="fas fa-user"></i> Customer Information</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${order.userName || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${order.userEmail || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">User ID</div>
                    <div class="detail-value">${order.userId ? order.userId.substring(0, 10) + '...' : 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Phone</div>
                    <div class="detail-value">${order.shippingAddress?.phone || 'N/A'}</div>
                </div>
            </div>
        </div>
        
        <!-- Order Items -->
        <div class="detail-section">
            <h2><i class="fas fa-box"></i> Order Items (${order.items?.length || 0})</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${(order.items || []).map(item => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-image">
                                        <img src="${item.image || 'https://via.placeholder.com/60x60?text=Stone'}" 
                                             alt="${item.name}" 
                                             onerror="this.src='https://via.placeholder.com/60x60?text=Stone'">
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${item.name}</div>
                                        <div style="font-size: 13px; color: var(--text-light);">${item.stoneName || 'Natural Stone'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 13px;">
                                    ${getCalculationInfo(item)}
                                    ${item.customRequirements ? `
                                        <div style="color: var(--primary-gold); margin-top: 5px;">
                                            <i class="fas fa-edit"></i> 
                                            <strong>Custom Requirements:</strong><br>
                                            ${item.customRequirements}
                                        </div>
                                    ` : ''}
                                    ${item.calculationData?.mode === 'custom' ? `
                                        <div style="color: var(--info); margin-top: 5px;">
                                            <i class="fas fa-ruler-combined"></i> Custom Measurements
                                        </div>
                                    ` : ''}
                                </div>
                            </td>
                            <td>${item.quantity || 1}</td>
                            <td>£${(item.price || 0).toFixed(2)}</td>
                            <td class="detail-value gold">£${(item.calculatedPrice || item.totalPrice || 0).toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- Payment Details -->
        <div class="detail-section">
            <h2><i class="fas fa-credit-card"></i> Payment Details</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Payment Method</div>
                    <div class="detail-value">${order.paymentMethod === 'bank' ? 'Bank Transfer' : order.paymentMethod || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Type</div>
                    <div class="detail-value">
                        <span style="color: ${order.paymentType === 'advance' ? 'var(--info)' : 'var(--success)'}">
                            ${order.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}
                        </span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Subtotal</div>
                    <div class="detail-value">£${(order.subtotal || 0).toFixed(2)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Shipping</div>
                    <div class="detail-value">
                        ${order.shipping === 0 ? 
                            '<span style="color: var(--success);">FREE</span>' : 
                            `£${(order.shipping || 0).toFixed(2)}`
                        }
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tax</div>
                    <div class="detail-value">£${(order.tax || 0).toFixed(2)}</div>
                </div>
                ${order.advancePayment ? `
                    <div class="detail-item">
                        <div class="detail-label">Advance Paid</div>
                        <div class="detail-value gold">£${(order.advancePayment || 0).toFixed(2)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Remaining Payment</div>
                        <div class="detail-value ${order.remainingPayment > 0 ? 'gold' : 'success'}">
                            £${(order.remainingPayment || 0).toFixed(2)}
                        </div>
                    </div>
                ` : ''}
                <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value gold" style="font-size: 18px;">£${(order.total || 0).toFixed(2)}</div>
                </div>
            </div>
            
            <!-- Bank Transfer Details -->
            ${order.paymentMethod === 'bank' && order.bankTransferDetails ? `
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: var(--stone-dark);">
                        <i class="fas fa-university"></i> Bank Transfer Instructions
                    </h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Account Name</div>
                            <div class="detail-value">${order.bankTransferDetails.accountName || 'IRYA STONE LTD'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Account Number</div>
                            <div class="detail-value">${order.bankTransferDetails.accountNumber || 'XXXX-XXXX'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Sort Code</div>
                            <div class="detail-value">${order.bankTransferDetails.sortCode || 'XX-XX-XX'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Reference</div>
                            <div class="detail-value gold">${order.bankTransferDetails.reference || order.orderNumber}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Amount to Pay</div>
                            <div class="detail-value gold">£${(order.bankTransferDetails.amount || order.advancePayment || order.total || 0).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            ` : ''}
        </div>
        
        <!-- Shipping Address -->
        <div class="detail-section">
            <h2><i class="fas fa-map-marker-alt"></i> Shipping Address</h2>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                ${order.shippingAddress ? `
                    <p style="font-weight: 600; margin-bottom: 10px; color: var(--stone-dark);">
                        <i class="fas fa-user"></i> ${order.shippingAddress.fullName || 'N/A'}
                    </p>
                    <p><i class="fas fa-home"></i> ${order.shippingAddress.address1}</p>
                    ${order.shippingAddress.address2 ? `<p>${order.shippingAddress.address2}</p>` : ''}
                    <p><i class="fas fa-city"></i> ${order.shippingAddress.city || ''}, 
                       ${order.shippingAddress.state || ''} ${order.shippingAddress.postalCode || ''}</p>
                    <p><i class="fas fa-globe"></i> ${order.shippingAddress.country || ''}</p>
                    <p style="margin-top: 10px;">
                        <strong><i class="fas fa-phone"></i> Phone:</strong> ${order.shippingAddress.phone || 'N/A'}
                    </p>
                    <p><strong><i class="fas fa-envelope"></i> Email:</strong> ${order.shippingAddress.email || order.userEmail || 'N/A'}</p>
                    ${order.shippingAddress.instructions ? `
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong><i class="fas fa-sticky-note"></i> Special Instructions:</strong>
                            <p style="margin-top: 5px; color: var(--text-dark);">${order.shippingAddress.instructions}</p>
                        </div>
                    ` : ''}
                ` : 'No shipping address provided'}
            </div>
        </div>
        
        <!-- Order Timeline -->
        <div class="detail-section">
            <h2><i class="fas fa-history"></i> Order Timeline</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div>
                        <div style="font-weight: 600; color: var(--stone-dark);">Order Placed</div>
                        <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.createdAt)}</div>
                    </div>
                </div>
                
                ${order.paymentVerifiedAt ? `
                    <div class="timeline-item">
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Payment Verified</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.paymentVerifiedAt)}</div>
                            ${order.paymentVerifiedBy ? `
                                <div style="font-size: 12px; color: var(--text-light);">
                                    <i class="fas fa-user-check"></i> Verified by: ${order.paymentVerifiedBy}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${order.shippedAt ? `
                    <div class="timeline-item">
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Order Shipped</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.shippedAt)}</div>
                            ${order.trackingNumber ? `
                                <div style="margin-top: 5px;">
                                    <span style="color: var(--info);">
                                        <i class="fas fa-shipping-fast"></i> Tracking: ${order.trackingNumber}
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${order.deliveredAt ? `
                    <div class="timeline-item">
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Order Delivered</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.deliveredAt)}</div>
                        </div>
                    </div>
                ` : ''}
                
                ${order.updatedAt ? `
                    <div class="timeline-item">
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Last Updated</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.updatedAt)}</div>
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button onclick="downloadInvoice()" class="btn btn-primary">
                <i class="fas fa-file-pdf"></i>
                Download Invoice
            </button>
            
            <button onclick="window.print()" class="btn btn-secondary">
                <i class="fas fa-print"></i>
                Print Details
            </button>
            
            <a href="orders.html" class="btn" style="background: var(--stone-medium);">
                <i class="fas fa-list"></i>
                View All Orders
            </a>
        </div>
    `;
}

// Helper functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status || 'Pending';
}

function getShippingStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status || 'Pending';
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'advance_paid': 'Advance Paid',
        'fully_paid': 'Fully Paid',
        'paid': 'Paid',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status || 'Pending';
}

function getCalculationInfo(item) {
    if (!item.calculationData) {
        return `Quantity: ${item.quantity || 1} piece${item.quantity > 1 ? 's' : ''}`;
    }
    
    const unit = item.calculationData.unit || 'piece';
    const quantity = item.calculationData.quantity || item.quantity || 1;
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft<br>
                Total: ${item.calculationData.area || quantity} sqft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m<br>
                Total: ${item.calculationData.area || quantity} sqm`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1} kg`;
    } else {
        return `Quantity: ${quantity} piece${quantity > 1 ? 's' : ''}`;
    }
}

function downloadInvoice() {
    alert('Invoice download feature will be implemented soon!');
    // In production, implement actual invoice generation
}

// Close notification dropdown when clicking outside
document.addEventListener('click', function(event) {
    const notificationIcon = document.querySelector('.notification-icon');
    const dropdown = document.getElementById('notificationDropdown');
    
    if (!notificationIcon.contains(event.target) && dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
    }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    auth.onAuthStateChanged((user) => {
        if (user || localStorage.getItem('irya_guest_id')) {
            loadOrderDetails();
        } else {
            window.location.href = 'login.html';
        }
    });
});
</script>
</body>
</html>
