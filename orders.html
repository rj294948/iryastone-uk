<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Orders | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- ===== AMAZON STYLE THEME ===== -->
<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#eaeded;
  color:#0F1111;
}
header{
  background:#131921;
  color:#fff;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position: sticky;
  top: 0;
  z-index: 100;
}
header h2{ 
  margin:0; 
  font-size:18px; 
  display: flex;
  align-items: center;
  gap: 10px;
}
header h2 i {
  color: #ff9900;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 20px;
}

.bell{
  position:relative;
  cursor:pointer;
  font-size: 20px;
}
.bell span{
  position:absolute;
  top:-8px;
  right:-8px;
  background:#ff9900;
  color:#000;
  border-radius:50%;
  font-size:11px;
  font-weight: bold;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.container{
  padding:15px;
  max-width: 1200px;
  margin: 0 auto;
}

.order-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 16px;
}

.order{
  background:#fff;
  border-radius:8px;
  margin-bottom:12px;
  padding:18px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  border: 1px solid #ddd;
  transition: transform 0.2s;
}
.order:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}
.order-header{
  display:flex;
  justify-content:space-between;
  align-items: flex-start;
  margin-bottom: 15px;
  padding-bottom: 12px;
  border-bottom: 1px solid #eee;
}
.order-id {
  font-size: 16px;
  font-weight: bold;
  color: #0F1111;
  margin-bottom: 4px;
}
.order-date {
  font-size: 12px;
  color: #666;
}
.badge{
  padding:6px 12px;
  border-radius:4px;
  font-size:12px;
  font-weight: bold;
  text-transform: uppercase;
}
.advance{ background:#f0ad4e; color:#000; }
.full{ background:#198754; color:#fff; }
.pending { background:#ffc107; color:#000; }
.processing { background:#17a2b8; color:#fff; }
.shipped { background:#007bff; color:#fff; }
.delivered { background:#28a745; color:#fff; }
.cancelled { background:#dc3545; color:#fff; }

.order-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin: 15px 0;
}
.detail-item {
  display: flex;
  flex-direction: column;
}
.detail-label {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}
.detail-value {
  font-size: 14px;
  font-weight: 600;
  color: #0F1111;
}

.order-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

button{
  background:#ffd814;
  border:1px solid #fcd200;
  padding:8px 16px;
  cursor:pointer;
  border-radius:6px;
  font-weight: 600;
  font-size: 14px;
  flex: 1;
  transition: all 0.2s;
}
button:hover{
  background:#f7ca00;
  border-color:#F2A900;
}
button.secondary{
  background:#f7f7f7;
  color:#0F1111;
  border:1px solid #d5d9d9;
}
button.secondary:hover{
  background:#e7e9ec;
  border-color:#adb1b8;
}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-content{
  background:#fff;
  max-width:700px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  margin:5% auto;
  padding:25px;
  border-radius:10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  position: relative;
}
.close{
  position: absolute;
  top: 15px;
  right: 20px;
  cursor:pointer;
  font-size:24px;
  color: #666;
}
.close:hover {
  color: #000;
}

.modal-section {
  margin: 20px 0;
  padding: 20px;
  background: #f9f9f9;
  border-radius: 8px;
  border: 1px solid #eee;
}

.modal-section h4 {
  margin: 0 0 15px 0;
  color: #131921;
  display: flex;
  align-items: center;
  gap: 8px;
}

.modal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 15px;
}

/* ===== NOTIFICATIONS ===== */
#notifications{
  display:none;
  position:fixed;
  top: 60px;
  right: 20px;
  background:#fff;
  width: 380px;
  max-height:500px;
  overflow:auto;
  border-radius:8px;
  box-shadow:0 4px 20px rgba(0,0,0,0.2);
  z-index: 1001;
  border: 1px solid #ddd;
}
.notification-header {
  padding: 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9f9f9;
  border-radius: 8px 8px 0 0;
}
.notification-header h3 {
  margin: 0;
  font-size: 16px;
  color: #131921;
}
.notification-actions {
  display: flex;
  gap: 10px;
}
.notification-actions button {
  background: none;
  border: none;
  color: #0066c0;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
}
.notification-actions button:hover {
  background: rgba(0,102,192,0.1);
}
.note{
  padding:15px;
  border-bottom:1px solid #eee;
  cursor: pointer;
  transition: background 0.2s;
}
.note:hover{
  background:#f9f9f9;
}
.note.unread{ 
  background: rgba(255, 153, 0, 0.05);
  border-left: 3px solid #ff9900;
}
.note-title {
  font-weight: bold;
  color: #0F1111;
  margin-bottom: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.note-message {
  font-size: 13px;
  color: #555;
  line-height: 1.4;
  margin-bottom: 8px;
}
.note-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.note-time {
  font-size: 11px;
  color: #888;
}
.note-type {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 3px;
  background: #eee;
  color: #666;
}
.note-type.order { background: #e8f4ff; color: #0066c0; }
.note-type.payment { background: #e8f8e8; color: #28a745; }
.note-type.shipping { background: #f0e8ff; color: #6f42c1; }

/* ===== LOADING ===== */
.loading {
  text-align: center;
  padding: 40px;
  color: #666;
}
.loading:after {
  content: '...';
  animation: dots 1.5s steps(5, end) infinite;
}

@keyframes dots {
  0%, 20% { content: ''; }
  40% { content: '.'; }
  60% { content: '..'; }
  80%, 100% { content: '...'; }
}

/* ===== STATUS BADGES ===== */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
}
.status-badge i {
  font-size: 10px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .order-grid {
    grid-template-columns: 1fr;
  }
  #notifications {
    width: calc(100% - 40px);
    right: 10px;
    left: 10px;
  }
  .header-actions {
    gap: 15px;
  }
}

/* ===== EMPTY STATE ===== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  background: #fff;
  border-radius: 8px;
  border: 1px solid #ddd;
}
.empty-state i {
  font-size: 48px;
  color: #ccc;
  margin-bottom: 20px;
}
.empty-state h3 {
  color: #666;
  margin-bottom: 10px;
}
</style>

<!-- Font Awesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<header>
  <h2><i class="fas fa-gem"></i> IRYA STONE – My Orders</h2>
  <div class="header-actions">
    <div class="bell" onclick="toggleNotes()">
      <i class="fas fa-bell"></i>
      <span id="noteCount" style="display:none">0</span>
    </div>
  </div>
</header>

<div class="container">
  <div class="order-grid" id="orders">
    <div class="loading">Loading orders</div>
  </div>
</div>

<!-- ===== ORDER DETAILS MODAL ===== -->
<div class="modal" id="orderModal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">✖</span>
    <div id="orderDetails"></div>
  </div>
</div>

<!-- ===== NOTIFICATION PANEL ===== -->
<div id="notifications">
  <div class="notification-header">
    <h3><i class="fas fa-bell"></i> Notifications</h3>
    <div class="notification-actions">
      <button onclick="markAllAsRead()">Mark all read</button>
      <button onclick="clearNotifications()">Clear all</button>
    </div>
  </div>
  <div id="notificationList"></div>
</div>

<!-- ===== FIREBASE + LOGIC ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, getDoc,
  query, orderBy, onSnapshot, where, updateDoc,
  deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebasestorage.app",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global variables
let userId = null;
let orders = [];
let notifications = [];
let ordersUnsubscribe = null;
let notificationsUnsubscribe = null;

// ============================================
// USER ID MANAGEMENT
// ============================================

async function getUserId() {
  try {
    // First check localStorage
    const savedUserId = localStorage.getItem('irya_user_id');
    if (savedUserId) {
      userId = savedUserId;
      return userId;
    }

    // Check for guest ID
    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
      guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('irya_guest_id', guestId);
    }
    
    userId = guestId;
    localStorage.setItem('irya_user_id', userId);
    return userId;
    
  } catch (error) {
    console.error("Error getting user ID:", error);
    return 'guest_' + Date.now();
  }
}

// ============================================
// ORDERS MANAGEMENT
// ============================================

async function loadOrders() {
  try {
    const ordersDiv = document.getElementById("orders");
    ordersDiv.innerHTML = '<div class="loading">Loading orders</div>';
    
    // Get user ID
    userId = await getUserId();
    console.log("Loading orders for user:", userId);
    
    // First try to get from user's orders collection
    let ordersQuery;
    
    try {
      const userOrdersRef = collection(db, "users", userId, "orders");
      ordersQuery = query(userOrdersRef, orderBy("createdAt", "desc"));
    } catch (error) {
      console.log("User orders collection not found, trying main orders collection");
      // Try main orders collection with user filter
      const ordersRef = collection(db, "orders");
      ordersQuery = query(
        ordersRef, 
        where("userId", "==", userId),
        orderBy("createdAt", "desc")
      );
    }
    
    // Setup real-time listener
    if (ordersUnsubscribe) ordersUnsubscribe();
    
    ordersUnsubscribe = onSnapshot(ordersQuery, (snapshot) => {
      orders = [];
      let hasOrders = false;
      
      snapshot.forEach((doc) => {
        const orderData = doc.data();
        orderData.id = doc.id;
        orders.push(orderData);
        hasOrders = true;
      });
      
      if (!hasOrders) {
        ordersDiv.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>No Orders Found</h3>
            <p>You haven't placed any orders yet.</p>
            <button onclick="window.location.href='products.html'" class="secondary" style="margin-top: 20px;">
              <i class="fas fa-shopping-bag"></i> Shop Now
            </button>
          </div>
        `;
        return;
      }
      
      displayOrders(orders);
      
    }, (error) => {
      console.error("Error loading orders:", error);
      ordersDiv.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error Loading Orders</h3>
          <p>${error.message}</p>
          <button onclick="loadOrders()" class="secondary" style="margin-top: 20px;">
            <i class="fas fa-redo"></i> Try Again
          </button>
        </div>
      `;
    });
    
  } catch (error) {
    console.error("Error in loadOrders:", error);
    document.getElementById("orders").innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Connection Error</h3>
        <p>Please check your internet connection and try again.</p>
      </div>
    `;
  }
}

function displayOrders(ordersList) {
  const ordersDiv = document.getElementById("orders");
  
  if (!ordersList || ordersList.length === 0) {
    ordersDiv.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-box-open"></i>
        <h3>No Orders Found</h3>
        <p>You haven't placed any orders yet.</p>
      </div>
    `;
    return;
  }
  
  let ordersHTML = '';
  
  ordersList.forEach((order) => {
    const orderDate = formatDate(order.createdAt);
    const isFull = order.paymentStatus === 'fully_paid' || 
                   order.paymentType === 'full' || 
                   (order.submittedAmount && order.submittedAmount >= order.total);
    
    // Determine status badge
    let statusClass = 'pending';
    let statusText = order.shippingStatus || order.status || 'Pending';
    
    if (statusText.toLowerCase().includes('processing')) statusClass = 'processing';
    else if (statusText.toLowerCase().includes('shipped')) statusClass = 'shipped';
    else if (statusText.toLowerCase().includes('delivered')) statusClass = 'delivered';
    else if (statusText.toLowerCase().includes('cancelled')) statusClass = 'cancelled';
    
    // Get first item for preview
    let itemName = 'Multiple Items';
    let itemImage = 'https://via.placeholder.com/60';
    
    if (order.items && order.items.length > 0) {
      const firstItem = order.items[0];
      itemName = firstItem.name || firstItem.stoneName || 'Product';
      itemImage = firstItem.image || 'https://via.placeholder.com/60';
    }
    
    ordersHTML += `
      <div class="order">
        <div class="order-header">
          <div>
            <div class="order-id">${order.orderNumber || 'Order #' + order.id.substring(0, 8)}</div>
            <div class="order-date">Placed on ${orderDate}</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-end;">
            <span class="badge ${isFull ? 'full' : 'advance'}">
              ${isFull ? 'FULL PAID' : 'ADVANCE'}
            </span>
            <span class="status-badge ${statusClass}">
              <i class="fas ${getStatusIcon(statusText)}"></i>
              ${statusText}
            </span>
          </div>
        </div>
        
        <div style="display: flex; gap: 15px; margin: 15px 0; align-items: center;">
          <img src="${itemImage}" 
               alt="${itemName}" 
               style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;"
               onerror="this.src='https://via.placeholder.com/60'">
          <div style="flex: 1;">
            <div style="font-weight: bold; font-size: 14px;">${itemName}</div>
            <div style="font-size: 12px; color: #666;">
              ${order.items ? order.items.length : 0} item${order.items && order.items.length !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
        
        <div class="order-details">
          <div class="detail-item">
            <span class="detail-label">Total Amount</span>
            <span class="detail-value">£${order.total?.toFixed(2) || '0.00'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Paid Amount</span>
            <span class="detail-value">£${order.submittedAmount?.toFixed(2) || order.advancePayment?.toFixed(2) || '0.00'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Remaining</span>
            <span class="detail-value" style="color: ${order.remainingPayment > 0 ? '#dc3545' : '#28a745'}">
              £${order.remainingPayment?.toFixed(2) || '0.00'}
            </span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Payment</span>
            <span class="detail-value">${getPaymentStatusText(order.paymentStatus)}</span>
          </div>
        </div>
        
        <div class="order-actions">
          <button onclick="viewOrder('${order.id}')">
            <i class="fas fa-eye"></i> View Details
          </button>
          <button class="secondary" onclick="downloadInvoice('${order.id}')">
            <i class="fas fa-file-invoice"></i> Invoice
          </button>
        </div>
      </div>
    `;
  });
  
  ordersDiv.innerHTML = ordersHTML;
}

function getStatusIcon(status) {
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing') || statusLower.includes('payment_verified')) {
    return 'fa-cog';
  } else if (statusLower.includes('shipped')) {
    return 'fa-shipping-fast';
  } else if (statusLower.includes('delivered')) {
    return 'fa-check-circle';
  } else if (statusLower.includes('cancelled')) {
    return 'fa-times-circle';
  }
  return 'fa-clock';
}

function getPaymentStatusText(paymentStatus) {
  if (!paymentStatus) return 'Pending';
  
  const statusMap = {
    'pending': 'Pending',
    'pending_bank_transfer': 'Awaiting Payment',
    'payment_verified': 'Payment Verified',
    'fully_paid': 'Fully Paid',
    'advance_paid': 'Advance Paid',
    'paid': 'Paid'
  };
  
  return statusMap[paymentStatus] || paymentStatus;
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

// ============================================
// ORDER DETAILS MODAL
// ============================================

window.viewOrder = async function(orderId) {
  try {
    const modal = document.getElementById("orderModal");
    const detailsDiv = document.getElementById("orderDetails");
    
    detailsDiv.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="loading">Loading order details</div>
      </div>
    `;
    
    modal.style.display = "flex";
    
    // Try multiple sources for order data
    let orderData = null;
    
    try {
      // Try user's orders collection first
      const orderDoc = await getDoc(doc(db, "users", userId, "orders", orderId));
      if (orderDoc.exists()) {
        orderData = orderDoc.data();
        orderData.id = orderDoc.id;
      }
    } catch (error) {
      console.log("Not found in user collection");
    }
    
    if (!orderData) {
      try {
        // Try main orders collection
        const orderDoc = await getDoc(doc(db, "orders", orderId));
        if (orderDoc.exists()) {
          orderData = orderDoc.data();
          orderData.id = orderDoc.id;
        }
      } catch (error) {
        console.log("Not found in main collection");
      }
    }
    
    if (!orderData) {
      detailsDiv.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 20px;"></i>
          <h3>Order Not Found</h3>
          <p>This order could not be found.</p>
        </div>
      `;
      return;
    }
    
    // Format order details
    const orderDate = formatDate(orderData.createdAt);
    const isFull = orderData.paymentStatus === 'fully_paid';
    
    let itemsHTML = '';
    if (orderData.items && orderData.items.length > 0) {
      itemsHTML = orderData.items.map(item => `
        <div style="display: flex; gap: 15px; padding: 12px; background: #fff; border-radius: 6px; border: 1px solid #eee; margin-bottom: 10px;">
          <img src="${item.image || 'https://via.placeholder.com/60'}" 
               alt="${item.name}" 
               style="width: 60px; height: 60px; border-radius: 6px; object-fit: cover;"
               onerror="this.src='https://via.placeholder.com/60'">
          <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
            <div style="font-size: 12px; color: #666;">
              ${item.quantity || 1} × £${item.price?.toFixed(2) || '0.00'}
              ${item.calculationData ? ` (${getCalculationInfo(item)})` : ''}
            </div>
            ${item.customRequirements ? `
              <div style="font-size: 12px; color: #ff9900; margin-top: 5px;">
                <i class="fas fa-edit"></i> Custom: ${item.customRequirements.substring(0, 50)}...
              </div>
            ` : ''}
          </div>
          <div style="font-weight: bold; color: #131921;">
            £${item.calculatedPrice?.toFixed(2) || item.totalPrice?.toFixed(2) || '0.00'}
          </div>
        </div>
      `).join('');
    }
    
    let paymentDetailsHTML = '';
    if (orderData.bankTransferDetails) {
      paymentDetailsHTML = `
        <div class="modal-section">
          <h4><i class="fas fa-university"></i> Bank Transfer Details</h4>
          <div style="background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
              <div><strong>Reference:</strong> ${orderData.bankTransferDetails.reference}</div>
              <div><strong>Amount:</strong> £${orderData.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 10px;">
              <i class="fas fa-info-circle"></i> Please use this reference when making the bank transfer.
            </div>
          </div>
        </div>
      `;
    }
    
    let shippingAddressHTML = '';
    if (orderData.shippingAddress) {
      const addr = orderData.shippingAddress;
      shippingAddressHTML = `
        <div class="modal-section">
          <h4><i class="fas fa-map-marker-alt"></i> Shipping Address</h4>
          <div style="background: #fff; padding: 15px; border-radius: 6px; border: 1px solid #eee;">
            <div><strong>${addr.fullName || ''}</strong></div>
            <div>${addr.address1 || ''}</div>
            ${addr.address2 ? `<div>${addr.address2}</div>` : ''}
            <div>${addr.city || ''}, ${addr.state || ''} ${addr.postalCode || ''}</div>
            <div>${addr.country || ''}</div>
            <div style="margin-top: 10px;">
              <strong>Phone:</strong> ${addr.phone || ''}<br>
              <strong>Email:</strong> ${addr.email || ''}
            </div>
          </div>
        </div>
      `;
    }
    
    detailsDiv.innerHTML = `
      <h2 style="color: #131921; margin-bottom: 20px;">
        Order ${orderData.orderNumber || 'Details'}
      </h2>
      
      <div class="modal-grid">
        <div class="modal-section">
          <h4><i class="fas fa-info-circle"></i> Order Information</h4>
          <div>
            <div><strong>Order Date:</strong> ${orderDate}</div>
            <div><strong>Status:</strong> ${orderData.shippingStatus || orderData.status || 'Pending'}</div>
            <div><strong>Payment Method:</strong> ${orderData.paymentMethod === 'bank' ? 'Bank Transfer' : orderData.paymentMethod || 'N/A'}</div>
            <div><strong>Payment Type:</strong> ${orderData.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</div>
            ${orderData.trackingNumber ? `<div><strong>Tracking Number:</strong> ${orderData.trackingNumber}</div>` : ''}
          </div>
        </div>
        
        <div class="modal-section">
          <h4><i class="fas fa-money-bill-wave"></i> Payment Summary</h4>
          <div>
            <div><strong>Total Amount:</strong> £${orderData.total?.toFixed(2) || '0.00'}</div>
            <div><strong>Advance Paid:</strong> £${orderData.advancePayment?.toFixed(2) || orderData.submittedAmount?.toFixed(2) || '0.00'}</div>
            <div><strong>Remaining:</strong> £${orderData.remainingPayment?.toFixed(2) || '0.00'}</div>
            <div><strong>Payment Status:</strong> ${getPaymentStatusText(orderData.paymentStatus)}</div>
          </div>
        </div>
      </div>
      
      ${paymentDetailsHTML}
      
      <div class="modal-section">
        <h4><i class="fas fa-box"></i> Order Items</h4>
        ${itemsHTML || '<p>No items found</p>'}
      </div>
      
      ${shippingAddressHTML}
      
      <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
        <button onclick="downloadInvoice('${orderId}')" style="flex: 1;">
          <i class="fas fa-file-pdf"></i> Download Invoice
        </button>
        <button class="secondary" onclick="closeModal()" style="flex: 1;">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
    `;
    
  } catch (error) {
    console.error("Error viewing order:", error);
    document.getElementById("orderDetails").innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
        <h3>Error Loading Order</h3>
        <p>${error.message}</p>
      </div>
    `;
  }
};

function getCalculationInfo(item) {
  if (!item.calculationData) return `${item.quantity || 1} piece(s)`;
  
  const unit = item.calculationData.unit || 'piece';
  if (unit === 'sqft') {
    return `${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
  } else if (unit === 'sqm') {
    return `${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
  } else if (unit === 'weight') {
    return `${item.calculationData.weight || 1}kg`;
  }
  return `${item.quantity || 1} piece(s)`;
}

window.closeModal = function() {
  document.getElementById("orderModal").style.display = "none";
};

// ============================================
// INVOICE DOWNLOAD
// ============================================

window.downloadInvoice = async function(orderId) {
  try {
    // Find order data
    const order = orders.find(o => o.id === orderId);
    if (!order) {
      alert("Order not found");
      return;
    }
    
    // Create invoice window
    const win = window.open("", "_blank");
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Invoice - ${order.orderNumber}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 40px; }
          .invoice-header { text-align: center; margin-bottom: 30px; }
          .company { font-size: 24px; font-weight: bold; color: #131921; }
          .invoice-details { margin: 20px 0; }
          .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .table th, .table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
          .table th { background: #f8f9fa; }
          .total-row { font-weight: bold; background: #f8f9fa; }
          .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; }
        </style>
      </head>
      <body>
        <div class="invoice-header">
          <div class="company">IRYA STONE</div>
          <div>INVOICE</div>
        </div>
        
        <div class="invoice-details">
          <div><strong>Invoice Number:</strong> ${order.orderNumber}</div>
          <div><strong>Invoice Date:</strong> ${formatDate(order.createdAt)}</div>
          <div><strong>Customer:</strong> ${order.userName || 'Customer'}</div>
        </div>
        
        <table class="table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            ${order.items ? order.items.map(item => `
              <tr>
                <td>${item.name}</td>
                <td>${item.quantity || 1}</td>
                <td>£${item.price?.toFixed(2) || '0.00'}</td>
                <td>£${item.calculatedPrice?.toFixed(2) || item.totalPrice?.toFixed(2) || '0.00'}</td>
              </tr>
            `).join('') : ''}
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Subtotal:</td>
              <td>£${order.subtotal?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Shipping:</td>
              <td>£${order.shipping?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Tax:</td>
              <td>£${order.tax?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Grand Total:</td>
              <td>£${order.total?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Amount Paid:</td>
              <td>£${order.submittedAmount?.toFixed(2) || order.advancePayment?.toFixed(2) || '0.00'}</td>
            </tr>
            <tr class="total-row">
              <td colspan="3" style="text-align: right;">Balance Due:</td>
              <td>£${order.remainingPayment?.toFixed(2) || '0.00'}</td>
            </tr>
          </tbody>
        </table>
        
        <div class="footer">
          <p><strong>Payment Terms:</strong> ${order.paymentType === 'advance' ? '30% advance payment, 70% after shipping confirmation' : 'Full payment upfront'}</p>
          <p><strong>Payment Status:</strong> ${getPaymentStatusText(order.paymentStatus)}</p>
          <p>Thank you for your business!</p>
        </div>
      </body>
      </html>
    `);
    
    win.document.close();
    
    // Wait for content to load before printing
    setTimeout(() => {
      win.print();
    }, 500);
    
  } catch (error) {
    console.error("Error downloading invoice:", error);
    alert("Failed to generate invoice: " + error.message);
  }
};

// ============================================
// NOTIFICATIONS MANAGEMENT
// ============================================

async function loadNotifications() {
  try {
    const notificationList = document.getElementById("notificationList");
    
    // Get user ID
    userId = await getUserId();
    
    // Setup real-time notifications listener
    const notificationsRef = collection(db, "users", userId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"));
    
    if (notificationsUnsubscribe) notificationsUnsubscribe();
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery, (snapshot) => {
      notifications = [];
      let hasNotifications = false;
      
      notificationList.innerHTML = '';
      
      snapshot.forEach((doc) => {
        const note = doc.data();
        note.id = doc.id;
        notifications.push(note);
        hasNotifications = true;
        
        // Add notification to list
        const noteDiv = document.createElement('div');
        noteDiv.className = `note ${note.read ? '' : 'unread'}`;
        noteDiv.onclick = () => viewNotification(note.id, note.orderId);
        
        const timeAgo = getTimeAgo(note.createdAt);
        const noteType = note.type || 'order';
        
        noteDiv.innerHTML = `
          <div class="note-title">
            <span>${note.title || 'Notification'}</span>
            <span class="note-type ${noteType}">${noteType.toUpperCase()}</span>
          </div>
          <div class="note-message">${note.message || ''}</div>
          <div class="note-meta">
            <span class="note-time">${timeAgo}</span>
            ${note.read ? '' : '<span style="font-size: 10px; color: #ff9900;"><i class="fas fa-circle"></i></span>'}
          </div>
        `;
        
        notificationList.appendChild(noteDiv);
      });
      
      if (!hasNotifications) {
        notificationList.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <i class="fas fa-bell-slash" style="font-size: 36px; margin-bottom: 15px;"></i>
            <p>No notifications yet</p>
          </div>
        `;
      }
      
      // Update badge count
      updateNotificationBadge();
      
    }, (error) => {
      console.error("Error loading notifications:", error);
      notificationList.innerHTML = `
        <div style="text-align: center; padding: 20px; color: #666;">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Failed to load notifications</p>
        </div>
      `;
    });
    
  } catch (error) {
    console.error("Error in loadNotifications:", error);
  }
}

function updateNotificationBadge() {
  const unreadCount = notifications.filter(n => !n.read).length;
  const badge = document.getElementById("noteCount");
  
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
}

async function viewNotification(notificationId, orderId) {
  try {
    // Mark notification as read
    const notificationRef = doc(db, "users", userId, "notifications", notificationId);
    await updateDoc(notificationRef, {
      read: true,
      readAt: new Date().toISOString()
    });
    
    // Update local notification
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      updateNotificationBadge();
      
      // Update notification item in UI
      const noteElement = document.querySelector(`.note[onclick*="${notificationId}"]`);
      if (noteElement) {
        noteElement.classList.remove('unread');
      }
    }
    
    // If notification has orderId, open order details
    if (orderId) {
      closeNotifications();
      setTimeout(() => {
        viewOrder(orderId);
      }, 300);
    }
    
  } catch (error) {
    console.error("Error viewing notification:", error);
  }
}

async function markAllAsRead() {
  try {
    const batchPromises = notifications
      .filter(n => !n.read)
      .map(async (notification) => {
        const notificationRef = doc(db, "users", userId, "notifications", notification.id);
        await updateDoc(notificationRef, {
          read: true,
          readAt: new Date().toISOString()
        });
      });
    
    await Promise.all(batchPromises);
    
    // Update all local notifications
    notifications.forEach(n => n.read = true);
    updateNotificationBadge();
    
    // Update UI
    document.querySelectorAll('.note.unread').forEach(note => {
      note.classList.remove('unread');
    });
    
  } catch (error) {
    console.error("Error marking all as read:", error);
    alert("Failed to mark all notifications as read");
  }
}

async function clearNotifications() {
  try {
    if (confirm("Are you sure you want to clear all notifications?")) {
      const batchPromises = notifications.map(async (notification) => {
        const notificationRef = doc(db, "users", userId, "notifications", notification.id);
        await deleteDoc(notificationRef);
      });
      
      await Promise.all(batchPromises);
      
      notifications = [];
      updateNotificationBadge();
      document.getElementById("notificationList").innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <i class="fas fa-check-circle" style="font-size: 36px; margin-bottom: 15px;"></i>
          <p>All notifications cleared</p>
        </div>
      `;
    }
  } catch (error) {
    console.error("Error clearing notifications:", error);
    alert("Failed to clear notifications");
  }
}

function getTimeAgo(dateString) {
  if (!dateString) return 'Just now';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short'
    });
  } catch (error) {
    return dateString;
  }
}

// ============================================
// UI FUNCTIONS
// ============================================

window.toggleNotes = function() {
  const notesDiv = document.getElementById("notifications");
  if (notesDiv.style.display === "block") {
    notesDiv.style.display = "none";
  } else {
    notesDiv.style.display = "block";
    // Load notifications when opened
    if (notifications.length === 0) {
      loadNotifications();
    }
  }
};

function closeNotifications() {
  document.getElementById("notifications").style.display = "none";
}

// Close notifications when clicking outside
document.addEventListener('click', function(event) {
  const notesDiv = document.getElementById("notifications");
  const bell = document.querySelector('.bell');
  
  if (notesDiv && bell && !notesDiv.contains(event.target) && !bell.contains(event.target)) {
    notesDiv.style.display = "none";
  }
});

// ============================================
// INITIALIZE
// ============================================

// Initialize when page loads
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Get user ID first
    await getUserId();
    
    // Load orders
    await loadOrders();
    
    // Load notifications
    await loadNotifications();
    
    // Setup periodic refresh (every 5 minutes)
    setInterval(() => {
      console.log("Refreshing data...");
      loadOrders();
      loadNotifications();
    }, 5 * 60 * 1000);
    
  } catch (error) {
    console.error("Error initializing:", error);
  }
});

// Clean up listeners when page unloads
window.addEventListener('beforeunload', () => {
  if (ordersUnsubscribe) ordersUnsubscribe();
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

</script>

</body>
</html>
