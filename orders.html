<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Details | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Main CSS Variables */
:root {
    --primary-gold: #d4af37;
    --stone-dark: #2c3e50;
    --text-dark: #333;
    --text-light: #666;
}

/* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: #f5f7fa;
    color: var(--text-dark);
    line-height: 1.6;
}

.order-details-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Header with back button */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    color: var(--text-dark);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

/* Order Status Summary Card */
.status-summary-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.2);
    position: relative;
    overflow: hidden;
}

.status-summary-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    position: relative;
    z-index: 1;
}

.summary-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.summary-label {
    font-size: 14px;
    opacity: 0.9;
}

.summary-value {
    font-size: 18px;
    font-weight: 600;
}

/* Order Overview Cards */
.overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.overview-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease;
}

.overview-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.overview-card h3 {
    color: var(--stone-dark);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
}

/* Status Badges */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-processing { background: #cce5ff; color: #004085; }
.status-shipped { background: #d4edda; color: #155724; }
.status-delivered { background: #d1ecf1; color: #0c5460; }
.status-cancelled { background: #f8d7da; color: #721c24; }
.status-awaiting-payment { background: #fff3cd; color: #856404; }
.status-payment-verified { background: #d4edda; color: #155724; }

/* Detail Sections */
.detail-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.detail-section h2 {
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-label {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 500;
}

.detail-value {
    font-size: 15px;
    color: var(--text-dark);
    font-weight: 600;
}

.detail-value.gold {
    color: var(--primary-gold);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    flex-wrap: wrap;
}

.action-btn {
    padding: 15px 25px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    font-size: 14px;
}

.action-btn-primary {
    background: var(--primary-gold);
    color: white;
}

.action-btn-secondary {
    background: #6c757d;
    color: white;
}

.action-btn-info {
    background: #17a2b8;
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* Modal Popup for View Details */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 16px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
    border-radius: 16px 16px 0 0;
}

.modal-header h2 {
    margin: 0;
    color: var(--stone-dark);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-light);
    transition: color 0.3s;
}

.modal-close:hover {
    color: var(--primary-gold);
}

.modal-body {
    padding: 30px;
}

/* View Details Button */
.view-details-btn {
    background: var(--primary-gold);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-size: 14px;
}

.view-details-btn:hover {
    background: #c59d2d;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
}

/* Real-time Indicator */
.real-time-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.95);
    padding: 10px 15px;
    border-radius: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    z-index: 100;
    border: 1px solid #e0e0e0;
}

.real-time-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

/* Items Table */
.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.items-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: var(--stone-dark);
    border-bottom: 2px solid #e0e0e0;
}

.items-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Timeline */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    position: relative;
    padding-left: 40px;
    margin-bottom: 25px;
}

.timeline-dot {
    position: absolute;
    left: 0;
    top: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-gold);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid var(--primary-gold);
}

.timeline-time {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 5px;
}

/* Loading Animation */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .overview-cards {
        grid-template-columns: 1fr;
    }
    
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
        justify-content: center;
    }
    
    .modal-content {
        max-height: 80vh;
    }
}
</style>
</head>
<body>

<!-- Real-time Indicator -->
<div class="real-time-indicator" id="realTimeIndicator">
    <div class="real-time-dot"></div>
    <span>Live Updates Active</span>
</div>

<!-- Modal for View Details -->
<div class="modal-overlay" id="detailsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Order Details</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Modal content will be loaded here -->
        </div>
    </div>
</div>

<div class="order-details-container">
    <div class="page-header">
        <a href="orders.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Orders
        </a>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="refreshOrder()" class="back-btn">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button onclick="printOrder()" class="back-btn">
                <i class="fas fa-print"></i>
                Print
            </button>
        </div>
    </div>
    
    <!-- Current Position/Status Summary -->
    <div class="status-summary-card" id="currentStatusSection">
        <div class="summary-grid">
            <div class="summary-item">
                <div class="summary-label">CURRENT STATUS</div>
                <div class="summary-value" id="currentStatus">Loading...</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">ORDER NUMBER</div>
                <div class="summary-value" id="orderNumber">Loading...</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">LAST UPDATED</div>
                <div class="summary-value" id="lastUpdated">Loading...</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">NEXT STEP</div>
                <div class="summary-value" id="nextStep">Loading...</div>
            </div>
        </div>
    </div>
    
    <!-- Quick Overview Cards -->
    <div class="overview-cards">
        <div class="overview-card">
            <h3><i class="fas fa-box"></i> Order Items</h3>
            <div id="itemsOverview">Loading items...</div>
            <button onclick="showItemsDetails()" class="view-details-btn" style="margin-top: 15px;">
                <i class="fas fa-list"></i> View All Items
            </button>
        </div>
        
        <div class="overview-card">
            <h3><i class="fas fa-credit-card"></i> Payment Status</h3>
            <div id="paymentOverview">Loading payment info...</div>
            <button onclick="showPaymentDetails()" class="view-details-btn" style="margin-top: 15px;">
                <i class="fas fa-receipt"></i> Payment Details
            </button>
        </div>
        
        <div class="overview-card">
            <h3><i class="fas fa-shipping-fast"></i> Shipping Info</h3>
            <div id="shippingOverview">Loading shipping info...</div>
            <button onclick="showShippingDetails()" class="view-details-btn" style="margin-top: 15px;">
                <i class="fas fa-map-marker-alt"></i> View Address & Tracking
            </button>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div id="orderDetailsContent">
        <!-- Detailed content will be loaded here -->
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <button onclick="contactSupport()" class="action-btn action-btn-primary">
            <i class="fas fa-headset"></i>
            Contact Support
        </button>
        
        <button onclick="downloadInvoice()" class="action-btn action-btn-secondary">
            <i class="fas fa-file-pdf"></i>
            Download Invoice
        </button>
        
        <button onclick="trackOrder()" class="action-btn action-btn-info">
            <i class="fas fa-shipping-fast"></i>
            Track Order
        </button>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// Global variables
let orderId = null;
let currentOrderData = null;
let db = null;
let unsubscribeFunctions = [];
let modalOpen = false;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get order ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    orderId = urlParams.get('id');
    
    if (!orderId) {
        window.location.href = 'orders.html';
        return;
    }
    
    // Initialize Firebase
    initializeFirebase();
    
    // Load order details with real-time updates
    loadOrderDetails();
    
    // Setup real-time indicator
    setupRealtimeIndicator();
});

// Firebase configuration
function initializeFirebase() {
    const firebaseConfig = {
        apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
        authDomain: "iryastone-uk.firebaseapp.com",
        projectId: "iryastone-uk",
        storageBucket: "iryastone-uk.firebasestorage.app",
        messagingSenderId: "110940910896",
        appId: "1:110940910896:web:b25e92127118665e5c84f5",
        measurementId: "G-6YM1FLYN48"
    };
    
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    // Get Firestore instance
    db = firebase.firestore();
}

// 9 Ways to Update Order (Main Function)
async function loadOrderDetails() {
    try {
        const auth = firebase.auth();
        const user = auth.currentUser;
        const userId = user ? user.uid : localStorage.getItem('irya_guest_id');
        
        if (!userId) {
            showError('User not authenticated');
            return;
        }
        
        // Setup 9 different listeners for comprehensive updates
        setupAllListeners(userId);
        
    } catch (error) {
        console.error('Error loading order details:', error);
        showError(error.message);
    }
}

// Setup all 9 update methods
function setupAllListeners(userId) {
    // Clear previous listeners
    unsubscribeFunctions.forEach(unsub => unsub());
    unsubscribeFunctions = [];
    
    // 1. Main Order Document Listener (Primary)
    const orderRef = db.collection('users').doc(userId).collection('orders').doc(orderId);
    const unsubscribe1 = orderRef.onSnapshot(async (orderDoc) => {
        if (orderDoc.exists) {
            const orderData = orderDoc.data();
            orderData.id = orderDoc.id;
            currentOrderData = orderData;
            
            // Update current position
            updateCurrentPosition(orderData);
            
            // Update overview cards
            updateOverviewCards(orderData);
            
            // Show notification for major changes
            detectAndNotifyChanges(orderData);
            
        } else {
            // Try main orders collection
            tryMainOrdersCollection();
        }
    }, (error) => {
        console.error('Error in main order listener:', error);
        setupFallbackListeners(userId);
    });
    
    unsubscribeFunctions.push(unsubscribe1);
    
    // 2. Status Changes Listener
    const statusRef = orderRef.collection('status_updates').orderBy('timestamp', 'desc').limit(5);
    const unsubscribe2 = statusRef.onSnapshot((snapshot) => {
        if (!snapshot.empty) {
            updateStatusTimeline(snapshot.docs);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe2);
    
    // 3. Payment Updates Listener
    const paymentRef = orderRef.collection('payment_updates').orderBy('timestamp', 'desc').limit(3);
    const unsubscribe3 = paymentRef.onSnapshot((snapshot) => {
        if (!snapshot.empty && currentOrderData) {
            updatePaymentOverview(currentOrderData);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe3);
    
    // 4. Shipping Updates Listener
    const shippingRef = orderRef.collection('shipping_updates').orderBy('timestamp', 'desc').limit(3);
    const unsubscribe4 = shippingRef.onSnapshot((snapshot) => {
        if (!snapshot.empty && currentOrderData) {
            updateShippingOverview(currentOrderData);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe4);
    
    // 5. Real-time Counter Updates
    setupRealtimeCounters(userId);
    
    // 6. Activity Log Listener
    const activityRef = db.collection('order_activities')
        .where('orderId', '==', orderId)
        .orderBy('createdAt', 'desc')
        .limit(10);
    
    const unsubscribe6 = activityRef.onSnapshot((snapshot) => {
        if (!snapshot.empty) {
            updateActivityLog(snapshot.docs);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe6);
    
    // 7. Estimated Delivery Updates
    const deliveryRef = orderRef.collection('delivery_updates');
    const unsubscribe7 = deliveryRef.onSnapshot((snapshot) => {
        if (!snapshot.empty && currentOrderData) {
            updateDeliveryEstimates(snapshot.docs[0].data());
        }
    });
    
    unsubscribeFunctions.push(unsubscribe7);
    
    // 8. Support Messages Listener
    const supportRef = orderRef.collection('support_messages')
        .where('status', '==', 'open')
        .limit(5);
    
    const unsubscribe8 = supportRef.onSnapshot((snapshot) => {
        if (!snapshot.empty) {
            updateSupportStatus(snapshot.size);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe8);
    
    // 9. Inventory/Stock Updates Listener
    if (currentOrderData && currentOrderData.items) {
        currentOrderData.items.forEach((item, index) => {
            if (item.productId) {
                const inventoryRef = db.collection('products').doc(item.productId);
                const unsubscribe9 = inventoryRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        updateItemStockInfo(item, doc.data());
                    }
                });
                
                unsubscribeFunctions.push(unsubscribe9);
            }
        });
    }
}

// Try main orders collection as fallback
function tryMainOrdersCollection() {
    const mainOrderRef = db.collection('orders').doc(orderId);
    const unsubscribe = mainOrderRef.onSnapshot((orderDoc) => {
        if (orderDoc.exists) {
            const orderData = orderDoc.data();
            orderData.id = orderDoc.id;
            currentOrderData = orderData;
            updateCurrentPosition(orderData);
            updateOverviewCards(orderData);
        } else {
            showOrderNotFound();
        }
    });
    
    unsubscribeFunctions.push(unsubscribe);
}

// Setup fallback listeners if primary fails
function setupFallbackListeners(userId) {
    // Simple polling as fallback
    const pollInterval = setInterval(async () => {
        try {
            const orderDoc = await db.collection('users').doc(userId)
                .collection('orders').doc(orderId).get();
            
            if (orderDoc.exists) {
                const orderData = orderDoc.data();
                orderData.id = orderDoc.id;
                currentOrderData = orderData;
                updateCurrentPosition(orderData);
                updateOverviewCards(orderData);
            }
        } catch (error) {
            console.error('Polling error:', error);
        }
    }, 30000); // Poll every 30 seconds
    
    unsubscribeFunctions.push(() => clearInterval(pollInterval));
}

// Setup real-time counters
function setupRealtimeCounters(userId) {
    // Counter for updates
    let updateCount = 0;
    const counterElement = document.createElement('div');
    counterElement.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #28a745; color: white; padding: 5px 10px; border-radius: 12px; font-size: 12px; z-index: 1000;';
    
    // Listen for all document changes
    const changesRef = db.collection('users').doc(userId)
        .collection('orders').doc(orderId)
        .collection('changes').orderBy('timestamp', 'desc').limit(1);
    
    const unsubscribe = changesRef.onSnapshot((snapshot) => {
        if (!snapshot.empty) {
            updateCount++;
            counterElement.textContent = `Updates: ${updateCount}`;
            document.body.appendChild(counterElement);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (counterElement.parentNode) {
                    counterElement.parentNode.removeChild(counterElement);
                }
            }, 3000);
        }
    });
    
    unsubscribeFunctions.push(unsubscribe);
}

// Update Current Position (Main Display)
function updateCurrentPosition(orderData) {
    // Update status summary card
    document.getElementById('currentStatus').innerHTML = `
        <span class="status-badge status-${getStatusClass(orderData.status)}">
            <i class="fas ${getStatusIcon(orderData.status)}"></i>
            ${getStatusText(orderData.status)}
        </span>
    `;
    
    document.getElementById('orderNumber').textContent = orderData.orderNumber || orderData.id;
    document.getElementById('lastUpdated').textContent = formatDate(orderData.updatedAt || orderData.createdAt);
    document.getElementById('nextStep').textContent = getNextStep(orderData.status);
    
    // Update main content
    updateMainContent(orderData);
}

// Update Overview Cards
function updateOverviewCards(orderData) {
    // Items Overview
    document.getElementById('itemsOverview').innerHTML = `
        <div style="font-size: 14px;">
            <div><strong>${orderData.items?.length || 0} Items</strong></div>
            <div style="color: var(--text-light); margin-top: 5px;">
                Total: £${orderData.total?.toFixed(2) || '0.00'}
            </div>
            ${orderData.items ? `
                <div style="margin-top: 10px;">
                    ${orderData.items.slice(0, 2).map(item => `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${item.name}</span>
                            <span>£${item.calculatedPrice?.toFixed(2) || '0.00'}</span>
                        </div>
                    `).join('')}
                    ${orderData.items.length > 2 ? `<div style="color: var(--primary-gold); font-size: 12px;">+${orderData.items.length - 2} more items</div>` : ''}
                </div>
            ` : ''}
        </div>
    `;
    
    // Payment Overview
    updatePaymentOverview(orderData);
    
    // Shipping Overview
    updateShippingOverview(orderData);
}

function updatePaymentOverview(orderData) {
    document.getElementById('paymentOverview').innerHTML = `
        <div style="font-size: 14px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <span class="status-badge status-${getPaymentStatusClass(orderData.paymentStatus)}">
                    ${getPaymentStatusText(orderData.paymentStatus)}
                </span>
            </div>
            <div style="color: var(--text-light);">
                <div>Method: ${orderData.paymentMethod || 'Bank Transfer'}</div>
                <div>Amount: £${orderData.total?.toFixed(2) || '0.00'}</div>
                ${orderData.paymentVerifiedAt ? `
                    <div>Verified: ${formatDate(orderData.paymentVerifiedAt)}</div>
                ` : ''}
            </div>
        </div>
    `;
}

function updateShippingOverview(orderData) {
    let shippingHtml = '<div style="font-size: 14px;">';
    
    if (orderData.tracking) {
        shippingHtml += `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-shipping-fast" style="color: #28a745;"></i>
                <span>Shipped</span>
            </div>
            <div style="color: var(--text-light);">
                <div>Tracking: ${orderData.tracking.number || 'N/A'}</div>
                ${orderData.shippedAt ? `<div>Shipped: ${formatDate(orderData.shippedAt)}</div>` : ''}
            </div>
        `;
    } else if (orderData.shippingAddress) {
        shippingHtml += `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-clock" style="color: #ffc107;"></i>
                <span>Ready to Ship</span>
            </div>
            <div style="color: var(--text-light);">
                <div>${orderData.shippingAddress.city}, ${orderData.shippingAddress.country}</div>
                <div>Estimated: 3-5 business days</div>
            </div>
        `;
    } else {
        shippingHtml += `
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <i class="fas fa-info-circle" style="color: #6c757d;"></i>
                <span>Shipping info pending</span>
            </div>
        `;
    }
    
    shippingHtml += '</div>';
    document.getElementById('shippingOverview').innerHTML = shippingHtml;
}

// Update Main Content
function updateMainContent(orderData) {
    const content = document.getElementById('orderDetailsContent');
    
    content.innerHTML = `
        <!-- Detailed Order Information -->
        <div class="detail-section">
            <h2><i class="fas fa-info-circle"></i> Order Information</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Order Date</div>
                    <div class="detail-value">${formatDate(orderData.createdAt)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Customer Name</div>
                    <div class="detail-value">${orderData.userName || 'Customer'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Customer Email</div>
                    <div class="detail-value">${orderData.userEmail || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Type</div>
                    <div class="detail-value">${orderData.paymentType === 'advance' ? '30% Advance Payment' : 'Full Payment'}</div>
                </div>
            </div>
        </div>
        
        <!-- Quick Timeline -->
        <div class="detail-section">
            <h2><i class="fas fa-history"></i> Recent Activity</h2>
            <div class="timeline" id="quickTimeline">
                <div class="timeline-item">
                    <div class="timeline-dot"><i class="fas fa-shopping-cart"></i></div>
                    <div class="timeline-content">
                        <div>Order placed successfully</div>
                        <div class="timeline-time">${formatDate(orderData.createdAt)}</div>
                    </div>
                </div>
                ${orderData.paymentVerifiedAt ? `
                <div class="timeline-item">
                    <div class="timeline-dot"><i class="fas fa-check-circle"></i></div>
                    <div class="timeline-content">
                        <div>Payment verified</div>
                        <div class="timeline-time">${formatDate(orderData.paymentVerifiedAt)}</div>
                    </div>
                </div>
                ` : ''}
                ${orderData.shippedAt ? `
                <div class="timeline-item">
                    <div class="timeline-dot"><i class="fas fa-shipping-fast"></i></div>
                    <div class="timeline-content">
                        <div>Order shipped</div>
                        <div class="timeline-time">${formatDate(orderData.shippedAt)}</div>
                    </div>
                </div>
                ` : ''}
            </div>
            <button onclick="showFullTimeline()" class="view-details-btn" style="margin-top: 15px;">
                <i class="fas fa-expand"></i> View Full Timeline
            </button>
        </div>
    `;
}

// Modal Functions
function showItemsDetails() {
    if (!currentOrderData) return;
    
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modal = document.getElementById('detailsModal');
    
    modalTitle.textContent = 'Order Items Details';
    modalBody.innerHTML = `
        <div style="overflow-x: auto;">
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${(currentOrderData.items || []).map(item => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-image">
                                        <img src="${item.image || 'https://via.placeholder.com/60'}" 
                                             alt="${item.name}">
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${item.name}</div>
                                        <div style="font-size: 13px; color: var(--text-light);">${item.category || 'General'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 13px;">
                                    ${item.calculationData ? getCalculationInfo(item) : `Standard item`}
                                    ${item.customRequirements ? `<div style="color: var(--primary-gold); margin-top: 5px;"><i class="fas fa-edit"></i> Custom requirements</div>` : ''}
                                </div>
                            </td>
                            <td>${item.quantity || 1}</td>
                            <td>£${item.price?.toFixed(2) || '0.00'}</td>
                            <td class="detail-value gold">£${item.calculatedPrice?.toFixed(2) || '0.00'}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: 600;">Subtotal:</td>
                        <td>£${currentOrderData.subtotal?.toFixed(2) || '0.00'}</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: 600;">Shipping:</td>
                        <td>${currentOrderData.shipping === 0 ? 'FREE' : `£${currentOrderData.shipping?.toFixed(2) || '0.00'}`}</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: 600;">Tax:</td>
                        <td>£${currentOrderData.tax?.toFixed(2) || '0.00'}</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align: right; font-weight: 600; font-size: 16px;">Total:</td>
                        <td class="detail-value gold" style="font-size: 16px;">£${currentOrderData.total?.toFixed(2) || '0.00'}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    modal.style.display = 'flex';
    modalOpen = true;
    document.body.style.overflow = 'hidden';
}

function showPaymentDetails() {
    if (!currentOrderData) return;
    
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modal = document.getElementById('detailsModal');
    
    modalTitle.textContent = 'Payment Details';
    
    let bankDetailsHtml = '';
    if (currentOrderData.paymentMethod === 'bank' && currentOrderData.bankTransferDetails) {
        bankDetailsHtml = `
            <div class="detail-section" style="margin-top: 20px;">
                <h3><i class="fas fa-university"></i> Bank Transfer Details</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Account Name</div>
                        <div class="detail-value">${currentOrderData.bankTransferDetails.accountName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Account Number</div>
                        <div class="detail-value">${currentOrderData.bankTransferDetails.accountNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sort Code</div>
                        <div class="detail-value">${currentOrderData.bankTransferDetails.sortCode}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reference</div>
                        <div class="detail-value gold">${currentOrderData.bankTransferDetails.reference}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Amount to Pay</div>
                        <div class="detail-value gold">£${currentOrderData.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div class="detail-grid">
            <div class="detail-item">
                <div class="detail-label">Payment Status</div>
                <div class="detail-value">
                    <span class="status-badge status-${getPaymentStatusClass(currentOrderData.paymentStatus)}">
                        ${getPaymentStatusText(currentOrderData.paymentStatus)}
                    </span>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Payment Method</div>
                <div class="detail-value">${currentOrderData.paymentMethod || 'Bank Transfer'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Payment Type</div>
                <div class="detail-value">${currentOrderData.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Subtotal</div>
                <div class="detail-value">£${currentOrderData.subtotal?.toFixed(2) || '0.00'}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Shipping</div>
                <div class="detail-value">${currentOrderData.shipping === 0 ? 'FREE' : `£${currentOrderData.shipping?.toFixed(2) || '0.00'}`}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Tax</div>
                <div class="detail-value">£${currentOrderData.tax?.toFixed(2) || '0.00'}</td>
            </div>
            <div class="detail-item">
                <div class="detail-label">Total Amount</div>
                <div class="detail-value gold">£${currentOrderData.total?.toFixed(2) || '0.00'}</div>
            </div>
            ${currentOrderData.paymentVerifiedAt ? `
            <div class="detail-item">
                <div class="detail-label">Payment Verified</div>
                <div class="detail-value">${formatDate(currentOrderData.paymentVerifiedAt)}</div>
            </div>
            ` : ''}
            ${currentOrderData.paymentVerifiedBy ? `
            <div class="detail-item">
                <div class="detail-label">Verified By</div>
                <div class="detail-value">${currentOrderData.paymentVerifiedBy}</div>
            </div>
            ` : ''}
        </div>
        ${bankDetailsHtml}
    `;
    
    modal.style.display = 'flex';
    modalOpen = true;
    document.body.style.overflow = 'hidden';
}

function showShippingDetails() {
    if (!currentOrderData) return;
    
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modal = document.getElementById('detailsModal');
    
    modalTitle.textContent = 'Shipping & Tracking Details';
    
    let shippingAddressHtml = 'No shipping address provided';
    if (currentOrderData.shippingAddress) {
        shippingAddressHtml = `
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                <p style="font-weight: 600; margin-bottom: 10px;">${currentOrderData.shippingAddress.fullName}</p>
                <p>${currentOrderData.shippingAddress.address1}</p>
                ${currentOrderData.shippingAddress.address2 ? `<p>${currentOrderData.shippingAddress.address2}</p>` : ''}
                <p>${currentOrderData.shippingAddress.city}, ${currentOrderData.shippingAddress.state} ${currentOrderData.shippingAddress.postalCode}</p>
                <p>${currentOrderData.shippingAddress.country}</p>
                <p style="margin-top: 10px;"><strong>Phone:</strong> ${currentOrderData.shippingAddress.phone || 'N/A'}</p>
                ${currentOrderData.shippingAddress.instructions ? `
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                        <strong>Special Instructions:</strong>
                        <p>${currentOrderData.shippingAddress.instructions}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    let trackingHtml = '';
    if (currentOrderData.tracking) {
        trackingHtml = `
            <div class="detail-section">
                <h3><i class="fas fa-shipping-fast"></i> Tracking Information</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Tracking Number</div>
                        <div class="detail-value gold">${currentOrderData.tracking.number}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Carrier</div>
                        <div class="detail-value">${currentOrderData.tracking.carrier || 'Standard Shipping'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Shipping Date</div>
                        <div class="detail-value">${currentOrderData.shippedAt ? formatDate(currentOrderData.shippedAt) : 'Not shipped yet'}</div>
                    </div>
                    ${currentOrderData.estimatedDelivery ? `
                    <div class="detail-item">
                        <div class="detail-label">Estimated Delivery</div>
                        <div class="detail-value">${formatDate(currentOrderData.estimatedDelivery)}</div>
                    </div>
                    ` : ''}
                    ${currentOrderData.deliveredAt ? `
                    <div class="detail-item">
                        <div class="detail-label">Delivered On</div>
                        <div class="detail-value gold">${formatDate(currentOrderData.deliveredAt)}</div>
                    </div>
                    ` : ''}
                </div>
                ${currentOrderData.tracking.url ? `
                    <div style="margin-top: 20px;">
                        <a href="${currentOrderData.tracking.url}" target="_blank" 
                           style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 20px; 
                                  background: var(--primary-gold); color: white; text-decoration: none; 
                                  border-radius: 8px; font-weight: 600;">
                            <i class="fas fa-external-link-alt"></i>
                            Track Package
                        </a>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    modalBody.innerHTML = `
        <div class="detail-section">
            <h3><i class="fas fa-map-marker-alt"></i> Shipping Address</h3>
            ${shippingAddressHtml}
        </div>
        ${trackingHtml}
    `;
    
    modal.style.display = 'flex';
    modalOpen = true;
    document.body.style.overflow = 'hidden';
}

function showFullTimeline() {
    // This would show the full timeline in modal
    // Implementation depends on your timeline data structure
    alert('Full timeline feature would show complete order history');
}

function closeModal() {
    const modal = document.getElementById('detailsModal');
    modal.style.display = 'none';
    modalOpen = false;
    document.body.style.overflow = 'auto';
}

// Close modal when clicking outside
document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modalOpen) {
        closeModal();
    }
});

// Helper Functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function getStatusClass(status) {
    const classMap = {
        'pending': 'pending',
        'pending_bank_transfer': 'awaiting-payment',
        'payment_submitted': 'processing',
        'payment_verified': 'payment-verified',
        'processing': 'processing',
        'shipped': 'shipped',
        'delivered': 'delivered',
        'cancelled': 'cancelled'
    };
    return classMap[status] || 'pending';
}

function getStatusIcon(status) {
    const iconMap = {
        'pending': 'fa-clock',
        'pending_bank_transfer': 'fa-money-bill-wave',
        'payment_submitted': 'fa-paper-plane',
        'payment_verified': 'fa-check-circle',
        'processing': 'fa-cog',
        'shipped': 'fa-shipping-fast',
        'delivered': 'fa-check-double',
        'cancelled': 'fa-times-circle'
    };
    return iconMap[status] || 'fa-clock';
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'paid': 'Paid',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || 'Pending';
}

function getPaymentStatusClass(status) {
    const classMap = {
        'pending_bank_transfer': 'awaiting-payment',
        'payment_submitted': 'processing',
        'payment_verified': 'payment-verified',
        'paid': 'delivered',
        'cancelled': 'cancelled'
    };
    return classMap[status] || 'pending';
}

function getNextStep(status) {
    const nextSteps = {
        'pending': 'Wait for order confirmation',
        'pending_bank_transfer': 'Complete payment to proceed',
        'payment_submitted': 'Wait for payment verification',
        'payment_verified': 'Order will be processed soon',
        'processing': 'Your order is being prepared',
        'shipped': 'Track your shipment',
        'delivered': 'Enjoy your purchase!',
        'cancelled': 'Order was cancelled'
    };
    return nextSteps[status] || 'Processing your order';
}

function getCalculationInfo(item) {
    if (!item.calculationData) return `Quantity: ${item.quantity || 1} pieces`;
    
    const unit = item.calculationData.unit || 'piece';
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1}kg`;
    } else {
        return `Quantity: ${item.quantity || 1} pieces`;
    }
}

// Action Functions
function refreshOrder() {
    if (unsubscribeFunctions.length > 0) {
        unsubscribeFunctions.forEach(unsub => unsub());
        unsubscribeFunctions = [];
    }
    
    loadOrderDetails();
    
    // Show refresh animation
    const refreshBtn = document.querySelector('button[onclick="refreshOrder()"]');
    const originalHTML = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        refreshBtn.innerHTML = originalHTML;
        refreshBtn.disabled = false;
    }, 1000);
}

function downloadInvoice() {
    if (!currentOrderData) {
        alert('Please wait for order data to load');
        return;
    }
    
    // Generate invoice (simplified - in real app, generate PDF)
    const invoiceData = {
        orderId: currentOrderData.id,
        orderNumber: currentOrderData.orderNumber,
        date: new Date().toLocaleDateString(),
        customer: currentOrderData.userName,
        items: currentOrderData.items,
        subtotal: currentOrderData.subtotal,
        shipping: currentOrderData.shipping,
        tax: currentOrderData.tax,
        total: currentOrderData.total
    };
    
    // Create download link
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(invoiceData, null, 2));
    const downloadAnchor = document.createElement('a');
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", `invoice_${currentOrderData.orderNumber}.json`);
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    document.body.removeChild(downloadAnchor);
    
    alert('Invoice download started. In production, this would generate a PDF.');
}

function contactSupport() {
    const subject = `Support Request - Order: ${currentOrderData?.orderNumber || orderId}`;
    const body = `Order Number: ${currentOrderData?.orderNumber || orderId}\n\nIssue Description:\n\n`;
    window.location.href = `mailto:support@iryastone.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

function trackOrder() {
    if (!currentOrderData || !currentOrderData.tracking?.url) {
        alert('Tracking information is not available yet.');
        return;
    }
    
    window.open(currentOrderData.tracking.url, '_blank');
}

function printOrder() {
    window.print();
}

function setupRealtimeIndicator() {
    // This function sets up the real-time indicator
    // In a real implementation, you might want to update this based on connection status
    const indicator = document.getElementById('realTimeIndicator');
    
    // Simulate connection status
    setInterval(() => {
        const dot = indicator.querySelector('.real-time-dot');
        dot.style.animation = 'none';
        setTimeout(() => {
            dot.style.animation = 'pulse 2s infinite';
        }, 10);
    }, 10000);
}

// Detect and notify changes
function detectAndNotifyChanges(newOrderData) {
    if (!currentOrderData) return;
    
    const changes = [];
    
    // Check status changes
    if (currentOrderData.status !== newOrderData.status) {
        changes.push({
            type: 'status',
            from: currentOrderData.status,
            to: newOrderData.status,
            message: `Order status changed from ${getStatusText(currentOrderData.status)} to ${getStatusText(newOrderData.status)}`
        });
    }
    
    // Check payment status changes
    if (currentOrderData.paymentStatus !== newOrderData.paymentStatus) {
        changes.push({
            type: 'payment',
            from: currentOrderData.paymentStatus,
            to: newOrderData.paymentStatus,
            message: `Payment status updated to ${getPaymentStatusText(newOrderData.paymentStatus)}`
        });
    }
    
    // Check tracking updates
    if (!currentOrderData.tracking && newOrderData.tracking) {
        changes.push({
            type: 'tracking',
            message: 'Tracking information has been added to your order'
        });
    }
    
    // Show notifications for significant changes
    if (changes.length > 0) {
        showChangeNotifications(changes);
    }
}

function showChangeNotifications(changes) {
    changes.forEach(change => {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            border-left: 4px solid var(--primary-gold);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        let icon = 'fa-info-circle';
        if (change.type === 'status') icon = 'fa-exchange-alt';
        if (change.type === 'payment') icon = 'fa-credit-card';
        if (change.type === 'tracking') icon = 'fa-shipping-fast';
        
        notification.innerHTML = `
            <i class="fas ${icon}" style="color: var(--primary-gold);"></i>
            <div>
                <div style="font-weight: 600; font-size: 14px;">Order Updated</div>
                <div style="font-size: 13px; margin-top: 5px;">${change.message}</div>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Remove after 5 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 5000);
    });
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Error handling
function showError(message) {
    document.getElementById('orderDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 50px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
            <h2>Error Loading Order</h2>
            <p>${message}</p>
            <button onclick="refreshOrder()" class="back-btn" style="margin-top: 20px;">
                <i class="fas fa-sync-alt"></i>
                Try Again
            </button>
        </div>
    `;
}

function showOrderNotFound() {
    document.getElementById('orderDetailsContent').innerHTML = `
        <div style="text-align: center; padding: 50px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 20px;"></i>
            <h2>Order Not Found</h2>
            <p>This order does not exist or you don't have permission to view it.</p>
            <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i>
                Back to Orders
            </a>
        </div>
    `;
}

// Clean up when leaving page
window.addEventListener('beforeunload', function() {
    unsubscribeFunctions.forEach(unsub => unsub());
});
</script>
</body>
</html>
