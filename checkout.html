<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Checkout | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  margin:0;
}
.container{
  max-width:1100px;
  margin:30px auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
}
h1{
  margin-bottom:20px;
}
.checkout-grid{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}
.product{
  display:flex;
  gap:15px;
  border-bottom:1px solid #eee;
  padding:10px 0;
}
.product img{
  width:80px;
  height:80px;
  object-fit:cover;
  border-radius:6px;
}
.summary{
  background:#fafafa;
  padding:15px;
  border-radius:10px;
}
.total{
  font-size:18px;
  font-weight:bold;
}
button{
  background:#000;
  color:#fff;
  padding:12px;
  border:none;
  width:100%;
  border-radius:6px;
  cursor:pointer;
  margin-top:10px;
}
#card-element{
  padding:12px;
  border:1px solid #ccc;
  border-radius:6px;
}
</style>
</head>
<body>

<div class="container">
  <h1>Checkout</h1>

  <div class="checkout-grid">

    <!-- CART ITEMS -->
    <div>
      <h3>Your Items</h3>
      <div id="cartItems"></div>
    </div>

    <!-- SUMMARY -->
    <div class="summary">
      <h3>Order Summary</h3>
      <p>Subtotal: £<span id="subtotal">0</span></p>
      <p>Advance (30%): £<span id="advance">0</span></p>
      <p class="total">Pay Now: £<span id="payNow">0</span></p>

      <form id="payment-form">
        <div id="card-element"></div>
        <button id="payBtn">Pay Securely</button>
        <p id="payment-message"></p>
      </form>
    </div>

  </div>
</div>

<script type="module">
// ================= FIREBASE =================
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
// ================= AUTH SYSTEM =================
// Existing CheckoutAuthSystem will be used
const authSystem = new CheckoutAuthSystem();
let currentUserId = null;
let subtotal = 0;

async function loadCheckout() {
  // INIT AUTH (LOGIN / GUEST)
  const user = await authSystem.init();
  currentUserId = authSystem.getUserId();

  const container = document.getElementById('cartItems');
  container.innerHTML = '';
  subtotal = 0;

  // ================= BUY NOW ITEMS =================
  const buyNowSnap = await getDocs(collection(db, 'buyNowItems'));
  buyNowSnap.forEach(docSnap => {
    const item = docSnap.data();
    if(item.userId === currentUserId && item.isBuyNow === true){
      const price = (item.price || 0) * (item.quantity || 1);
      subtotal += price;

      container.innerHTML += `
        <div class="product">
          <img src="${item.image}" />
          <div>
            <strong>${item.name}</strong><br>
            Buy Now Item<br>
            Qty: ${item.quantity}<br>
            £${price}
          </div>
        </div>`;
    }
  });

  // ================= CART ITEMS =================
  const cartRef = doc(db,'users',currentUserId,'userCarts','cart');
  const cartSnap = await getDoc(cartRef);

  if(cartSnap.exists()){
    const items = cartSnap.data().items || [];
    items.forEach(item => {
      const price = (item.price || 0) * (item.quantity || 1);
      subtotal += price;

      container.innerHTML += `
        <div class="product">
          <img src="${item.image}" />
          <div>
            <strong>${item.name}</strong><br>
            Cart Item<br>
            Qty: ${item.quantity}<br>
            £${price}
          </div>
        </div>`;
    });
  }

  const advance = subtotal * 0.3;
  document.getElementById('subtotal').innerText = subtotal.toFixed(2);
  document.getElementById('advance').innerText = advance.toFixed(2);
  document.getElementById('payNow').innerText = advance.toFixed(2);
}

loadCheckout();

  const cartRef = doc(db,'users',user.uid,'userCarts','cart');
  const snap = await getDoc(cartRef);
  if(!snap.exists()) return;

  const items = snap.data().items || [];
  const container = document.getElementById('cartItems');

  items.forEach(item => {
    const price = (item.price || 0) * (item.quantity || 1);
    subtotal += price;

    container.innerHTML += `
      <div class="product">
        <img src="${item.image}" />
        <div>
          <strong>${item.name}</strong><br>
          Qty: ${item.quantity}<br>
          £${price}
        </div>
      </div>`;
  });

  const advance = subtotal * 0.3;

  document.getElementById('subtotal').innerText = subtotal.toFixed(2);
  document.getElementById('advance').innerText = advance.toFixed(2);
  document.getElementById('payNow').innerText = advance.toFixed(2);
}

loadCheckout();

// ================= PAYMENT =================
document.getElementById('payment-form').addEventListener('submit', async (e)=>{
  e.preventDefault();

  document.getElementById('payment-message').innerText = 'Processing payment...';

  // CALL YOUR BACKEND TO CREATE PAYMENT INTENT
  const res = await fetch('/create-payment-intent',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ amount: Math.round(subtotal * 0.3 * 100) })
  });

  const { clientSecret } = await res.json();

  const result = await stripe.confirmCardPayment(clientSecret,{
    payment_method:{ card }
  });

  if(result.error){
    document.getElementById('payment-message').innerText = result.error.message;
  } else {
    document.getElementById('payment-message').innerText = 'Payment Successful ✅';
    // redirect or update order status
  }
});
</script>
</body>
</html>
