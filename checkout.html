<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* All CSS remains same as before */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header - Hide/Show on Scroll */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
    transition: transform 0.3s ease;
    transform: translateY(0);
}

header.hidden {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Checkout Container */
.checkout-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
}

/* Checkout Sections */
.checkout-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.section-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
}

.section-header i {
    color: var(--primary-gold);
    font-size: 18px;
}

/* Address Form */
.address-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: " *";
    color: #ff4757;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* Saved Address */
.saved-address {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
}

.saved-address:hover {
    border-color: var(--primary-gold);
}

.saved-address.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.address-type {
    display: inline-block;
    background: var(--primary-gold);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    margin-bottom: 10px;
}

.address-details {
    font-size: 14px;
    line-height: 1.5;
}

.address-details .name {
    font-weight: 600;
    margin-bottom: 5px;
}

/* Order Summary */
.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
}

.order-item-name {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 15px;
}

.order-item-info {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
}

.order-item-quantity {
    font-size: 13px;
    color: var(--text-light);
}

/* Price Breakdown */
.price-breakdown {
    margin-bottom: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.price-row:last-child {
    border-bottom: none;
}

.price-row.total {
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-gold);
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
}

.price-label {
    color: var(--text-dark);
}

.price-value {
    font-weight: 600;
}

/* Payment Options */
.payment-options {
    margin: 20px 0;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 10px;
}

.payment-options h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-options h4 i {
    color: var(--primary-gold);
}

.payment-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    background: var(--white);
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    transition: var(--transition);
}

.payment-option:hover {
    border-color: var(--gold-light);
}

.payment-option.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-option input[type="radio"] {
    accent-color: var(--primary-gold);
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.payment-option label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-dark);
    flex: 1;
}

.payment-option i {
    color: var(--primary-gold);
    font-size: 16px;
}

.payment-details {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 5px;
    margin-left: 30px;
}

/* Payment Breakdown */
.payment-breakdown {
    background: var(--bg-light);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 1px solid #e0e0e0;
}

.payment-breakdown h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-breakdown h4 i {
    color: var(--primary-gold);
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e0e0e0;
}

.payment-item:last-child {
    border-bottom: none;
    font-weight: 600;
    color: var(--primary-gold);
    padding-top: 10px;
    margin-top: 5px;
    border-top: 2px solid #e0e0e0;
}

.payment-label {
    color: var(--text-dark);
    font-size: 14px;
}

.payment-amount {
    font-weight: 600;
    font-size: 14px;
}

/* Custom Requirements */
.custom-requirements-box {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-gold);
}

.custom-requirements-box h5 {
    font-size: 14px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-requirements-box h5 i {
    color: var(--primary-gold);
    font-size: 14px;
}

.custom-requirements-text {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.5;
    background: var(--white);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

/* Payment Methods */
.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
}

.payment-method:hover {
    border-color: var(--primary-gold);
}

.payment-method.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-gold);
    font-size: 20px;
}

.payment-info {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.payment-description {
    font-size: 12px;
    color: var(--text-light);
}

/* Stripe Card Element */
.stripe-card-element {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    background: var(--white);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.action-btn-large {
    flex: 1;
    padding: 16px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 16px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
    border: 2px solid #e0e0e0;
}

.btn-secondary:hover {
    background: #f0f0f0;
    border-color: var(--primary-gold);
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    display: none;
}

.notification.show {
    transform: translateX(0);
    display: block;
}

/* Bottom Navigation - Hide/Show on Scroll */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.bottom-nav.hidden {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive */
@media (max-width: 992px) {
    .checkout-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }
    
    .address-form {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .checkout-section {
        padding: 20px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .payment-option {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .payment-details {
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .checkout-container {
        padding: 20px 12px;
    }
    
    .payment-method {
        flex-direction: column;
        text-align: center;
    }
    
    .payment-icon {
        width: 35px;
        height: 35px;
        font-size: 18px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Payment Processing Modal -->
<div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
        <div id="paymentSpinner" class="loading-spinner" style="position: relative; top: 0; left: 0; transform: none; margin: 0 auto 20px;"></div>
        <h3 id="paymentTitle" style="margin-bottom: 15px;">Processing Payment</h3>
        <p id="paymentMessage">Please wait while we process your payment...</p>
        <div id="paypalButtonContainer" style="margin-top: 20px;"></div>
        <button id="cancelPayment" onclick="cancelPayment()" style="margin-top: 20px; padding: 10px 20px; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Cancel Payment
        </button>
    </div>
</div>

<!-- Header -->
<header id="mainHeader">
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="products.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item">
            <a href="products.html">Products</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active" id="breadcrumbTitle">
            Checkout
        </div>
    </div>
</section>

<!-- Checkout Container -->
<section class="checkout-container">
    <div class="checkout-grid">
        <!-- Left Column: Shipping & Payment -->
        <div>
            <!-- Shipping Address -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-shipping-fast"></i>
                    <h3>Shipping Address</h3>
                </div>
                
                <div id="savedAddresses">
                    <!-- Saved addresses will be loaded here -->
                </div>
                
                <div class="address-form" id="addressForm">
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Email Address</label>
                        <input type="email" id="email" placeholder="your.email@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Phone Number</label>
                        <input type="tel" id="phone" placeholder="+1 234 567 8900" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Country</label>
                        <select id="country" required>
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="AE">United Arab Emirates</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Address Line 1</label>
                        <input type="text" id="address1" placeholder="Street address, P.O. box, company name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Address Line 2</label>
                        <input type="text" id="address2" placeholder="Apartment, suite, unit, building, floor, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">City</label>
                        <input type="text" id="city" placeholder="City" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">State/Province</label>
                        <input type="text" id="state" placeholder="State or Province" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Postal Code</label>
                        <input type="text" id="postalCode" placeholder="ZIP or Postal code" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea id="instructions" placeholder="Any special delivery instructions..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="saveAddress">
                            <span>Save this address for future orders</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Payment Information -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Information</h3>
                </div>
                
                <!-- Payment Type Selection -->
                <div class="payment-options">
                    <h4><i class="fas fa-money-bill-wave"></i> Select Payment Type</h4>
                    
                    <div class="payment-option selected" onclick="selectPaymentOption('advance')" id="advancePaymentOption">
                        <input type="radio" id="advancePayment" name="paymentType" value="advance" checked>
                        <label for="advancePayment">
                            <i class="fas fa-credit-card"></i>
                            <div>
                                <div>30% Advance Payment</div>
                                <div class="payment-details">Pay 30% now, 70% after shipping confirmation</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="payment-option" onclick="selectPaymentOption('full')" id="fullPaymentOption">
                        <input type="radio" id="fullPayment" name="paymentType" value="full">
                        <label for="fullPayment">
                            <i class="fas fa-money-check-alt"></i>
                            <div>
                                <div>Full Payment Now</div>
                                <div class="payment-details">Pay full amount now and get 5% discount</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Payment Breakdown -->
                <div class="payment-breakdown" id="paymentBreakdown">
                    <h4><i class="fas fa-file-invoice-dollar"></i> Payment Breakdown</h4>
                    <div class="payment-item">
                        <span class="payment-label">Total Order Value:</span>
                        <span class="payment-amount" id="totalOrderValue">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="advanceLabel">30% Advance:</span>
                        <span class="payment-amount" id="advanceAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="remainingLabel">70% After Shipping:</span>
                        <span class="payment-amount" id="remainingAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="payNowLabel">Amount to Pay Now:</span>
                        <span class="payment-amount" id="payNowAmount">£0.00</span>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="section-header" style="margin-top: 25px;">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Method</h3>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active" data-method="stripe" onclick="selectPaymentMethod('stripe')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-stripe"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-description">Pay securely with your card (Stripe)</div>
                        </div>
                        <i class="fas fa-check-circle" style="color: var(--primary-gold);"></i>
                    </div>
                    
                    <div class="payment-method" data-method="paypal" onclick="selectPaymentMethod('paypal')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-paypal"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">PayPal</div>
                            <div class="payment-description">Pay with your PayPal account or card</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <div class="payment-method" data-method="bank" onclick="selectPaymentMethod('bank')">
                        <div class="payment-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Bank Transfer</div>
                            <div class="payment-description">Direct bank transfer</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                
                <!-- Stripe Card Element -->
                <div id="stripeCardElement" style="margin-top: 20px; display: none;">
                    <div class="stripe-card-element" id="card-element"></div>
                    <div id="card-errors" role="alert" style="color: #ff4757; font-size: 13px; margin-top: 10px;"></div>
                </div>
                
                <!-- PayPal Smart Buttons Container -->
                <div id="paypalButtonsContainer" style="margin-top: 20px; display: none;"></div>
            </div>
        </div>
        
        <!-- Right Column: Order Summary -->
        <div>
            <!-- Order Summary -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-receipt"></i>
                    <h3 id="orderSummaryTitle">Order Summary</h3>
                </div>
                
                <div class="order-items" id="orderItems">
                    <!-- Order items will be loaded here -->
                </div>
                
                <!-- Custom Requirements Display -->
                <div id="customRequirementsContainer"></div>
                
                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Subtotal</span>
                        <span class="price-value" id="subtotal">£0.00</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Shipping</span>
                        <span class="price-value" id="shipping">Calculated after address</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Tax (VAT)</span>
                        <span class="price-value" id="tax">£0.00</span>
                    </div>
                    
                    <div class="price-row total">
                        <span class="price-label">Total Amount</span>
                        <span class="price-value" id="total">£0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Terms & Conditions -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-file-contract"></i>
                    <h3>Terms & Conditions</h3>
                </div>
                
                <div style="font-size: 13px; color: var(--text-light); line-height: 1.6;">
                    <p>By placing your order, you agree to our Terms of Service and Privacy Policy.</p>
                    <p><strong>Payment Terms:</strong> 30% advance payment required to confirm order. Remaining 70% payable after shipping confirmation. Full payment upfront receives 5% discount.</p>
                    <p><strong>Shipping:</strong> Delivery within 7-14 business days after payment confirmation.</p>
                    <p style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="agreeTerms" required>
                            <span>I agree to the terms and conditions and payment terms</span>
                        </label>
                    </p>
                </div>
            </div>
            
            <!-- Place Order Button -->
            <div class="action-buttons">
                <button class="action-btn-large btn-primary" onclick="validateAndProcessPayment()">
                    <i class="fas fa-lock"></i>
                    <span id="payButtonText">Proceed to Payment</span>
                </button>
                <button class="action-btn-large btn-secondary" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    <span id="backButtonText">Back</span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav" id="bottomNav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn active">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let cartItems = [];
let isBuyNowFlow = false;
let currentPaymentType = 'advance';
let selectedPaymentMethod = 'bank';
let currentOrderData = null;
let authSystem = null;

// ============================================
// UPDATED AUTHENTICATION SYSTEM
// ============================================

class CheckoutAuthSystem {
    constructor() {
        this.currentUser = null;
        this.authKey = 'irya_stone_auth_user';
        this.guestIdKey = 'irya_guest_id';
        this.adminStatus = false;
    }
    
    async init() {
        try {
            await this.initializeFirebase();
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    console.log("Auth State Changed:", user ? user.uid : "No user");
                    
                    if (user) {
                        // Firebase authenticated user
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL,
                            providerId: user.providerId,
                            isFirebaseUser: true
                        };
                        
                        // Check admin status
                        await this.checkAdminStatus(user.uid);
                        
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        console.log("Firebase user saved:", user.uid);
                        
                    } else {
                        // No Firebase user, check localStorage
                        const storedUser = this.getUserFromStorage();
                        
                        if (storedUser && storedUser.isFirebaseUser) {
                            // Previously logged in user (now logged out)
                            this.currentUser = storedUser;
                            console.log("Using stored user from localStorage:", storedUser.uid);
                        } else {
                            // Create guest user
                            this.currentUser = this.createGuestUser();
                            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                            console.log("Guest user created:", this.currentUser.uid);
                        }
                    }
                    
                    resolve(this.currentUser);
                });
            });
            
        } catch (error) {
            console.error('Auth init error:', error);
            this.currentUser = this.getUserFromStorage() || this.createGuestUser();
            return this.currentUser;
        }
    }
    
    async checkAdminStatus(userId) {
        try {
            if (!firebaseDB) return false;
            
            const adminDoc = await firebaseDB.collection('admins').doc(userId).get();
            this.adminStatus = adminDoc.exists;
            
            console.log("Admin status:", this.adminStatus);
            return this.adminStatus;
        } catch (error) {
            console.error('Error checking admin status:', error);
            this.adminStatus = false;
            return false;
        }
    }
    
    async initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            console.log('Firebase initialized successfully');
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            throw error;
        }
    }
    
    getUserFromStorage() {
        const userData = localStorage.getItem(this.authKey);
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error parsing user data:', e);
                return null;
            }
        }
        return null;
    }
    
    createGuestUser() {
        let guestId = localStorage.getItem(this.guestIdKey);
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(this.guestIdKey, guestId);
        }
        
        return {
            uid: guestId,
            displayName: 'Guest',
            email: '',
            photoURL: '',
            providerId: 'guest',
            isFirebaseUser: false,
            isGuest: true
        };
    }
    
    isLoggedIn() {
        return this.currentUser && this.currentUser.isFirebaseUser === true;
    }
    
    getUserId() {
        if (!this.currentUser) {
            return this.createGuestUser().uid;
        }
        return this.currentUser.uid;
    }
    
    getUserEmail() {
        return this.currentUser ? this.currentUser.email : '';
    }
    
    getUserName() {
        return this.currentUser ? this.currentUser.displayName : 'Guest';
    }
    
    async migrateCartData(oldUserId, newUserId) {
        try {
            if (oldUserId === newUserId) return;
            
            console.log("Migrating cart data from", oldUserId, "to", newUserId);
            
            // Migrate regular cart
            const oldCartKey = 'irya_local_cart_' + oldUserId;
            const newCartKey = 'irya_local_cart_' + newUserId;
            
            const oldCartData = localStorage.getItem(oldCartKey);
            if (oldCartData) {
                localStorage.setItem(newCartKey, oldCartData);
                localStorage.removeItem(oldCartKey);
                console.log("Regular cart migrated");
            }
            
            // Migrate buy now cart
            const oldBuyNowKey = 'irya_buynow_cart_' + oldUserId;
            const newBuyNowKey = 'irya_buynow_cart_' + newUserId;
            
            const oldBuyNowData = localStorage.getItem(oldBuyNowKey);
            if (oldBuyNowData) {
                localStorage.setItem(newBuyNowKey, oldBuyNowData);
                localStorage.removeItem(oldBuyNowKey);
                console.log("Buy Now cart migrated");
            }
            
            return true;
        } catch (error) {
            console.error('Cart migration error:', error);
            return false;
        }
    }
}

// ============================================
// CHECKOUT INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("Checkout page loaded");
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    isBuyNowFlow = urlParams.get('buynow') === 'true';
    const buyNowProductId = urlParams.get('product');
    const source = urlParams.get('source');
    
    console.log("URL Parameters:", {
        isBuyNowFlow: isBuyNowFlow,
        productId: buyNowProductId,
        source: source
    });
    
    // Update UI for Buy Now flow
    if (isBuyNowFlow) {
        document.title = 'Buy Now Checkout | IRYA STONE';
        
        const breadcrumbTitle = document.getElementById('breadcrumbTitle');
        if (breadcrumbTitle) breadcrumbTitle.textContent = 'Buy Now Checkout';
        
        const orderSummaryTitle = document.getElementById('orderSummaryTitle');
        if (orderSummaryTitle) orderSummaryTitle.textContent = 'Buy Now Summary';
        
        const payButtonText = document.getElementById('payButtonText');
        if (payButtonText) payButtonText.textContent = 'Buy Now & Pay';
        
        const backButtonText = document.getElementById('backButtonText');
        if (backButtonText) backButtonText.textContent = 'Back to Product';
    }
    
    // Initialize Auth System FIRST
    authSystem = new CheckoutAuthSystem();
    await authSystem.init();
    
    console.log("Auth initialized. User ID:", authSystem.getUserId(), "Logged in:", authSystem.isLoggedIn());
    
    // Load order items
    await loadOrderItems();
    
    // Initialize payment options
    initializePaymentOptions();
    
    // Update cart badge
    updateCartBadge();
    
    // Initialize form validation
    initializeFormValidation();
});

// ============================================
// LOAD ORDER ITEMS
// ============================================

async function loadOrderItems() {
    try {
        showLoading(true);
        
        const userId = authSystem.getUserId();
        console.log("Loading order items for user:", userId);
        
        if (isBuyNowFlow) {
            await loadBuyNowItems(userId);
        } else {
            await loadRegularCartItems(userId);
        }
        
        console.log("Cart items loaded:", cartItems.length);
        
        if (cartItems.length === 0) {
            showError('Your cart is empty');
            window.location.href = isBuyNowFlow ? 'products.html' : 'cart.html';
            return;
        }
        
        displayOrderItems();
        calculateTotals();
        
    } catch (error) {
        console.error('Error loading order items:', error);
        showError('Failed to load order items. Please try again.');
        window.location.href = isBuyNowFlow ? 'products.html' : 'cart.html';
    } finally {
        showLoading(false);
    }
}

async function loadBuyNowItems(userId) {
    try {
        console.log("Loading Buy Now items for user:", userId);
        
        let buyNowItem = null;
        
        const sources = [
            { name: 'sessionStorage', getter: () => getBuyNowFromSession() },
            { name: 'localStorage', getter: () => getBuyNowFromLocalStorage(userId) },
            { name: 'URL params', getter: () => createBuyNowFromURL(userId) }
        ];
        
        for (const source of sources) {
            try {
                buyNowItem = await source.getter();
                if (buyNowItem) {
                    console.log("Buy Now item found in", source.name);
                    break;
                }
            } catch (err) {
                console.warn(`Error getting from ${source.name}:`, err);
            }
        }
        
        if (buyNowItem) {
            buyNowItem = validateBuyNowItem(buyNowItem, userId);
            cartItems = [buyNowItem];
            
            sessionStorage.setItem('irya_current_buynow', JSON.stringify(buyNowItem));
            
        } else {
            console.error("No Buy Now item found in any source");
            cartItems = [];
        }
        
    } catch (error) {
        console.error('Error loading buy now items:', error);
        cartItems = [];
        throw error;
    }
}

async function getBuyNowFromSession() {
    const sessionItem = sessionStorage.getItem('irya_current_buynow');
    if (sessionItem) {
        return JSON.parse(sessionItem);
    }
    return null;
}

async function getBuyNowFromLocalStorage(userId) {
    const buyNowKey = 'irya_buynow_cart_' + userId;
    const buyNowData = localStorage.getItem(buyNowKey);
    
    if (buyNowData) {
        const items = JSON.parse(buyNowData);
        return items.length > 0 ? items[0] : null;
    }
    return null;
}

async function createBuyNowFromURL(userId) {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('product');
    
    if (!productId) return null;
    
    try {
        // Get from localStorage cache or session
        const calcDataStr = sessionStorage.getItem('irya_buynow_calc_data');
        const calcData = calcDataStr ? JSON.parse(calcDataStr) : {
            mode: 'standard',
            unit: 'piece',
            quantity: parseInt(sessionStorage.getItem('irya_buynow_quantity')) || 1
        };
        
        const quantity = calcData.quantity || 1;
        const customReq = sessionStorage.getItem('irya_buynow_custom_req') || '';
        
        // Create buy now item
        const buyNowItem = {
            id: productId,
            uniqueId: `BUYNOW_${productId}_${Date.now()}`,
            name: 'Product ' + productId,
            stoneName: 'Stone Product',
            price: 100, // Default price
            priceUnit: 'piece',
            image: getDefaultImage('general'),
            category: 'General',
            description: '',
            quantity: quantity,
            calculationData: calcData,
            customRequirements: customReq,
            isBuyNow: true,
            buyNowTimestamp: Date.now(),
            userId: userId
        };
        
        // Calculate price
        buyNowItem.calculatedPrice = calculateItemPrice(buyNowItem, calcData);
        
        // Calculate payments
        const totalPrice = buyNowItem.calculatedPrice;
        buyNowItem.advancePayment = totalPrice * 0.3;
        buyNowItem.remainingPayment = totalPrice * 0.7;
        buyNowItem.totalPrice = totalPrice;
        
        return buyNowItem;
        
    } catch (error) {
        console.error('Error creating from URL:', error);
        return null;
    }
}

function validateBuyNowItem(item, userId) {
    if (!item.userId) item.userId = userId;
    if (!item.uniqueId) item.uniqueId = `BUYNOW_${item.id}_${Date.now()}`;
    if (!item.isBuyNow) item.isBuyNow = true;
    if (!item.buyNowTimestamp) item.buyNowTimestamp = Date.now();
    
    if (!item.calculatedPrice) {
        item.calculatedPrice = calculateItemPrice(item, item.calculationData);
    }
    
    if (!item.advancePayment || !item.remainingPayment || !item.totalPrice) {
        const totalPrice = item.calculatedPrice || (item.price * item.quantity);
        item.advancePayment = totalPrice * 0.3;
        item.remainingPayment = totalPrice * 0.7;
        item.totalPrice = totalPrice;
    }
    
    return item;
}

async function loadRegularCartItems(userId) {
    try {
        const cartKey = 'irya_local_cart_' + userId;
        const cartData = localStorage.getItem(cartKey);
        
        if (cartData) {
            cartItems = JSON.parse(cartData);
        } else {
            cartItems = [];
        }
        
        cartItems = cartItems.map(item => validateCartItem(item, userId));
        
    } catch (error) {
        console.error('Error loading regular cart:', error);
        cartItems = [];
    }
}

function validateCartItem(item, userId) {
    if (!item.userId) item.userId = userId;
    
    if (!item.calculatedPrice) {
        item.calculatedPrice = calculateItemPrice(item, item.calculationData);
    }
    
    if (!item.advancePayment || !item.remainingPayment || !item.totalPrice) {
        const totalPrice = item.calculatedPrice || (item.price * item.quantity);
        item.advancePayment = totalPrice * 0.3;
        item.remainingPayment = totalPrice * 0.7;
        item.totalPrice = totalPrice;
    }
    
    return item;
}

function calculateItemPrice(item, calculationData) {
    if (!calculationData) {
        return item.price * item.quantity;
    }
    
    const unit = calculationData.unit || item.priceUnit || 'piece';
    const quantity = calculationData.quantity || item.quantity || 1;
    const price = item.price || 0;
    
    let totalPrice = price * quantity;
    
    if (unit === 'sqft' || unit === 'sqm') {
        const length = calculationData.length || 1;
        const width = calculationData.width || 1;
        const area = length * width;
        totalPrice = price * area * quantity;
    } else if (unit === 'weight') {
        const weight = calculationData.weight || 1;
        totalPrice = price * weight * quantity;
    }
    
    return parseFloat(totalPrice.toFixed(2));
}

// ============================================
// DISPLAY ORDER ITEMS
// ============================================

function displayOrderItems() {
    const orderItemsDiv = document.getElementById('orderItems');
    const customRequirementsContainer = document.getElementById('customRequirementsContainer');
    
    if (!orderItemsDiv) {
        console.error("Order items container not found");
        return;
    }
    
    if (cartItems.length === 0) {
        orderItemsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-shopping-cart" style="font-size: 48px; color: var(--text-light); margin-bottom: 20px;"></i>
                <p style="color: var(--text-light); font-size: 16px;">Your cart is empty</p>
            </div>
        `;
        return;
    }
    
    customRequirementsContainer.innerHTML = '';
    
    const itemsHTML = cartItems.map(item => {
        if (item.customRequirements && item.customRequirements.trim() !== '') {
            const customReqHTML = `
                <div class="custom-requirements-box">
                    <h5><i class="fas fa-edit"></i> Custom Requirements for ${item.name}</h5>
                    <div class="custom-requirements-text">${item.customRequirements}</div>
                </div>
            `;
            customRequirementsContainer.innerHTML += customReqHTML;
        }
        
        let calculationInfo = '';
        if (item.calculationData) {
            if (item.calculationData.unit === 'sqft') {
                calculationInfo = `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
            } else if (item.calculationData.unit === 'sqm') {
                calculationInfo = `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
            } else if (item.calculationData.unit === 'weight') {
                calculationInfo = `Weight: ${item.calculationData.weight || 1}kg`;
            } else {
                calculationInfo = `Quantity: ${item.quantity} pieces`;
            }
        } else {
            calculationInfo = `Quantity: ${item.quantity} pieces`;
        }
        
        const itemPrice = item.calculatedPrice || (item.price * item.quantity);
        const imageUrl = item.image || getDefaultImage(item.category);
        
        return `
            <div class="order-item">
                <div class="order-item-image">
                    <img src="${imageUrl}" 
                         alt="${item.name}" 
                         onerror="this.src='${getDefaultImage(item.category)}'">
                </div>
                <div class="order-item-details">
                    <div class="order-item-name">${item.name || 'Product'}</div>
                    <div class="order-item-info">${item.category || 'General'}</div>
                    <div class="order-item-info">${calculationInfo}</div>
                    <div class="order-item-price">£${itemPrice.toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');
    
    orderItemsDiv.innerHTML = itemsHTML;
}

// ============================================
// CALCULATE TOTALS
// ============================================

function calculateTotals() {
    let subtotal = 0;
    let advanceTotal = 0;
    let remainingTotal = 0;
    
    cartItems.forEach(item => {
        const itemTotal = item.calculatedPrice || (item.price * item.quantity);
        subtotal += itemTotal;
        
        if (item.advancePayment && item.remainingPayment) {
            advanceTotal += item.advancePayment;
            remainingTotal += item.remainingPayment;
        } else {
            advanceTotal += itemTotal * 0.3;
            remainingTotal += itemTotal * 0.7;
        }
    });
    
    const tax = subtotal * 0.2;
    const shipping = calculateShippingCost(subtotal);
    const total = subtotal + tax + shipping;
    
    updatePriceDisplay(subtotal, tax, shipping, total);
    updatePaymentBreakdown(total, advanceTotal, remainingTotal);
    
    return { 
        subtotal, 
        tax, 
        shipping, 
        total,
        advanceTotal: parseFloat(advanceTotal.toFixed(2)),
        remainingTotal: parseFloat(remainingTotal.toFixed(2))
    };
}

function updatePriceDisplay(subtotal, tax, shipping, total) {
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const shippingEl = document.getElementById('shipping');
    const totalEl = document.getElementById('total');
    
    if (subtotalEl) subtotalEl.textContent = `£${subtotal.toFixed(2)}`;
    if (taxEl) taxEl.textContent = `£${tax.toFixed(2)}`;
    if (shippingEl) shippingEl.textContent = shipping === 0 ? 'FREE' : `£${shipping.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `£${total.toFixed(2)}`;
}

function calculateShippingCost(subtotal) {
    if (subtotal > 500) {
        return 0;
    } else if (subtotal > 200) {
        return 25;
    } else {
        return 35;
    }
}

function updatePaymentBreakdown(total, advanceTotal, remainingTotal) {
    const totalOrderValue = document.getElementById('totalOrderValue');
    const advanceAmount = document.getElementById('advanceAmount');
    const remainingAmount = document.getElementById('remainingAmount');
    const payNowAmount = document.getElementById('payNowAmount');
    const advanceLabel = document.getElementById('advanceLabel');
    const remainingLabel = document.getElementById('remainingLabel');
    const payNowLabel = document.getElementById('payNowLabel');
    
    if (!totalOrderValue || !advanceAmount || !remainingAmount || !payNowAmount) return;
    
    if (currentPaymentType === 'advance') {
        totalOrderValue.textContent = `£${total.toFixed(2)}`;
        advanceAmount.textContent = `£${advanceTotal.toFixed(2)}`;
        remainingAmount.textContent = `£${remainingTotal.toFixed(2)}`;
        payNowAmount.textContent = `£${advanceTotal.toFixed(2)}`;
        
        if (advanceLabel) advanceLabel.textContent = '30% Advance:';
        if (remainingLabel) remainingLabel.textContent = '70% After Shipping:';
        if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
    } else {
        const discountedTotal = total * 0.95;
        const discountAmount = total * 0.05;
        
        totalOrderValue.textContent = `£${total.toFixed(2)}`;
        advanceAmount.textContent = `-£${discountAmount.toFixed(2)}`;
        remainingAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        payNowAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        
        if (advanceLabel) advanceLabel.textContent = 'Discount (5%):';
        if (remainingLabel) remainingLabel.textContent = 'Discounted Total:';
        if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
    }
}

// ============================================
// PAYMENT OPTIONS
// ============================================

function initializePaymentOptions() {
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    
    if (advanceOption && fullOption) {
        advanceOption.classList.add('selected');
        fullOption.classList.remove('selected');
    }
    
    const totals = calculateTotals();
    updatePaymentBreakdown(totals.total, totals.advanceTotal, totals.remainingTotal);
}

function selectPaymentOption(paymentType) {
    currentPaymentType = paymentType;
    
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    
    if (!advanceOption || !fullOption) return;
    
    advanceOption.classList.remove('selected');
    fullOption.classList.remove('selected');
    
    if (paymentType === 'advance') {
        advanceOption.classList.add('selected');
        document.getElementById('advancePayment').checked = true;
    } else {
        fullOption.classList.add('selected');
        document.getElementById('fullPayment').checked = true;
    }
    
    const totals = calculateTotals();
    updatePaymentBreakdown(totals.total, totals.advanceTotal, totals.remainingTotal);
}

function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('active');
        const checkIcon = el.querySelector('.fa-check-circle');
        if (checkIcon) {
            checkIcon.style.color = '';
        }
    });
    
    const clickedElement = event.currentTarget;
    clickedElement.classList.add('active');
    
    const checkIcon = clickedElement.querySelector('.fa-check-circle');
    if (checkIcon) {
        checkIcon.style.color = 'var(--primary-gold)';
    }
    
    const stripeCardElement = document.getElementById('stripeCardElement');
    const paypalButtonsContainer = document.getElementById('paypalButtonsContainer');
    
    if (stripeCardElement) {
        stripeCardElement.style.display = method === 'stripe' ? 'block' : 'none';
    }
    
    if (paypalButtonsContainer) {
        paypalButtonsContainer.style.display = method === 'paypal' ? 'block' : 'none';
        
        if (method === 'paypal') {
            initializePayPalButtons();
        }
    }
}

function initializePayPalButtons() {
    const paypalButtonsContainer = document.getElementById('paypalButtonsContainer');
    if (!paypalButtonsContainer) return;
    
    paypalButtonsContainer.innerHTML = `
        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <i class="fab fa-cc-paypal" style="font-size: 32px; color: #003087; margin-bottom: 10px;"></i>
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 10px;">
                PayPal integration coming soon. Please use Bank Transfer for now.
            </p>
        </div>
    `;
}

// ============================================
// FORM VALIDATION
// ============================================

function initializeFormValidation() {
    const requiredFields = ['fullName', 'email', 'phone', 'country', 'address1', 'city', 'state', 'postalCode'];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            const label = field.previousElementSibling;
            if (label && label.tagName === 'LABEL') {
                if (!label.classList.contains('required')) {
                    label.classList.add('required');
                }
            }
        }
    });
    
    const emailField = document.getElementById('email');
    if (emailField) {
        emailField.addEventListener('blur', validateEmail);
    }
    
    const phoneField = document.getElementById('phone');
    if (phoneField) {
        phoneField.addEventListener('blur', validatePhone);
    }
}

function validateEmail() {
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email && !emailRegex.test(email)) {
        showFieldError('email', 'Please enter a valid email address');
        return false;
    } else {
        clearFieldError('email');
        return true;
    }
}

function validatePhone() {
    const phone = document.getElementById('phone').value;
    const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
    const cleanedPhone = phone.replace(/[\s\-\(\)]/g, '');
    
    if (phone && !phoneRegex.test(cleanedPhone)) {
        showFieldError('phone', 'Please enter a valid phone number');
        return false;
    } else {
        clearFieldError('phone');
        return true;
    }
}

function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    let errorDiv = field.parentElement.querySelector('.field-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'field-error';
        errorDiv.style.cssText = 'color: #ff4757; font-size: 12px; margin-top: 5px;';
        field.parentElement.appendChild(errorDiv);
    }
    
    errorDiv.textContent = message;
    field.style.borderColor = '#ff4757';
}

function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    const errorDiv = field.parentElement.querySelector('.field-error');
    if (errorDiv) {
        errorDiv.remove();
    }
    field.style.borderColor = '';
}

function validateForm() {
    const requiredFields = [
        { id: 'fullName', label: 'Full Name' },
        { id: 'email', label: 'Email Address' },
        { id: 'phone', label: 'Phone Number' },
        { id: 'country', label: 'Country' },
        { id: 'address1', label: 'Address Line 1' },
        { id: 'city', label: 'City' },
        { id: 'state', label: 'State/Province' },
        { id: 'postalCode', label: 'Postal Code' }
    ];
    
    let isValid = true;
    
    for (const field of requiredFields) {
        const element = document.getElementById(field.id);
        if (!element || !element.value.trim()) {
            showFieldError(field.id, `${field.label} is required`);
            if (isValid) {
                element?.focus();
                isValid = false;
            }
        } else {
            clearFieldError(field.id);
        }
    }
    
    if (isValid && !validateEmail()) {
        isValid = false;
    }
    
    if (isValid && !validatePhone()) {
        isValid = false;
    }
    
    const agreeTerms = document.getElementById('agreeTerms');
    if (!agreeTerms || !agreeTerms.checked) {
        showError('Please agree to the terms and conditions');
        isValid = false;
    }
    
    return isValid;
}

// ============================================
// UPDATED PAYMENT PROCESSING - LOCAL STORAGE SOLUTION
// ============================================

async function validateAndProcessPayment() {
    try {
        console.log("Starting payment processing...");
        
        if (!validateForm()) {
            console.log("Form validation failed");
            return;
        }
        
        showLoading(true);
        
        // Get address data
        const addressData = {
            fullName: document.getElementById('fullName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            country: document.getElementById('country').value,
            address1: document.getElementById('address1').value.trim(),
            address2: document.getElementById('address2').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            postalCode: document.getElementById('postalCode').value.trim(),
            instructions: document.getElementById('instructions').value.trim(),
            saveAddress: document.getElementById('saveAddress')?.checked || false
        };
        
        console.log("Address data collected");
        
        // Calculate totals
        const totals = calculateTotals();
        const paymentType = currentPaymentType;
        const paymentAmount = paymentType === 'advance' ? totals.advanceTotal : totals.total * 0.95;
        
        console.log("Payment calculation:", {
            paymentType: paymentType,
            amount: paymentAmount,
            method: selectedPaymentMethod
        });
        
        // Create order data
        currentOrderData = {
            userId: authSystem.getUserId(),
            userEmail: authSystem.getUserEmail(),
            userName: authSystem.getUserName(),
            isLoggedIn: authSystem.isLoggedIn(),
            items: cartItems.map(item => ({
                id: item.id || '',
                uniqueId: item.uniqueId || '',
                name: item.name || 'Product',
                stoneName: item.stoneName || '',
                quantity: item.quantity || 1,
                price: item.price || 0,
                priceUnit: item.priceUnit || 'piece',
                calculatedPrice: item.calculatedPrice || 0,
                calculationData: item.calculationData || null,
                customRequirements: item.customRequirements || '',
                advancePayment: item.advancePayment || 0,
                remainingPayment: item.remainingPayment || 0,
                totalPrice: item.totalPrice || 0,
                isBuyNow: item.isBuyNow || false,
                buyNowTimestamp: item.buyNowTimestamp || null
            })),
            shippingAddress: addressData,
            billingAddress: addressData,
            paymentMethod: selectedPaymentMethod,
            paymentType: paymentType,
            subtotal: totals.subtotal,
            tax: totals.tax,
            shipping: totals.shipping,
            total: totals.total,
            advancePayment: paymentType === 'advance' ? paymentAmount : 0,
            remainingPayment: paymentType === 'advance' ? totals.remainingTotal : 0,
            amountToPay: paymentAmount,
            status: 'pending',
            createdAt: new Date().toISOString(),
            orderNumber: generateOrderNumber(),
            paymentStatus: 'pending',
            isBuyNowOrder: isBuyNowFlow,
            isGuestOrder: !authSystem.isLoggedIn()
        };
        
        console.log("Order data created:", currentOrderData.orderNumber);
        
        // Process based on payment method
        if (selectedPaymentMethod === 'bank') {
            await processBankTransfer(currentOrderData);
        } else if (selectedPaymentMethod === 'stripe') {
            showError('Credit card payment coming soon. Please use Bank Transfer.');
        } else if (selectedPaymentMethod === 'paypal') {
            showError('PayPal payment coming soon. Please use Bank Transfer.');
        } else {
            showError('Please select a payment method');
        }
        
    } catch (error) {
        console.error('Payment processing error:', error);
        showError('Payment processing failed: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function processBankTransfer(orderData) {
    try {
        showPaymentProcessing('Preparing Bank Transfer Details...');
        
        orderData.paymentStatus = 'pending_bank_transfer';
        orderData.bankTransferDetails = {
            accountName: 'IRYA STONE LTD',
            accountNumber: '12345678',
            sortCode: '04-00-04',
            iban: 'GB29NWBK60161331926819',
            swift: 'NWBKGB2L',
            reference: orderData.orderNumber,
            amount: orderData.amountToPay,
            currency: 'GBP',
            bankName: 'NatWest Bank',
            bankAddress: 'NatWest Bank PLC, 135 Bishopsgate, London EC2M 3UR, United Kingdom'
        };
        
        // Save order to localStorage (Firebase permission bypass)
        const orderId = saveOrderToLocalStorage(orderData);
        orderData.id = orderId;
        
        hidePaymentProcessing();
        
        // Show bank transfer modal
        showBankTransferModal(orderData);
        
    } catch (error) {
        console.error('Bank transfer error:', error);
        hidePaymentProcessing();
        showError('Failed to process bank transfer: ' + error.message);
    }
}

function saveOrderToLocalStorage(orderData) {
    try {
        const orderId = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const userId = authSystem.getUserId();
        
        const ordersKey = 'irya_local_orders_' + userId;
        let storedOrders = localStorage.getItem(ordersKey);
        
        if (storedOrders) {
            storedOrders = JSON.parse(storedOrders);
        } else {
            storedOrders = [];
        }
        
        const orderToSave = {
            ...orderData,
            id: orderId,
            localSave: true,
            saveTime: new Date().toISOString(),
            firestoreId: null,
            isSyncedToFirestore: false
        };
        
        storedOrders.push(orderToSave);
        localStorage.setItem(ordersKey, JSON.stringify(storedOrders));
        
        console.log('✅ Order saved to localStorage:', orderId);
        
        // Also save to recent orders for quick access
        const recentOrdersKey = 'irya_recent_orders';
        let recentOrders = localStorage.getItem(recentOrdersKey);
        if (recentOrders) {
            recentOrders = JSON.parse(recentOrders);
        } else {
            recentOrders = [];
        }
        
        recentOrders.unshift({
            orderNumber: orderData.orderNumber,
            id: orderId,
            date: new Date().toISOString(),
            total: orderData.total,
            status: orderData.status
        });
        
        // Keep only last 10 orders
        if (recentOrders.length > 10) {
            recentOrders = recentOrders.slice(0, 10);
        }
        
        localStorage.setItem(recentOrdersKey, JSON.stringify(recentOrders));
        
        return orderId;
        
    } catch (error) {
        console.error('❌ Error saving to localStorage:', error);
        throw error;
    }
}

function showBankTransferModal(orderData) {
    const modalHTML = `
        <div id="bankTransferModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--primary-gold); margin: 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-university"></i> Bank Transfer Instructions
                    </h3>
                    <button onclick="closeBankTransferModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); padding: 5px;">
                        &times;
                    </button>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <h4 style="color: var(--stone-dark); margin-bottom: 10px; font-size: 16px;">
                            <i class="fas fa-receipt"></i> Order Summary
                        </h4>
                        <p style="margin: 5px 0;"><strong>Order Number:</strong> ${orderData.orderNumber}</p>
                        <p style="margin: 5px 0;"><strong>Amount to Pay:</strong> £${orderData.amountToPay.toFixed(2)}</p>
                        <p style="margin: 5px 0;"><strong>Payment Type:</strong> ${orderData.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</p>
                    </div>
                    
                    <div style="background: #fff8e1; padding: 20px; border-radius: 10px; border-left: 4px solid var(--primary-gold); margin-bottom: 20px;">
                        <h4 style="color: var(--stone-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: var(--primary-gold);"></i> Important Information
                        </h4>
                        <ul style="margin-left: 20px; color: var(--text-dark);">
                            <li>Your order will be processed only after payment confirmation</li>
                            <li>Use the reference number when making transfer</li>
                            <li>Keep the transaction receipt for verification</li>
                            <li>You will receive confirmation email within 24 hours</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--bg-light); padding: 20px; border-radius: 10px;">
                        <h4 style="color: var(--stone-dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-university"></i> Bank Details
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">Account Name</p>
                                <p style="margin: 0; font-weight: 600; color: var(--stone-dark);">IRYA STONE LTD</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">Account Number</p>
                                <p style="margin: 0; font-weight: 600; color: var(--stone-dark);">12345678</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">Sort Code</p>
                                <p style="margin: 0; font-weight: 600; color: var(--stone-dark);">04-00-04</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">IBAN</p>
                                <p style="margin: 0; font-weight: 600; color: var(--stone-dark); font-size: 13px;">GB29NWBK60161331926819</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">SWIFT/BIC</p>
                                <p style="margin: 0; font-weight: 600; color: var(--stone-dark);">NWBKGB2L</p>
                            </div>
                            
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                <p style="margin: 0 0 8px 0; color: var(--text-light); font-size: 13px;">Reference</p>
                                <p style="margin: 0; font-weight: 600; color: var(--primary-gold);">${orderData.orderNumber}</p>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold);">
                            <p style="margin: 0; text-align: center; font-weight: 700; color: var(--primary-gold); font-size: 18px;">
                                Amount to Transfer: £${orderData.amountToPay.toFixed(2)}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="markAsPaidAndComplete('${orderData.id}')" 
                            style="padding: 15px; background: var(--primary-gold); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="fas fa-check-circle"></i> I have completed the transfer
                    </button>
                    
                    <button onclick="printBankDetails()" 
                            style="padding: 12px; background: white; color: var(--text-dark); border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="fas fa-print"></i> Print Instructions
                    </button>
                    
                    <button onclick="saveBankDetails()" 
                            style="padding: 12px; background: white; color: var(--text-dark); border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="fas fa-download"></i> Save Details
                    </button>
                </div>
                
                <p style="margin-top: 20px; font-size: 12px; color: var(--text-light); text-align: center;">
                    Need assistance? Email us at <a href="mailto:support@iryastone.com" style="color: var(--primary-gold);">support@iryastone.com</a>
                </p>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('bankTransferModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeBankTransferModal() {
    const modal = document.getElementById('bankTransferModal');
    if (modal) {
        modal.remove();
    }
}

function printBankDetails() {
    window.print();
}

function saveBankDetails() {
    const orderData = currentOrderData;
    const bankDetails = `
IRYA STONE - Bank Transfer Details
===================================

Order Number: ${orderData.orderNumber}
Amount: £${orderData.amountToPay.toFixed(2)}
Date: ${new Date().toLocaleDateString()}

Bank Details:
-------------
Account Name: IRYA STONE LTD
Account Number: 12345678
Sort Code: 04-00-04
IBAN: GB29NWBK60161331926819
SWIFT/BIC: NWBKGB2L
Reference: ${orderData.orderNumber}

Bank Information:
-----------------
Bank Name: NatWest Bank
Bank Address: NatWest Bank PLC, 135 Bishopsgate, London EC2M 3UR, United Kingdom

Important Notes:
----------------
1. Use the exact reference number when transferring
2. Keep transaction receipt for verification
3. Order will be processed after payment confirmation
4. Contact support@iryastone.com for assistance

Thank you for your order!
IRYA STONE Team
`;
    
    const blob = new Blob([bankDetails], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `bank_details_${orderData.orderNumber}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('Bank details saved successfully!');
}

async function markAsPaidAndComplete(orderId) {
    try {
        showLoading(true);
        
        // Update local order status
        const userId = authSystem.getUserId();
        const ordersKey = 'irya_local_orders_' + userId;
        let storedOrders = localStorage.getItem(ordersKey);
        
        if (storedOrders) {
            storedOrders = JSON.parse(storedOrders);
            const orderIndex = storedOrders.findIndex(order => order.id === orderId);
            
            if (orderIndex !== -1) {
                // Update order status
                storedOrders[orderIndex].paymentStatus = 'paid_awaiting_confirmation';
                storedOrders[orderIndex].status = 'processing';
                storedOrders[orderIndex].markedAsPaidAt = new Date().toISOString();
                storedOrders[orderIndex].markedAsPaidBy = authSystem.getUserName();
                
                localStorage.setItem(ordersKey, JSON.stringify(storedOrders));
                
                // Update currentOrderData
                currentOrderData = storedOrders[orderIndex];
                
                // Close modal
                closeBankTransferModal();
                
                // Try to sync with Firestore if user is authenticated
                if (authSystem.isLoggedIn() && firebaseAuth.currentUser) {
                    await syncOrderToFirestore(currentOrderData);
                } else {
                    // For guest users, create public notification
                    await createPublicNotification(currentOrderData);
                }
                
                // Show success message
                showNotification('Payment marked as completed! Your order is now processing.');
                
                // Clear cart and redirect
                setTimeout(() => {
                    completeOrderAndRedirect();
                }, 1500);
                
                return;
            }
        }
        
        showError('Order not found');
        
    } catch (error) {
        console.error('Error marking as paid:', error);
        showError('Failed to mark payment as completed');
    } finally {
        showLoading(false);
    }
}

async function syncOrderToFirestore(orderData) {
    try {
        if (!firebaseDB || !firebaseAuth.currentUser) return false;
        
        const userId = firebaseAuth.currentUser.uid;
        
        const firestoreOrder = {
            userId: userId,
            userEmail: orderData.userEmail || firebaseAuth.currentUser.email,
            userName: orderData.userName || firebaseAuth.currentUser.displayName,
            items: orderData.items || [],
            shippingAddress: orderData.shippingAddress || {},
            paymentMethod: orderData.paymentMethod || 'bank',
            paymentType: orderData.paymentType || 'advance',
            subtotal: orderData.subtotal || 0,
            tax: orderData.tax || 0,
            shipping: orderData.shipping || 0,
            total: orderData.total || 0,
            advancePayment: orderData.advancePayment || 0,
            remainingPayment: orderData.remainingPayment || 0,
            amountToPay: orderData.amountToPay || 0,
            status: orderData.status || 'processing',
            createdAt: orderData.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            orderNumber: orderData.orderNumber,
            paymentStatus: orderData.paymentStatus || 'paid_awaiting_confirmation',
            isBuyNowOrder: orderData.isBuyNowOrder || false,
            isGuestOrder: false,
            bankTransferDetails: orderData.bankTransferDetails || null,
            localOrderId: orderData.id,
            markedAsPaidAt: orderData.markedAsPaidAt,
            markedAsPaidBy: orderData.markedAsPaidBy
        };
        
        // Save to user's orders subcollection (users can write here)
        const userOrderRef = firebaseDB.collection('users')
            .doc(userId)
            .collection('orders')
            .doc();
        
        await userOrderRef.set(firestoreOrder);
        
        // Update local order with Firestore ID
        const ordersKey = 'irya_local_orders_' + userId;
        let storedOrders = localStorage.getItem(ordersKey);
        
        if (storedOrders) {
            storedOrders = JSON.parse(storedOrders);
            const orderIndex = storedOrders.findIndex(order => order.id === orderData.id);
            
            if (orderIndex !== -1) {
                storedOrders[orderIndex].firestoreId = userOrderRef.id;
                storedOrders[orderIndex].isSyncedToFirestore = true;
                storedOrders[orderIndex].syncedAt = new Date().toISOString();
                
                localStorage.setItem(ordersKey, JSON.stringify(storedOrders));
            }
        }
        
        console.log('✅ Order synced to Firestore:', userOrderRef.id);
        
        // Create notification for admin
        await createAdminNotification(userOrderRef.id, firestoreOrder);
        
        return true;
        
    } catch (error) {
        console.warn('⚠️ Could not sync to Firestore:', error.message);
        return false;
    }
}

async function createPublicNotification(orderData) {
    try {
        if (!firebaseDB) return;
        
        const notificationRef = firebaseDB.collection('publicNotifications').doc();
        
        const notification = {
            type: 'new_order',
            orderId: orderData.id,
            orderNumber: orderData.orderNumber,
            userId: orderData.userId,
            userName: orderData.userName || 'Guest Customer',
            message: `New order #${orderData.orderNumber} placed (Guest Order)`,
            createdAt: new Date().toISOString(),
            isRead: false,
            requiresAction: true,
            isPublic: true,
            isGuestOrder: true,
            orderTotal: orderData.total,
            paymentMethod: orderData.paymentMethod,
            paymentStatus: orderData.paymentStatus
        };
        
        await notificationRef.set(notification);
        console.log('✅ Public notification created');
        
    } catch (error) {
        console.warn('⚠️ Could not create public notification:', error);
    }
}

async function createAdminNotification(orderId, orderData) {
    try {
        if (!firebaseDB) return;
        
        // Create in adminNotifications if possible
        try {
            const notificationRef = firebaseDB.collection('adminNotifications').doc();
            
            const notification = {
                type: 'new_order',
                orderId: orderId,
                orderNumber: orderData.orderNumber,
                userId: orderData.userId,
                userName: orderData.userName || 'Customer',
                title: 'New Order Placed',
                message: `New order #${orderData.orderNumber} has been placed by ${orderData.userName || 'Customer'}`,
                isRead: false,
                requiresAction: true,
                createdAt: new Date().toISOString(),
                orderData: {
                    total: orderData.total,
                    paymentMethod: orderData.paymentMethod,
                    paymentStatus: orderData.paymentStatus,
                    itemsCount: orderData.items.length,
                    isGuestOrder: false
                }
            };
            
            await notificationRef.set(notification);
            console.log('✅ Admin notification created');
        } catch (adminError) {
            console.warn('⚠️ Could not create admin notification:', adminError);
            
            // Fallback to public notifications
            await createPublicNotification(orderData);
        }
        
    } catch (error) {
        console.error('❌ Error creating notification:', error);
    }
}

function completeOrderAndRedirect() {
    try {
        // Clear cart items
        const userId = authSystem.getUserId();
        
        if (isBuyNowFlow) {
            const buyNowKey = 'irya_buynow_cart_' + userId;
            localStorage.removeItem(buyNowKey);
            
            sessionStorage.removeItem('irya_current_buynow');
            sessionStorage.removeItem('irya_buynow_product_id');
            sessionStorage.removeItem('irya_buynow_quantity');
            sessionStorage.removeItem('irya_buynow_calc_data');
            sessionStorage.removeItem('irya_buynow_custom_req');
            localStorage.removeItem('irya_is_buynow_flow');
        } else {
            const cartKey = 'irya_local_cart_' + userId;
            localStorage.removeItem(cartKey);
        }
        
        updateCartBadge();
        
        // Create order summary for confirmation page
        const orderSummary = {
            orderNumber: currentOrderData.orderNumber,
            total: currentOrderData.total,
            paymentMethod: currentOrderData.paymentMethod,
            paymentStatus: currentOrderData.paymentStatus,
            status: currentOrderData.status,
            items: currentOrderData.items,
            shippingAddress: currentOrderData.shippingAddress,
            createdAt: currentOrderData.createdAt
        };
        
        // Save to session for confirmation page
        sessionStorage.setItem('irya_last_order', JSON.stringify(orderSummary));
        
        // Redirect to confirmation page
        window.location.href = `order-confirmation.html?order=${currentOrderData.orderNumber}&status=${currentOrderData.status}`;
        
    } catch (error) {
        console.error('Error completing order:', error);
        showError('Failed to complete order');
    }
}

// ============================================
// PAYMENT MODAL FUNCTIONS
// ============================================

function showPaymentProcessing(message = 'Processing Payment...') {
    const modal = document.getElementById('paymentModal');
    const paymentSpinner = document.getElementById('paymentSpinner');
    const paymentMessage = document.getElementById('paymentMessage');
    
    if (modal && paymentSpinner && paymentMessage) {
        paymentMessage.textContent = message;
        paymentSpinner.style.display = 'block';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function hidePaymentProcessing() {
    const modal = document.getElementById('paymentModal');
    const paymentSpinner = document.getElementById('paymentSpinner');
    
    if (modal && paymentSpinner) {
        paymentSpinner.style.display = 'none';
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function cancelPayment() {
    hidePaymentProcessing();
    showNotification('Payment cancelled');
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function getDefaultImage(category) {
    const categoryLower = (category || '').toLowerCase();
    
    if (categoryLower.includes('sand')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('kota')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('granite')) {
        return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800';
    }
    
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
}

function updateCartBadge() {
    const userId = authSystem.getUserId();
    
    const cartKey = 'irya_local_cart_' + userId;
    const buyNowKey = 'irya_buynow_cart_' + userId;
    
    const cartData = localStorage.getItem(cartKey);
    const buyNowData = localStorage.getItem(buyNowKey);
    
    let count = 0;
    
    if (cartData) {
        const items = JSON.parse(cartData);
        count += items.reduce((total, item) => total + (item.quantity || 0), 0);
    }
    
    if (buyNowData) {
        const items = JSON.parse(buyNowData);
        count += items.reduce((total, item) => total + (item.quantity || 0), 0);
    }
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function generateOrderNumber() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    return `IRYA-${timestamp}-${random}`;
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function showError(message) {
    alert(message);
}

function goBack() {
    if (isBuyNowFlow) {
        window.history.back();
    } else {
        window.location.href = 'cart.html';
    }
}

// ============================================
// FIREBASE SYNC FUNCTION FOR LOGGED IN USERS
// ============================================

async function syncLocalOrdersToFirebase(userId) {
    try {
        if (!firebaseAuth.currentUser || firebaseAuth.currentUser.uid !== userId) {
            return;
        }
        
        const localOrdersKey = 'irya_local_orders_' + userId;
        const localOrders = localStorage.getItem(localOrdersKey);
        
        if (!localOrders) return;
        
        const orders = JSON.parse(localOrders);
        const unsyncedOrders = orders.filter(order => !order.isSyncedToFirestore);
        
        for (const order of unsyncedOrders) {
            try {
                await syncOrderToFirestore(order);
                
                // Update local storage to mark as synced
                const updatedOrders = orders.map(o => 
                    o.id === order.id ? { ...o, isSyncedToFirestore: true } : o
                );
                localStorage.setItem(localOrdersKey, JSON.stringify(updatedOrders));
                
            } catch (error) {
                console.error('❌ Error syncing order:', error);
            }
        }
        
    } catch (error) {
        console.error('❌ Error syncing local orders:', error);
    }
}

// Call this when user logs in
async function onUserLogin(userId) {
    await syncLocalOrdersToFirebase(userId);
}

// Make functions available globally
window.selectPaymentOption = selectPaymentOption;
window.selectPaymentMethod = selectPaymentMethod;
window.validateAndProcessPayment = validateAndProcessPayment;
window.cancelPayment = cancelPayment;
window.goBack = goBack;
window.markAsPaidAndComplete = markAsPaidAndComplete;
window.closeBankTransferModal = closeBankTransferModal;
window.printBankDetails = printBankDetails;
window.saveBankDetails = saveBankDetails;
</body>
</html>
