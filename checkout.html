<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | IRYA STONE</title>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f6fa;margin:0;padding:0}
    .container{max-width:1100px;margin:auto;padding:20px}
    h1{margin-bottom:10px}
    .card{background:#fff;border-radius:8px;padding:16px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .row{display:flex;gap:15px;flex-wrap:wrap}
    .col{flex:1;min-width:260px}
    img{max-width:100px;border-radius:6px}
    .item{display:flex;gap:12px;border-bottom:1px solid #eee;padding:10px 0}
    .item:last-child{border-bottom:none}
    .total{font-size:18px;font-weight:bold}
    button{background:#0a7cff;color:#fff;border:none;padding:12px 18px;border-radius:6px;cursor:pointer}
    button:disabled{background:#aaa}
    .muted{color:#777;font-size:13px}
    .badge{display:inline-block;background:#eee;padding:3px 8px;border-radius:4px;font-size:12px}
  </style>
</head>
<body>

<div class="container">
  <h1>Checkout</h1>
  <div id="flowInfo" class="muted"></div>

  <div class="row">
    <div class="col">
      <div class="card">
        <h3>Order Items</h3>
        <div id="itemsContainer"></div>
      </div>
    </div>

    <div class="col">
      <div class="card">
        <h3>Payment Summary</h3>
        <p>Total: <span id="totalAmount">0</span></p>
        <p>Advance Paid: <span id="advanceAmount">0</span></p>
        <p class="total">Pay Now: <span id="payableAmount">0</span></p>
        <br>
        <button id="payBtn">Confirm Payment</button>
        <p class="muted">* Payment confirmation demo (Firestore update only)</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
  /* ================= FIREBASE SETUP ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs,
    query,
    where,
    orderBy,
    limit,
    updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ================= GLOBAL ================= */
  const params = new URLSearchParams(window.location.search);
  const flow = params.get("flow"); // buynow | cart

  const itemsContainer = document.getElementById("itemsContainer");
  const totalEl = document.getElementById("totalAmount");
  const advanceEl = document.getElementById("advanceAmount");
  const payableEl = document.getElementById("payableAmount");
  const payBtn = document.getElementById("payBtn");
  const flowInfo = document.getElementById("flowInfo");

  let currentUserId = null;
  let total = 0;
  let advance = 0;

  /* ================= AUTH ================= */
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("Please login to continue checkout");
      window.location.href = "login.html";
      return;
    }
    currentUserId = user.uid;

    if (flow === "buynow") {
      flowInfo.innerHTML = "Flow: <b>Buy Now</b>";
      await loadBuyNow();
    } else if (flow === "cart") {
      flowInfo.innerHTML = "Flow: <b>Cart Checkout</b>";
      await loadCart();
    } else {
      flowInfo.innerHTML = "<span style='color:red'>Invalid checkout flow</span>";
    }
  });

  /* ================= BUY NOW FLOW ================= */
  async function loadBuyNow() {
    const q = query(
      collection(db, "buyNowItems"),
      where("userId", "==", currentUserId),
      where("isBuyNow", "==", true),
      orderBy("buyNowTimestamp", "desc"),
      limit(1)
    );

    const snap = await getDocs(q);
    if (snap.empty) {
      itemsContainer.innerHTML = "<p>No Buy Now item found</p>";
      return;
    }

    const data = snap.docs[0].data();
    renderItem(data.item || data);

    total = data.totalPrice || data.calculatedPrice || 0;
    advance = data.advancePayment || 0;

    updateSummary();

    payBtn.onclick = async () => {
      await updateDoc(snap.docs[0].ref, {
        remainingPayment: 0,
        paymentStatus: "paid",
        paidAt: serverTimestamp()
      });
      alert("Buy Now payment confirmed");
    };
  }

  /* ================= CART FLOW ================= */
  async function loadCart() {
    const cartRef = doc(db, "userCarts", currentUserId);
    const snap = await getDoc(cartRef);

    if (!snap.exists()) {
      itemsContainer.innerHTML = "<p>Your cart is empty</p>";
      return;
    }

    const cart = snap.data();
    total = 0;
    advance = 0;

    cart.items.forEach(item => {
      renderItem(item);
      const price = item.calculatedPrice || (item.price || 0) * (item.quantity || 1);
      total += price;
      advance += item.advancePayment || 0;
    });

    updateSummary();

    payBtn.onclick = async () => {
      await updateDoc(cartRef, {
        paidAt: serverTimestamp(),
        status: "paid"
      });
      alert("Cart payment confirmed");
    };
  }

  /* ================= UI HELPERS ================= */
  function renderItem(item) {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <img src="${item.image || ''}" />
      <div>
        <b>${item.name || item.stoneName}</b><br>
        <span class="muted">Qty: ${item.quantity || 1} | ${item.priceUnit || ''}</span><br>
        <span class="badge">${item.category || ''}</span>
      </div>
    `;
    itemsContainer.appendChild(div);
  }

  function updateSummary() {
    totalEl.textContent = total.toFixed(2);
    advanceEl.textContent = advance.toFixed(2);
    payableEl.textContent = (total - advance).toFixed(2);
  }
</script>

</body>
</html>
