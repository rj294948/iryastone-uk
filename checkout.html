<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - IRYA STONE</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
    header { background:#2c3e50; color:#fff; padding:15px; text-align:center; }
    h1 { margin:0; font-size:1.5em; }
    .container { max-width:1000px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-bottom:20px; }
    table th, table td { padding:12px; border:1px solid #ddd; text-align:center; }
    table th { background:#2c3e50; color:#fff; }
    button { padding:10px 20px; border:none; background:#27ae60; color:#fff; cursor:pointer; border-radius:5px; }
    button:disabled { background:#95a5a6; cursor:not-allowed; }
    #loadingIndicator { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); color:#fff; font-size:1.5em; text-align:center; padding-top:20%; z-index:1000; }
</style>
</head>
<body>

<header>
    <h1>Checkout - IRYA STONE</h1>
</header>

<div id="loadingIndicator">Loading...</div>

<div class="container">
    <h2>Your Cart</h2>
    <table id="cartTable">
        <thead>
            <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <!-- Cart items will load here -->
        </tbody>
    </table>
    <h3 id="cartTotal">Grand Total: ₹0</h3>
    <button id="placeOrderBtn">Place Order</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================
const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp = null;
let firebaseDB = null;
let firebaseAuth = null;

// Initialize Firebase
async function initializeFirebase() {
    if (!firebase.apps.length) {
        firebaseApp = firebase.initializeApp(firebaseConfig);
    } else {
        firebaseApp = firebase.app();
    }
    firebaseDB = firebase.firestore();
    firebaseAuth = firebase.auth();

    try {
        await firebaseDB.enablePersistence();
        console.log('Firestore offline persistence enabled');
    } catch(err) {
        console.warn('Firestore persistence not enabled:', err.code);
    }
}

// Get current user or guest
function getCurrentUser() {
    const userData = localStorage.getItem('irya_stone_user');
    let user = userData ? JSON.parse(userData) : null;

    if (!user) {
        let guestId = localStorage.getItem('irya_guest_id');
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('irya_guest_id', guestId);
        }
        user = { uid: guestId, displayName: 'Guest User', email: '' };
    }

    return user;
}

// Cart system
let cartItems = [];

// Load cart from localStorage
function loadCart() {
    const cartData = localStorage.getItem('irya_cart');
    cartItems = cartData ? JSON.parse(cartData) : [];
}

// Render cart table
function renderCart() {
    const tbody = document.querySelector('#cartTable tbody');
    tbody.innerHTML = '';
    let grandTotal = 0;

    cartItems.forEach(item => {
        const total = item.price * item.qty;
        grandTotal += total;
        tbody.innerHTML += `<tr>
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>₹${item.price}</td>
            <td>₹${total}</td>
        </tr>`;
    });

    document.getElementById('cartTotal').innerText = 'Grand Total: ₹' + grandTotal;
}

// Place order
async function placeOrder() {
    if(cartItems.length === 0) {
        alert('Cart is empty!');
        return;
    }

    const user = getCurrentUser();
    const orderData = {
        userId: user.uid,
        items: cartItems,
        totalAmount: cartItems.reduce((sum, item) => sum + item.price * item.qty, 0),
        status: 'Pending',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    showLoading(true);

    try {
        await firebaseDB.collection('orders').add(orderData);
        alert('✅ Order placed successfully!');
        cartItems = [];
        localStorage.removeItem('irya_cart');
        renderCart();
    } catch (error) {
        console.error('Error placing order:', error);
        alert('❌ Failed to place order. Try again.');
    }

    showLoading(false);
}

// Loading indicator
function showLoading(show) {
    const loader = document.getElementById('loadingIndicator');
    loader.style.display = show ? 'block' : 'none';
}

// DOM ready
document.addEventListener('DOMContentLoaded', async () => {
    showLoading(true);
    await initializeFirebase();
    loadCart();
    renderCart();

    document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);
    showLoading(false);
});
</script>

</body>
</html>
