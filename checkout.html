<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

/* Back Button */
.back-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-light);
    color: var(--text-dark);
    padding: 8px 16px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
}

.back-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Main Content */
.main-content {
    padding: 90px 16px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    margin-bottom: 30px;
}

.page-header h1 {
    font-size: 28px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-bottom: 10px;
    font-family: 'Roboto Slab', serif;
}

.page-subtitle {
    color: var(--text-light);
    font-size: 16px;
}

/* Checkout Layout */
.checkout-container {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 30px;
}

/* Checkout Steps */
.checkout-steps {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.checkout-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    min-width: 100px;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    color: var(--text-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    transition: var(--transition);
}

.step-label {
    font-size: 12px;
    color: var(--text-light);
    text-align: center;
    font-weight: 500;
}

.checkout-step.active .step-number {
    background: var(--primary-gold);
    color: white;
}

.checkout-step.active .step-label {
    color: var(--primary-gold);
    font-weight: 600;
}

.checkout-step.completed .step-number {
    background: #10b981;
    color: white;
}

/* Checkout Form */
.checkout-form-section {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    padding: 30px;
    margin-bottom: 20px;
}

.checkout-form-section h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.checkout-form-section h2 i {
    color: var(--primary-gold);
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: ' *';
    color: #ff4757;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* Shipping Method */
.shipping-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.shipping-method {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
}

.shipping-method:hover {
    border-color: var(--gold-light);
}

.shipping-method.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.method-radio {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #e0e0e0;
    position: relative;
    flex-shrink: 0;
}

.shipping-method.selected .method-radio {
    border-color: var(--primary-gold);
}

.shipping-method.selected .method-radio::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    background: var(--primary-gold);
    border-radius: 50%;
}

.method-details {
    flex: 1;
}

.method-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--stone-dark);
}

.method-description {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 5px;
}

.method-price {
    font-weight: 700;
    color: var(--primary-gold);
    font-size: 16px;
}

/* Payment Methods */
.payment-methods {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.payment-method {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
}

.payment-method:hover {
    border-color: var(--gold-light);
}

.payment-method.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-method i {
    font-size: 32px;
    margin-bottom: 10px;
    color: var(--text-light);
}

.payment-method.selected i {
    color: var(--primary-gold);
}

.payment-method span {
    display: block;
    font-weight: 600;
    color: var(--stone-dark);
    font-size: 14px;
}

/* Order Summary */
.order-summary {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    padding: 25px;
    position: sticky;
    top: 100px;
    height: fit-content;
}

.order-summary h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
    background: var(--bg-light);
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.order-item-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--stone-dark);
}

.order-item-quantity {
    font-size: 12px;
    color: var(--text-light);
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
    font-size: 16px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 15px;
}

.summary-label {
    color: var(--text-light);
}

.summary-value {
    font-weight: 500;
    color: var(--stone-dark);
}

.summary-total {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #f0f0f0;
}

.summary-total .summary-value {
    color: var(--primary-gold);
    font-size: 24px;
}

.terms-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin: 25px 0;
    font-size: 13px;
    color: var(--text-light);
}

.terms-checkbox input[type="checkbox"] {
    margin-top: 3px;
    accent-color: var(--primary-gold);
}

.terms-checkbox a {
    color: var(--primary-gold);
    text-decoration: none;
}

.terms-checkbox a:hover {
    text-decoration: underline;
}

.place-order-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.place-order-btn:hover:not(:disabled) {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.place-order-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Loading & Notifications */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    display: none;
}

.notification.show {
    transform: translateX(0);
    display: block;
}

.error-message {
    background: #fee;
    color: #c00;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 14px;
    border-left: 4px solid #c00;
    display: none;
}

.error-message.show {
    display: block;
}

/* Responsive */
@media (max-width: 992px) {
    .checkout-container {
        grid-template-columns: 1fr;
    }
    
    .order-summary {
        position: static;
        margin-top: 30px;
    }
}

@media (max-width: 768px) {
    .checkout-form-section {
        padding: 20px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .payment-methods {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .main-content {
        padding: 80px 12px 20px;
    }
}

@media (max-width: 480px) {
    .checkout-steps {
        justify-content: space-between;
    }
    
    .checkout-step {
        min-width: auto;
        flex: 1;
    }
    
    .payment-methods {
        grid-template-columns: 1fr;
    }
    
    .nav-btn {
        min-width: 60px;
        padding: 5px;
    }
    
    .nav-btn span {
        font-size: 10px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Header -->
<header>
    <a href="cart.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Cart</span>
    </a>
    
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="min-width: 140px; text-align: right;">
        <a href="index.html" class="back-btn" style="padding: 8px 12px;">
            <i class="fas fa-home"></i>
        </a>
    </div>
</header>

<!-- Main Content -->
<main class="main-content">
    <div class="page-header">
        <h1>Checkout</h1>
        <p class="page-subtitle">Complete your order in just 3 steps</p>
    </div>
    
    <!-- Checkout Steps -->
    <div class="checkout-steps">
        <div class="checkout-step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-label">Shipping Details</div>
        </div>
        <div class="checkout-step" id="step2">
            <div class="step-number">2</div>
            <div class="step-label">Payment Method</div>
        </div>
        <div class="checkout-step" id="step3">
            <div class="step-number">3</div>
            <div class="step-label">Place Order</div>
        </div>
    </div>
    
    <div class="checkout-container">
        <!-- Checkout Form -->
        <div class="checkout-form">
            <!-- Step 1: Shipping Details -->
            <div class="checkout-form-section" id="shippingSection">
                <h2><i class="fas fa-truck"></i> Shipping Details</h2>
                
                <div class="error-message" id="shippingError"></div>
                
                <form id="shippingForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName" class="required">Full Name</label>
                            <input type="text" id="fullName" name="fullName" required placeholder="Enter your full name">
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="required">Email Address</label>
                            <input type="email" id="email" name="email" required placeholder="Enter your email">
                        </div>
                        
                        <div class="form-group">
                            <label for="phone" class="required">Phone Number</label>
                            <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
                        </div>
                        
                        <div class="form-group">
                            <label for="company">Company Name (Optional)</label>
                            <input type="text" id="company" name="company" placeholder="Enter company name">
                        </div>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Shipping Address</h3>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="address" class="required">Street Address</label>
                                <input type="text" id="address" name="address" required placeholder="Enter street address">
                            </div>
                            
                            <div class="form-group">
                                <label for="city" class="required">City</label>
                                <input type="text" id="city" name="city" required placeholder="Enter city">
                            </div>
                            
                            <div class="form-group">
                                <label for="state" class="required">State/Region</label>
                                <input type="text" id="state" name="state" required placeholder="Enter state or region">
                            </div>
                            
                            <div class="form-group">
                                <label for="postalCode" class="required">Postal Code</label>
                                <input type="text" id="postalCode" name="postalCode" required placeholder="Enter postal code">
                            </div>
                            
                            <div class="form-group">
                                <label for="country" class="required">Country</label>
                                <select id="country" name="country" required>
                                    <option value="">Select Country</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="AU">Australia</option>
                                    <option value="IN">India</option>
                                    <option value="DE">Germany</option>
                                    <option value="FR">France</option>
                                    <option value="IT">Italy</option>
                                    <option value="ES">Spain</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Shipping Method</h3>
                        
                        <div class="shipping-methods">
                            <div class="shipping-method" onclick="selectShippingMethod('standard')">
                                <div class="method-radio"></div>
                                <div class="method-details">
                                    <div class="method-name">Standard Delivery</div>
                                    <div class="method-description">5-10 business days</div>
                                    <div class="method-price">£25.00</div>
                                </div>
                            </div>
                            
                            <div class="shipping-method" onclick="selectShippingMethod('express')">
                                <div class="method-radio"></div>
                                <div class="method-details">
                                    <div class="method-name">Express Delivery</div>
                                    <div class="method-description">2-4 business days</div>
                                    <div class="method-price">£45.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Order Notes (Optional)</label>
                        <textarea id="notes" name="notes" placeholder="Add any special instructions or notes for your order..."></textarea>
                    </div>
                </form>
                
                <div style="margin-top: 30px; text-align: right;">
                    <button class="place-order-btn" onclick="goToStep(2)">
                        Continue to Payment
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Payment Method -->
            <div class="checkout-form-section" id="paymentSection" style="display: none;">
                <h2><i class="fas fa-credit-card"></i> Payment Method</h2>
                
                <div class="error-message" id="paymentError"></div>
                
                <div style="margin-bottom: 25px;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Select Payment Method</h3>
                    
                    <div class="payment-methods">
                        <div class="payment-method" onclick="selectPaymentMethod('card')">
                            <i class="fas fa-credit-card"></i>
                            <span>Credit/Debit Card</span>
                        </div>
                        
                        <div class="payment-method" onclick="selectPaymentMethod('paypal')">
                            <i class="fab fa-paypal"></i>
                            <span>PayPal</span>
                        </div>
                        
                        <div class="payment-method" onclick="selectPaymentMethod('bank')">
                            <i class="fas fa-university"></i>
                            <span>Bank Transfer</span>
                        </div>
                        
                        <div class="payment-method" onclick="selectPaymentMethod('cod')">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Advance Payment (30%)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Card Details Form -->
                <div id="cardDetailsForm" style="display: none;">
                    <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Card Details</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cardNumber" class="required">Card Number</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        
                        <div class="form-group">
                            <label for="cardName" class="required">Name on Card</label>
                            <input type="text" id="cardName" placeholder="Enter name as on card">
                        </div>
                        
                        <div class="form-group">
                            <label for="expiryDate" class="required">Expiry Date</label>
                            <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5">
                        </div>
                        
                        <div class="form-group">
                            <label for="cvv" class="required">CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px;">
                    <button class="back-btn" style="padding: 12px 24px;" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button class="place-order-btn" onclick="goToStep(3)">
                        Review Order
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Review Order -->
            <div class="checkout-form-section" id="reviewSection" style="display: none;">
                <h2><i class="fas fa-clipboard-check"></i> Review Your Order</h2>
                
                <div id="orderReviewContent">
                    <!-- Order details will be populated here -->
                </div>
                
                <div class="terms-checkbox">
                    <input type="checkbox" id="termsAgreement" required>
                    <label for="termsAgreement">
                        I agree to the <a href="#" onclick="showTerms()">Terms & Conditions</a> and 
                        <a href="#" onclick="showPrivacy()">Privacy Policy</a>. I understand that I'm 
                        placing an order for natural stone products and 30% advance payment is required.
                    </label>
                </div>
                
                <div class="error-message" id="reviewError"></div>
                
                <div style="margin-top: 30px; display: flex; gap: 15px;">
                    <button class="back-btn" style="padding: 12px 24px;" onclick="goToStep(2)">
                        <i class="fas fa-arrow-left"></i>
                        Back to Payment
                    </button>
                    <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">
                        <i class="fas fa-lock"></i>
                        Place Order
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="order-summary">
            <h2>Order Summary</h2>
            
            <div class="order-items" id="orderItemsList">
                <!-- Order items will be loaded here -->
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Subtotal</span>
                <span class="summary-value" id="subtotalAmount">£0.00</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Shipping</span>
                <span class="summary-value" id="shippingAmount">£0.00</span>
            </div>
            
            <div class="summary-row">
                <span class="summary-label">Tax (VAT 20%)</span>
                <span class="summary-value" id="taxAmount">£0.00</span>
            </div>
            
            <div class="summary-row" id="advancePaymentRow" style="display: none;">
                <span class="summary-label">Advance Payment (30%)</span>
                <span class="summary-value" id="advanceAmount">£0.00</span>
            </div>
            
            <div class="summary-total">
                <span class="summary-label">Total Amount</span>
                <span class="summary-value" id="totalAmount">£0.00</span>
            </div>
            
            <div style="margin-top: 20px; text-align: center; font-size: 12px; color: var(--text-light);">
                <i class="fas fa-shield-alt"></i> Secure checkout • SSL encrypted
            </div>
        </div>
    </div>
</main>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="account.html" class="nav-btn">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
    <a href="orders.html" class="nav-btn">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="cart.html" class="nav-btn">
        <i class="fas fa-shopping-cart"></i>
        <span>Cart</span>
        <span class="cart-badge" id="cartBadge">0</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

// Firebase variables
let firebaseApp, firebaseDB, firebaseAuth;
let authSystem = null;
let cartSystem = null;

// ============================================
// CHECKOUT STATE MANAGEMENT
// ============================================

const checkoutState = {
    currentStep: 1,
    shippingMethod: 'standard',
    shippingCost: 25.00,
    paymentMethod: null,
    orderItems: [],
    isBuyNowFlow: false,
    advancePayment: true,
    orderData: {
        shipping: {},
        payment: {},
        items: [],
        totals: {}
    }
};

// ============================================
// AUTH SYSTEM (SAME AS CART)
// ============================================

class SimpleAuthSystem {
    constructor() {
        this.authKey = 'irya_stone_auth_user';
        this.currentUser = null;
    }
    
    async init() {
        return new Promise((resolve) => {
            const userData = localStorage.getItem(this.authKey);
            if (userData) {
                try {
                    this.currentUser = JSON.parse(userData);
                } catch (e) {
                    this.currentUser = null;
                }
            }
            
            if (firebaseAuth) {
                firebaseAuth.onAuthStateChanged((user) => {
                    if (user) {
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            isFirebaseUser: true
                        };
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                    } else if (this.currentUser && this.currentUser.isFirebaseUser) {
                        this.currentUser = null;
                        localStorage.removeItem(this.authKey);
                    }
                    resolve(this);
                });
            } else {
                if (!this.currentUser) {
                    let guestId = localStorage.getItem('irya_guest_id');
                    if (!guestId) {
                        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('irya_guest_id', guestId);
                    }
                    this.currentUser = {
                        uid: guestId,
                        displayName: 'Guest',
                        isFirebaseUser: false,
                        isGuest: true
                    };
                    localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                }
                resolve(this);
            }
        });
    }
    
    isLoggedIn() {
        return this.currentUser && this.currentUser.isFirebaseUser === true;
    }
    
    getUserId() {
        if (!this.currentUser) {
            let guestId = localStorage.getItem('irya_guest_id');
            if (!guestId) {
                guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('irya_guest_id', guestId);
            }
            this.currentUser = {
                uid: guestId,
                displayName: 'Guest',
                isFirebaseUser: false,
                isGuest: true
            };
            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
        }
        return this.currentUser.uid;
    }
    
    getUserName() {
        return this.currentUser ? this.currentUser.displayName : 'Guest';
    }
    
    getUserEmail() {
        return this.currentUser ? this.currentUser.email : '';
    }
}

// ============================================
// CHECKOUT CART SYSTEM
// ============================================

class CheckoutCartSystem {
    constructor(authSystem) {
        this.authSystem = authSystem;
        this.localCartKey = 'irya_local_cart_';
        this.buyNowKey = 'irya_buynow_cart_';
        this.orderItems = [];
        this.userId = null;
        this.isBuyNowFlow = false;
    }
    
    async init() {
        this.userId = this.authSystem.getUserId();
        await this.loadOrderItems();
        return this;
    }
    
    async loadOrderItems() {
        try {
            // Check if this is a Buy Now flow
            const urlParams = new URLSearchParams(window.location.search);
            this.isBuyNowFlow = urlParams.get('buynow') === 'true' || 
                                localStorage.getItem('irya_is_buynow_flow') === 'true';
            
            if (this.isBuyNowFlow) {
                await this.loadBuyNowItems();
            } else {
                await this.loadCartItems();
            }
            
            console.log("Loaded order items:", this.orderItems.length, "Buy Now:", this.isBuyNowFlow);
            return this.orderItems;
        } catch (error) {
            console.error('Error loading order items:', error);
            this.orderItems = [];
            return [];
        }
    }
    
    async loadCartItems() {
        const cartKey = this.localCartKey + this.userId;
        const cartData = localStorage.getItem(cartKey);
        this.orderItems = cartData ? JSON.parse(cartData) : [];
        
        // Also try Firebase if logged in
        if (this.authSystem.isLoggedIn() && firebaseDB) {
            try {
                const cartDoc = await firebaseDB.collection('userCarts').doc(this.userId).get();
                if (cartDoc.exists) {
                    const firebaseCart = cartDoc.data().items || [];
                    if (firebaseCart.length > 0) {
                        // Merge with local cart
                        const mergedCart = this.mergeCarts(this.orderItems, firebaseCart);
                        this.orderItems = mergedCart;
                    }
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
            }
        }
    }
    
    async loadBuyNowItems() {
        try {
            // First try session storage
            const sessionBuyNow = sessionStorage.getItem('irya_current_buynow');
            if (sessionBuyNow) {
                this.orderItems = [JSON.parse(sessionBuyNow)];
                return;
            }
            
            // Then try localStorage
            const buyNowKey = this.buyNowKey + this.userId;
            const buyNowData = localStorage.getItem(buyNowKey);
            if (buyNowData) {
                this.orderItems = JSON.parse(buyNowData);
            }
        } catch (error) {
            console.error('Error loading buy now items:', error);
            this.orderItems = [];
        }
    }
    
    mergeCarts(localCart, firebaseCart) {
        const mergedMap = new Map();
        
        localCart.forEach(item => {
            const key = item.uniqueId || item.id;
            mergedMap.set(key, item);
        });
        
        firebaseCart.forEach(item => {
            const key = item.uniqueId || item.id;
            if (!mergedMap.has(key)) {
                mergedMap.set(key, item);
            }
        });
        
        return Array.from(mergedMap.values());
    }
    
    getOrderItems() {
        return this.orderItems;
    }
    
    getItemCount() {
        return this.orderItems.reduce((total, item) => total + (item.quantity || 1), 0);
    }
    
    getSubtotal() {
        return this.orderItems.reduce((total, item) => {
            const itemTotal = item.calculatedPrice || (item.price * (item.quantity || 1));
            return total + itemTotal;
        }, 0);
    }
    
    getTax() {
        return this.getSubtotal() * 0.2; // 20% VAT
    }
    
    getShippingCost(shippingMethod = 'standard') {
        return shippingMethod === 'express' ? 45.00 : 25.00;
    }
    
    getTotal(shippingMethod = 'standard') {
        const subtotal = this.getSubtotal();
        const tax = this.getTax();
        const shipping = this.getShippingCost(shippingMethod);
        return subtotal + tax + shipping;
    }
    
    getAdvancePayment(shippingMethod = 'standard') {
        const total = this.getTotal(shippingMethod);
        return total * 0.3;
    }
    
    clearBuyNowData() {
        const buyNowKey = this.buyNowKey + this.userId;
        localStorage.removeItem(buyNowKey);
        localStorage.removeItem('irya_is_buynow_flow');
        sessionStorage.removeItem('irya_current_buynow');
    }
    
    async clearCartAfterOrder() {
        if (this.isBuyNowFlow) {
            this.clearBuyNowData();
        } else {
            // Clear local cart
            const cartKey = this.localCartKey + this.userId;
            localStorage.removeItem(cartKey);
            
            // Clear Firebase cart if logged in
            if (this.authSystem.isLoggedIn() && firebaseDB) {
                try {
                    await firebaseDB.collection('userCarts').doc(this.userId).delete();
                } catch (error) {
                    console.error('Error clearing Firebase cart:', error);
                }
            }
        }
        
        // Update cart badge
        updateCartBadge();
    }
    
    updateCartBadge() {
        const cartBadge = document.getElementById('cartBadge');
        if (cartBadge) {
            // If cart is empty, show 0
            const count = this.isBuyNowFlow ? 0 : this.getItemCount();
            cartBadge.textContent = count;
            cartBadge.style.display = count > 0 ? 'flex' : 'none';
        }
    }
}

// ============================================
// UI FUNCTIONS
// ============================================

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    if (!errorElement) return;
    
    errorElement.textContent = message;
    errorElement.classList.add('show');
    
    setTimeout(() => {
        errorElement.classList.remove('show');
    }, 5000);
}

function formatPrice(price) {
    if (!price && price !== 0) return '£0.00';
    return `£${parseFloat(price).toFixed(2)}`;
}

// ============================================
// CHECKOUT STEP MANAGEMENT
// ============================================

function goToStep(step) {
    const currentStep = checkoutState.currentStep;
    
    // Validate current step before proceeding
    if (step > currentStep && !validateCurrentStep(currentStep)) {
        return;
    }
    
    // Update step visuals
    document.querySelectorAll('.checkout-step').forEach((stepEl, index) => {
        const stepNumber = index + 1;
        stepEl.classList.remove('active', 'completed');
        
        if (stepNumber < step) {
            stepEl.classList.add('completed');
        } else if (stepNumber === step) {
            stepEl.classList.add('active');
        }
    });
    
    // Show/hide sections
    document.getElementById('shippingSection').style.display = step === 1 ? 'block' : 'none';
    document.getElementById('paymentSection').style.display = step === 2 ? 'block' : 'none';
    document.getElementById('reviewSection').style.display = step === 3 ? 'block' : 'none';
    
    checkoutState.currentStep = step;
    
    // If going to step 3, update review content
    if (step === 3) {
        updateOrderReview();
    }
    
    // Scroll to top of form
    window.scrollTo({ top: 180, behavior: 'smooth' });
}

function validateCurrentStep(step) {
    switch(step) {
        case 1:
            return validateShippingDetails();
        case 2:
            return validatePaymentMethod();
        default:
            return true;
    }
}

function validateShippingDetails() {
    const requiredFields = ['fullName', 'email', 'phone', 'address', 'city', 'state', 'postalCode', 'country'];
    let isValid = true;
    let firstInvalidField = null;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
            if (!firstInvalidField) firstInvalidField = field;
            field.style.borderColor = '#ff4757';
            isValid = false;
        } else if (field) {
            field.style.borderColor = '';
        }
    });
    
    // Validate email format
    const emailField = document.getElementById('email');
    if (emailField && emailField.value.trim()) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailField.value.trim())) {
            emailField.style.borderColor = '#ff4757';
            isValid = false;
            showError('shippingError', 'Please enter a valid email address.');
        }
    }
    
    if (!isValid) {
        showError('shippingError', 'Please fill in all required fields.');
        if (firstInvalidField) {
            firstInvalidField.focus();
        }
    } else {
        // Save shipping data to state
        checkoutState.orderData.shipping = {
            fullName: document.getElementById('fullName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            company: document.getElementById('company').value.trim(),
            address: document.getElementById('address').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            postalCode: document.getElementById('postalCode').value.trim(),
            country: document.getElementById('country').value,
            shippingMethod: checkoutState.shippingMethod,
            notes: document.getElementById('notes').value.trim()
        };
    }
    
    return isValid;
}

function validatePaymentMethod() {
    if (!checkoutState.paymentMethod) {
        showError('paymentError', 'Please select a payment method.');
        return false;
    }
    
    // Validate card details if card payment selected
    if (checkoutState.paymentMethod === 'card') {
        const cardFields = ['cardNumber', 'cardName', 'expiryDate', 'cvv'];
        let isValid = true;
        
        cardFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field && !field.value.trim()) {
                field.style.borderColor = '#ff4757';
                isValid = false;
            } else if (field) {
                field.style.borderColor = '';
            }
        });
        
        if (!isValid) {
            showError('paymentError', 'Please fill in all card details.');
            return false;
        }
        
        // Save card details (in real app, this would be handled by payment processor)
        checkoutState.orderData.payment.card = {
            last4: document.getElementById('cardNumber').value.trim().slice(-4),
            brand: detectCardBrand(document.getElementById('cardNumber').value.trim())
        };
    }
    
    // Save payment data to state
    checkoutState.orderData.payment = {
        method: checkoutState.paymentMethod,
        status: 'pending',
        advancePayment: checkoutState.paymentMethod === 'cod',
        advanceAmount: calculateAdvanceAmount()
    };
    
    return true;
}

function detectCardBrand(cardNumber) {
    const cleaned = cardNumber.replace(/\D/g, '');
    
    if (/^4/.test(cleaned)) return 'Visa';
    if (/^5[1-5]/.test(cleaned)) return 'Mastercard';
    if (/^3[47]/.test(cleaned)) return 'American Express';
    if (/^6(?:011|5)/.test(cleaned)) return 'Discover';
    if (/^3(?:0[0-5]|[68])/.test(cleaned)) return 'Diners Club';
    
    return 'Unknown';
}

function calculateAdvanceAmount() {
    const total = checkoutState.orderData.totals.total || 0;
    return total * 0.3;
}

// ============================================
// SHIPPING & PAYMENT METHODS
// ============================================

function selectShippingMethod(method) {
    checkoutState.shippingMethod = method;
    checkoutState.shippingCost = method === 'express' ? 45.00 : 25.00;
    
    // Update UI
    document.querySelectorAll('.shipping-method').forEach(el => {
        el.classList.remove('selected');
    });
    
    const selectedEl = document.querySelector(`[onclick="selectShippingMethod('${method}')"]`);
    if (selectedEl) {
        selectedEl.classList.add('selected');
    }
    
    // Update order summary
    updateOrderSummary();
}

function selectPaymentMethod(method) {
    checkoutState.paymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
    });
    
    const selectedEl = document.querySelector(`[onclick="selectPaymentMethod('${method}')"]`);
    if (selectedEl) {
        selectedEl.classList.add('selected');
    }
    
    // Show/hide card details form
    const cardForm = document.getElementById('cardDetailsForm');
    if (cardForm) {
        cardForm.style.display = method === 'card' ? 'block' : 'none';
    }
    
    // Update advance payment display
    updateOrderSummary();
}

// ============================================
// ORDER SUMMARY FUNCTIONS
// ============================================

function updateOrderSummary() {
    if (!cartSystem) return;
    
    const items = cartSystem.getOrderItems();
    const subtotal = cartSystem.getSubtotal();
    const shipping = cartSystem.getShippingCost(checkoutState.shippingMethod);
    const tax = cartSystem.getTax();
    const total = subtotal + shipping + tax;
    const advanceAmount = checkoutState.paymentMethod === 'cod' ? total * 0.3 : 0;
    
    // Update amounts
    document.getElementById('subtotalAmount').textContent = formatPrice(subtotal);
    document.getElementById('shippingAmount').textContent = formatPrice(shipping);
    document.getElementById('taxAmount').textContent = formatPrice(tax);
    document.getElementById('totalAmount').textContent = formatPrice(total);
    
    // Update advance payment display
    const advanceRow = document.getElementById('advancePaymentRow');
    const advanceAmountEl = document.getElementById('advanceAmount');
    
    if (checkoutState.paymentMethod === 'cod') {
        advanceRow.style.display = 'flex';
        advanceAmountEl.textContent = formatPrice(advanceAmount);
    } else {
        advanceRow.style.display = 'none';
    }
    
    // Update order items list
    const orderItemsList = document.getElementById('orderItemsList');
    if (orderItemsList) {
        if (items.length === 0) {
            orderItemsList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">No items in cart</div>';
            return;
        }
        
        const itemsHTML = items.slice(0, 3).map(item => {
            const itemPrice = item.calculatedPrice || (item.price * (item.quantity || 1));
            let specsHTML = '';
            
            if (item.calculationData) {
                const calc = item.calculationData;
                if (calc.unit === 'sqft' || calc.unit === 'sqm') {
                    specsHTML = `<div style="font-size: 11px; color: var(--text-light);">${calc.length || 0} × ${calc.width || 0} ${calc.unit}</div>`;
                } else if (calc.unit === 'weight') {
                    specsHTML = `<div style="font-size: 11px; color: var(--text-light);">${calc.weight || 0} kg</div>`;
                }
            }
            
            return `
            <div class="order-item">
                <div class="order-item-image">
                    <img src="${item.image || 'https://images.unsplash.com/photo-1544931170-3ca1337cce88'}" 
                         alt="${item.name}"
                         onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88'">
                </div>
                <div class="order-item-details">
                    <div class="order-item-name">${item.stone_name || item.name}</div>
                    <div class="order-item-quantity">Quantity: ${item.quantity || 1}</div>
                    ${specsHTML}
                    <div class="order-item-price">${formatPrice(itemPrice)}</div>
                </div>
            </div>
            `;
        }).join('');
        
        if (items.length > 3) {
            orderItemsList.innerHTML = itemsHTML + `
                <div style="text-align: center; padding: 10px; color: var(--text-light); font-size: 12px;">
                    + ${items.length - 3} more item(s)
                </div>
            `;
        } else {
            orderItemsList.innerHTML = itemsHTML;
        }
    }
    
    // Update checkout state
    checkoutState.orderData.totals = {
        subtotal: subtotal,
        shipping: shipping,
        tax: tax,
        total: total,
        advanceAmount: advanceAmount
    };
    
    checkoutState.orderData.items = items;
}

function updateOrderReview() {
    const reviewContent = document.getElementById('orderReviewContent');
    if (!reviewContent) return;
    
    const shipping = checkoutState.orderData.shipping;
    const payment = checkoutState.orderData.payment;
    const totals = checkoutState.orderData.totals;
    
    reviewContent.innerHTML = `
        <div style="margin-bottom: 25px;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Shipping Information</h3>
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;">
                <p><strong>${shipping.fullName || 'Not provided'}</strong></p>
                <p>${shipping.address || ''}</p>
                <p>${shipping.city || ''}, ${shipping.state || ''} ${shipping.postalCode || ''}</p>
                <p>${shipping.country || ''}</p>
                <p>Phone: ${shipping.phone || ''}</p>
                <p>Email: ${shipping.email || ''}</p>
                <p style="margin-top: 10px;"><strong>Shipping Method:</strong> ${checkoutState.shippingMethod === 'express' ? 'Express Delivery' : 'Standard Delivery'}</p>
            </div>
        </div>
        
        <div style="margin-bottom: 25px;">
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Payment Method</h3>
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;">
                <p><strong>${getPaymentMethodName(payment.method)}</strong></p>
                ${payment.method === 'cod' ? '<p><em>30% advance payment required</em></p>' : ''}
            </div>
        </div>
        
        <div>
            <h3 style="font-size: 16px; margin-bottom: 15px; color: var(--stone-dark);">Order Summary</h3>
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Subtotal:</span>
                    <span>${formatPrice(totals.subtotal)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Shipping:</span>
                    <span>${formatPrice(totals.shipping)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Tax (VAT):</span>
                    <span>${formatPrice(totals.tax)}</span>
                </div>
                ${payment.method === 'cod' ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; color: var(--primary-gold); font-weight: 600;">
                    <span>Advance Payment (30%):</span>
                    <span>${formatPrice(totals.advanceAmount)}</span>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; font-weight: 700; font-size: 18px;">
                    <span>${payment.method === 'cod' ? 'Balance After Shipping:' : 'Total Amount:'}</span>
                    <span>${formatPrice(payment.method === 'cod' ? totals.total - totals.advanceAmount : totals.total)}</span>
                </div>
            </div>
        </div>
    `;
}

function getPaymentMethodName(method) {
    switch(method) {
        case 'card': return 'Credit/Debit Card';
        case 'paypal': return 'PayPal';
        case 'bank': return 'Bank Transfer';
        case 'cod': return 'Advance Payment (30%)';
        default: return 'Unknown';
    }
}

// ============================================
// ORDER PLACEMENT
// ============================================

async function placeOrder() {
    // Validate terms agreement
    const termsCheckbox = document.getElementById('termsAgreement');
    if (!termsCheckbox || !termsCheckbox.checked) {
        showError('reviewError', 'You must agree to the Terms & Conditions to place your order.');
        return;
    }
    
    // Validate all steps
    if (!validateShippingDetails() || !validatePaymentMethod()) {
        showError('reviewError', 'Please complete all steps before placing your order.');
        return;
    }
    
    // Check if there are items
    if (!cartSystem || cartSystem.getOrderItems().length === 0) {
        showError('reviewError', 'Your cart is empty. Please add items to your cart first.');
        return;
    }
    
    showLoading(true);
    
    try {
        // Generate order ID
        const orderId = 'IRYA' + Date.now() + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        // Prepare order data
        const orderData = {
            id: orderId,
            userId: cartSystem.userId,
            userEmail: checkoutState.orderData.shipping.email,
            userName: checkoutState.orderData.shipping.fullName,
            items: checkoutState.orderData.items,
            shipping: checkoutState.orderData.shipping,
            payment: checkoutState.orderData.payment,
            totals: checkoutState.orderData.totals,
            status: 'pending',
            orderDate: new Date().toISOString(),
            estimatedDelivery: calculateDeliveryDate(),
            notes: checkoutState.orderData.shipping.notes,
            source: cartSystem.isBuyNowFlow ? 'buy_now' : 'cart',
            isAdvancePayment: checkoutState.orderData.payment.advancePayment,
            advancePaid: false,
            balancePaid: false
        };
        
        // Save order to Firebase
        if (firebaseDB) {
            await firebaseDB.collection('orders').doc(orderId).set(orderData);
            console.log('Order saved to Firebase:', orderId);
        }
        
        // Save order to localStorage for offline access
        const userOrdersKey = 'irya_user_orders_' + cartSystem.userId;
        const existingOrders = JSON.parse(localStorage.getItem(userOrdersKey) || '[]');
        existingOrders.push(orderData);
        localStorage.setItem(userOrdersKey, JSON.stringify(existingOrders));
        
        // Clear cart after successful order
        await cartSystem.clearCartAfterOrder();
        
        // Save order data for confirmation page
        sessionStorage.setItem('irya_last_order_id', orderId);
        sessionStorage.setItem('irya_last_order_data', JSON.stringify(orderData));
        
        showNotification('Order placed successfully!');
        
        // Redirect to confirmation page
        setTimeout(() => {
            window.location.href = `order-confirmation.html?id=${orderId}`;
        }, 1500);
        
    } catch (error) {
        console.error('Error placing order:', error);
        showError('reviewError', 'Failed to place order. Please try again.');
    } finally {
        showLoading(false);
    }
}

function calculateDeliveryDate() {
    const today = new Date();
    const daysToAdd = checkoutState.shippingMethod === 'express' ? 4 : 10;
    
    // Add business days
    let count = 0;
    while (count < daysToAdd) {
        today.setDate(today.getDate() + 1);
        if (today.getDay() !== 0 && today.getDay() !== 6) {
            count++;
        }
    }
    
    return today.toISOString();
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showTerms() {
    alert('Terms & Conditions:\n\n1. 30% advance payment is required for all orders.\n2. Balance payment is due after shipping confirmation.\n3. Natural stone products may have slight variations in color and pattern.\n4. Shipping costs are calculated based on weight and destination.\n5. Returns are accepted within 7 days of delivery for unused products.\n\nBy placing an order, you agree to these terms.');
}

function showPrivacy() {
    alert('Privacy Policy:\n\nYour personal information is used solely for order processing and shipping. We do not share your data with third parties. All payments are processed securely.');
}

function updateCartBadge() {
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        // Show 0 if no items
        cartBadge.textContent = '0';
        cartBadge.style.display = 'none';
    }
}

// ============================================
// FIREBASE INITIALIZATION
// ============================================

async function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            console.warn('Firebase SDK not loaded');
            return false;
        }
        
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        
        firebaseDB = firebase.firestore();
        firebaseAuth = firebase.auth();
        
        console.log('Firebase initialized successfully');
        return true;
    } catch (error) {
        console.error('Firebase initialization error:', error);
        return false;
    }
}

// ============================================
// CHECKOUT PAGE INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log('Checkout page initializing...');
    
    showLoading(true);
    
    try {
        // Initialize Firebase
        await initializeFirebase();
        
        // Initialize Authentication System
        authSystem = new SimpleAuthSystem();
        await authSystem.init();
        
        // Initialize Cart System
        cartSystem = new CheckoutCartSystem(authSystem);
        await cartSystem.init();
        
        // Check if there are items to checkout
        if (cartSystem.getOrderItems().length === 0) {
            showNotification('Your cart is empty!');
            setTimeout(() => {
                window.location.href = cartSystem.isBuyNowFlow ? 'products.html' : 'cart.html';
            }, 1500);
            return;
        }
        
        // Pre-fill user info if available
        if (authSystem && authSystem.isLoggedIn()) {
            const userEmail = authSystem.getUserEmail();
            const userName = authSystem.getUserName();
            
            if (userEmail && document.getElementById('email')) {
                document.getElementById('email').value = userEmail;
            }
            if (userName && document.getElementById('fullName')) {
                document.getElementById('fullName').value = userName;
            }
        }
        
        // Set default shipping method
        selectShippingMethod('standard');
        
        // Update order summary
        updateOrderSummary();
        
        // Setup event listeners for input formatting
        setupInputFormatting();
        
        // Setup country selector
        const countrySelect = document.getElementById('country');
        if (countrySelect) {
            countrySelect.value = 'GB'; // Default to UK
        }
        
        console.log('Checkout page initialized successfully');
        
    } catch (error) {
        console.error('Checkout page initialization error:', error);
        showNotification('Failed to initialize checkout. Please refresh the page.');
    } finally {
        showLoading(false);
    }
});

function setupInputFormatting() {
    // Format card number
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(.{4})/g, '$1 ').trim();
            e.target.value = value.substring(0, 19);
        });
    }
    
    // Format expiry date
    const expiryInput = document.getElementById('expiryDate');
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value.substring(0, 5);
        });
    }
    
    // Format CVV
    const cvvInput = document.getElementById('cvv');
    if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
        });
    }
    
    // Format phone number
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 15);
        });
    }
    
    // Format postal code
    const postalInput = document.getElementById('postalCode');
    if (postalInput) {
        postalInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase().substring(0, 10);
        });
    }
}

// Make functions available globally
window.selectShippingMethod = selectShippingMethod;
window.selectPaymentMethod = selectPaymentMethod;
window.goToStep = goToStep;
window.placeOrder = placeOrder;
window.showTerms = showTerms;
window.showPrivacy = showPrivacy;
</script>
</body>
</html>
