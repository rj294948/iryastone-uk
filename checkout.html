<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* All CSS remains same as before */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header - Hide/Show on Scroll */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
    transition: transform 0.3s ease;
    transform: translateY(0);
}

header.hidden {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Checkout Container */
.checkout-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
}

/* Checkout Sections */
.checkout-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.section-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
}

.section-header i {
    color: var(--primary-gold);
    font-size: 18px;
}

/* Address Form */
.address-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: " *";
    color: #ff4757;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* Saved Address */
.saved-address {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
}

.saved-address:hover {
    border-color: var(--primary-gold);
}

.saved-address.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.address-type {
    display: inline-block;
    background: var(--primary-gold);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    margin-bottom: 10px;
}

.address-details {
    font-size: 14px;
    line-height: 1.5;
}

.address-details .name {
    font-weight: 600;
    margin-bottom: 5px;
}

/* Order Summary */
.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
}

.order-item-name {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 15px;
}

.order-item-info {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
}

.order-item-quantity {
    font-size: 13px;
    color: var(--text-light);
}

/* Existing Order Info Box */
.existing-order-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: var(--shadow-md);
}

.existing-order-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.existing-order-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.existing-order-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.existing-order-value {
    font-weight: 600;
    font-size: 16px;
}

.existing-order-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

/* Price Breakdown */
.price-breakdown {
    margin-bottom: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
}

.price-row:last-child {
    border-bottom: none;
}

.price-row.total {
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-gold);
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
}

.price-label {
    color: var(--text-dark);
}

.price-value {
    font-weight: 600;
}

/* Payment Options */
.payment-options {
    margin: 20px 0;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 10px;
}

.payment-options h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-options h4 i {
    color: var(--primary-gold);
}

.payment-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    background: var(--white);
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    transition: var(--transition);
}

.payment-option:hover {
    border-color: var(--gold-light);
}

.payment-option.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-option input[type="radio"] {
    accent-color: var(--primary-gold);
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.payment-option label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-dark);
    flex: 1;
}

.payment-option i {
    color: var(--primary-gold);
    font-size: 16px;
}

.payment-details {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 5px;
    margin-left: 30px;
}

/* Payment Breakdown */
.payment-breakdown {
    background: var(--bg-light);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 1px solid #e0e0e0;
}

.payment-breakdown h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-breakdown h4 i {
    color: var(--primary-gold);
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e0e0e0;
}

.payment-item:last-child {
    border-bottom: none;
    font-weight: 600;
    color: var(--primary-gold);
    padding-top: 10px;
    margin-top: 5px;
    border-top: 2px solid #e0e0e0;
}

.payment-label {
    color: var(--text-dark);
    font-size: 14px;
}

.payment-amount {
    font-weight: 600;
    font-size: 14px;
}

/* Custom Requirements */
.custom-requirements-box {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-gold);
}

.custom-requirements-box h5 {
    font-size: 14px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-requirements-box h5 i {
    color: var(--primary-gold);
    font-size: 14px;
}

.custom-requirements-text {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.5;
    background: var(--white);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

/* Payment Methods */
.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
}

.payment-method:hover {
    border-color: var(--primary-gold);
}

.payment-method.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-gold);
    font-size: 20px;
}

.payment-info {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.payment-description {
    font-size: 12px;
    color: var(--text-light);
}

/* Stripe Card Element */
.stripe-card-element {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    background: var(--white);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.action-btn-large {
    flex: 1;
    padding: 16px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 16px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
    border: 2px solid #e0e0e0;
}

.btn-secondary:hover {
    background: #f0f0f0;
    border-color: var(--primary-gold);
}

.btn-success {
    background: #40c057;
    color: white;
}

.btn-success:hover {
    background: #37b24d;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(64, 192, 87, 0.3);
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    display: none;
}

.notification.show {
    transform: translateX(0);
    display: block;
}

/* Bottom Navigation - Hide/Show on Scroll */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.bottom-nav.hidden {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive */
@media (max-width: 992px) {
    .checkout-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }
    
    .address-form {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .checkout-section {
        padding: 20px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .payment-option {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .payment-details {
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .checkout-container {
        padding: 20px 12px;
    }
    
    .payment-method {
        flex-direction: column;
        text-align: center;
    }
    
    .payment-icon {
        width: 35px;
        height: 35px;
        font-size: 18px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Payment Processing Modal -->
<div id="paymentModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px;">
        <div id="paymentSpinner" class="loading-spinner" style="position: relative; top: 0; left: 0; transform: none; margin: 0 auto 20px;"></div>
        <h3 id="paymentTitle" style="margin-bottom: 15px;">Processing Payment</h3>
        <p id="paymentMessage">Please wait while we process your payment...</p>
        <div id="paypalButtonContainer" style="margin-top: 20px;"></div>
        <button id="cancelPayment" onclick="cancelPayment()" style="margin-top: 20px; padding: 10px 20px; background: #ff4757; color: white; border: none; border-radius: 8px; cursor: pointer;">
            Cancel Payment
        </button>
    </div>
</div>

<!-- Header -->
<header id="mainHeader">
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="products.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item">
            <a href="products.html">Products</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active" id="breadcrumbTitle">
            Checkout
        </div>
    </div>
</section>

<!-- Checkout Container -->
<section class="checkout-container">
    <div class="checkout-grid">
        <!-- Left Column: Shipping & Payment -->
        <div>
            <!-- EXISTING ORDER INFO (Shows when coming from notification) -->
            <div class="existing-order-info" id="existingOrderInfo" style="display: none;">
                <h3 style="margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span id="existingOrderTitle">Pay Remaining Balance</span>
                </h3>
                
                <div class="existing-order-details">
                    <div class="existing-order-item">
                        <div class="existing-order-label">Order Number</div>
                        <div class="existing-order-value" id="existingOrderNumber">#N/A</div>
                    </div>
                    <div class="existing-order-item">
                        <div class="existing-order-label">Current Status</div>
                        <div class="existing-order-value" id="existingOrderStatus">Processing</div>
                    </div>
                    <div class="existing-order-item">
                        <div class="existing-order-label">Already Paid</div>
                        <div class="existing-order-value" id="existingOrderPaid">£0.00</div>
                    </div>
                    <div class="existing-order-item">
                        <div class="existing-order-label">Remaining Balance</div>
                        <div class="existing-order-value" id="existingOrderRemaining">£0.00</div>
                    </div>
                </div>
                
                <div class="existing-order-actions">
                    <button class="btn btn-success" onclick="showOrderDetails()">
                        <i class="fas fa-eye"></i> View Order Details
                    </button>
                    <button class="btn btn-primary" onclick="togglePaymentOptions()" id="togglePaymentOptionsBtn">
                        <i class="fas fa-chevron-down"></i> Change Payment Type
                    </button>
                </div>
            </div>

            <!-- Shipping Address -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-shipping-fast"></i>
                    <h3>Shipping Address</h3>
                </div>
                
                <div id="savedAddresses">
                    <!-- Saved addresses will be loaded here -->
                </div>
                
                <div class="address-form" id="addressForm">
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Email Address</label>
                        <input type="email" id="email" placeholder="your.email@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Phone Number</label>
                        <input type="tel" id="phone" placeholder="+1 234 567 8900" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Country</label>
                        <select id="country" required>
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="AE">United Arab Emirates</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Address Line 1</label>
                        <input type="text" id="address1" placeholder="Street address, P.O. box, company name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Address Line 2</label>
                        <input type="text" id="address2" placeholder="Apartment, suite, unit, building, floor, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">City</label>
                        <input type="text" id="city" placeholder="City" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">State/Province</label>
                        <input type="text" id="state" placeholder="State or Province" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Postal Code</label>
                        <input type="text" id="postalCode" placeholder="ZIP or Postal code" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea id="instructions" placeholder="Any special delivery instructions..."></textarea>
                    </div>
                    
                    <div class="form-group full-width" id="saveAddressContainer">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="saveAddress">
                            <span>Save this address for future orders</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Payment Information -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Information</h3>
                </div>
                
                <!-- Payment Type Selection -->
                <div class="payment-options" id="paymentOptions">
                    <h4><i class="fas fa-money-bill-wave"></i> Select Payment Type</h4>
                    
                    <div class="payment-option selected" onclick="selectPaymentOption('advance')" id="advancePaymentOption">
                        <input type="radio" id="advancePayment" name="paymentType" value="advance" checked>
                        <label for="advancePayment">
                            <i class="fas fa-credit-card"></i>
                            <div>
                                <div>30% Advance Payment</div>
                                <div class="payment-details">Pay 30% now, 70% after shipping confirmation</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="payment-option" onclick="selectPaymentOption('full')" id="fullPaymentOption">
                        <input type="radio" id="fullPayment" name="paymentType" value="full">
                        <label for="fullPayment">
                            <i class="fas fa-money-check-alt"></i>
                            <div>
                                <div>Full Payment Now</div>
                                <div class="payment-details">Pay full amount now and get 5% discount</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="payment-option" onclick="selectPaymentOption('remaining')" id="remainingPaymentOption" style="display: none;">
                        <input type="radio" id="remainingPayment" name="paymentType" value="remaining">
                        <label for="remainingPayment">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>
                                <div>Pay Remaining Balance</div>
                                <div class="payment-details">Pay only the remaining balance of this order</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Payment Breakdown -->
                <div class="payment-breakdown" id="paymentBreakdown">
                    <h4><i class="fas fa-file-invoice-dollar"></i> Payment Breakdown</h4>
                    <div class="payment-item">
                        <span class="payment-label">Total Order Value:</span>
                        <span class="payment-amount" id="totalOrderValue">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="advanceLabel">30% Advance:</span>
                        <span class="payment-amount" id="advanceAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="remainingLabel">70% After Shipping:</span>
                        <span class="payment-amount" id="remainingAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="payNowLabel">Amount to Pay Now:</span>
                        <span class="payment-amount" id="payNowAmount">£0.00</span>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="section-header" style="margin-top: 25px;">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Method</h3>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active" data-method="stripe" onclick="selectPaymentMethod('stripe')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-stripe"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-description">Pay securely with your card (Stripe)</div>
                        </div>
                        <i class="fas fa-check-circle" style="color: var(--primary-gold);"></i>
                    </div>
                    
                    <div class="payment-method" data-method="paypal" onclick="selectPaymentMethod('paypal')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-paypal"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">PayPal</div>
                            <div class="payment-description">Pay with your PayPal account or card</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <div class="payment-method" data-method="bank" onclick="selectPaymentMethod('bank')">
                        <div class="payment-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Bank Transfer</div>
                            <div class="payment-description">Direct bank transfer</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                
                <!-- Stripe Card Element -->
                <div id="stripeCardElement" style="margin-top: 20px; display: none;">
                    <div class="stripe-card-element" id="card-element"></div>
                    <div id="card-errors" role="alert" style="color: #ff4757; font-size: 13px; margin-top: 10px;"></div>
                </div>
                
                <!-- PayPal Smart Buttons Container -->
                <div id="paypalButtonsContainer" style="margin-top: 20px; display: none;"></div>
            </div>
        </div>
        
        <!-- Right Column: Order Summary -->
        <div>
            <!-- Order Summary -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-receipt"></i>
                    <h3 id="orderSummaryTitle">Order Summary</h3>
                </div>
                
                <div class="order-items" id="orderItems">
                    <!-- Order items will be loaded here -->
                </div>
                
                <!-- Custom Requirements Display -->
                <div id="customRequirementsContainer"></div>
                
                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Subtotal</span>
                        <span class="price-value" id="subtotal">£0.00</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Shipping</span>
                        <span class="price-value" id="shipping">Calculated after address</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Tax (VAT)</span>
                        <span class="price-value" id="tax">£0.00</span>
                    </div>
                    
                    <div class="price-row total">
                        <span class="price-label">Total Amount</span>
                        <span class="price-value" id="total">£0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Terms & Conditions -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-file-contract"></i>
                    <h3>Terms & Conditions</h3>
                </div>
                
                <div style="font-size: 13px; color: var(--text-light); line-height: 1.6;">
                    <p>By placing your order, you agree to our Terms of Service and Privacy Policy.</p>
                    <p><strong>Payment Terms:</strong> 30% advance payment required to confirm order. Remaining 70% payable after shipping confirmation. Full payment upfront receives 5% discount.</p>
                    <p><strong>Shipping:</strong> Delivery within 7-14 business days after payment confirmation.</p>
                    <p style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="agreeTerms" required>
                            <span>I agree to the terms and conditions and payment terms</span>
                        </label>
                    </p>
                </div>
            </div>
            
            <!-- Place Order Button -->
            <div class="action-buttons">
                <button class="action-btn-large btn-primary" onclick="validateAndProcessPayment()" id="processPaymentBtn">
                    <i class="fas fa-lock"></i>
                    <span id="payButtonText">Proceed to Payment</span>
                </button>
                <button class="action-btn-large btn-secondary" onclick="goBack()" id="backButton">
                    <i class="fas fa-arrow-left"></i>
                    <span id="backButtonText">Back</span>
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav" id="bottomNav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn active">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let cartItems = [];
let isBuyNowFlow = false;
let isExistingOrderFlow = false;
let currentPaymentType = 'advance';
let selectedPaymentMethod = 'bank';
let currentOrderData = null;
let existingOrderData = null;
let authSystem = null;
let checkoutType = null;
let buyNowItemId = null;

// ============================================
// CHECKOUT TYPES
// ============================================

const CHECKOUT_TYPES = {
    BUY_NOW: 'buy_now',
    CART: 'cart',
    EXISTING_ORDER: 'existing_order'
};

// ============================================
// CHECKOUT INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("Checkout page loaded");
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    isBuyNowFlow = urlParams.get('buynow') === 'true';
    buyNowItemId = urlParams.get('buynow_item_id');
    const source = urlParams.get('source');
    const existingOrderId = urlParams.get('order');
    const paymentType = urlParams.get('type');
    const userId = urlParams.get('user');
    const amount = urlParams.get('amount');
    
    console.log("URL Parameters:", {
        isBuyNowFlow: isBuyNowFlow,
        buyNowItemId: buyNowItemId,
        source: source,
        existingOrderId: existingOrderId,
        paymentType: paymentType,
        userId: userId,
        amount: amount
    });
    
    // Initialize Auth System FIRST
    authSystem = new CheckoutAuthSystem();
    await authSystem.init();
    
    console.log("Auth initialized. User ID:", authSystem.getUserId(), "Logged in:", authSystem.isLoggedIn());
    
    // Determine checkout type
    if (existingOrderId && paymentType === 'remaining_payment') {
        checkoutType = CHECKOUT_TYPES.EXISTING_ORDER;
        console.log("Existing order payment detected:", existingOrderId);
        isExistingOrderFlow = true;
        await loadExistingOrder(existingOrderId, userId);
    } else if (isBuyNowFlow && buyNowItemId) {
        checkoutType = CHECKOUT_TYPES.BUY_NOW;
        console.log("Buy Now flow detected with item ID:", buyNowItemId);
        updateUITitles('Buy Now');
        await loadBuyNowItems(buyNowItemId);
    } else {
        checkoutType = CHECKOUT_TYPES.CART;
        console.log("Regular cart checkout flow");
        updateUITitles('Checkout');
        await loadCartItems();
    }
    
    // Initialize payment options
    initializePaymentOptions();
    
    // Update cart badge
    updateCartBadge();
    
    // Initialize form validation
    initializeFormValidation();
});

// ============================================
// LOAD BUY NOW ITEMS FROM buyNowItems COLLECTION
// ============================================

// ============================================
// LOAD CART ITEMS FROM userCarts COLLECTION
// ============================================
// ============================================
// DISPLAY ORDER ITEMS
// ============================================

async function displayOrderItems(items) {
    try {
        const orderItemsDiv = document.getElementById('orderItems');
        if (!orderItemsDiv) return;
        
        if (items && items.length > 0) {
            const itemsHTML = items.map(item => {
                // Image decide karo
                let imageUrl = item.imageUrl || item.image;
                
                // Agar image nahi hai to default lelo
                if (!imageUrl) {
                    imageUrl = getDefaultImage(item.category);
                }
                
                // Price calculate karo based on available fields
                let itemPrice = 0;
                
                if (item.calculatedPrice && item.calculatedPrice > 0) {
                    itemPrice = item.calculatedPrice;
                } else if (item.totalPrice && item.totalPrice > 0) {
                    itemPrice = item.totalPrice;
                } else if (item.totalAmount && item.totalAmount > 0) {
                    itemPrice = item.totalAmount;
                } else if (item.price && item.quantity) {
                    itemPrice = item.price * item.quantity;
                } else if (item.price) {
                    itemPrice = item.price;
                }
                
                const quantity = item.quantity || 1;
                const itemName = item.name || item.stoneName || 'Product';
                const category = item.category || 'General';
                
                return `
                    <div class="order-item">
                        <div class="order-item-image">
                            <img src="${imageUrl}" 
                                 alt="${itemName}" 
                                 onerror="this.src='${getDefaultImage(category)}'">
                        </div>
                        <div class="order-item-details">
                            <div class="order-item-name">${itemName}</div>
                            <div class="order-item-info">${category}</div>
                            <div class="order-item-info">Quantity: ${quantity}</div>
                            ${item.priceUnit ? `<div class="order-item-info">Price per ${item.priceUnit}</div>` : ''}
                            ${item.calculationType === 'standard' && item.calculationData ? 
                              `<div class="order-item-info">
                                Size: ${item.calculationData.length || 1} × ${item.calculationData.width || 1} ${item.calculationData.unit || 'sqft'}
                               </div>` : ''}
                            <div class="order-item-price">£${itemPrice.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            orderItemsDiv.innerHTML = itemsHTML;
            
            // Calculate and update totals
            calculateAndUpdateTotals(items);
        } else {
            orderItemsDiv.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">No items found</p>';
        }
        
    } catch (error) {
        console.error('Error displaying order items:', error);
        const orderItemsDiv = document.getElementById('orderItems');
        if (orderItemsDiv) {
            orderItemsDiv.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">Error loading items</p>';
        }
    }
}

// ============================================
// SHOW CUSTOM REQUIREMENTS
// ============================================

function showCustomRequirements(requirements) {
    const container = document.getElementById('customRequirementsContainer');
    if (!container || !requirements || !requirements.trim()) return;
    
    container.innerHTML = `
        <div class="custom-requirements-box">
            <h5><i class="fas fa-clipboard-check"></i> Custom Requirements</h5>
            <div class="custom-requirements-text">${requirements}</div>
        </div>
    `;
}

// ============================================
// CALCULATE AND UPDATE TOTALS
// ============================================

function calculateAndUpdateTotals(items) {
    try {
        const subtotalEl = document.getElementById('subtotal');
        const taxEl = document.getElementById('tax');
        const shippingEl = document.getElementById('shipping');
        const totalEl = document.getElementById('total');
        
        if (!subtotalEl || !totalEl) return;
        
        // Calculate subtotal
        let subtotal = 0;
        items.forEach(item => {
            let itemPrice = 0;
            
            if (item.calculatedPrice && item.calculatedPrice > 0) {
                itemPrice = item.calculatedPrice;
            } else if (item.totalPrice && item.totalPrice > 0) {
                itemPrice = item.totalPrice;
            } else if (item.totalAmount && item.totalAmount > 0) {
                itemPrice = item.totalAmount;
            } else if (item.price && item.quantity) {
                itemPrice = item.price * item.quantity;
            } else if (item.price) {
                itemPrice = item.price;
            }
            
            subtotal += itemPrice;
        });
        
        // Calculate tax (20% VAT)
        const tax = subtotal * 0.2;
        
        // Calculate shipping (free for orders over £500, otherwise £50)
        const shipping = subtotal >= 500 ? 0 : 50;
        
        // Calculate total
        const total = subtotal + tax + shipping;
        
        // Update display
        subtotalEl.textContent = `£${subtotal.toFixed(2)}`;
        taxEl.textContent = `£${tax.toFixed(2)}`;
        shippingEl.textContent = shipping === 0 ? 'FREE' : `£${shipping.toFixed(2)}`;
        totalEl.textContent = `£${total.toFixed(2)}`;
        
        // Also update payment breakdown
        updatePaymentBreakdown();
        
    } catch (error) {
        console.error('Error calculating totals:', error);
    }
}

// ============================================
// PAYMENT PROCESSING - VALIDATE AND PROCESS
// ============================================

async function validateAndProcessPayment() {
    try {
        console.log("Starting payment process...");
        console.log("Checkout Type:", checkoutType);
        console.log("Cart Items:", cartItems);
        
        if (!validateForm()) {
            console.log("Form validation failed");
            return;
        }
        
        showLoading(true);
        
        // Get address data
        const addressData = getAddressData();
        
        // Process based on checkout type
        if (checkoutType === CHECKOUT_TYPES.EXISTING_ORDER) {
            await processExistingOrderPayment(addressData);
        } else if (checkoutType === CHECKOUT_TYPES.BUY_NOW) {
            await processBuyNowPayment(addressData);
        } else if (checkoutType === CHECKOUT_TYPES.CART) {
            await processCartPayment(addressData);
        } else {
            throw new Error('Invalid checkout type');
        }
        
    } catch (error) {
        console.error('❌ Payment processing error:', error);
        showError('Payment processing failed: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// PROCESS BUY NOW PAYMENT
// ============================================

async function processBuyNowPayment(addressData) {
    try {
        console.log("Processing Buy Now payment...");
        
        if (cartItems.length === 0 || !cartItems[0]) {
            throw new Error('No Buy Now item to purchase');
        }
        
        const buyNowItem = cartItems[0];
        
        // Calculate total
        const total = calculateTotal(cartItems);
        
        // Create order number
        const orderNumber = generateOrderNumber();
        
        // Create order data
        const orderData = {
            orderNumber: orderNumber,
            userId: authSystem.getUserId(),
            userEmail: authSystem.getUserEmail(),
            userName: authSystem.getUserName(),
            items: cartItems,
            shippingAddress: addressData,
            billingAddress: addressData,
            total: total,
            subtotal: calculateSubtotal(cartItems),
            tax: calculateTax(cartItems),
            shipping: calculateShipping(cartItems),
            paymentType: currentPaymentType,
            paymentMethod: selectedPaymentMethod,
            status: 'pending',
            paymentStatus: 'pending',
            createdAt: new Date().toISOString(),
            source: 'buy_now',
            buyNowItemId: buyNowItemId,
            customRequirements: buyNowItem.customRequirements || ''
        };
        
        // Add payment details based on type
        if (currentPaymentType === 'advance') {
            orderData.advancePayment = total * 0.3;
            orderData.remainingPayment = total * 0.7;
            orderData.submittedAmount = 0;
        } else if (currentPaymentType === 'full') {
            const discount = total * 0.05;
            orderData.advancePayment = total - discount;
            orderData.remainingPayment = 0;
            orderData.submittedAmount = 0;
            orderData.discount = discount;
            orderData.discountPercentage = 5;
        }
        
        console.log("Buy Now order data:", orderData);
        
        // Process based on payment method
        if (selectedPaymentMethod === 'bank') {
            await processBankTransfer(orderData, 'buy_now');
        } else if (selectedPaymentMethod === 'stripe') {
            showError('Credit card payment coming soon. Please use Bank Transfer.');
        } else if (selectedPaymentMethod === 'paypal') {
            showError('PayPal payment coming soon. Please use Bank Transfer.');
        } else {
            showError('Please select a payment method');
        }
        
    } catch (error) {
        console.error('Buy Now payment processing error:', error);
        throw error;
    }
}

// ============================================
// PROCESS CART PAYMENT
// ============================================

async function processCartPayment(addressData) {
    try {
        console.log("Processing Cart payment...");
        
        if (cartItems.length === 0) {
            throw new Error('Your cart is empty');
        }
        
        // Calculate total
        const total = calculateTotal(cartItems);
        
        // Create order number
        const orderNumber = generateOrderNumber();
        
        // Create order data
        const orderData = {
            orderNumber: orderNumber,
            userId: authSystem.getUserId(),
            userEmail: authSystem.getUserEmail(),
            userName: authSystem.getUserName(),
            items: cartItems,
            shippingAddress: addressData,
            billingAddress: addressData,
            total: total,
            subtotal: calculateSubtotal(cartItems),
            tax: calculateTax(cartItems),
            shipping: calculateShipping(cartItems),
            paymentType: currentPaymentType,
            paymentMethod: selectedPaymentMethod,
            status: 'pending',
            paymentStatus: 'pending',
            createdAt: new Date().toISOString(),
            source: 'cart'
        };
        
        // Add payment details based on type
        if (currentPaymentType === 'advance') {
            orderData.advancePayment = total * 0.3;
            orderData.remainingPayment = total * 0.7;
            orderData.submittedAmount = 0;
        } else if (currentPaymentType === 'full') {
            const discount = total * 0.05;
            orderData.advancePayment = total - discount;
            orderData.remainingPayment = 0;
            orderData.submittedAmount = 0;
            orderData.discount = discount;
            orderData.discountPercentage = 5;
        }
        
        console.log("Cart order data:", orderData);
        
        // Process based on payment method
        if (selectedPaymentMethod === 'bank') {
            await processBankTransfer(orderData, 'cart');
        } else if (selectedPaymentMethod === 'stripe') {
            showError('Credit card payment coming soon. Please use Bank Transfer.');
        } else if (selectedPaymentMethod === 'paypal') {
            showError('PayPal payment coming soon. Please use Bank Transfer.');
        } else {
            showError('Please select a payment method');
        }
        
    } catch (error) {
        console.error('Cart payment processing error:', error);
        throw error;
    }
}

// ============================================
// BANK TRANSFER PROCESSING
// ============================================

async function processBankTransfer(orderData, source) {
    try {
        showPaymentProcessing('Preparing Bank Transfer Details...');
        
        // Generate payment ID
        const paymentId = 'payment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Calculate amount to pay now
        let amountToPay = 0;
        if (orderData.paymentType === 'advance') {
            amountToPay = orderData.advancePayment;
        } else if (orderData.paymentType === 'full') {
            amountToPay = orderData.advancePayment; // Already includes discount
        }
        
        // Add bank transfer details
        orderData.bankTransferDetails = {
            accountName: 'IRYA STONE LTD',
            accountNumber: '12345678',
            sortCode: '04-00-04',
            iban: 'GB29NWBK60161331926819',
            swift: 'NWBKGB2L',
            reference: `${orderData.orderNumber}-${source.toUpperCase()}`,
            amount: amountToPay,
            currency: 'GBP',
            bankName: 'NatWest Bank',
            bankAddress: 'NatWest Bank PLC, 135 Bishopsgate, London EC2M 3UR, United Kingdom'
        };
        
        // Save order to Firebase
        await saveOrderToFirebase(orderData, paymentId);
        
        // Clear cart if it was a cart checkout
        if (source === 'cart') {
            await clearUserCart();
        }
        
        // Delete buyNowItems entry if it was a buy now
        if (source === 'buy_now' && buyNowItemId) {
            await deleteBuyNowItem(buyNowItemId);
        }
        
        // Hide processing modal
        hidePaymentProcessing();
        
        // Show bank transfer details
        showBankTransferDetails(orderData, paymentId, source);
        
    } catch (error) {
        console.error('Bank transfer error:', error);
        hidePaymentProcessing();
        showError('Failed to process bank transfer: ' + error.message);
    }
}

// ============================================
// SAVE ORDER TO FIREBASE
// ============================================

async function saveOrderToFirebase(orderData, paymentId) {
    try {
        if (!firebaseDB) {
            throw new Error('Firebase not initialized');
        }
        
        // Save to user's orders collection
        const userOrderRef = firebaseDB.collection('users')
            .doc(orderData.userId)
            .collection('orders')
            .doc(paymentId);
        
        await userOrderRef.set({
            id: paymentId,
            ...orderData,
            updatedAt: new Date().toISOString()
        });
        
        console.log('✅ Order saved to user collection:', paymentId);
        
        // Save to main orders collection
        const mainOrderRef = firebaseDB.collection('orders').doc(paymentId);
        await mainOrderRef.set({
            id: paymentId,
            ...orderData,
            updatedAt: new Date().toISOString()
        });
        
        console.log('✅ Order saved to main collection:', paymentId);
        
        // Create payment record
        const paymentData = {
            id: paymentId,
            orderId: paymentId,
            orderNumber: orderData.orderNumber,
            userId: orderData.userId,
            userEmail: orderData.userEmail,
            userName: orderData.userName,
            paymentType: orderData.paymentType,
            paymentMethod: orderData.paymentMethod,
            amount: orderData.bankTransferDetails.amount,
            status: 'pending',
            createdAt: new Date().toISOString(),
            bankTransferDetails: orderData.bankTransferDetails,
            source: orderData.source
        };
        
        // Save to payments collection
        await firebaseDB.collection('payments').doc(paymentId).set(paymentData);
        
        // Save to user's payments collection
        const userPaymentRef = firebaseDB.collection('users')
            .doc(orderData.userId)
            .collection('payments')
            .doc(paymentId);
        
        await userPaymentRef.set(paymentData);
        
        console.log('✅ Payment record saved:', paymentId);
        
    } catch (error) {
        console.error('Error saving order to Firebase:', error);
        throw error;
    }
}

// ============================================
// CLEAR USER CART
// ============================================

async function clearUserCart() {
    try {
        const userId = authSystem.getUserId();
        
        // Clear from Firestore
        await firebaseDB.collection('users')
            .doc(userId)
            .collection('userCarts')
            .doc('current')
            .set({ items: [] });
        
        // Clear localStorage
        localStorage.removeItem('irya_stone_cart');
        
        // Update cart badge
        updateCartBadge();
        
        console.log('✅ Cart cleared successfully');
        
    } catch (error) {
        console.error('Error clearing cart:', error);
        // Continue anyway
    }
}

// ============================================
// DELETE BUY NOW ITEM
// ============================================

async function deleteBuyNowItem(itemId) {
    try {
        await firebaseDB.collection('buyNowItems')
            .doc(itemId)
            .delete();
        
        console.log('✅ Buy Now item deleted:', itemId);
        
    } catch (error) {
        console.error('Error deleting Buy Now item:', error);
        // Continue anyway
    }
}

// ============================================
// SHOW BANK TRANSFER DETAILS
// ============================================

function showBankTransferDetails(orderData, paymentId, source) {
    const bankDetailsHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <h3 style="color: var(--primary-gold); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-university"></i> Bank Transfer Details
                </h3>
                
                <div style="background: var(--bg-light); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--stone-dark);">Order Information</h4>
                    <div style="margin-bottom: 10px;">
                        <strong>Order Number:</strong> ${orderData.orderNumber}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Payment Type:</strong> ${orderData.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Amount to Pay:</strong> £${orderData.bankTransferDetails.amount.toFixed(2)}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Payment ID:</strong> ${paymentId.substring(0, 12)}...
                    </div>
                    ${orderData.discount ? `
                    <div style="margin-bottom: 10px; color: #40c057;">
                        <strong>Discount Applied:</strong> £${orderData.discount.toFixed(2)} (5%)
                    </div>
                    ` : ''}
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                    <h4 style="margin-bottom: 15px; color: #0369a1;">Bank Details</h4>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Name:</strong> ${orderData.bankTransferDetails.accountName}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Number:</strong> ${orderData.bankTransferDetails.accountNumber}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Sort Code:</strong> ${orderData.bankTransferDetails.sortCode}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>IBAN:</strong> ${orderData.bankTransferDetails.iban}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>SWIFT/BIC:</strong> ${orderData.bankTransferDetails.swift}
                    </div>
                    <div style="margin-bottom: 10px; background: #fffbeb; padding: 10px; border-radius: 5px; border: 1px solid #fde68a;">
                        <strong style="color: #92400e;">Reference:</strong> 
                        <span style="font-family: monospace; font-weight: bold; color: #92400e;">
                            ${orderData.bankTransferDetails.reference}
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> £${orderData.bankTransferDetails.amount.toFixed(2)} GBP
                    </div>
                </div>
                
                <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bbf7d0;">
                    <h5 style="margin-bottom: 10px; color: #166534;">
                        <i class="fas fa-info-circle"></i> Important Notes
                    </h5>
                    <ul style="font-size: 13px; color: #166534; padding-left: 20px;">
                        <li>Use the exact reference number when making transfer</li>
                        <li>Payment will be verified within 1-2 business days</li>
                        <li>Order status will update automatically after verification</li>
                        <li>You will receive email confirmation</li>
                        <li>Check your orders page for updates</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="copyBankDetails('${orderData.bankTransferDetails.reference}')" 
                            style="padding: 12px 20px; background: var(--primary-gold); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-copy"></i> Copy Reference
                    </button>
                    <button onclick="completePayment('${paymentId}', '${orderData.orderNumber}', '${source}')" 
                            style="padding: 12px 20px; background: #40c057; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-check-circle"></i> Mark as Paid
                    </button>
                    <button onclick="closeBankDetailsModal()" 
                            style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', bankDetailsHTML);
}

// ============================================
// COMPLETE PAYMENT
// ============================================

async function completePayment(paymentId, orderNumber, source) {
    try {
        showLoading(true);
        
        if (!firebaseDB) {
            throw new Error('Firebase not initialized');
        }
        
        const userId = authSystem.getUserId();
        
        // Update payment status to completed
        const paymentRef = firebaseDB.collection('payments').doc(paymentId);
        await paymentRef.update({
            status: 'completed',
            completedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        // Update user's payment status
        const userPaymentRef = firebaseDB.collection('users')
            .doc(userId)
            .collection('payments')
            .doc(paymentId);
        
        await userPaymentRef.update({
            status: 'completed',
            completedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        // Update order status
        const userOrderRef = firebaseDB.collection('users')
            .doc(userId)
            .collection('orders')
            .doc(paymentId);
        
        let paymentStatus = 'pending';
        if (currentPaymentType === 'full') {
            paymentStatus = 'fully_paid';
            await userOrderRef.update({
                status: 'processing',
                paymentStatus: 'fully_paid',
                submittedAmount: firebase.firestore.FieldValue.increment(orderData.bankTransferDetails.amount),
                updatedAt: new Date().toISOString()
            });
        } else if (currentPaymentType === 'advance') {
            paymentStatus = 'advance_paid';
            await userOrderRef.update({
                status: 'processing',
                paymentStatus: 'advance_paid',
                submittedAmount: firebase.firestore.FieldValue.increment(orderData.bankTransferDetails.amount),
                updatedAt: new Date().toISOString()
            });
        }
        
        // Update order in main collection
        const mainOrderRef = firebaseDB.collection('orders').doc(paymentId);
        if (currentPaymentType === 'full') {
            await mainOrderRef.update({
                status: 'processing',
                paymentStatus: 'fully_paid',
                submittedAmount: firebase.firestore.FieldValue.increment(orderData.bankTransferDetails.amount),
                updatedAt: new Date().toISOString()
            });
        } else if (currentPaymentType === 'advance') {
            await mainOrderRef.update({
                status: 'processing',
                paymentStatus: 'advance_paid',
                submittedAmount: firebase.firestore.FieldValue.increment(orderData.bankTransferDetails.amount),
                updatedAt: new Date().toISOString()
            });
        }
        
        // Create notification for user
        await createNotificationForUser(userId, orderNumber, source);
        
        // Close modal
        closeBankDetailsModal();
        
        // Show success message
        showNotification('Payment marked as completed! Order status updated.');
        
        // Redirect to order confirmation
        setTimeout(() => {
            window.location.href = `order-confirmation.html?order=${orderNumber}&payment=bank&type=${currentPaymentType}&source=${source}&payment_id=${paymentId}`;
        }, 2000);
        
    } catch (error) {
        console.error('Error completing payment:', error);
        showError('Failed to complete payment: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// CREATE NOTIFICATION FOR USER
// ============================================

async function createNotificationForUser(userId, orderNumber, source) {
    try {
        if (!firebaseDB) return;
        
        const notification = {
            title: 'Payment Received - Order Confirmed',
            message: `Your payment for order ${orderNumber} has been received. Your order is now being processed.`,
            orderNumber: orderNumber,
            type: 'payment_confirmation',
            userId: userId,
            source: source,
            createdAt: new Date().toISOString(),
            read: false,
            readAt: null
        };
        
        const notificationRef = firebaseDB.collection('users')
            .doc(userId)
            .collection('notifications')
            .doc();
        
        await notificationRef.set(notification);
        
        console.log('✅ Notification created for user');
        
    } catch (error) {
        console.error('Error creating notification:', error);
    }
}

// ============================================
// CALCULATION HELPER FUNCTIONS
// ============================================

function calculateSubtotal(items) {
    let subtotal = 0;
    items.forEach(item => {
        let itemPrice = 0;
        
        if (item.calculatedPrice && item.calculatedPrice > 0) {
            itemPrice = item.calculatedPrice;
        } else if (item.totalPrice && item.totalPrice > 0) {
            itemPrice = item.totalPrice;
        } else if (item.totalAmount && item.totalAmount > 0) {
            itemPrice = item.totalAmount;
        } else if (item.price && item.quantity) {
            itemPrice = item.price * item.quantity;
        } else if (item.price) {
            itemPrice = item.price;
        }
        
        subtotal += itemPrice;
    });
    return subtotal;
}

function calculateTax(items) {
    const subtotal = calculateSubtotal(items);
    return subtotal * 0.2; // 20% VAT
}

function calculateShipping(items) {
    const subtotal = calculateSubtotal(items);
    return subtotal >= 500 ? 0 : 50;
}

function calculateTotal(items) {
    const subtotal = calculateSubtotal(items);
    const tax = calculateTax(items);
    const shipping = calculateShipping(items);
    return subtotal + tax + shipping;
}

function generateOrderNumber() {
    const prefix = 'IRYA';
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}-${random}`;
}

// ============================================
// EXISTING ORDER FUNCTIONS
// ============================================

async function loadExistingOrder(orderId, userId) {
    try {
        showLoading(true);
        
        console.log("Loading existing order:", orderId, "for user:", userId);
        
        const targetUserId = userId || authSystem.getUserId();
        await loadOrderFromFirebase(orderId, targetUserId);
        
        if (existingOrderData) {
            console.log("Existing order loaded successfully:", existingOrderData.orderNumber);
            updateUITitles('Pay Remaining Balance');
            displayExistingOrderInfo();
            prefillAddressFromOrder();
            setupForExistingOrderPayment();
            updatePaymentBreakdownForExistingOrder();
            await displayOrderItems(existingOrderData.items || []);
        } else {
            console.error("Failed to load existing order");
            showError('Failed to load order details. Please try again.');
            setTimeout(() => window.location.href = 'orders.html', 2000);
        }
        
    } catch (error) {
        console.error('Error loading existing order:', error);
        showError('Failed to load order details. Please try again.');
    } finally {
        showLoading(false);
    }
}

async function processExistingOrderPayment(addressData) {
    try {
        if (!existingOrderData) {
            throw new Error('No existing order data');
        }
        
        // Calculate remaining payment
        const paidAmount = existingOrderData.submittedAmount || existingOrderData.advancePayment || 0;
        const totalAmount = existingOrderData.total || 0;
        const remainingAmount = existingOrderData.remainingPayment || (totalAmount - paidAmount);
        
        // Create payment data
        const paymentData = {
            orderId: existingOrderData.id,
            orderNumber: existingOrderData.orderNumber,
            userId: authSystem.getUserId(),
            userEmail: authSystem.getUserEmail(),
            userName: authSystem.getUserName(),
            paymentType: 'remaining_payment',
            paymentMethod: selectedPaymentMethod,
            amount: remainingAmount,
            previousPaidAmount: paidAmount,
            newPaidAmount: paidAmount + remainingAmount,
            status: 'pending',
            createdAt: new Date().toISOString(),
            transactionType: 'remaining_balance'
        };
        
        // Process based on payment method
        if (selectedPaymentMethod === 'bank') {
            await processBankTransferForExistingOrder(paymentData, addressData);
        } else if (selectedPaymentMethod === 'stripe') {
            showError('Credit card payment coming soon. Please use Bank Transfer.');
        } else if (selectedPaymentMethod === 'paypal') {
            showError('PayPal payment coming soon. Please use Bank Transfer.');
        } else {
            showError('Please select a payment method');
        }
        
    } catch (error) {
        console.error('Existing order payment processing error:', error);
        throw error;
    }
}

async function processBankTransferForExistingOrder(paymentData, addressData) {
    try {
        showPaymentProcessing('Preparing Bank Transfer Details...');
        
        // Generate payment ID
        const paymentId = 'payment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // Add bank transfer details
        paymentData.bankTransferDetails = {
            accountName: 'IRYA STONE LTD',
            accountNumber: '12345678',
            sortCode: '04-00-04',
            iban: 'GB29NWBK60161331926819',
            swift: 'NWBKGB2L',
            reference: `${paymentData.orderNumber}-REM`,
            amount: paymentData.amount,
            currency: 'GBP',
            bankName: 'NatWest Bank',
            bankAddress: 'NatWest Bank PLC, 135 Bishopsgate, London EC2M 3UR, United Kingdom'
        };
        
        // Save payment record to Firebase
        await savePaymentToFirebase(paymentData, paymentId);
        
        // Hide processing modal
        hidePaymentProcessing();
        
        // Show bank transfer details
        showBankTransferDetailsForExistingOrder(paymentData, paymentId);
        
    } catch (error) {
        console.error('Bank transfer error for existing order:', error);
        hidePaymentProcessing();
        showError('Failed to process bank transfer: ' + error.message);
    }
}

// ============================================
// UI AND FORM FUNCTIONS
// ============================================

function selectPaymentOption(paymentType) {
    console.log("selectPaymentOption called with:", paymentType);
    
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    const remainingOption = document.getElementById('remainingPaymentOption');
    
    [advanceOption, fullOption, remainingOption].forEach(option => {
        if (option) option.classList.remove('selected');
    });
    
    if (paymentType === 'advance' && advanceOption) {
        advanceOption.classList.add('selected');
        document.getElementById('advancePayment').checked = true;
    } else if (paymentType === 'full' && fullOption) {
        fullOption.classList.add('selected');
        document.getElementById('fullPayment').checked = true;
    } else if (paymentType === 'remaining' && remainingOption) {
        remainingOption.classList.add('selected');
        document.getElementById('remainingPayment').checked = true;
    }
    
    currentPaymentType = paymentType;
    updatePaymentBreakdown();
}

function selectPaymentMethod(method) {
    console.log("selectPaymentMethod called with:", method);
    
    document.querySelectorAll('.payment-method').forEach(element => {
        element.classList.remove('active');
        element.querySelector('.fa-check-circle').style.color = '';
    });
    
    const selectedMethod = document.querySelector(`[data-method="${method}"]`);
    if (selectedMethod) {
        selectedMethod.classList.add('active');
        selectedMethod.querySelector('.fa-check-circle').style.color = 'var(--primary-gold)';
    }
    
    selectedPaymentMethod = method;
    
    document.getElementById('stripeCardElement').style.display = method === 'stripe' ? 'block' : 'none';
    document.getElementById('paypalButtonsContainer').style.display = method === 'paypal' ? 'block' : 'none';
}

function initializePaymentOptions() {
    console.log("initializePaymentOptions called");
    selectPaymentOption('advance');
    selectPaymentMethod('bank');
}

function initializeFormValidation() {
    console.log("initializeFormValidation called");
    
    const formInputs = document.querySelectorAll('#addressForm input, #addressForm select');
    formInputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });
    });
}

function validateField(field) {
    const value = field.value.trim();
    
    if (field.required && !value) {
        field.style.borderColor = '#ff4757';
        return false;
    }
    
    if (field.type === 'email' && value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            field.style.borderColor = '#ff4757';
            return false;
        }
    }
    
    if (field.type === 'tel' && value) {
        const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
        if (!phoneRegex.test(value.replace(/[\s\-\(\)]/g, ''))) {
            field.style.borderColor = '#ff4757';
            return false;
        }
    }
    
    field.style.borderColor = '#e0e0e0';
    return true;
}

function validateForm() {
    console.log("validateForm called");
    
    let isValid = true;
    
    const requiredFields = document.querySelectorAll('#addressForm input[required], #addressForm select[required]');
    requiredFields.forEach(field => {
        if (!validateField(field)) {
            isValid = false;
        }
    });
    
    const agreeTerms = document.getElementById('agreeTerms');
    if (agreeTerms && !agreeTerms.checked) {
        showError('Please agree to the terms and conditions');
        isValid = false;
    }
    
    return isValid;
}

function updatePaymentBreakdown() {
    console.log("updatePaymentBreakdown called");
    
    const totalAmountText = document.getElementById('total').textContent;
    const totalAmount = parseFloat(totalAmountText.replace(/[^0-9.-]+/g, "")) || 0;
    
    const totalOrderValue = document.getElementById('totalOrderValue');
    const advanceAmount = document.getElementById('advanceAmount');
    const remainingAmount = document.getElementById('remainingAmount');
    const payNowAmount = document.getElementById('payNowAmount');
    const advanceLabel = document.getElementById('advanceLabel');
    const remainingLabel = document.getElementById('remainingLabel');
    const payNowLabel = document.getElementById('payNowLabel');
    
    if (!totalOrderValue || !advanceAmount) return;
    
    if (currentPaymentType === 'full') {
        const discount = totalAmount * 0.05;
        const discountedTotal = totalAmount - discount;
        
        totalOrderValue.textContent = `£${totalAmount.toFixed(2)}`;
        advanceAmount.textContent = `-£${discount.toFixed(2)} (5% discount)`;
        remainingAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        payNowAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        
        if (advanceLabel) advanceLabel.textContent = '5% Discount:';
        if (remainingLabel) remainingLabel.textContent = 'Amount After Discount:';
        if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
        
    } else if (currentPaymentType === 'advance') {
        const advance = totalAmount * 0.3;
        const remaining = totalAmount * 0.7;
        
        totalOrderValue.textContent = `£${totalAmount.toFixed(2)}`;
        advanceAmount.textContent = `£${advance.toFixed(2)}`;
        remainingAmount.textContent = `£${remaining.toFixed(2)}`;
        payNowAmount.textContent = `£${advance.toFixed(2)}`;
        
        if (advanceLabel) advanceLabel.textContent = '30% Advance:';
        if (remainingLabel) remainingLabel.textContent = '70% After Shipping:';
        if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
        
    } else if (currentPaymentType === 'remaining' && existingOrderData) {
        const paidAmount = existingOrderData.submittedAmount || existingOrderData.advancePayment || 0;
        const remaining = existingOrderData.remainingPayment || (totalAmount - paidAmount);
        
        totalOrderValue.textContent = `£${totalAmount.toFixed(2)}`;
        advanceAmount.textContent = `£${paidAmount.toFixed(2)}`;
        remainingAmount.textContent = `£${remaining.toFixed(2)}`;
        payNowAmount.textContent = `£${remaining.toFixed(2)}`;
        
        if (advanceLabel) advanceLabel.textContent = 'Already Paid:';
        if (remainingLabel) remainingLabel.textContent = 'Remaining Balance:';
        if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
    }
}

function getAddressData() {
    return {
        fullName: document.getElementById('fullName').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        country: document.getElementById('country').value,
        address1: document.getElementById('address1').value.trim(),
        address2: document.getElementById('address2').value.trim(),
        city: document.getElementById('city').value.trim(),
        state: document.getElementById('state').value.trim(),
        postalCode: document.getElementById('postalCode').value.trim(),
        instructions: document.getElementById('instructions').value.trim()
    };
}

function updateUITitles(type) {
    const breadcrumbTitle = document.getElementById('breadcrumbTitle');
    const orderSummaryTitle = document.getElementById('orderSummaryTitle');
    const payButtonText = document.getElementById('payButtonText');
    const backButtonText = document.getElementById('backButtonText');
    
    if (type === 'Buy Now') {
        if (breadcrumbTitle) breadcrumbTitle.textContent = 'Buy Now Checkout';
        if (orderSummaryTitle) orderSummaryTitle.textContent = 'Buy Now Summary';
        if (payButtonText) payButtonText.textContent = 'Buy Now & Pay';
        if (backButtonText) backButtonText.textContent = 'Back to Product';
    } else if (type === 'Pay Remaining Balance') {
        if (breadcrumbTitle) breadcrumbTitle.textContent = 'Pay Remaining Balance';
        if (orderSummaryTitle) orderSummaryTitle.textContent = 'Existing Order';
        if (payButtonText) payButtonText.textContent = 'Pay Remaining Balance';
        if (backButtonText) backButtonText.textContent = 'Back to Orders';
    } else {
        if (breadcrumbTitle) breadcrumbTitle.textContent = 'Checkout';
        if (orderSummaryTitle) orderSummaryTitle.textContent = 'Order Summary';
        if (payButtonText) payButtonText.textContent = 'Proceed to Payment';
        if (backButtonText) backButtonText.textContent = 'Back to Cart';
    }
}

function updateCartBadge() {
    try {
        const cartBadge = document.getElementById('cartBadge');
        if (!cartBadge) return;
        
        if (cartItems && cartItems.length > 0) {
            const totalItems = cartItems.reduce((sum, item) => sum + (item.quantity || 1), 0);
            cartBadge.textContent = totalItems > 0 ? totalItems : '0';
        } else {
            cartBadge.textContent = '0';
        }
    } catch (error) {
        console.error('Error updating cart badge:', error);
    }
}

function getDefaultImage(category) {
    const categoryLower = (category || '').toLowerCase();
    
    if (categoryLower.includes('sand')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('kota')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('granite')) {
        return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('marble')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('limestone')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('kitchen')) {
        return 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?auto=format&fit=crop&w=800';
    }
    
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function showError(message) {
    alert(message);
}

function showPaymentProcessing(message) {
    const modal = document.getElementById('paymentModal');
    const paymentTitle = document.getElementById('paymentTitle');
    const paymentMessage = document.getElementById('paymentMessage');
    const paymentSpinner = document.getElementById('paymentSpinner');
    
    if (modal && paymentTitle && paymentMessage && paymentSpinner) {
        paymentTitle.textContent = 'Processing Payment';
        paymentMessage.textContent = message || 'Please wait while we process your payment...';
        paymentSpinner.style.display = 'block';
        modal.style.display = 'flex';
    }
}

function hidePaymentProcessing() {
    const modal = document.getElementById('paymentModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function cancelPayment() {
    hidePaymentProcessing();
    showNotification('Payment cancelled');
}

function goBack() {
    if (checkoutType === CHECKOUT_TYPES.EXISTING_ORDER) {
        window.location.href = 'orders.html';
    } else if (checkoutType === CHECKOUT_TYPES.BUY_NOW) {
        window.history.back();
    } else {
        window.location.href = 'cart.html';
    }
}

// ============================================
// AUTHENTICATION SYSTEM
// ============================================

class CheckoutAuthSystem {
    constructor() {
        this.currentUser = null;
        this.authKey = 'irya_stone_auth_user';
        this.guestIdKey = 'irya_guest_id';
    }
    
    async init() {
        try {
            await this.initializeFirebase();
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged((user) => {
                    console.log("Auth State Changed:", user ? user.uid : "No user");
                    
                    if (user) {
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL,
                            providerId: user.providerId,
                            isFirebaseUser: true
                        };
                        
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        console.log("Firebase user saved:", user.uid);
                        
                    } else {
                        const storedUser = this.getUserFromStorage();
                        
                        if (storedUser && storedUser.isFirebaseUser) {
                            this.currentUser = storedUser;
                            console.log("Using stored user from localStorage:", storedUser.uid);
                        } else {
                            this.currentUser = this.createGuestUser();
                            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                            console.log("Guest user created:", this.currentUser.uid);
                        }
                    }
                    
                    resolve(this.currentUser);
                });
            });
            
        } catch (error) {
            console.error('Auth init error:', error);
            this.currentUser = this.getUserFromStorage() || this.createGuestUser();
            return this.currentUser;
        }
    }
    
    async initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            console.log('Firebase initialized successfully');
            return true;
        } catch (error) {
            console.error('Firebase initialization error:', error);
            throw error;
        }
    }
    
    getUserFromStorage() {
        const userData = localStorage.getItem(this.authKey);
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('Error parsing user data:', e);
                return null;
            }
        }
        return null;
    }
    
    createGuestUser() {
        let guestId = localStorage.getItem(this.guestIdKey);
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(this.guestIdKey, guestId);
        }
        
        return {
            uid: guestId,
            displayName: 'Guest',
            email: '',
            photoURL: '',
            providerId: 'guest',
            isFirebaseUser: false,
            isGuest: true
        };
    }
    
    isLoggedIn() {
        return this.currentUser && this.currentUser.isFirebaseUser === true;
    }
    
    getUserId() {
        if (!this.currentUser) {
            return this.createGuestUser().uid;
        }
        return this.currentUser.uid;
    }
    
    getUserEmail() {
        return this.currentUser ? this.currentUser.email : '';
    }
    
    getUserName() {
        return this.currentUser ? this.currentUser.displayName : 'Guest';
    }
}

// ============================================
// EXISTING ORDER SPECIFIC FUNCTIONS
// ============================================

async function loadOrderFromFirebase(orderId, userId) {
    try {
        if (!firebaseDB) {
            console.error("Firebase not initialized");
            return null;
        }
        
        console.log("Fetching order from Firebase:", orderId);
        
        // Try user's orders collection first
        try {
            const userOrderDoc = await firebaseDB.collection('users')
                .doc(userId)
                .collection('orders')
                .doc(orderId)
                .get();
            
            if (userOrderDoc.exists) {
                existingOrderData = { id: userOrderDoc.id, ...userOrderDoc.data() };
                console.log("Order found in user's collection:", existingOrderData.orderNumber);
                return existingOrderData;
            }
        } catch (userError) {
            console.log("Order not in user collection, trying main collection:", userError);
        }
        
        // Try main orders collection
        try {
            const mainOrderDoc = await firebaseDB.collection('orders')
                .doc(orderId)
                .get();
            
            if (mainOrderDoc.exists) {
                existingOrderData = { id: mainOrderDoc.id, ...mainOrderDoc.data() };
                console.log("Order found in main collection:", existingOrderData.orderNumber);
                
                if (existingOrderData.userId && existingOrderData.userId !== userId) {
                    console.warn("Order user ID mismatch:", existingOrderData.userId, "vs", userId);
                    showError('This order does not belong to your account.');
                    existingOrderData = null;
                    return null;
                }
                
                return existingOrderData;
            }
        } catch (mainError) {
            console.log("Order not in main collection:", mainError);
        }
        
        console.error("Order not found in any collection");
        return null;
        
    } catch (error) {
        console.error('Firebase order fetch error:', error);
        return null;
    }
}

function displayExistingOrderInfo() {
    if (!existingOrderData) return;
    
    const existingOrderInfoDiv = document.getElementById('existingOrderInfo');
    const existingOrderNumber = document.getElementById('existingOrderNumber');
    const existingOrderStatus = document.getElementById('existingOrderStatus');
    const existingOrderPaid = document.getElementById('existingOrderPaid');
    const existingOrderRemaining = document.getElementById('existingOrderRemaining');
    const existingOrderTitle = document.getElementById('existingOrderTitle');
    
    if (!existingOrderInfoDiv) return;
    
    const paidAmount = existingOrderData.submittedAmount || existingOrderData.advancePayment || 0;
    const totalAmount = existingOrderData.total || 0;
    const remainingAmount = existingOrderData.remainingPayment || (totalAmount - paidAmount);
    
    existingOrderNumber.textContent = existingOrderData.orderNumber || `#${existingOrderData.id?.substring(0, 8)}`;
    existingOrderStatus.textContent = existingOrderData.status ? existingOrderData.status.replace(/_/g, ' ') : 'Processing';
    existingOrderPaid.textContent = `£${paidAmount.toFixed(2)}`;
    existingOrderRemaining.textContent = `£${remainingAmount.toFixed(2)}`;
    
    const orderSummaryTitle = document.getElementById('orderSummaryTitle');
    if (orderSummaryTitle) {
        orderSummaryTitle.textContent = `Existing Order #${existingOrderData.orderNumber}`;
    }
    
    existingOrderInfoDiv.style.display = 'block';
    
    const payButtonText = document.getElementById('payButtonText');
    if (payButtonText) {
        payButtonText.textContent = `Pay Remaining £${remainingAmount.toFixed(2)}`;
    }
    
    const saveAddressContainer = document.getElementById('saveAddressContainer');
    if (saveAddressContainer) {
        saveAddressContainer.style.display = 'none';
    }
}

function prefillAddressFromOrder() {
    if (!existingOrderData) return;
    
    const address = existingOrderData.shippingAddress || existingOrderData.billingAddress;
    if (!address) return;
    
    const fullNameField = document.getElementById('fullName');
    const emailField = document.getElementById('email');
    const phoneField = document.getElementById('phone');
    const countryField = document.getElementById('country');
    const address1Field = document.getElementById('address1');
    const address2Field = document.getElementById('address2');
    const cityField = document.getElementById('city');
    const stateField = document.getElementById('state');
    const postalCodeField = document.getElementById('postalCode');
    const instructionsField = document.getElementById('instructions');
    
    if (fullNameField && address.fullName) fullNameField.value = address.fullName;
    if (emailField && address.email) emailField.value = address.email;
    if (phoneField && address.phone) phoneField.value = address.phone;
    if (countryField && address.country) countryField.value = address.country;
    if (address1Field && address.address1) address1Field.value = address.address1;
    if (address2Field && address.address2) address2Field.value = address.address2;
    if (cityField && address.city) cityField.value = address.city;
    if (stateField && address.state) stateField.value = address.state;
    if (postalCodeField && address.postalCode) postalCodeField.value = address.postalCode;
    if (instructionsField && address.instructions) instructionsField.value = address.instructions;
    
    if (!address.email && authSystem.getUserEmail()) {
        emailField.value = authSystem.getUserEmail();
    }
    
    if (!address.fullName && authSystem.getUserName() !== 'Guest') {
        fullNameField.value = authSystem.getUserName();
    }
}

function setupForExistingOrderPayment() {
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    const remainingOption = document.getElementById('remainingPaymentOption');
    
    if (advanceOption) advanceOption.style.display = 'none';
    if (fullOption) fullOption.style.display = 'none';
    if (remainingOption) remainingOption.style.display = 'block';
    
    selectPaymentOption('remaining');
    
    const paymentOptionsTitle = document.querySelector('.payment-options h4');
    if (paymentOptionsTitle) {
        paymentOptionsTitle.innerHTML = '<i class="fas fa-money-bill-wave"></i> Payment Type (Existing Order)';
    }
}

function updatePaymentBreakdownForExistingOrder() {
    if (!existingOrderData) return;
    
    const totalOrderValue = document.getElementById('totalOrderValue');
    const advanceAmount = document.getElementById('advanceAmount');
    const remainingAmount = document.getElementById('remainingAmount');
    const payNowAmount = document.getElementById('payNowAmount');
    const advanceLabel = document.getElementById('advanceLabel');
    const remainingLabel = document.getElementById('remainingLabel');
    const payNowLabel = document.getElementById('payNowLabel');
    
    if (!totalOrderValue || !advanceAmount || !remainingAmount || !payNowAmount) return;
    
    const paidAmount = existingOrderData.submittedAmount || existingOrderData.advancePayment || 0;
    const totalAmount = existingOrderData.total || 0;
    const remainingBalance = existingOrderData.remainingPayment || (totalAmount - paidAmount);
    
    totalOrderValue.textContent = `£${totalAmount.toFixed(2)}`;
    advanceAmount.textContent = `£${paidAmount.toFixed(2)}`;
    remainingAmount.textContent = `£${remainingBalance.toFixed(2)}`;
    payNowAmount.textContent = `£${remainingBalance.toFixed(2)}`;
    
    if (advanceLabel) advanceLabel.textContent = 'Already Paid:';
    if (remainingLabel) remainingLabel.textContent = 'Remaining Balance:';
    if (payNowLabel) payNowLabel.textContent = 'Amount to Pay Now:';
}

async function savePaymentToFirebase(paymentData, paymentId) {
    try {
        if (!firebaseDB) {
            throw new Error('Firebase not initialized');
        }
        
        const finalPayment = {
            id: paymentId,
            ...paymentData,
            updatedAt: new Date().toISOString()
        };
        
        await firebaseDB.collection('payments').doc(paymentId).set(finalPayment);
        
        const userPaymentRef = firebaseDB.collection('users').doc(paymentData.userId).collection('payments').doc(paymentId);
        await userPaymentRef.set(finalPayment);
        
        const userOrderRef = firebaseDB.collection('users').doc(paymentData.userId).collection('orders').doc(paymentData.orderId);
        
        const userOrderDoc = await userOrderRef.get();
        if (userOrderDoc.exists) {
            const currentOrderData = userOrderDoc.data();
            
            const currentPaid = currentOrderData.submittedAmount || currentOrderData.advancePayment || 0;
            const newPaidAmount = currentPaid + paymentData.amount;
            const newRemaining = 0;
            
            await userOrderRef.update({
                submittedAmount: newPaidAmount,
                remainingPayment: newRemaining,
                paymentStatus: 'fully_paid',
                updatedAt: new Date().toISOString(),
                paymentHistory: firebase.firestore.FieldValue.arrayUnion({
                    paymentId: paymentId,
                    amount: paymentData.amount,
                    type: 'remaining_payment',
                    method: paymentData.paymentMethod,
                    status: 'pending',
                    date: new Date().toISOString(),
                    reference: `${paymentData.orderNumber}-REM`
                })
            });
            
            console.log('✅ User order updated with payment');
            
            const mainOrderRef = firebaseDB.collection('orders').doc(paymentData.orderId);
            const mainOrderDoc = await mainOrderRef.get();
            
            if (mainOrderDoc.exists) {
                await mainOrderRef.update({
                    submittedAmount: newPaidAmount,
                    remainingPayment: newRemaining,
                    paymentStatus: 'fully_paid',
                    updatedAt: new Date().toISOString(),
                    paymentHistory: firebase.firestore.FieldValue.arrayUnion({
                        paymentId: paymentId,
                        amount: paymentData.amount,
                        type: 'remaining_payment',
                        method: paymentData.paymentMethod,
                        status: 'pending',
                        date: new Date().toISOString(),
                        reference: `${paymentData.orderNumber}-REM`
                    })
                });
                console.log('✅ Main order updated with payment');
            } else {
                await mainOrderRef.set({
                    ...currentOrderData,
                    submittedAmount: newPaidAmount,
                    remainingPayment: newRemaining,
                    paymentStatus: 'fully_paid',
                    updatedAt: new Date().toISOString(),
                    paymentHistory: firebase.firestore.FieldValue.arrayUnion({
                        paymentId: paymentId,
                        amount: paymentData.amount,
                        type: 'remaining_payment',
                        method: paymentData.paymentMethod,
                        status: 'pending',
                        date: new Date().toISOString(),
                        reference: `${paymentData.orderNumber}-REM`
                    }),
                    syncedFromUser: true,
                    syncedAt: new Date().toISOString()
                });
                console.log('✅ Order created in main collection');
            }
        } else {
            throw new Error('Order not found in user collection');
        }
        
        console.log('✅ Payment record saved:', paymentId);
        
    } catch (error) {
        console.error('Error saving payment to Firebase:', error);
        throw error;
    }
}

function showBankTransferDetailsForExistingOrder(paymentData, paymentId) {
    const bankDetailsHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                <h3 style="color: var(--primary-gold); margin-bottom: 20px; text-align: center;">
                    <i class="fas fa-university"></i> Bank Transfer Details
                </h3>
                
                <div style="background: var(--bg-light); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--stone-dark);">Order Information</h4>
                    <div style="margin-bottom: 10px;">
                        <strong>Order Number:</strong> ${paymentData.orderNumber}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Payment For:</strong> Remaining Balance
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Amount to Pay:</strong> £${paymentData.amount.toFixed(2)}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Payment ID:</strong> ${paymentId.substring(0, 12)}...
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bae6fd;">
                    <h4 style="margin-bottom: 15px; color: #0369a1;">Bank Details</h4>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Name:</strong> ${paymentData.bankTransferDetails.accountName}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Account Number:</strong> ${paymentData.bankTransferDetails.accountNumber}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Sort Code:</strong> ${paymentData.bankTransferDetails.sortCode}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>IBAN:</strong> ${paymentData.bankTransferDetails.iban}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>SWIFT/BIC:</strong> ${paymentData.bankTransferDetails.swift}
                    </div>
                    <div style="margin-bottom: 10px; background: #fffbeb; padding: 10px; border-radius: 5px; border: 1px solid #fde68a;">
                        <strong style="color: #92400e;">Reference:</strong> 
                        <span style="font-family: monospace; font-weight: bold; color: #92400e;">
                            ${paymentData.bankTransferDetails.reference}
                        </span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Amount:</strong> £${paymentData.bankTransferDetails.amount.toFixed(2)} GBP
                    </div>
                </div>
                
                <div style="background: #f0fff4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #bbf7d0;">
                    <h5 style="margin-bottom: 10px; color: #166534;">
                        <i class="fas fa-info-circle"></i> Important Notes
                    </h5>
                    <ul style="font-size: 13px; color: #166534; padding-left: 20px;">
                        <li>Use the exact reference number when making transfer</li>
                        <li>Payment will be verified within 1-2 business days</li>
                        <li>Order status will update automatically after verification</li>
                        <li>You will receive email confirmation</li>
                        <li>Your order will be marked as "Fully Paid"</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button onclick="copyBankDetails('${paymentData.bankTransferDetails.reference}')" 
                            style="padding: 12px 20px; background: var(--primary-gold); color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-copy"></i> Copy Reference
                    </button>
                    <button onclick="completeExistingOrderPayment('${paymentData.orderId}', '${paymentId}')" 
                            style="padding: 12px 20px; background: #40c057; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-check-circle"></i> Mark as Paid
                    </button>
                    <button onclick="closeBankDetailsModal()" 
                            style="padding: 12px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; flex: 1; min-width: 160px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', bankDetailsHTML);
}

async function completeExistingOrderPayment(orderId, paymentId) {
    try {
        showLoading(true);
        
        if (!firebaseDB) {
            throw new Error('Firebase not initialized');
        }
        
        const paymentRef = firebaseDB.collection('payments').doc(paymentId);
        await paymentRef.update({
            status: 'completed',
            completedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        const userPaymentRef = firebaseDB.collection('users')
            .doc(authSystem.getUserId())
            .collection('payments')
            .doc(paymentId);
        await userPaymentRef.update({
            status: 'completed',
            completedAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        const userOrderRef = firebaseDB.collection('users')
            .doc(authSystem.getUserId())
            .collection('orders')
            .doc(orderId);
        
        await userOrderRef.update({
            status: 'processing',
            paymentStatus: 'fully_paid',
            updatedAt: new Date().toISOString()
        });
        
        const mainOrderRef = firebaseDB.collection('orders').doc(orderId);
        const mainOrderDoc = await mainOrderRef.get();
        
        if (mainOrderDoc.exists) {
            await mainOrderRef.update({
                status: 'processing',
                paymentStatus: 'fully_paid',
                updatedAt: new Date().toISOString()
            });
        }
        
        await sendPaymentNotificationToUser();
        
        closeBankDetailsModal();
        
        showNotification('Payment marked as completed! Order status updated.');
        
        setTimeout(() => {
            window.location.href = `order-confirmation.html?order=${existingOrderData.orderNumber}&payment=bank&type=remaining`;
        }, 2000);
        
    } catch (error) {
        console.error('Error completing existing order payment:', error);
        showError('Failed to complete payment: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function sendPaymentNotificationToUser() {
    try {
        if (!firebaseDB) return;
        
        const notification = {
            title: 'Payment Received - Order Fully Paid',
            message: `Your remaining payment of £${existingOrderData.remainingPayment?.toFixed(2) || '0.00'} has been received for order ${existingOrderData.orderNumber}. Your order is now marked as fully paid and will be processed shortly.`,
            orderId: existingOrderData.id,
            orderNumber: existingOrderData.orderNumber,
            type: 'payment_completed',
            userId: existingOrderData.userId || authSystem.getUserId(),
            createdAt: new Date().toISOString(),
            read: false,
            readAt: null
        };
        
        const notificationRef = firebaseDB.collection('users')
            .doc(authSystem.getUserId())
            .collection('notifications')
            .doc();
        
        await notificationRef.set(notification);
        
        console.log('✅ Payment notification sent to user');
        
    } catch (error) {
        console.error('Error sending payment notification:', error);
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function togglePaymentOptions() {
    const paymentOptions = document.getElementById('paymentOptions');
    const toggleBtn = document.getElementById('togglePaymentOptionsBtn');
    
    if (paymentOptions.style.display === 'none') {
        paymentOptions.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Payment Options';
    } else {
        paymentOptions.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show Payment Options';
    }
}

function showOrderDetails() {
    if (!existingOrderData) return;
    
    const orderDetails = `
        Order Number: ${existingOrderData.orderNumber}
        Status: ${existingOrderData.status || 'Processing'}
        Total: £${existingOrderData.total?.toFixed(2) || '0.00'}
        Paid: £${existingOrderData.submittedAmount?.toFixed(2) || '0.00'}
        Remaining: £${existingOrderData.remainingPayment?.toFixed(2) || '0.00'}
        Items: ${existingOrderData.items?.length || 0}
        Created: ${new Date(existingOrderData.createdAt).toLocaleDateString()}
    `;
    
    alert(orderDetails);
}

function copyBankDetails(reference) {
    navigator.clipboard.writeText(reference).then(() => {
        showNotification('Reference copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showError('Failed to copy reference');
    });
}

function closeBankDetailsModal() {
    const modal = document.querySelector('div[style*="position: fixed; top: 0; left: 0"]');
    if (modal) {
        modal.remove();
    }
}

// ============================================
// GLOBAL FUNCTIONS
// ============================================

window.selectPaymentOption = selectPaymentOption;
window.selectPaymentMethod = selectPaymentMethod;
window.validateAndProcessPayment = validateAndProcessPayment;
window.cancelPayment = cancelPayment;
window.goBack = goBack;
window.togglePaymentOptions = togglePaymentOptions;
window.showOrderDetails = showOrderDetails;
window.copyBankDetails = copyBankDetails;
window.completeExistingOrderPayment = completeExistingOrderPayment;
window.completePayment = completePayment;
window.closeBankDetailsModal = closeBankDetailsModal;
</script>
</body>
</html>
