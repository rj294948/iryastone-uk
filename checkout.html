<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Checkout | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ================= BASIC RESET ================= */
*{box-sizing:border-box;margin:0;padding:0;font-family:Poppins,Arial}
body{background:#f6f6f6;color:#333}

/* ================= HEADER ================= */
.checkout-header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:15px;
  background:#111;
  color:#fff
}
.checkout-header button{
  background:none;
  border:none;
  color:#fff;
  font-size:18px;
  cursor:pointer
}

/* ================= STEPS ================= */
.checkout-step{
  display:none;
  padding:20px;
  background:#fff;
  margin:15px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.08)
}
.checkout-step.active{display:block}
.checkout-step h3{margin-bottom:15px}

/* ================= FORM ================= */
input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border:1px solid #ccc;
  border-radius:6px
}
label{display:block;margin:10px 0;font-weight:500}

/* ================= BUTTON ================= */
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:6px;
  background:#caa84d;
  color:#000;
  font-weight:600;
  cursor:pointer
}
button:hover{opacity:.9}

/* ================= SUMMARY ================= */
#orderSummary p{
  margin:6px 0;
  font-size:14px
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center
}
.modal div{
  background:#fff;
  padding:25px;
  border-radius:10px;
  text-align:center;
  width:90%;
  max-width:400px
}
</style>
</head>

<body>

<header class="checkout-header">
  <button id="backBtn"><i class="fa fa-arrow-left"></i></button>
  <h2>Checkout</h2>
</header>

<!-- ================= STEP 1 ================= -->
<section class="checkout-step active" id="step-1">
  <h3>Shipping Details</h3>
  <input id="shippingName" placeholder="Full Name">
  <input id="shippingEmail" placeholder="Email">
  <input id="shippingPhone" placeholder="Phone">
  <input id="shippingAddress1" placeholder="Address Line 1">
  <input id="shippingAddress2" placeholder="Address Line 2">
  <input id="shippingCity" placeholder="City">
  <input id="shippingState" placeholder="State">
  <input id="shippingPostalCode" placeholder="Postal Code">
  <input id="shippingCountry" value="United Kingdom">
  <button onclick="goToStep(2)">Continue</button>
</section>

<!-- ================= STEP 2 ================= -->
<section class="checkout-step" id="step-2">
  <h3>Payment Method</h3>

  <label><input type="radio" name="payment" value="card"> Card Payment</label>
  <label><input type="radio" name="payment" value="bank"> Bank Transfer</label>

  <button onclick="goToStep(3)">Continue</button>
</section>

<!-- ================= STEP 3 ================= -->
<section class="checkout-step" id="step-3">
  <h3>Review Order</h3>
  <div id="orderSummary"></div>

  <label>
    <input type="checkbox" id="acceptTerms">
    I accept Terms & Conditions
  </label>

  <button onclick="placeOrder()">Place Order</button>
</section>

<!-- ================= SUCCESS MODAL ================= -->
<div class="modal" id="successModal">
  <div>
    <h3>‚úÖ Order Successful</h3>
    <p>Payment confirmed</p>
    <button onclick="goToOrders()">View Orders</button>
  </div>
</div>

<!-- ================= PENDING MODAL ================= -->
<div class="modal" id="pendingModal">
  <div>
    <h3>üè¶ Bank Transfer Pending</h3>
    <p>Please complete payment within 24 hours</p>
    <button onclick="goToOrders()">OK</button>
  </div>
</div>

<!-- ================= FIREBASE SDK ================= -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<!-- üî• PASTE YOUR FULL FIREBASE CODE HERE (UNCHANGED) -->
<!-- üëâ EXACT wahi code jo tumne last message me diya hai -->
<!-- ================================================= -->

<script>
/* ================= CHECKOUT LOGIC ================= */

let orderData={
  items:[],subtotal:0,shipping:0,tax:0,total:0,
  advancePayment:0,remainingPayment:0,platformFee:0,netAdvance:0,
  paymentMethod:null,paymentStatus:"pending",orderStatus:"created",
  userId:null,userName:"",userEmail:""
};

let selectedPaymentMethod=null;
let isBuyNow=false;

document.addEventListener("DOMContentLoaded",async()=>{
  const user=getCurrentUser();
  if(!user){location.href="index.html";return;}

  orderData.userId=user.uid;
  orderData.userName=user.displayName||"";
  orderData.userEmail=user.email||"";

  const p=new URLSearchParams(location.search);
  isBuyNow=p.get("buynow")==="true";

  isBuyNow?loadBuyNow():loadCart();

  backBtn.onclick=()=>isBuyNow?history.back():location.href="cart.html";

  document.querySelectorAll("input[name=payment]").forEach(r=>{
    r.onchange=()=>selectedPaymentMethod=r.value;
  });
});

function loadCart(){
  const cart=JSON.parse(localStorage.getItem("irya_cart_"+orderData.userId))||[];
  if(!cart.length){location.href="products.html";return;}
  orderData.items=cart;
  calculate();
}

function loadBuyNow(){
  const d=JSON.parse(sessionStorage.getItem("irya_buy_now"));
  if(!d){location.href="products.html";return;}
  orderData.items=[d];
  calculate();
}

function calculate(){
  orderData.subtotal=orderData.items.reduce((s,i)=>s+i.price*i.quantity,0);
  orderData.shipping=orderData.subtotal>500?0:25;
  orderData.tax=orderData.subtotal*0.2;
  orderData.total=orderData.subtotal+orderData.shipping+orderData.tax;
  orderData.advancePayment=orderData.total*0.3;
  orderData.remainingPayment=orderData.total-orderData.advancePayment;
  orderData.platformFee=(orderData.advancePayment*0.025)+0.30;
  orderData.netAdvance=orderData.advancePayment-orderData.platformFee;

  orderSummary.innerHTML=`
    <p>Subtotal: ¬£${orderData.subtotal.toFixed(2)}</p>
    <p>Tax: ¬£${orderData.tax.toFixed(2)}</p>
    <p>Total: ¬£${orderData.total.toFixed(2)}</p>
    <p>Advance: ¬£${orderData.advancePayment.toFixed(2)}</p>`;
}

function goToStep(n){
  document.querySelectorAll(".checkout-step").forEach(s=>s.classList.remove("active"));
  document.getElementById("step-"+n).classList.add("active");
}

async function placeOrder(){
  if(!selectedPaymentMethod){alert("Select payment method");return;}
  if(!acceptTerms.checked){alert("Accept terms");return;}

  orderData.paymentMethod=selectedPaymentMethod;
  orderData.paymentStatus=selectedPaymentMethod==="bank"?"pending":"paid";
  orderData.orderStatus=selectedPaymentMethod==="bank"?"pending_confirmation":"confirmed";

  const orderObj={
    ...orderData,
    orderId:"ORD_"+Date.now(),
    orderNumber:"IRYA-"+Math.floor(Math.random()*99999),
    shippingDetails:{
      name:shippingName.value,
      email:shippingEmail.value,
      phone:shippingPhone.value,
      address1:shippingAddress1.value,
      address2:shippingAddress2.value,
      city:shippingCity.value,
      state:shippingState.value,
      postalCode:shippingPostalCode.value,
      country:shippingCountry.value
    }
  };

  await saveOrderToFirebase(orderObj);

  if(!isBuyNow) localStorage.removeItem("irya_cart_"+orderData.userId);

  document.getElementById(
    selectedPaymentMethod==="bank"?"pendingModal":"successModal"
  ).style.display="flex";
}

function goToOrders(){
  location.href="orders.html?user="+orderData.userId;
}
</script>

</body>
</html>
