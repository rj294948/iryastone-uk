<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Stripe for International Payments -->
<script src="https://js.stripe.com/v3/"></script>

<style>
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header - Hide/Show on Scroll */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
    transition: transform 0.3s ease, opacity 0.3s ease;
    transform: translateY(0);
    opacity: 1;
}

header.hidden {
    transform: translateY(-100%);
    opacity: 0;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
    transition: padding 0.3s ease;
}

.breadcrumb.scrolled {
    padding-top: 20px;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Checkout Container */
.checkout-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

.checkout-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
}

/* Checkout Sections */
.checkout-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.section-header h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
}

.section-header i {
    color: var(--primary-gold);
    font-size: 18px;
}

/* Address Form */
.address-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: " *";
    color: #ff4757;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

/* Saved Address */
.saved-address {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: var(--transition);
    border: 2px solid transparent;
}

.saved-address:hover {
    border-color: var(--primary-gold);
}

.saved-address.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.address-type {
    display: inline-block;
    background: var(--primary-gold);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 500;
    margin-bottom: 10px;
}

.address-details {
    font-size: 14px;
    line-height: 1.5;
}

.address-details .name {
    font-weight: 600;
    margin-bottom: 5px;
}

/* Order Summary */
.order-items {
    margin-bottom: 20px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.order-item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.order-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.order-item-details {
    flex: 1;
}

.order-item-name {
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 15px;
}

.order-item-info {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.order-item-price {
    font-weight: 600;
    color: var(--primary-gold);
}

.order-item-quantity {
    font-size: 13px;
    color: var(--text-light);
}

/* Price Breakdown */
.price-breakdown {
    margin-bottom: 20px;
}

.price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.price-row:last-child {
    border-bottom: none;
}

.price-row.total {
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-gold);
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
}

.price-label {
    color: var(--text-dark);
}

.price-value {
    font-weight: 600;
}

/* Payment Options */
.payment-options {
    margin: 20px 0;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 10px;
}

.payment-options h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-options h4 i {
    color: var(--primary-gold);
}

.payment-option {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    padding: 12px;
    background: var(--white);
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    transition: var(--transition);
}

.payment-option:hover {
    border-color: var(--gold-light);
}

.payment-option.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-option input[type="radio"] {
    accent-color: var(--primary-gold);
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.payment-option label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-dark);
    flex: 1;
}

.payment-option i {
    color: var(--primary-gold);
    font-size: 16px;
}

.payment-details {
    font-size: 12px;
    color: var(--text-light);
    margin-top: 5px;
    margin-left: 30px;
}

/* Payment Breakdown */
.payment-breakdown {
    background: var(--bg-light);
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    border: 1px solid #e0e0e0;
}

.payment-breakdown h4 {
    font-size: 16px;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.payment-breakdown h4 i {
    color: var(--primary-gold);
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #e0e0e0;
}

.payment-item:last-child {
    border-bottom: none;
    font-weight: 600;
    color: var(--primary-gold);
    padding-top: 10px;
    margin-top: 5px;
    border-top: 2px solid #e0e0e0;
}

.payment-label {
    color: var(--text-dark);
    font-size: 14px;
}

.payment-amount {
    font-weight: 600;
    font-size: 14px;
}

/* Custom Requirements */
.custom-requirements-box {
    background: var(--bg-light);
    padding: 15px;
    border-radius: 10px;
    margin: 15px 0;
    border-left: 4px solid var(--primary-gold);
}

.custom-requirements-box h5 {
    font-size: 14px;
    margin-bottom: 10px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 8px;
}

.custom-requirements-box h5 i {
    color: var(--primary-gold);
    font-size: 14px;
}

.custom-requirements-text {
    font-size: 13px;
    color: var(--text-dark);
    line-height: 1.5;
    background: var(--white);
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
}

/* Payment Methods */
.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.payment-method {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition);
}

.payment-method:hover {
    border-color: var(--primary-gold);
}

.payment-method.active {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.payment-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary-gold);
    font-size: 20px;
}

.payment-info {
    flex: 1;
}

.payment-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.payment-description {
    font-size: 12px;
    color: var(--text-light);
}

/* Stripe Card Element */
.stripe-card-element {
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    background: var(--white);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.action-btn-large {
    flex: 1;
    padding: 16px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 16px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-gold), var(--gold-dark));
    color: var(--white);
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
}

.btn-secondary {
    background: var(--bg-light);
    color: var(--text-dark);
    border: 2px solid #e0e0e0;
}

.btn-secondary:hover {
    background: #f0f0f0;
    border-color: var(--primary-gold);
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--primary-gold);
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    z-index: 9999;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    max-width: 300px;
    display: none;
}

.notification.show {
    transform: translateX(0);
    display: block;
}

/* Bottom Navigation - Hide/Show on Scroll */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, opacity 0.3s ease;
    transform: translateY(0);
    opacity: 1;
}

.bottom-nav.hidden {
    transform: translateY(100%);
    opacity: 0;
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive */
@media (max-width: 992px) {
    .checkout-grid {
        grid-template-columns: 1fr;
        gap: 30px;
    }
    
    .address-form {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .checkout-section {
        padding: 20px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .payment-option {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .payment-details {
        margin-left: 0;
    }
}

@media (max-width: 480px) {
    .checkout-container {
        padding: 20px 12px;
    }
    
    .payment-method {
        flex-direction: column;
        text-align: center;
    }
    
    .payment-icon {
        width: 35px;
        height: 35px;
        font-size: 18px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<!-- Header -->
<header id="mainHeader">
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="products.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb" id="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item">
            <a href="cart.html">Cart</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active">
            Checkout
        </div>
    </div>
</section>

<!-- Checkout Container -->
<section class="checkout-container">
    <div class="checkout-grid">
        <!-- Left Column: Shipping & Payment -->
        <div>
            <!-- Shipping Address -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-shipping-fast"></i>
                    <h3>Shipping Address</h3>
                </div>
                
                <div id="savedAddresses">
                    <!-- Saved addresses will be loaded here -->
                </div>
                
                <div class="address-form" id="addressForm">
                    <div class="form-group">
                        <label class="required">Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Email Address</label>
                        <input type="email" id="email" placeholder="your.email@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Phone Number</label>
                        <input type="tel" id="phone" placeholder="+1 234 567 8900" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Country</label>
                        <select id="country" required>
                            <option value="">Select Country</option>
                            <option value="GB">United Kingdom</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="IN">India</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="IT">Italy</option>
                            <option value="ES">Spain</option>
                            <option value="AE">United Arab Emirates</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Address Line 1</label>
                        <input type="text" id="address1" placeholder="Street address, P.O. box, company name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Address Line 2</label>
                        <input type="text" id="address2" placeholder="Apartment, suite, unit, building, floor, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label class="required">City</label>
                        <input type="text" id="city" placeholder="City" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">State/Province</label>
                        <input type="text" id="state" placeholder="State or Province" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Postal Code</label>
                        <input type="text" id="postalCode" placeholder="ZIP or Postal code" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Special Instructions</label>
                        <textarea id="instructions" placeholder="Any special delivery instructions..."></textarea>
                    </div>
                    
                    <div class="form-group full-width">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="saveAddress">
                            <span>Save this address for future orders</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Payment Information -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Information</h3>
                </div>
                
                <!-- Payment Type Selection -->
                <div class="payment-options">
                    <h4><i class="fas fa-money-bill-wave"></i> Select Payment Type</h4>
                    
                    <div class="payment-option selected" onclick="selectPaymentOption('advance')" id="advancePaymentOption">
                        <input type="radio" id="advancePayment" name="paymentType" value="advance" checked>
                        <label for="advancePayment">
                            <i class="fas fa-credit-card"></i>
                            <div>
                                <div>30% Advance Payment</div>
                                <div class="payment-details">Pay 30% now, 70% after shipping confirmation</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="payment-option" onclick="selectPaymentOption('full')" id="fullPaymentOption">
                        <input type="radio" id="fullPayment" name="paymentType" value="full">
                        <label for="fullPayment">
                            <i class="fas fa-money-check-alt"></i>
                            <div>
                                <div>Full Payment Now</div>
                                <div class="payment-details">Pay full amount now and get 5% discount</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Payment Breakdown -->
                <div class="payment-breakdown" id="paymentBreakdown">
                    <h4><i class="fas fa-file-invoice-dollar"></i> Payment Breakdown</h4>
                    <div class="payment-item">
                        <span class="payment-label">Total Order Value:</span>
                        <span class="payment-amount" id="totalOrderValue">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="advanceLabel">30% Advance:</span>
                        <span class="payment-amount" id="advanceAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="remainingLabel">70% After Shipping:</span>
                        <span class="payment-amount" id="remainingAmount">£0.00</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label" id="payNowLabel">Amount to Pay Now:</span>
                        <span class="payment-amount" id="payNowAmount">£0.00</span>
                    </div>
                </div>
                
                <!-- Payment Method -->
                <div class="section-header" style="margin-top: 25px;">
                    <i class="fas fa-credit-card"></i>
                    <h3>Payment Method</h3>
                </div>
                
                <div class="payment-methods">
                    <div class="payment-method active" data-method="stripe" onclick="selectPaymentMethod('stripe')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-stripe"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-description">Pay securely with your card (Stripe)</div>
                        </div>
                        <i class="fas fa-check-circle" style="color: var(--primary-gold);"></i>
                    </div>
                    
                    <div class="payment-method" data-method="paypal" onclick="selectPaymentMethod('paypal')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-paypal"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">PayPal</div>
                            <div class="payment-description">Pay with your PayPal account</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                    
                    <div class="payment-method" data-method="bank" onclick="selectPaymentMethod('bank')">
                        <div class="payment-icon">
                            <i class="fas fa-university"></i>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Bank Transfer</div>
                            <div class="payment-description">Direct bank transfer</div>
                        </div>
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                
                <!-- Stripe Card Element -->
                <div id="stripeCardElement" style="margin-top: 20px; display: none;">
                    <div class="stripe-card-element" id="card-element"></div>
                    <div id="card-errors" role="alert" style="color: #ff4757; font-size: 13px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Order Summary -->
        <div>
            <!-- Order Summary -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-receipt"></i>
                    <h3>Order Summary</h3>
                </div>
                
                <div class="order-items" id="orderItems">
                    <!-- Order items will be loaded here -->
                </div>
                
                <!-- Custom Requirements Display -->
                <div id="customRequirementsContainer"></div>
                
                <div class="price-breakdown">
                    <div class="price-row">
                        <span class="price-label">Subtotal</span>
                        <span class="price-value" id="subtotal">£0.00</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Shipping</span>
                        <span class="price-value" id="shipping">Calculated after address</span>
                    </div>
                    
                    <div class="price-row">
                        <span class="price-label">Tax (VAT)</span>
                        <span class="price-value" id="tax">£0.00</span>
                    </div>
                    
                    <div class="price-row total">
                        <span class="price-label">Total Amount</span>
                        <span class="price-value" id="total">£0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Terms & Conditions -->
            <div class="checkout-section">
                <div class="section-header">
                    <i class="fas fa-file-contract"></i>
                    <h3>Terms & Conditions</h3>
                </div>
                
                <div style="font-size: 13px; color: var(--text-light); line-height: 1.6;">
                    <p>By placing your order, you agree to our Terms of Service and Privacy Policy.</p>
                    <p><strong>Payment Terms:</strong> 30% advance payment required to confirm order. Remaining 70% payable after shipping confirmation. Full payment upfront receives 5% discount.</p>
                    <p><strong>Shipping:</strong> Delivery within 7-14 business days after payment confirmation.</p>
                    <p style="margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="agreeTerms" required>
                            <span>I agree to the terms and conditions and payment terms</span>
                        </label>
                    </p>
                </div>
            </div>
            
            <!-- Place Order Button -->
            <div class="action-buttons">
                <button class="action-btn-large btn-primary" onclick="placeOrder()">
                    <i class="fas fa-lock"></i>
                    Proceed to Payment
                </button>
                <a href="cart.html" class="action-btn-large btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back to Cart
                </a>
            </div>
        </div>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav" id="bottomNav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn active">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebasestorage.app",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let stripe, cardElement;
let cartItems = [];
let selectedPaymentMethod = 'stripe';
let userAddress = null;
let isBuyNow = false;
let currentPaymentType = 'advance';
let lastScrollTop = 0;

// ============================================
// SCROLL HIDE/SHOW FUNCTIONALITY
// ============================================

function initScrollHideShow() {
    const header = document.getElementById('mainHeader');
    const bottomNav = document.getElementById('bottomNav');
    const breadcrumb = document.getElementById('breadcrumb');
    
    let ticking = false;
    
    window.addEventListener('scroll', function() {
        if (!ticking) {
            window.requestAnimationFrame(function() {
                handleScroll(header, bottomNav, breadcrumb);
                ticking = false;
            });
            ticking = true;
        }
    });
    
    // Initial call to set proper state
    handleScroll(header, bottomNav, breadcrumb);
}

function handleScroll(header, bottomNav, breadcrumb) {
    const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
    
    // For mobile screens, hide/show based on scroll direction
    if (window.innerWidth <= 768) {
        if (currentScroll > lastScrollTop && currentScroll > 100) {
            // Scrolling down
            header.classList.add('hidden');
            bottomNav.classList.add('hidden');
            breadcrumb.classList.add('scrolled');
        } else {
            // Scrolling up
            header.classList.remove('hidden');
            bottomNav.classList.remove('hidden');
            
            // Only add scrolled class if we're not at the very top
            if (currentScroll > 50) {
                breadcrumb.classList.add('scrolled');
            } else {
                breadcrumb.classList.remove('scrolled');
            }
        }
    } else {
        // For desktop, always show but adjust breadcrumb
        header.classList.remove('hidden');
        bottomNav.classList.remove('hidden');
        
        if (currentScroll > 50) {
            breadcrumb.classList.add('scrolled');
        } else {
            breadcrumb.classList.remove('scrolled');
        }
    }
    
    lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    // Initialize scroll hide/show
    initScrollHideShow();
    
    // Initialize Firebase
    await initializeFirebase();
    
    // Initialize Stripe
    await initializeStripe();
    
    // Check if this is Buy Now flow
    isBuyNow = localStorage.getItem('irya_buy_now') === 'true';
    
    // Load cart items
    await loadCartItems();
    
    // Load saved addresses
    await loadSavedAddresses();
    
    // Calculate shipping
    calculateShipping();
    
    // Update cart badge
    updateCartBadge();
    
    // Initialize payment options
    initializePaymentOptions();
});

// ============================================
// FIREBASE INITIALIZATION
// ============================================

async function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            showError('Firebase not loaded');
            return false;
        }
        
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        
        firebaseDB = firebase.firestore();
        firebaseAuth = firebase.auth();
        
        return true;
    } catch (error) {
        console.error('Firebase initialization error:', error);
        return false;
    }
}

// ============================================
// STRIPE INITIALIZATION
// ============================================

async function initializeStripe() {
    try {
        // Initialize Stripe with your publishable key
        stripe = Stripe('pk_test_YOUR_STRIPE_PUBLISHABLE_KEY'); // Replace with your Stripe key
        
        // Create card element
        const elements = stripe.elements();
        cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#32325d',
                    fontFamily: '"Poppins", sans-serif',
                },
            },
        });
        
        cardElement.mount('#card-element');
        
        // Handle real-time validation errors
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        
    } catch (error) {
        console.error('Stripe initialization error:', error);
        // Don't show error for Stripe as it might be optional
    }
}

// ============================================
// LOAD CART ITEMS
// ============================================

async function loadCartItems() {
    try {
        showLoading(true);
        
        const userId = getUserId();
        const cartKey = 'irya_local_cart_' + userId;
        const cartData = localStorage.getItem(cartKey);
        
        if (cartData) {
            cartItems = JSON.parse(cartData);
            displayOrderItems();
            calculateTotals();
            
            // Clear buy now flag
            if (isBuyNow) {
                localStorage.removeItem('irya_buy_now');
            }
        } else {
            showError('Your cart is empty');
            window.location.href = 'cart.html';
        }
        
    } catch (error) {
        console.error('Error loading cart items:', error);
        showError('Failed to load cart items');
    } finally {
        showLoading(false);
    }
}

function displayOrderItems() {
    const orderItemsDiv = document.getElementById('orderItems');
    const customRequirementsContainer = document.getElementById('customRequirementsContainer');
    
    if (cartItems.length === 0) {
        orderItemsDiv.innerHTML = '<p style="text-align: center; color: var(--text-light);">No items in cart</p>';
        return;
    }
    
    // Clear custom requirements container
    customRequirementsContainer.innerHTML = '';
    
    const itemsHTML = cartItems.map(item => {
        // Display custom requirements if any
        if (item.customRequirements) {
            const customReqHTML = `
                <div class="custom-requirements-box">
                    <h5><i class="fas fa-edit"></i> Custom Requirements for ${item.name}</h5>
                    <div class="custom-requirements-text">${item.customRequirements}</div>
                </div>
            `;
            customRequirementsContainer.innerHTML += customReqHTML;
        }
        
        let calculationInfo = '';
        if (item.calculationData) {
            if (item.calculationData.unit === 'sqft') {
                calculationInfo = `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
            } else if (item.calculationData.unit === 'sqm') {
                calculationInfo = `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
            } else if (item.calculationData.unit === 'weight') {
                calculationInfo = `Weight: ${item.calculationData.weight || 1}kg`;
            } else {
                calculationInfo = `Quantity: ${item.quantity} pieces`;
            }
        } else {
            calculationInfo = `Quantity: ${item.quantity} pieces`;
        }
        
        return `
            <div class="order-item">
                <div class="order-item-image">
                    <img src="${item.image}" alt="${item.name}" onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800'">
                </div>
                <div class="order-item-details">
                    <div class="order-item-name">${item.name}</div>
                    <div class="order-item-info">${item.category}</div>
                    <div class="order-item-info">${calculationInfo}</div>
                    <div class="order-item-price">£${item.calculatedPrice ? parseFloat(item.calculatedPrice).toFixed(2) : (item.price * item.quantity).toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');
    
    orderItemsDiv.innerHTML = itemsHTML;
}

function calculateTotals() {
    let subtotal = 0;
    let advanceTotal = 0;
    let remainingTotal = 0;
    
    cartItems.forEach(item => {
        const itemTotal = item.calculatedPrice || (item.price * item.quantity);
        subtotal += itemTotal;
        
        // Use stored advance and remaining if available
        if (item.advancePayment !== undefined && item.remainingPayment !== undefined) {
            advanceTotal += item.advancePayment;
            remainingTotal += item.remainingPayment;
        } else {
            // Calculate if not stored
            advanceTotal += itemTotal * 0.3;
            remainingTotal += itemTotal * 0.7;
        }
    });
    
    const tax = subtotal * 0.2; // 20% VAT
    const shipping = calculateShippingCost();
    const total = subtotal + tax + shipping;
    
    // Update stored values in cart items
    cartItems.forEach(item => {
        const itemTotal = item.calculatedPrice || (item.price * item.quantity);
        if (item.advancePayment === undefined) {
            item.advancePayment = itemTotal * 0.3;
        }
        if (item.remainingPayment === undefined) {
            item.remainingPayment = itemTotal * 0.7;
        }
        item.totalPrice = itemTotal;
    });
    
    // Save updated cart items
    saveCartItems();
    
    // Update display
    document.getElementById('subtotal').textContent = `£${subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `£${tax.toFixed(2)}`;
    document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `£${shipping.toFixed(2)}`;
    document.getElementById('total').textContent = `£${total.toFixed(2)}`;
    
    // Update payment breakdown
    updatePaymentBreakdown(total, advanceTotal, remainingTotal);
    
    return { 
        subtotal, 
        tax, 
        shipping, 
        total,
        advanceTotal: parseFloat(advanceTotal.toFixed(2)),
        remainingTotal: parseFloat(remainingTotal.toFixed(2))
    };
}

function updatePaymentBreakdown(total, advanceTotal, remainingTotal) {
    const totalOrderValue = document.getElementById('totalOrderValue');
    const advanceAmount = document.getElementById('advanceAmount');
    const remainingAmount = document.getElementById('remainingAmount');
    const payNowAmount = document.getElementById('payNowAmount');
    const advanceLabel = document.getElementById('advanceLabel');
    const remainingLabel = document.getElementById('remainingLabel');
    
    if (currentPaymentType === 'advance') {
        totalOrderValue.textContent = `£${total.toFixed(2)}`;
        advanceAmount.textContent = `£${advanceTotal.toFixed(2)}`;
        remainingAmount.textContent = `£${remainingTotal.toFixed(2)}`;
        payNowAmount.textContent = `£${advanceTotal.toFixed(2)}`;
        
        // Reset labels for advance payment
        advanceLabel.textContent = '30% Advance:';
        remainingLabel.textContent = '70% After Shipping:';
    } else {
        const discountedTotal = total * 0.95; // 5% discount
        totalOrderValue.textContent = `£${total.toFixed(2)}`;
        advanceAmount.textContent = `-£${(total * 0.05).toFixed(2)}`;
        remainingAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        payNowAmount.textContent = `£${discountedTotal.toFixed(2)}`;
        
        // Update labels for full payment
        advanceLabel.textContent = 'Discount (5%):';
        remainingLabel.textContent = 'Discounted Total:';
    }
}

function calculateShippingCost() {
    // Simple shipping calculation based on subtotal
    const subtotal = cartItems.reduce((sum, item) => sum + (item.calculatedPrice || (item.price * item.quantity)), 0);
    
    if (subtotal > 500) {
        return 0; // Free shipping for orders over £500
    } else if (subtotal > 200) {
        return 25; // £25 shipping
    } else {
        return 35; // £35 shipping
    }
}

function calculateShipping() {
    const shipping = calculateShippingCost();
    document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `£${shipping.toFixed(2)}`;
    
    // Recalculate totals with shipping
    calculateTotals();
}

// ============================================
// PAYMENT OPTIONS - FIXED ERROR
// ============================================

function initializePaymentOptions() {
    // Get elements directly instead of relying on event
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    
    // Set default selection
    if (advanceOption && fullOption) {
        advanceOption.classList.add('selected');
        fullOption.classList.remove('selected');
    }
    
    // Update payment breakdown with initial values
    const totals = calculateTotals();
    updatePaymentBreakdown(totals.total, totals.advanceTotal, totals.remainingTotal);
}

function selectPaymentOption(paymentType) {
    currentPaymentType = paymentType;
    
    // Get elements
    const advanceOption = document.getElementById('advancePaymentOption');
    const fullOption = document.getElementById('fullPaymentOption');
    
    if (!advanceOption || !fullOption) {
        console.error('Payment option elements not found');
        return;
    }
    
    // Update UI
    advanceOption.classList.remove('selected');
    fullOption.classList.remove('selected');
    
    if (paymentType === 'advance') {
        advanceOption.classList.add('selected');
    } else {
        fullOption.classList.add('selected');
    }
    
    // Update radio button
    document.getElementById(`${paymentType}Payment`).checked = true;
    
    // Update payment breakdown
    const totals = calculateTotals();
    updatePaymentBreakdown(totals.total, totals.advanceTotal, totals.remainingTotal);
}

function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Update UI
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('active');
        el.querySelector('.fa-check-circle').style.color = '';
    });
    
    event.currentTarget.classList.add('active');
    event.currentTarget.querySelector('.fa-check-circle').style.color = 'var(--primary-gold)';
    
    // Show/hide card element
    const stripeCardElement = document.getElementById('stripeCardElement');
    stripeCardElement.style.display = method === 'stripe' ? 'block' : 'none';
}

// ============================================
// ADDRESS MANAGEMENT
// ============================================

async function loadSavedAddresses() {
    try {
        const userId = getUserId();
        
        if (!firebaseDB) return;
        
        // Try to load from Firebase
        const doc = await firebaseDB.collection('userAddresses').doc(userId).get();
        
        if (doc.exists) {
            userAddress = doc.data();
            displaySavedAddress(userAddress);
        }
        
    } catch (error) {
        console.error('Error loading saved addresses:', error);
    }
}

function displaySavedAddress(address) {
    const savedAddressesDiv = document.getElementById('savedAddresses');
    
    const addressHTML = `
        <div class="saved-address active" onclick="useSavedAddress()">
            <div class="address-type">Saved Address</div>
            <div class="address-details">
                <div class="name">${address.fullName || ''}</div>
                <div>${address.address1 || ''} ${address.address2 || ''}</div>
                <div>${address.city || ''}, ${address.state || ''} ${address.postalCode || ''}</div>
                <div>${getCountryName(address.country)}</div>
                <div>Phone: ${address.phone || ''}</div>
            </div>
        </div>
    `;
    
    savedAddressesDiv.innerHTML = addressHTML;
    
    // Fill form with saved address
    if (address) {
        document.getElementById('fullName').value = address.fullName || '';
        document.getElementById('email').value = address.email || '';
        document.getElementById('phone').value = address.phone || '';
        document.getElementById('country').value = address.country || '';
        document.getElementById('address1').value = address.address1 || '';
        document.getElementById('address2').value = address.address2 || '';
        document.getElementById('city').value = address.city || '';
        document.getElementById('state').value = address.state || '';
        document.getElementById('postalCode').value = address.postalCode || '';
    }
}

function useSavedAddress() {
    if (userAddress) {
        document.getElementById('fullName').value = userAddress.fullName || '';
        document.getElementById('email').value = userAddress.email || '';
        document.getElementById('phone').value = userAddress.phone || '';
        document.getElementById('country').value = userAddress.country || '';
        document.getElementById('address1').value = userAddress.address1 || '';
        document.getElementById('address2').value = userAddress.address2 || '';
        document.getElementById('city').value = userAddress.city || '';
        document.getElementById('state').value = userAddress.state || '';
        document.getElementById('postalCode').value = userAddress.postalCode || '';
    }
}

function getCountryName(countryCode) {
    const countries = {
        'GB': 'United Kingdom',
        'US': 'United States',
        'CA': 'Canada',
        'AU': 'Australia',
        'IN': 'India',
        'DE': 'Germany',
        'FR': 'France',
        'IT': 'Italy',
        'ES': 'Spain',
        'AE': 'United Arab Emirates'
    };
    
    return countries[countryCode] || countryCode;
}

// ============================================
// PLACE ORDER
// ============================================

async function placeOrder() {
    try {
        // Validate form
        if (!validateForm()) return;
        
        // Check terms agreement
        if (!document.getElementById('agreeTerms').checked) {
            showError('Please agree to the terms and conditions');
            return;
        }
        
        showLoading(true);
        
        // Get address data
        const addressData = {
            fullName: document.getElementById('fullName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            country: document.getElementById('country').value,
            address1: document.getElementById('address1').value.trim(),
            address2: document.getElementById('address2').value.trim(),
            city: document.getElementById('city').value.trim(),
            state: document.getElementById('state').value.trim(),
            postalCode: document.getElementById('postalCode').value.trim(),
            instructions: document.getElementById('instructions').value.trim(),
            saveAddress: document.getElementById('saveAddress').checked
        };
        
        // Save address if requested
        if (addressData.saveAddress) {
            await saveUserAddress(addressData);
        }
        
        // Calculate totals
        const totals = calculateTotals();
        const paymentType = currentPaymentType;
        const paymentAmount = paymentType === 'advance' ? totals.advanceTotal : totals.total * 0.95;
        
        // Create order object
        const order = {
            userId: getUserId(),
            items: cartItems.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                calculatedPrice: item.calculatedPrice,
                calculationData: item.calculationData,
                customRequirements: item.customRequirements,
                advancePayment: item.advancePayment,
                remainingPayment: item.remainingPayment,
                totalPrice: item.totalPrice
            })),
            shippingAddress: addressData,
            billingAddress: addressData,
            paymentMethod: selectedPaymentMethod,
            paymentType: paymentType,
            subtotal: totals.subtotal,
            tax: totals.tax,
            shipping: totals.shipping,
            total: totals.total,
            advancePayment: paymentType === 'advance' ? paymentAmount : 0,
            remainingPayment: paymentType === 'advance' ? totals.remainingTotal : 0,
            amountPaid: paymentAmount,
            status: 'pending',
            createdAt: new Date().toISOString(),
            orderNumber: generateOrderNumber(),
            paymentStatus: 'pending',
            customRequirements: cartItems
                .map(item => item.customRequirements)
                .filter(req => req && req.trim() !== '')
        };
        
        // Process payment
        let paymentResult;
        
        switch(selectedPaymentMethod) {
            case 'stripe':
                paymentResult = await processStripePayment(order, paymentAmount);
                break;
            case 'paypal':
                paymentResult = await processPayPalPayment(order, paymentAmount);
                break;
            case 'bank':
                paymentResult = { success: true, method: 'bank_transfer' };
                break;
            default:
                throw new Error('Invalid payment method');
        }
        
        if (paymentResult.success) {
            // Update order with payment info
            order.paymentStatus = paymentType === 'full' ? 'paid' : 'advance_paid';
            order.paymentId = paymentResult.paymentId;
            order.paymentMethod = paymentResult.method;
            order.transactionDetails = paymentResult.transactionDetails;
            
            // Save order to Firebase
            const orderId = await saveOrderToFirebase(order);
            
            // Save custom requirements if any
            if (order.customRequirements && order.customRequirements.length > 0) {
                await saveCustomRequirements(orderId, order.customRequirements);
            }
            
            // Clear cart
            await clearCart();
            
            // Redirect to order confirmation
            window.location.href = `order-confirmation.html?order=${order.orderNumber}`;
            
        } else {
            throw new Error(paymentResult.error || 'Payment failed');
        }
        
    } catch (error) {
        console.error('Error placing order:', error);
        showError('Failed to place order: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// PAYMENT PROCESSING
// ============================================

async function processStripePayment(order, amount) {
    try {
        // For demo purposes, simulate successful payment
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        const paymentId = 'pi_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        return {
            success: true,
            paymentId: paymentId,
            method: 'stripe',
            transactionDetails: {
                amount: amount,
                currency: 'gbp',
                paymentType: order.paymentType,
                timestamp: new Date().toISOString()
            }
        };
        
    } catch (error) {
        console.error('Payment processing error:', error);
        return { success: false, error: 'Payment processing failed' };
    }
}

async function processPayPalPayment(order, amount) {
    // Mock PayPal payment
    return {
        success: true,
        paymentId: 'PAYPAL_' + Date.now(),
        method: 'paypal',
        transactionDetails: {
            amount: amount,
            currency: 'gbp',
            paymentType: order.paymentType,
            timestamp: new Date().toISOString()
        }
    };
}

// ============================================
// FIREBASE ORDER MANAGEMENT
// ============================================

async function saveOrderToFirebase(order) {
    try {
        if (!firebaseDB) {
            throw new Error('Firebase not initialized');
        }
        
        // Generate document ID
        const orderId = firebaseDB.collection('orders').doc().id;
        
        // Save to main orders collection
        await firebaseDB.collection('orders').doc(orderId).set({
            ...order,
            id: orderId,
            updatedAt: new Date().toISOString()
        });
        
        return orderId;
    } catch (error) {
        console.error('Error saving order to Firebase:', error);
        throw error;
    }
}

async function saveCustomRequirements(orderId, requirements) {
    try {
        if (!firebaseDB || !requirements || requirements.length === 0) return;
        
        await firebaseDB.collection('orderCustomRequirements').doc(orderId).set({
            orderId: orderId,
            requirements: requirements,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('Error saving custom requirements:', error);
    }
}

async function saveUserAddress(addressData) {
    try {
        if (!firebaseDB) return false;
        
        const userId = getUserId();
        await firebaseDB.collection('userAddresses').doc(userId).set({
            ...addressData,
            userId: userId,
            updatedAt: new Date().toISOString()
        }, { merge: true });
        
        return true;
    } catch (error) {
        console.error('Error saving address:', error);
        return false;
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function getUserId() {
    let userId = localStorage.getItem('irya_guest_id');
    if (!userId) {
        userId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('irya_guest_id', userId);
    }
    return userId;
}

function saveCartItems() {
    const userId = getUserId();
    const cartKey = 'irya_local_cart_' + userId;
    localStorage.setItem(cartKey, JSON.stringify(cartItems));
}

async function clearCart() {
    try {
        const userId = getUserId();
        const cartKey = 'irya_local_cart_' + userId;
        
        // Clear local storage
        localStorage.removeItem(cartKey);
        
        // Update cart badge
        updateCartBadge();
        
        return true;
    } catch (error) {
        console.error('Error clearing cart:', error);
        return false;
    }
}

function updateCartBadge() {
    const userId = getUserId();
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + item.quantity, 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        cartBadge.textContent = count;
        cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
}

function generateOrderNumber() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000);
    return `IRYA-${timestamp}-${random}`;
}

function validateForm() {
    const requiredFields = ['fullName', 'email', 'phone', 'country', 'address1', 'city', 'state', 'postalCode'];
    
    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            showError(`Please fill in ${field.placeholder || fieldId}`);
            field.focus();
            return false;
        }
    }
    
    // Validate email
    const email = document.getElementById('email').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showError('Please enter a valid email address');
        return false;
    }
    
    // Validate phone
    const phone = document.getElementById('phone').value;
    const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
    if (!phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''))) {
        showError('Please enter a valid phone number');
        return false;
    }
    
    return true;
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function showError(message) {
    alert(message);
}

// Make functions available globally
window.selectPaymentOption = selectPaymentOption;
window.selectPaymentMethod = selectPaymentMethod;
window.placeOrder = placeOrder;
window.useSavedAddress = useSavedAddress;
</script>
</body>
</html>
