<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Checkout | IRYA STONE - Complete Payment System</title> 
     
    <!-- Font Awesome --> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
     
    <!-- Google Fonts --> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet"> 
     
    <style> 
        :root { 
            --primary-gold: #c9a227; 
            --gold-light: #f0d77c; 
            --gold-dark: #9c7c1f; 
            --stone-dark: #1a1a1a; 
            --stone-light: #f4f6f4; 
            --bg-light: #f7f9fc; 
            --text-dark: #222222; 
            --text-light: #666666; 
            --white: #ffffff; 
            --success-green: #10b981; 
            --warning-orange: #f59e0b; 
            --error-red: #ef4444; 
            --info-blue: #3b82f6; 
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.1); 
            --shadow-md: 0 4px 15px rgba(0,0,0,0.1); 
            --shadow-lg: 0 8px 25px rgba(0,0,0,0.15); 
            --transition: all 0.3s ease; 
            --border-radius: 12px; 
            --border-radius-lg: 20px; 
        } 
         
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Poppins', sans-serif; 
        } 
         
        body { 
            background: var(--bg-light); 
            color: var(--text-dark); 
            padding-bottom: 80px; 
            font-size: 14px; 
        } 
         
        .header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: var(--white); 
            padding: 12px 16px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: var(--shadow-sm); 
            z-index: 1000; 
        } 
         
        .logo { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        } 
         
        .logo i { 
            color: var(--primary-gold); 
            font-size: 24px; 
        } 
         
        .logo span { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--stone-dark); 
            font-family: 'Roboto Slab', serif; 
        } 
         
        .container { 
            max-width: 1200px; 
            margin: 80px auto 30px; 
            padding: 0 16px; 
        } 
         
        .page-header { 
            text-align: center; 
            margin-bottom: 30px; 
            padding: 20px; 
            background: var(--white); 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-sm); 
        } 
         
        .page-header h1 { 
            font-size: 28px; 
            color: var(--stone-dark); 
            margin-bottom: 10px; 
        } 
         
        .page-header p { 
            color: var(--text-light); 
        } 
         
        .checkout-flow { 
            display: flex; 
            gap: 30px; 
            margin-bottom: 30px; 
        } 
         
        .checkout-steps { 
            flex: 1; 
        } 
         
        .checkout-summary { 
            width: 350px; 
            position: sticky; 
            top: 100px; 
            align-self: flex-start; 
        } 
         
        .step { 
            background: var(--white); 
            border-radius: var(--border-radius); 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow-sm); 
        } 
         
        .step-header { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 20px; 
        } 
         
        .step-number { 
            width: 36px; 
            height: 36px; 
            background: var(--primary-gold); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600; 
        } 
         
        .step-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--stone-dark); 
        } 
         
        .form-group { 
            margin-bottom: 20px; 
        } 
         
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: var(--stone-dark); 
        } 
         
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px; 
            transition: var(--transition); 
        } 
         
        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus { 
            outline: none; 
            border-color: var(--primary-gold); 
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1); 
        } 
         
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        } 
         
        .order-summary-box { 
            background: var(--white); 
            border-radius: var(--border-radius); 
            padding: 25px; 
            box-shadow: var(--shadow-md); 
            margin-bottom: 20px; 
        } 
         
        .order-items { 
            max-height: 300px; 
            overflow-y: auto; 
            margin-bottom: 20px; 
        } 
         
        .order-item { 
            display: flex; 
            gap: 15px; 
            padding: 15px 0; 
            border-bottom: 1px solid #eee; 
        } 
         
        .item-image { 
            width: 80px; 
            height: 80px; 
            border-radius: 8px; 
            overflow: hidden; 
            flex-shrink: 0; 
        } 
         
        .item-image img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        } 
         
        .item-details { 
            flex: 1; 
        } 
         
        .item-name { 
            font-weight: 600; 
            margin-bottom: 5px; 
        } 
         
        .item-price { 
            color: var(--primary-gold); 
            font-weight: 600; 
        } 
         
        .summary-total { 
            border-top: 2px solid #eee; 
            padding-top: 20px; 
            margin-top: 20px; 
        } 
         
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
        } 
         
        .final-total { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--stone-dark); 
        } 
         
        .payment-method { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: var(--transition); 
            background: white; 
            position: relative; 
        } 
         
        .payment-method:hover { 
            border-color: var(--gold-light); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-sm); 
        } 
         
        .payment-method.selected { 
            border-color: var(--primary-gold); 
            background: rgba(201, 162, 39, 0.05); 
            box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1); 
        } 
         
        .method-icon { 
            width: 50px; 
            height: 50px; 
            background: var(--bg-light); 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            color: var(--primary-gold); 
            flex-shrink: 0; 
        } 
         
        .method-info h4 { 
            margin-bottom: 5px; 
            color: var(--stone-dark); 
        } 
         
        .method-info p { 
            font-size: 12px; 
            color: var(--text-light); 
            margin-bottom: 4px; 
        } 
         
        .method-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 10px; 
            font-weight: 600; 
            margin-right: 5px; 
            margin-top: 2px; 
        } 
         
        .method-badge.fast { background: var(--success-green); color: white; } 
        .method-badge.instant { background: var(--info-blue); color: white; } 
        .method-badge.delayed { background: var(--warning-orange); color: white; } 
         
        .btn { 
            padding: 15px 30px; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            font-size: 16px; 
            cursor: pointer; 
            transition: var(--transition); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        } 
         
        .btn-primary { 
            background: var(--primary-gold); 
            color: white; 
            width: 100%; 
        } 
         
        .btn-primary:hover { 
            background: var(--gold-dark); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
        } 
         
        .btn-secondary { 
            background: var(--white); 
            color: var(--text-dark); 
            border: 1px solid #ddd; 
        } 
         
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none !important; 
        } 
         
        .loading { 
            text-align: center; 
            padding: 40px; 
        } 
         
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary-gold); 
            border-radius: 50%; 
            margin: 0 auto 20px; 
            animation: spin 1s linear infinite; 
        } 
         
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        } 
         
        .error-box { 
            background: #fff5f5; 
            border: 1px solid #ffcccc; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px; 
            text-align: center; 
        } 
         
        .success-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 10000; 
            padding: 20px; 
        } 
         
        .success-content { 
            background: white; 
            border-radius: var(--border-radius-lg); 
            padding: 40px; 
            text-align: center; 
            max-width: 500px; 
            width: 100%; 
        } 
         
        .success-icon { 
            width: 80px; 
            height: 80px; 
            background: #51cf66; 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 40px; 
            margin: 0 auto 20px; 
        } 
         
        @media (max-width: 992px) { 
            .checkout-flow { flex-direction: column; } 
            .checkout-summary { width: 100%; position: static; } 
        } 
         
        @media (max-width: 768px) { 
            .form-row { grid-template-columns: 1fr; } 
            .container { margin: 70px auto 20px; } 
        } 
         
        .bank-details-box { 
            background: #f8f9ff; 
            padding: 20px; 
            border-radius: 8px; 
            border-left: 4px solid var(--info-blue); 
            margin-top: 15px; 
        } 
         
        .debug-info { 
            background: #f0f8ff; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: monospace; 
            font-size: 12px; 
            margin-top: 20px; 
            border-left: 4px solid var(--primary-gold); 
        } 
    </style> 
</head> 
<body> 
 
<header class="header"> 
    <div class="logo"> 
        <i class="fas fa-gem"></i> 
        <span>IRYA STONE</span> 
    </div> 
    <div style="display: flex; gap: 10px;"> 
        <a href="cart.html" class="btn-secondary" style="padding: 8px 15px; text-decoration: none;"> 
            <i class="fas fa-shopping-cart"></i> Cart 
        </a> 
    </div> 
</header> 
 
<main class="container"> 
    <div class="page-header"> 
        <h1 id="pageTitle">Complete Your Order</h1> 
        <p id="pageSubtitle">Secure checkout for your stone products</p> 
    </div> 
     
    <div class="loading" id="loadingState"> 
        <div class="spinner"></div> 
        <p>Loading your order details...</p> 
    </div> 
     
    <div class="error-box" id="errorState" style="display: none;"> 
        <i class="fas fa-exclamation-triangle"></i> 
        <h3 id="errorTitle">Error Loading Order</h3> 
        <p id="errorMessage">Failed to load order details. Please try again.</p> 
        <button class="btn-primary" onclick="retryLoad()" style="margin-top: 15px;"> 
            <i class="fas fa-redo"></i> Retry 
        </button> 
    </div> 
     
    <div id="checkoutContent" style="display: none;"> 
        <div class="checkout-flow"> 
            <div class="checkout-steps"> 
                <div class="step" id="orderTypeStep"> 
                    <div class="step-header"> 
                        <div class="step-number">1</div> 
                        <h3 class="step-title">Order Type</h3> 
                    </div> 
                    <div id="orderTypeContent"></div> 
                    <div class="form-group" style="margin-top: 20px;"> 
                        <label>Special Requirements?</label> 
                        <textarea id="orderNotes" rows="3" placeholder="Add special instructions..."></textarea> 
                    </div> 
                </div> 
                 
                <div class="step" id="shippingStep" style="display: none;"> 
                    <div class="step-header"> 
                        <div class="step-number">2</div> 
                        <h3 class="step-title">Shipping Details</h3> 
                    </div> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Full Name *</label> 
                            <input type="text" id="shippingName" required> 
                        </div> 
                        <div class="form-group"> 
                            <label>Email *</label> 
                            <input type="email" id="shippingEmail" required> 
                        </div> 
                    </div> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>Phone Number *</label> 
                            <input type="tel" id="shippingPhone" required> 
                        </div> 
                        <div class="form-group"> 
                            <label>Country *</label> 
                            <select id="shippingCountry" required> 
                                <option value="">Select Country</option> 
                                <option value="IN" selected>India</option> 
                                <option value="GB">United Kingdom</option> 
                                <option value="US">United States</option> 
                            </select> 
                        </div> 
                    </div> 
                    <div class="form-group"> 
                        <label>Address Line 1 *</label> 
                        <input type="text" id="shippingAddress1" required> 
                    </div> 
                    <div class="form-group"> 
                        <label>Address Line 2</label> 
                        <input type="text" id="shippingAddress2"> 
                    </div> 
                    <div class="form-row"> 
                        <div class="form-group"> 
                            <label>City *</label> 
                            <input type="text" id="shippingCity" required> 
                        </div> 
                        <div class="form-group"> 
                            <label>Postal Code *</label> 
                            <input type="text" id="shippingPostalCode" required> 
                        </div> 
                    </div> 
                    <div class="form-group"> 
                        <label>State/Province *</label> 
                        <input type="text" id="shippingState" required> 
                    </div> 
                </div> 
                 
                <div class="step" id="paymentStep" style="display: none;"> 
                    <div class="step-header"> 
                        <div class="step-number">3</div> 
                        <h3 class="step-title">Payment Method</h3> 
                    </div> 
                    <p style="margin-bottom: 20px; color: var(--text-light);">Select your preferred payment method:</p> 
                     
                    <div class="payment-method" onclick="selectPaymentMethod('test-confirm')" id="testConfirmMethod"> 
                        <div class="method-icon"> 
                            <i class="fas fa-check-circle"></i> 
                        </div> 
                        <div class="method-info"> 
                            <h4>TEST - Auto Confirm Payment ‚úÖ</h4> 
                            <p>Instant payment confirmation for testing (Firestore data creation)</p> 
                            <div> 
                                <span class="method-badge fast">INSTANT CONFIRM</span> 
                                <span class="method-badge instant">FIRESTORE UPDATE</span> 
                            </div> 
                            <small style="color: var(--success-green); display: block; margin-top: 5px;"> 
                                <i class="fas fa-bolt"></i> Creates payments, addresses, updates order automatically 
                            </small> 
                        </div> 
                    </div> 
                     
                    <div class="payment-method" onclick="selectPaymentMethod('bank')" id="bankMethod"> 
                        <div class="method-icon"> 
                            <i class="fas fa-university"></i> 
                        </div> 
                        <div class="method-info"> 
                            <h4>Bank Transfer</h4> 
                            <p>Transfer directly to our bank account</p> 
                            <div> 
                                <span class="method-badge delayed">1-3 BUSINESS DAYS</span> 
                            </div> 
                        </div> 
                    </div> 
                </div> 
                 
                <div class="step" id="reviewStep" style="display: none;"> 
                    <div class="step-header"> 
                        <div class="step-number">4</div> 
                        <h3 class="step-title">Review & Confirm</h3> 
                    </div> 
                    <div id="reviewContent"></div> 
                    <div style="margin-top: 30px;"> 
                        <button class="btn btn-primary" onclick="placeOrder()" id="placeOrderBtn"> 
                            <i class="fas fa-lock"></i> Place Order & Confirm Payment 
                        </button> 
                        <p style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--text-light);"> 
                            <i class="fas fa-shield-alt"></i> Your payment is secure and encrypted 
                        </p> 
                    </div> 
                </div> 
            </div> 
             
            <div class="checkout-summary"> 
                <div class="order-summary-box"> 
                    <h3 style="margin-bottom: 20px; color: var(--stone-dark);">Order Summary</h3> 
                    <div class="order-items" id="orderItemsSummary"> 
                        <!-- Items loaded here --> 
                    </div> 
                    <div class="summary-total"> 
                        <div class="total-row"> 
                            <span>Subtotal:</span> 
                            <span id="subtotalAmount">‚Çπ0.00</span> 
                        </div> 
                        <div class="total-row"> 
                            <span>Shipping:</span> 
                            <span id="shippingAmount">‚Çπ0.00</span> 
                        </div> 
                        <div class="total-row"> 
                            <span>Tax (18%):</span> 
                            <span id="taxAmount">‚Çπ0.00</span> 
                        </div> 
                        <div class="total-row final-total"> 
                            <span>Total:</span> 
                            <span id="totalAmount">‚Çπ0.00</span> 
                        </div> 
                        <div class="total-row" style="font-size: 14px; color: var(--success-green); font-weight: 600;"> 
                            <span>Advance Payment (30%):</span> 
                            <span id="advanceAmount">‚Çπ0.00</span> 
                        </div> 
                    </div> 
                </div> 
                 
                <div style="display: flex; gap: 10px;"> 
                    <button class="btn btn-secondary" onclick="goBack()" id="backBtn"> 
                        <i class="fas fa-arrow-left"></i> Back 
                    </button> 
                    <button class="btn btn-primary" onclick="nextStep()" id="nextBtn"> 
                        Continue <i class="fas fa-arrow-right"></i> 
                    </button> 
                </div> 
            </div> 
        </div> 
    </div> 
</main> 
 
<!-- Success Modal --> 
<div class="success-modal" id="successModal"> 
    <div class="success-content"> 
        <div class="success-icon"> 
            <i class="fas fa-check"></i> 
        </div> 
        <h2 id="successTitle">Order Successful!</h2> 
        <p id="successMessage">Your order has been placed successfully.</p> 
        <div id="successDetails"></div> 
        <div id="debugInfo" class="debug-info" style="display: none;"></div> 
        <div style="display: flex; gap: 10px; margin-top: 25px;"> 
            <button class="btn btn-primary" onclick="viewOrder()"> 
                <i class="fas fa-box"></i> View Order 
            </button> 
            <button class="btn btn-secondary" onclick="goToOrders()"> 
                <i class="fas fa-list"></i> My Orders 
            </button> 
        </div> 
    </div> 
</div> 
 
<script type="module"> 
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"; 
import {  
    getFirestore,  
    collection,  
    doc,  
    getDoc, setDoc, updateDoc, addDoc, 
    arrayUnion, serverTimestamp,  
    query, where, getDocs 
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"; 
 
const firebaseConfig = { 
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk", 
    authDomain: "iryastone-uk.firebaseapp.com", 
    projectId: "iryastone-uk", 
    storageBucket: "iryastone-uk.firebasestorage.app", 
    messagingSenderId: "110940910896", 
    appId: "1:110940910896:web:b25e92127118665e5c84f5" 
}; 
 
const app = initializeApp(firebaseConfig); 
const db = getFirestore(app); 
 
let currentUserId = null; 
let currentOrder = null; 
let orderType = 'cart'; 
let currentStep = 1; 
let selectedPaymentMethod = 'test-confirm'; 
let orderData = { 
    items: [], 
    subtotal: 0, 
    shipping: 0, 
    tax: 0, 
    total: 0, 
    advancePayment: 0, 
    remainingPayment: 0 
}; 
 
// SAMPLE DATA FOR TESTING - REMOVE IN PRODUCTION 
const sampleItems = [ 
    { 
        id: "test-stone-1", 
        stoneName: "Premium Sandstone", 
        price: 5000, 
        quantity: 2, 
        calculatedPrice: 10000, 
        image: "https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800" 
    }, 
    { 
        id: "test-stone-2",  
        stoneName: "Kota Stone Slab", 
        price: 3500, 
        quantity: 1, 
        calculatedPrice: 3500, 
        image: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800" 
    } 
]; 
 
document.addEventListener('DOMContentLoaded', async function() { 
    await getUserId(); 
    await loadTestOrderData(); 
    setupEventListeners(); 
    updateOrderTypeUI(); 
    updateOrderSummary(); 
    document.getElementById('checkoutContent').style.display = 'block'; 
    updateStepDisplay(); 
}); 
 
async function getUserId() { 
    let guestId = localStorage.getItem('irya_guest_id'); 
    if (!guestId) { 
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); 
        localStorage.setItem('irya_guest_id', guestId); 
    } 
    currentUserId = guestId; 
} 
 
async function loadTestOrderData() { 
    orderData.items = sampleItems; 
    calculateOrderTotals(); 
} 
 
function calculateOrderTotals() { 
    let subtotal = 0; 
    orderData.items.forEach(item => { 
        subtotal += item.calculatedPrice || (item.price * item.quantity); 
    }); 
     
    orderData.shipping = subtotal > 20000 ? 0 : 500; 
    orderData.tax = subtotal * 0.18; 
    orderData.total = subtotal + orderData.shipping + orderData.tax; 
    orderData.advancePayment = orderData.total * 0.3; 
    orderData.remainingPayment = orderData.total * 0.7; 
     
    orderData.subtotal = subtotal; 
} 
 
function updateOrderSummary() { 
    const orderItemsSummary = document.getElementById('orderItemsSummary'); 
    let itemsHTML = ''; 
     
    orderData.items.forEach(item => { 
        itemsHTML += ` 
            <div class="order-item"> 
                <div class="item-image"> 
                    <img src="${item.image}" alt="${item.stoneName}" onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=800'"> 
                </div> 
                <div class="item-details"> 
                    <div class="item-name">${item.stoneName}</div> 
                    <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;"> 
                        Quantity: ${item.quantity} ‚Ä¢ ‚Çπ${item.price}/unit 
                    </div> 
                    <div class="item-price">‚Çπ${item.calculatedPrice?.toLocaleString()}</div> 
                </div> 
            </div> 
        `; 
    }); 
     
    orderItemsSummary.innerHTML = itemsHTML; 
     
    document.getElementById('subtotalAmount').textContent = `‚Çπ${orderData.subtotal.toLocaleString()}`; 
    document.getElementById('shippingAmount').textContent = `‚Çπ${orderData.shipping.toLocaleString()}`; 
    document.getElementById('taxAmount').textContent = `‚Çπ${orderData.tax.toLocaleString('en-IN', {maximumFractionDigits: 0})}`; 
    document.getElementById('totalAmount').textContent = `‚Çπ${orderData.total.toLocaleString('en-IN', {maximumFractionDigits: 0})}`; 
    document.getElementById('advanceAmount').textContent = `‚Çπ${orderData.advancePayment.toLocaleString('en-IN', {maximumFractionDigits: 0})}`; 
} 
 
function updateOrderTypeUI() { 
    document.getElementById('orderTypeContent').innerHTML = ` 
        <div style="background: var(--bg-light); padding: 20px; border-radius: 8px;"> 
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;"> 
                <i class="fas fa-shopping-cart" style="color: var(--primary-gold); font-size: 24px;"></i> 
                <div> 
                    <h4 style="margin: 0; color: var(--stone-dark);">Test Order - ${orderData.items.length} items</h4> 
                    <p style="margin: 5px 0 0 0; color: var(--text-light);"> 
                        Total: ‚Çπ${orderData.total.toLocaleString()} | Advance: ‚Çπ${orderData.advancePayment.toLocaleString()} 
                    </p> 
                </div> 
            </div> 
            <p><strong>TEST MODE:</strong> All payments auto-confirmed. Creates: orders, payments, addresses in Firestore.</p> 
        </div> 
    `; 
} 
 
function nextStep() { 
    if (currentStep === 4) return; 
    if (!validateStep(currentStep)) return; 
     
    currentStep++; 
    updateStepDisplay(); 
} 
 
function goBack() { 
    if (currentStep === 1) { 
        window.history.back(); 
        return; 
    } 
    currentStep--; 
    updateStepDisplay(); 
} 
 
function updateStepDisplay() { 
    document.querySelectorAll('.step').forEach(step => { 
        step.style.display = 'none'; 
    }); 
     
    const stepElements = ['orderTypeStep', 'shippingStep', 'paymentStep', 'reviewStep']; 
    if (stepElements[currentStep - 1]) { 
        document.getElementById(stepElements[currentStep - 1]).style.display = 'block'; 
    } 
     
    const backBtn = document.getElementById('backBtn'); 
    const nextBtn = document.getElementById('nextBtn'); 
     
    if (currentStep === 1) { 
        backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back to Store'; 
    } else { 
        backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back'; 
    } 
     
    if (currentStep === 4) { 
        nextBtn.style.display = 'none'; 
        document.getElementById('placeOrderBtn').style.display = 'block'; 
        updateReviewContent(); 
    } else { 
        nextBtn.style.display = 'block'; 
        document.getElementById('placeOrderBtn').style.display = 'none'; 
    } 
} 
 
function validateStep(step) { 
    if (step === 2) { 
        const requiredFields = ['shippingName', 'shippingEmail', 'shippingPhone', 'shippingAddress1', 'shippingCity', 'shippingPostalCode', 'shippingState']; 
        for (const fieldId of requiredFields) { 
            const field = document.getElementById(fieldId); 
            if (!field.value.trim()) { 
                alert(`Please fill in ${field.previousElementSibling.textContent}`); 
                field.focus(); 
                return false; 
            } 
        } 
        return isValidEmail(document.getElementById('shippingEmail').value); 
    } 
    return true; 
} 
 
function isValidEmail(email) { 
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); 
} 
 
function selectPaymentMethod(method) { 
    selectedPaymentMethod = method; 
    document.querySelectorAll('.payment-method').forEach(el => { 
        el.classList.remove('selected'); 
        el.querySelector('.fa-check-circle').style.display = 'none'; 
    }); 
     
    const selectedMethod = document.getElementById(method + 'Method'); 
    selectedMethod.classList.add('selected'); 
    selectedMethod.querySelector('.fa-check-circle') ?  
        selectedMethod.querySelector('.fa-check-circle').style.display = 'block' :  
        selectedMethod.querySelector('i').style.display = 'block'; 
} 
 
function updateReviewContent() { 
    const reviewContent = document.getElementById('reviewContent'); 
    const shippingName = document.getElementById('shippingName').value; 
    const shippingEmail = document.getElementById('shippingEmail').value; 
    const shippingPhone = document.getElementById('shippingPhone').value; 
    const shippingAddress = [ 
        document.getElementById('shippingAddress1').value, 
        document.getElementById('shippingAddress2').value, 
        document.getElementById('shippingCity').value + ', ' + document.getElementById('shippingState').value, 
        document.getElementById('shippingPostalCode').value 
    ].filter(Boolean).join(', '); 
     
    const paymentMethodNames = { 
        'test-confirm': 'TEST - Auto Confirm Payment ‚úÖ', 
        'bank': 'Bank Transfer' 
    }; 
     
    reviewContent.innerHTML = ` 
        <div style="display: grid; gap: 20px;"> 
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;"> 
                <h4 style="margin-bottom: 10px; color: var(--stone-dark);">Order Summary</h4> 
                <div style="font-size: 14px;"> 
                    <div><strong>Items:</strong> ${orderData.items.length} products</div> 
                    <div><strong>Total Amount:</strong> ‚Çπ${orderData.total.toLocaleString()}</div> 
                    <div><strong>Advance Payment (30%):</strong> ‚Çπ${orderData.advancePayment.toLocaleString()}</div> 
                    <div><strong>Remaining (70%):</strong> ‚Çπ${orderData.remainingPayment.toLocaleString()}</div> 
                </div> 
            </div> 
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;"> 
                <h4 style="margin-bottom: 10px; color: var(--stone-dark);">Shipping Address</h4> 
                <div style="font-size: 14px;"> 
                    <div><strong>${shippingName}</strong></div> 
                    <div>${shippingEmail} | ${shippingPhone}</div> 
                    <div>${shippingAddress}</div> 
                </div> 
            </div> 
            <div style="background: var(--bg-light); padding: 15px; border-radius: 8px;"> 
                <h4 style="margin-bottom: 10px; color: var(--stone-dark);">Payment</h4> 
                <div style="font-size: 14px;"> 
                    <div><strong>Method:</strong> ${paymentMethodNames[selectedPaymentMethod]}</div> 
                    ${selectedPaymentMethod === 'test-confirm' ?  
                        '<div style="color: var(--success-green);"><i class="fas fa-check-circle"></i> INSTANT CONFIRMATION - Firestore Updated</div>' : 
                        '<div style="color: var(--warning-orange);"><i class="fas fa-clock"></i> 1-3 Business Days</div>' 
                    } 
                    <div><strong>Amount Due Now:</strong> ‚Çπ${orderData.advancePayment.toLocaleString()}</div> 
                </div> 
            </div> 
        </div> 
    `; 
} 
 
async function placeOrder() { 
    const placeOrderBtn = document.getElementById('placeOrderBtn'); 
    placeOrderBtn.disabled = true; 
    placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...'; 
     
    try { 
        const orderDataToSave = await prepareOrderData(); 
         
        // 1. SAVE ADDRESS to users/{userId}/addresses 
        await saveAddress(orderDataToSave.shippingAddress, 'shipping'); 
         
        // 2. SAVE PAYMENT to users/{userId}/payments   
        const paymentId = await savePayment(orderDataToSave); 
         
        // 3. SAVE/UPDATE ORDER with paymentHistory, status updates 
        const orderId = await saveOrderToFirebase(orderDataToSave, paymentId); 
         
        // 4. Show success with debug info 
        showSuccess(orderId, orderDataToSave, paymentId); 
         
        console.log('‚úÖ COMPLETE ORDER PROCESSING SUCCESSFUL'); 
        console.log('üìÅ Firestore Data Created:'); 
        console.log('   ‚Üí users/' + currentUserId + '/addresses/*'); 
        console.log('   ‚Üí users/' + currentUserId + '/payments/' + paymentId); 
        console.log('   ‚Üí users/' + currentUserId + '/orders/' + orderId); 
        console.log('   ‚Üí orders/' + orderId); 
         
    } catch (error) { 
        console.error('‚ùå Order Error:', error); 
        alert('Order failed: ' + error.message); 
        placeOrderBtn.disabled = false; 
        placeOrderBtn.innerHTML = '<i class="fas fa-lock"></i> Place Order & Confirm Payment'; 
    } 
} 
 
async function prepareOrderData() { 
    const timestamp = Date.now(); 
    const orderNumber = `IRYA-${timestamp}-${Math.floor(Math.random() * 1000)}`; 
     
    const shippingData = { 
        fullName: document.getElementById('shippingName').value, 
        email: document.getElementById('shippingEmail').value, 
        phone: document.getElementById('shippingPhone').value, 
        address1: document.getElementById('shippingAddress1').value, 
        address2: document.getElementById('shippingAddress2').value || '', 
        city: document.getElementById('shippingCity').value, 
        state: document.getElementById('shippingState').value, 
        postalCode: document.getElementById('shippingPostalCode').value, 
        country: document.getElementById('shippingCountry').value, 
        saveAddress: true 
    }; 
     
    return { 
        orderNumber, 
        userId: currentUserId, 
        userEmail: shippingData.email, 
        userName: shippingData.fullName, 
        items: [...orderData.items], 
        subtotal: orderData.subtotal, 
        shipping: orderData.shipping, 
        tax: orderData.tax, 
        total: orderData.total, 
        advancePayment: orderData.advancePayment, 
        remainingPayment: orderData.remainingPayment, 
        paymentDueNow: orderData.advancePayment, 
        shippingAddress: shippingData, 
        paymentMethod: selectedPaymentMethod, 
        paymentStatus: selectedPaymentMethod === 'test-confirm' ? 'completed' : 'pending', 
        status: selectedPaymentMethod === 'test-confirm' ? 'confirmed' : 'payment_pending', 
        notes: document.getElementById('orderNotes').value || '', 
        source: 'test-checkout', 
        createdAt: serverTimestamp(), 
        updatedAt: serverTimestamp(), 
        paymentHistory: [], 
        paymentSubmittedAt: serverTimestamp() 
    }; 
} 
 
async function saveAddress(addressData, type) { 
    const addressesRef = collection(db, "users", currentUserId, "addresses"); 
    const addressDoc = await addDoc(addressesRef, { 
        ...addressData, 
        type, 
        createdAt: serverTimestamp(), 
        updatedAt: serverTimestamp() 
    }); 
    console.log('‚úÖ Address saved:', addressDoc.id); 
    return addressDoc.id; 
} 
 
async function savePayment(orderData) { 
    const paymentsRef = collection(db, "users", currentUserId, "payments"); 
    const paymentDoc = await addDoc(paymentsRef, { 
        paymentId: 'payment_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9), 
        orderNumber: orderData.orderNumber, 
        orderId: null, // Will be updated after order creation 
        amount: orderData.paymentDueNow, 
        currency: 'INR', 
        method: orderData.paymentMethod, 
        status: orderData.paymentStatus, 
        reference: orderData.orderNumber + '-PAY', 
        paymentType: 'advance', 
        createdAt: serverTimestamp(), 
        updatedAt: serverTimestamp() 
    }); 
    console.log('‚úÖ Payment saved:', paymentDoc.id); 
    return paymentDoc.id; 
} 
 
async function saveOrderToFirebase(orderData, paymentId) { 
    const orderId = 'order_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); 
     
    // Add payment to history 
    const paymentEntry = { 
        amount: orderData.paymentDueNow, 
        date: serverTimestamp(), 
        paymentMethod: orderData.paymentMethod, 
        paymentType: 'advance', 
        reference: orderData.orderNumber + '-ADV', 
        status: orderData.paymentStatus, 
        paymentId: paymentId, 
        updatedBy: 'system' 
    }; 
     
    const finalOrderData = { 
        ...orderData, 
        id: orderId, 
        paymentHistory: [paymentEntry], 
        bankTransferDetails: selectedPaymentMethod === 'bank' ? { 
            accountName: "IRYA STONE LTD", 
            accountNumber: "12345678", 
            sortCode: "40-04-15", 
            iban: "GB29NWBK60161331926819", 
            swift: "NWBKGB2L", 
            reference: orderData.orderNumber, 
            amount: orderData.paymentDueNow, 
            currency: "INR" 
        } : null 
    }; 
     
    // Save to user orders 
    const userOrderRef = doc(db, "users", currentUserId, "orders", orderId); 
    await setDoc(userOrderRef, finalOrderData); 
     
    // Save to main orders   
    const mainOrderRef = doc(db, "orders", orderId); 
    await setDoc(mainOrderRef, finalOrderData); 
     
    // Update payment with orderId 
    const paymentRef = doc(db, "users", currentUserId, "payments", paymentId); 
    await updateDoc(paymentRef, { orderId }); 
     
    console.log('‚úÖ Order saved:', orderId); 
    return orderId; 
} 
 
function showSuccess(orderId, orderData, paymentId) { 
    document.getElementById('successTitle').textContent = 'Order Confirmed! ‚úÖ'; 
    document.getElementById('successMessage').textContent =  
        `Order #${orderData.orderNumber} created successfully. Advance payment confirmed!`; 
     
    document.getElementById('successDetails').innerHTML = ` 
        <div style="background: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;"> 
            <div style="font-size: 14px;"> 
                <div><strong>Order ID:</strong> ${orderId}</div> 
                <div><strong>Order Number:</strong> ${orderData.orderNumber}</div> 
                <div><strong>Total Amount:</strong> ‚Çπ${orderData.total.toLocaleString()}</div> 
                <div><strong>Advance Paid:</strong> <span style="color: var(--success-green);">‚Çπ${orderData.advancePayment.toLocaleString()}</span></div> 
                <div><strong>Remaining:</strong> ‚Çπ${orderData.remainingPayment.toLocaleString()}</div> 
                <div><strong>Payment Method:</strong> ${orderData.paymentMethod}</div> 
                <div><strong>Status:</strong> <span style="color: var(--success-green); font-weight: 600;">${orderData.status}</span></div> 
            </div> 
        </div> 
    `; 
     
    // Debug info 
    document.getElementById('debugInfo').innerHTML = ` 
        <strong>üî• FIRESTORE DATA CREATED:</strong><br> 
        üìÅ <strong>users/${currentUserId}/</strong><br> 
        &nbsp;&nbsp;‚Üí addresses/* (Shipping address saved)<br> 
        &nbsp;&nbsp;‚Üí payments/${paymentId} (Payment record)<br> 
        &nbsp;&nbsp;‚Üí orders/${orderId} (Order with paymentHistory)<br> 
        üìÅ <strong>orders/${orderId}</strong> (Main order copy)<br><br> 
        <strong>üìä ORDER FIELDS UPDATED:</strong><br> 
        ‚úÖ paymentStatus: ${orderData.paymentStatus}<br> 
        ‚úÖ status: ${orderData.status}<br> 
        ‚úÖ advancePayment: ‚Çπ${orderData.advancePayment.toLocaleString()}<br> 
        ‚úÖ remainingPayment: ‚Çπ${orderData.remainingPayment.toLocaleString()}<br> 
        ‚úÖ paymentHistory: [${paymentId}]<br> 
        ‚úÖ paymentSubmittedAt: NOW 
    `; 
    document.getElementById('debugInfo').style.display = 'block'; 
     
    document.getElementById('successModal').style.display = 'flex'; 
} 
 
function viewOrder() { 
    alert('Check Firestore Console:\nusers/' + currentUserId + '/orders/' +  
          'order_* & orders/order_*'); 
} 
 
function goToOrders() { 
    window.location.href = 'orders.html'; 
} 
 
function setupEventListeners() { 
    // Set default values 
    document.getElementById('shippingName').value = 'Ravi Jain'; 
    document.getElementById('shippingEmail').value = 'ravijain236129@gmail.com'; 
    document.getElementById('shippingPhone').value = '+917737740207'; 
    document.getElementById('shippingAddress1').value = 'Mayur Kirana Store, Tejaji Choke'; 
    document.getElementById('shippingCity').value = 'Bijoliya'; 
    document.getElementById('shippingState').value = 'Rajasthan'; 
    document.getElementById('shippingPostalCode').value = '311602'; 
     
    // Auto select TEST payment 
    selectPaymentMethod('test-confirm'); 
} 
 
// Global functions 
window.nextStep = nextStep; 
window.goBack = goBack; 
window.selectPaymentMethod = selectPaymentMethod; 
window.placeOrder = placeOrder; 
window.viewOrder = viewOrder; 
window.goToOrders = goToOrders; 
</script> 
 
</body> 
</html> 
