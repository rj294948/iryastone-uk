<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment Checkout</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        /* Global/Utility Variables (For demo purposes, defined here) */
        :root {
            --primary-gold: #FFC107; /* A gold/yellow color for primary actions */
            --bg-light: #f8f9fa; /* Light background for summaries/modals */
            --text-dark: #343a40; /* Dark text */
            --text-light: #6c757d; /* Lighter text for details */
            --stone-dark: #495057;
            --border-radius: 8px;
            --transition: all 0.2s ease;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f4;
            color: var(--text-dark);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary-gold);
            margin-bottom: 30px;
        }

        /* Form & Button Base Styling (Copied from product.css context) */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row > .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--stone-dark);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-gold);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        .product-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-gold);
            color: var(--text-dark);
        }

        .btn-primary:hover {
            background-color: #e0ac00;
            color: var(--text-dark);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        /* Modal Base Styling */
        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .payment-modal.active {
            display: flex;
        }

        .payment-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 650px;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        .payment-modal.active .payment-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--stone-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--primary-gold);
        }

        /* --- Custom Payment CSS (From Section 3) --- */
        
        /* Payment Steps */
        .payment-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .payment-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step i {
            width: 32px;
            height: 32px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: var(--text-light);
            font-size: 14px;
        }

        .step.active i {
            background: var(--primary-gold);
            color: white;
        }

        .step span {
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
        }

        .step.active span {
            color: var(--primary-gold);
            font-weight: 500;
        }

        /* Payment Steps Content */
        .payment-step {
            display: none;
        }

        .payment-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Step Buttons */
        .step-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .step-buttons .product-btn {
            flex: 1;
        }

        /* Order Summary */
        .order-summary {
            background: var(--bg-light);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }

        .order-summary h4 {
            margin-bottom: 15px;
            color: var(--stone-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item.total {
            font-weight: 700;
            font-size: 18px;
            color: var(--primary-gold);
            padding-top: 10px;
            margin-top: 10px;
            border-top: 2px solid var(--primary-gold);
        }

        /* Card Input Styling */
        .card-details {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            border: 1px solid #e0e0e0;
        }

        /* Alternative Payments */
        .alternative-payments {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .alternative-payments h4 {
            margin-bottom: 15px;
            color: var(--stone-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .payment-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .payment-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            color: var(--text-dark);
            min-width: 120px;
        }

        .payment-option:hover {
            border-color: var(--primary-gold);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* var(--shadow-sm) replacement */
        }

        .payment-option i {
            font-size: 24px;
        }

        /* Terms and Conditions */
        .terms {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .checkbox-label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-dark);
        }

        .checkbox-label input[type="checkbox"] {
            margin-top: 3px;
        }

        .checkbox-label a {
            color: var(--primary-gold);
            text-decoration: none;
        }

        .checkbox-label a:hover {
            text-decoration: underline;
        }

        /* Notification/Loading Style (Simplified for demo) */
        .notification, .loading-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            background: green;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .error-message {
            background: red;
            color: white;
        }
        
        .loading-overlay.active {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 1;
            font-size: 24px;
            color: var(--text-dark);
            z-index: 1002;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>E-commerce Product Page Demo</h1>
        <p>This button simulates adding a product to the cart and initiating checkout.</p>
        <button class="product-btn btn-primary" onclick="initiatePayment()">
            <i class="fas fa-shopping-cart"></i> Initiate Secure Payment
        </button>
        <hr style="margin-top: 30px;">
        <p><strong>Note:</strong> This is a front-end demo. Payment and Firebase actions are simulated with `setTimeout` and console logs.</p>
        <p>Current Demo Product: **Test Sandstone (ID: test-123, Price: £50/sqft)**</p>
    </div>

    <div class="payment-modal" id="paymentModal">
        <div class="payment-content">
            <div class="modal-header">
                <h2><i class="fas fa-credit-card"></i> Secure Checkout</h2>
                <button class="modal-close" id="paymentModalClose" onclick="closePaymentModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="payment-steps">
                    <div class="step active" data-step="1">
                        <i class="fas fa-user"></i>
                        <span>Customer</span>
                    </div>
                    <div class="step" data-step="2">
                        <i class="fas fa-truck"></i>
                        <span>Delivery</span>
                    </div>
                    <div class="step" data-step="3">
                        <i class="fas fa-credit-card"></i>
                        <span>Payment</span>
                    </div>
                </div>
                
                <div class="payment-step active" id="step1">
                    <h3><i class="fas fa-user-circle"></i> Customer Information</h3>
                    <div class="form-group">
                        <label for="fullName"><i class="fas fa-user"></i> Full Name *</label>
                        <input type="text" id="fullName" placeholder="John Smith" value="John Smith" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email"><i class="fas fa-envelope"></i> Email *</label>
                            <input type="email" id="email" placeholder="john@example.com" value="john@test.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone"><i class="fas fa-phone"></i> Phone *</label>
                            <input type="tel" id="phone" placeholder="+44 7123 456789" value="+44 1234567890" required>
                        </div>
                    </div>
                    
                    <button class="product-btn btn-primary next-step" data-next="2">
                        Continue to Delivery <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
                
                <div class="payment-step" id="step2">
                    <h3><i class="fas fa-truck"></i> Delivery Address</h3>
                    
                    <div class="form-group">
                        <label for="addressLine1"><i class="fas fa-home"></i> Address Line 1 *</label>
                        <input type="text" id="addressLine1" placeholder="123 Main Street" value="123 Test Street" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="addressLine2"><i class="fas fa-building"></i> Address Line 2</label>
                        <input type="text" id="addressLine2" placeholder="Apartment, Suite, etc.">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city"><i class="fas fa-city"></i> City *</label>
                            <input type="text" id="city" placeholder="London" value="London" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="postcode"><i class="fas fa-map-marker-alt"></i> Postcode *</label>
                            <input type="text" id="postcode" placeholder="SW1A 1AA" value="SW1A 1AA" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="country"><i class="fas fa-globe"></i> Country *</label>
                        <select id="country" required>
                            <option value="GB" selected>United Kingdom</option>
                            <option value="IN">India</option>
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="specialInstructions"><i class="fas fa-comment"></i> Special Instructions</label>
                        <textarea id="specialInstructions" rows="3" placeholder="Any special delivery instructions..."></textarea>
                    </div>
                    
                    <div class="step-buttons">
                        <button class="product-btn btn-secondary prev-step" data-prev="1">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="product-btn btn-primary next-step" data-next="3">
                            Continue to Payment <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="payment-step" id="step3">
                    <h3><i class="fas fa-credit-card"></i> Payment Details</h3>
                    
                    <div class="order-summary" id="orderSummary">
                        <h4><i class="fas fa-receipt"></i> Order Summary</h4>
                        <div class="summary-item">
                            <span>Subtotal:</span>
                            <span id="summarySubtotal">£0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Delivery:</span>
                            <span id="summaryDelivery">FREE</span>
                        </div>
                        <div class="summary-item">
                            <span>VAT (20%):</span>
                            <span id="summaryVAT">£0.00</span>
                        </div>
                        <div class="summary-item total">
                            <span>Total:</span>
                            <span id="summaryTotal">£0.00</span>
                        </div>
                    </div>
                    
                    <div class="card-details">
                        <div class="form-group">
                            <label for="cardNumber"><i class="far fa-credit-card"></i> Card Number *</label>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" 
                                    maxlength="19" oninput="formatCardNumber(this)" value="4242 4242 4242 4242"> </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expiryDate"><i class="far fa-calendar-alt"></i> Expiry Date *</label>
                                <input type="text" id="expiryDate" placeholder="MM/YY" 
                                        maxlength="5" oninput="formatExpiryDate(this)" value="12/26">
                            </div>
                            
                            <div class="form-group">
                                <label for="cvv"><i class="fas fa-lock"></i> CVV *</label>
                                <input type="text" id="cvv" placeholder="123" 
                                        maxlength="4" oninput="formatCVV(this)" value="123">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="cardName"><i class="fas fa-user"></i> Name on Card *</label>
                            <input type="text" id="cardName" placeholder="JOHN SMITH" value="JOHN SMITH" required>
                        </div>
                        
                        <div class="alternative-payments">
                            <h4><i class="fas fa-mobile-alt"></i> Quick Pay</h4>
                            <div class="payment-options">
                                <button type="button" class="payment-option" onclick="processPayPal()">
                                    <i class="fab fa-cc-paypal"></i> PayPal
                                </button>
                                <button type="button" class="payment-option" onclick="processGooglePay()">
                                    <i class="fab fa-google-pay"></i> Google Pay
                                </button>
                                <button type="button" class="payment-option" onclick="processApplePay()">
                                    <i class="fab fa-apple-pay"></i> Apple Pay
                                </button>
                            </div>
                        </div>
                        
                        <div class="terms">
                            <label class="checkbox-label">
                                <input type="checkbox" id="agreeTerms" checked required>
                                <span>I agree to the <a href="#" target="_blank">Terms & Conditions</a> 
                                and <a href="#" target="_blank">Privacy Policy</a></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="step-buttons">
                        <button class="product-btn btn-secondary prev-step" data-prev="2">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        <button class="product-btn btn-primary" id="submitPaymentBtn" onclick="processPayment()">
                            <i class="fas fa-lock"></i> Pay Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div> Processing Payment...
    </div>

    <script>
        // ============================================
        // 5. Firebase Initialization (Placeholder)
        // ============================================
        
        // **IMPORTANT:** Replace with your actual Firebase project config in a real app.
        const firebaseConfig = {
            // apiKey: "YOUR_API_KEY",
            // authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            // projectId: "YOUR_PROJECT_ID",
            // storageBucket: "YOUR_PROJECT_ID.appspot.com",
            // messagingSenderId: "YOUR_SENDER_ID",
            // appId: "YOUR_APP_ID"
        };
        
        // Simulate Firebase objects for the demo
        let firebaseDB = {
            collection: () => ({
                doc: (id) => ({
                    set: (data) => {
                        console.log(`[Firebase Mock] Saving Order: ${id}`, data);
                        // Simulate async delay
                        return new Promise(resolve => setTimeout(resolve, 100));
                    },
                    update: (data) => {
                        console.log(`[Firebase Mock] Updating Product Stock for ${id}:`, data);
                        // Simulate async delay
                        return new Promise(resolve => setTimeout(resolve, 50));
                    }
                })
            }),
            firestore: {
                FieldValue: {
                    increment: (value) => `[Increment:${value}]` // Mock increment function
                }
            }
        };

        // window.authSystem Mock for getUserId
        window.authSystem = {
            getUserId: () => 'user123-demo-id'
        };

        // ============================================
        // 6. Stripe Test Keys Setup (From Section 1)
        // ============================================
        
        const stripeConfig = {
            // Note: In a real scenario, the secret key should ONLY be used on the server-side.
            publishableKey: 'pk_test_51NtY2JSJ7h8t8J5k9K8jH7m6nB9cX8zL6mN9pQr4sV2dF6gH7', // Test key
            secretKey: 'sk_test_51NtY2JSJ7h8t8J5k9K8jH7m6nB9cX8zL6mN9pQr4sV2dF6gH7' // Test key (server-side mock)
        };

        // Mock currentProduct and cartSystem for the demo
        let currentProduct = {
            id: 'test-123',
            stone_name: 'Test Sandstone',
            price: 50,
            price_unit: 'sqft',
            min_order: 1,
            stock_quantity: 100 
        };
        
        let currentCalculatorTab = 'area'; // Default for calculation logic
        let currentAreaUnit = 'sqft'; 
        
        let cartSystem = { // Mock cart system
            cartItems: [],
            saveCart: () => console.log('[Cart Mock] Cart saved/cleared'),
            updateCartBadge: () => console.log('[Cart Mock] Cart badge updated')
        };
        
        // Mock calculator inputs needed for calculateOrderSummary
        const createMockInputs = () => {
             // Inject mock input elements for calculateOrderSummary to work
            if (!document.getElementById('lengthInput')) {
                document.body.insertAdjacentHTML('beforeend', '<input type="hidden" id="lengthInput" value="4">');
                document.body.insertAdjacentHTML('beforeend', '<input type="hidden" id="widthInput" value="2.5">');
                document.body.insertAdjacentHTML('beforeend', '<input type="hidden" id="weightInput" value="0">');
                document.body.insertAdjacentHTML('beforeend', '<select id="weightUnit"><option value="kg">kg</option></select>');
                document.body.insertAdjacentHTML('beforeend', '<input type="hidden" id="pieceQuantity" value="10">');
            }
        };
        createMockInputs();


        // ============================================
        // 7. Working JavaScript Payment System (From Section 4)
        // ============================================

        let currentPaymentStep = 1;
        let paymentData = {
            customer: {},
            delivery: {},
            payment: {},
            order: {}
        };

        function showNotification(message, isError = false) {
            const notificationEl = document.getElementById('notification');
            notificationEl.textContent = message;
            notificationEl.className = isError ? 'notification error-message' : 'notification';
            notificationEl.style.display = 'block';
            setTimeout(() => {
                 notificationEl.style.opacity = '1';
            }, 10); // Small delay to trigger transition

            setTimeout(() => {
                notificationEl.style.opacity = '0';
                setTimeout(() => {
                    notificationEl.style.display = 'none';
                }, 300);
            }, 3000);
        }

        function showError(message) {
            showNotification(message, true);
        }

        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (show) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }


        function initiatePayment() {
            if (!currentProduct) {
                showError('Please select a product first');
                return;
            }
            
            // Calculate order summary
            calculateOrderSummary();
            
            // Show payment modal
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reset to first step
            currentPaymentStep = 1;
            showPaymentStep(1);
        }

        function showPaymentStep(step) {
            // Hide all steps
            document.querySelectorAll('.payment-step').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active class from all step indicators
            document.querySelectorAll('.step').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show current step
            const stepElement = document.getElementById(`step${step}`);
            if (stepElement) {
                stepElement.classList.add('active');
            }
            
            // Update step indicator (and all previous steps)
            for(let i = 1; i <= step; i++) {
                 const stepIndicator = document.querySelector(`.step[data-step="${i}"]`);
                 if (stepIndicator) {
                     stepIndicator.classList.add('active');
                 }
            }
            
            currentPaymentStep = step;
        }

        // Step navigation
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('next-step')) {
                const nextStep = parseInt(e.target.dataset.next);
                
                // Validate current step
                if (currentPaymentStep === 1 && !validateStep1()) {
                    return;
                }
                if (currentPaymentStep === 2 && !validateStep2()) {
                    return;
                }
                
                saveStepData(currentPaymentStep);
                showPaymentStep(nextStep);
            }
            
            if (e.target.classList.contains('prev-step')) {
                const prevStep = parseInt(e.target.dataset.prev);
                showPaymentStep(prevStep);
            }
        });

        function validateStep1() {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            
            if (!fullName) {
                showError('Please enter your full name');
                return false;
            }
            
            if (!email || !isValidEmail(email)) {
                showError('Please enter a valid email address');
                return false;
            }
            
            if (!phone) {
                showError('Please enter your phone number');
                return false;
            }
            
            return true;
        }

        function validateStep2() {
            const addressLine1 = document.getElementById('addressLine1').value.trim();
            const city = document.getElementById('city').value.trim();
            const postcode = document.getElementById('postcode').value.trim();
            const country = document.getElementById('country').value;
            
            if (!addressLine1) {
                showError('Please enter your address');
                return false;
            }
            
            if (!city) {
                showError('Please enter your city');
                return false;
            }
            
            if (!postcode) {
                showError('Please enter your postcode');
                return false;
            }
            
            if (!country) {
                showError('Please select your country');
                return false;
            }
            
            return true;
        }

        function saveStepData(step) {
            switch(step) {
                case 1:
                    paymentData.customer = {
                        fullName: document.getElementById('fullName').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        phone: document.getElementById('phone').value.trim()
                    };
                    break;
                    
                case 2:
                    paymentData.delivery = {
                        addressLine1: document.getElementById('addressLine1').value.trim(),
                        addressLine2: document.getElementById('addressLine2').value.trim(),
                        city: document.getElementById('city').value.trim(),
                        postcode: document.getElementById('postcode').value.trim(),
                        country: document.getElementById('country').value,
                        specialInstructions: document.getElementById('specialInstructions').value.trim()
                    };
                    break;
            }
        }

        function calculateOrderSummary() {
            if (!currentProduct) return;
            
            // Mock Calculation based on your provided logic
            let quantity = 1;
            let area = 0;
            
            switch(currentCalculatorTab) {
                case 'area':
                    const length = parseFloat(document.getElementById('lengthInput').value) || 0;
                    const width = parseFloat(document.getElementById('widthInput').value) || 0;
                    area = length * width; // 4 * 2.5 = 10
                    // quantity = Math.ceil(area * (currentAreaUnit === 'sqm' ? 10.7639 : 1)); 
                    quantity = Math.ceil(area); // Simplified to 10 for demo, assuming sqft unit
                    break;
                    
                case 'weight':
                    const weight = parseFloat(document.getElementById('weightInput').value) || 0;
                    // const weightUnit = document.getElementById('weightUnit').value;
                    // quantity = Math.ceil(weight * (weightUnit === 'ton' ? 1000 : weightUnit === 'lb' ? 0.453592 : 1) / 50);
                    quantity = 0;
                    break;
                    
                case 'piece':
                    quantity = parseInt(document.getElementById('pieceQuantity').value) || currentProduct.min_order; // 10
                    break;
                default:
                    quantity = 10; // Default to 10 for testing
            }
            
            const subtotal = currentProduct.price * quantity; // 50 * 10 = 500
            const vat = subtotal * 0.2; // 20% VAT = 100
            const total = subtotal + vat; // 600
            
            // Save order data
            paymentData.order = {
                productId: currentProduct.id,
                productName: currentProduct.stone_name,
                quantity: quantity,
                unitPrice: currentProduct.price,
                subtotal: subtotal,
                vat: vat,
                total: total,
                area: area,
                unit: currentCalculatorTab === 'area' ? currentAreaUnit : 
                    currentCalculatorTab === 'weight' ? 'weight' : 'piece'
            };
            
            // Update summary display
            document.getElementById('summarySubtotal').textContent = `£${subtotal.toFixed(2)}`;
            document.getElementById('summaryVAT').textContent = `£${vat.toFixed(2)}`;
            document.getElementById('summaryTotal').textContent = `£${total.toFixed(2)}`;
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formatted = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += ' ';
                }
                formatted += value[i];
            }
            
            input.value = formatted;
            
            // Validate card type
            // const cardType = getCardType(value);
            // if (cardType) { /* show card type icon here */ }
        }

        function formatExpiryDate(input) {
            let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            
            input.value = value;
        }

        function formatCVV(input) {
            let value = input.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            input.value = value.substring(0, 4);
        }

        // function getCardType(cardNumber) { ... } // Not strictly needed for the flow
        
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email.toLowerCase());
        }

        // ============================================
        // PAYMENT PROCESSING
        // ============================================

        async function processPayment() {
            // Validate step 3
            if (!validateStep3()) {
                return;
            }
            
            // Check terms agreement
            if (!document.getElementById('agreeTerms').checked) {
                showError('Please agree to the Terms & Conditions');
                return;
            }
            
            showLoading(true);
            
            try {
                // Save payment data
                paymentData.payment = {
                    cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g, ''),
                    expiryDate: document.getElementById('expiryDate').value,
                    cvv: document.getElementById('cvv').value,
                    cardName: document.getElementById('cardName').value.trim(),
                    paymentMethod: 'credit_card'
                };
                
                // Create order in Firebase (Mocked)
                const orderId = await createOrderInFirebase();
                
                // Simulate payment processing
                setTimeout(() => {
                    showLoading(false);
                    
                    // Show success message
                    showNotification('Payment successful! Order #' + orderId + ' has been placed.');
                    
                    // Close payment modal
                    closePaymentModal();
                    
                    // Clear cart
                    if (cartSystem) {
                        cartSystem.cartItems = [];
                        cartSystem.saveCart();
                        cartSystem.updateCartBadge();
                    }
                    
                    // Redirect to order confirmation (Simulated)
                    // window.location.href = `order-confirmation.html?orderId=${orderId}`;
                    console.log(`[Demo] Simulating Redirect to: order-confirmation.html?orderId=${orderId}`);
                    
                }, 2000);
                
            } catch (error) {
                console.error('Payment error:', error);
                showError('Payment failed: ' + (error.message || 'An unknown error occurred.'));
                showLoading(false);
            }
        }

        function validateStep3() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s+/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            const cardName = document.getElementById('cardName').value.trim();
            
            if (!cardNumber || cardNumber.length < 16) {
                showError('Please enter a valid card number');
                return false;
            }
            
            if (!expiryDate || !/^\d{2}\/\d{2}$/.test(expiryDate)) {
                showError('Please enter a valid expiry date (MM/YY)');
                return false;
            }
            
            if (!cvv || (cvv.length < 3 || cvv.length > 4)) {
                showError('Please enter a valid CVV');
                return false;
            }
            
            if (!cardName) {
                showError('Please enter the name on card');
                return false;
            }
            
            // Validate expiry date
            const [month, year] = expiryDate.split('/');
            const currentYear = new Date().getFullYear() % 100;
            const currentMonth = new Date().getMonth() + 1;
            
            if (parseInt(month) < 1 || parseInt(month) > 12) {
                showError('Invalid month in expiry date');
                return false;
            }
            
            if (parseInt(year) < currentYear || 
                (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                showError('Card has expired');
                return false;
            }
            
            return true;
        }

        async function createOrderInFirebase() {
            if (!firebaseDB) {
                throw new Error('Firebase not initialized');
            }
            
            const orderId = 'ORD' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase(); // Shortened random part
            const userId = window.authSystem ? window.authSystem.getUserId() : 'guest';
            
            const orderData = {
                orderId: orderId,
                userId: userId,
                customer: paymentData.customer,
                delivery: paymentData.delivery,
                order: paymentData.order,
                payment: {
                    method: paymentData.payment.paymentMethod,
                    status: 'completed',
                    amount: paymentData.order.total,
                    currency: 'GBP',
                    timestamp: new Date().toISOString()
                },
                status: 'processing',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Save order to Firebase (Mocked)
            await firebaseDB.collection('orders').doc(orderId).set(orderData);
            
            // Update product stock (Mocked)
            if (currentProduct && currentProduct.stock_quantity) {
                await firebaseDB.collection('products').doc(currentProduct.id).update({
                    stock_quantity: firebaseDB.firestore.FieldValue.increment(-paymentData.order.quantity),
                    updatedAt: new Date().toISOString()
                });
            }
            
            return orderId;
        }

        // Alternative Payment Methods
        function processPayPal() {
            showNotification('PayPal integration coming soon!');
        }

        function processGooglePay() {
            showNotification('Google Pay integration coming soon!');
        }

        function processApplePay() {
            showNotification('Apple Pay integration coming soon!');
        }

        function closePaymentModal() {
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Reset form (simplified for demo)
            // Note: In a real app, reset logic should be more robust
            paymentData = {
                customer: {},
                delivery: {},
                payment: {},
                order: {}
            };

            // Reload customer data to mock the form reset (since we use pre-filled data for testing)
            document.getElementById('fullName').value = 'John Smith';
            document.getElementById('email').value = 'john@test.com';
            document.getElementById('phone').value = '+44 1234567890';
            document.getElementById('addressLine1').value = '123 Test Street';
            document.getElementById('city').value = 'London';
            document.getElementById('postcode').value = 'SW1A 1AA';
            document.getElementById('country').value = 'GB';
            document.getElementById('specialInstructions').value = '';

            document.getElementById('cardNumber').value = '4242 4242 4242 4242';
            document.getElementById('expiryDate').value = '12/26';
            document.getElementById('cvv').value = '123';
            document.getElementById('cardName').value = 'JOHN SMITH';
            document.getElementById('agreeTerms').checked = true;

        }
        
        // Initial setup for the close button
        document.getElementById('paymentModalClose').addEventListener('click', closePaymentModal);


        // ============================================
        // 8. Testing Payment System (From Section 5 - Only for console verification)
        // ============================================
        
        function testPaymentSystem() {
            console.log('Testing Payment System...');
            
            // The test data is essentially what's pre-filled in the form and calculated in calculateOrderSummary
            
            console.log('Stripe Keys:', stripeConfig);
            console.log('Initial Payment Data Structure:', paymentData);
            console.log('Payment system is ready for the demo!');
        }

        // Run test on load
        window.addEventListener('load', testPaymentSystem);
    </script>
</body>
</html>
