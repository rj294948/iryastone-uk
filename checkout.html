<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Complete Payment | IRYA STONE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<!-- Simple Loading Indicator -->
<div id="loading" style="text-align: center; padding: 50px;">
    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #c9a227; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
    <p>Loading payment details...</p>
</div>

<!-- Error State (Hidden by default) -->
<div id="errorState" style="display: none; text-align: center; padding: 40px; background: #fff5f5; border: 1px solid #ffcccc; border-radius: 8px; margin: 20px;">
    <h3 style="color: #c92a2a;">Payment Error</h3>
    <p id="errorMessage">An error occurred while loading payment details.</p>
    <button onclick="retryLoad()" style="background: #c9a227; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
        Try Again
    </button>
</div>

<!-- Payment Content (Hidden until loaded) -->
<div id="paymentContent" style="display: none; max-width: 800px; margin: 20px auto; padding: 20px;">
    
    <!-- Order Info -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        <h2 style="margin: 0 0 15px 0;">Complete Payment</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <div style="font-size: 12px; opacity: 0.9;">Order Number</div>
                <div style="font-weight: bold; font-size: 18px;" id="orderNumber">Loading...</div>
            </div>
            <div>
                <div style="font-size: 12px; opacity: 0.9;">Remaining Amount</div>
                <div style="font-weight: bold; font-size: 18px; color: #ff6b6b;" id="remainingAmount">£0.00</div>
            </div>
            <div>
                <div style="font-size: 12px; opacity: 0.9;">Total Amount</div>
                <div style="font-weight: bold; font-size: 18px;" id="totalAmount">£0.00</div>
            </div>
        </div>
    </div>
    
    <!-- Payment Methods -->
    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0;">Select Payment Method</h3>
        
        <div style="margin-bottom: 15px;">
            <input type="radio" id="bankMethod" name="paymentMethod" value="bank" checked onclick="selectPaymentMethod('bank')">
            <label for="bankMethod" style="margin-left: 10px; font-weight: bold;">Bank Transfer</label>
            <div style="margin-left: 30px; margin-top: 10px; display: none;" id="bankDetails">
                <p><strong>Bank Account Details:</strong></p>
                <p>Bank: HSBC UK</p>
                <p>Account Name: IRYA STONE LTD</p>
                <p>Account: 12345678</p>
                <p>Sort Code: 40-04-15</p>
                <p>Reference: <span id="bankReference"></span></p>
            </div>
        </div>
        
        <div style="margin-bottom: 15px;">
            <input type="radio" id="stripeMethod" name="paymentMethod" value="stripe" onclick="selectPaymentMethod('stripe')">
            <label for="stripeMethod" style="margin-left: 10px; font-weight: bold;">Credit/Debit Card</label>
            <div style="margin-left: 30px; margin-top: 10px; display: none;" id="stripeDetails">
                <div style="margin-bottom: 10px;">
                    <label>Card Number:</label><br>
                    <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <label>Expiry Date:</label><br>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>CVC:</label><br>
                        <input type="text" id="cardCvc" placeholder="123" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div style="margin-bottom: 10px;">
                    <label>Cardholder Name:</label><br>
                    <input type="text" id="cardName" placeholder="John Doe" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
        </div>
        
        <div>
            <input type="radio" id="paypalMethod" name="paymentMethod" value="paypal" onclick="selectPaymentMethod('paypal')">
            <label for="paypalMethod" style="margin-left: 10px; font-weight: bold;">PayPal</label>
            <div style="margin-left: 30px; margin-top: 10px; display: none;" id="paypalDetails">
                <p>You will be redirected to PayPal to complete your payment.</p>
                <p><strong>Amount:</strong> <span id="paypalAmount">£0.00</span></p>
            </div>
        </div>
    </div>
    
    <!-- Order Items -->
    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0;">Order Items</h3>
        <div id="orderItems" style="max-height: 200px; overflow-y: auto;">
            <!-- Items will be loaded here -->
        </div>
        
        <div style="border-top: 2px solid #eee; padding-top: 15px; margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Subtotal:</span>
                <span id="subtotalAmount">£0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Shipping:</span>
                <span id="shippingAmount">£0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Tax:</span>
                <span id="taxAmount">£0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Already Paid:</span>
                <span id="paidAmount">£0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #ff6b6b; font-weight: bold;">
                <span>Remaining Amount:</span>
                <span id="remainingSummary">£0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; border-top: 1px solid #eee; padding-top: 10px;">
                <span>Total:</span>
                <span id="totalSummary">£0.00</span>
            </div>
        </div>
    </div>
    
    <!-- Payment Button -->
    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;">
        <button onclick="processPayment()" id="processPaymentBtn" style="background: #c9a227; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">
            Complete Payment
        </button>
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
            <i>Complete your payment to avoid order cancellation</i>
        </p>
    </div>
</div>

<!-- Success Modal (Hidden by default) -->
<div id="successModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; text-align: center;">
        <div style="width: 60px; height: 60px; background: #51cf66; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; margin: 0 auto 20px;">
            ✓
        </div>
        <h2 style="margin: 0 0 10px 0;">Payment Successful!</h2>
        <p>Your remaining payment has been processed successfully.</p>
        
        <div id="successDetails" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: left;">
            <!-- Success details will be shown here -->
        </div>
        
        <div style="display: flex; gap: 10px;">
            <button onclick="viewOrder()" style="background: #c9a227; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                View Order
            </button>
            <button onclick="closeSuccessModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; flex: 1;">
                Close
            </button>
        </div>
    </div>
</div>

<script type="module">
// Firebase SDK Import
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
    getFirestore, 
    collection, 
    doc, 
    getDoc,
    query,
    where,
    getDocs,
    updateDoc,
    arrayUnion,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global Variables
let currentUserId = null;
let paymentData = null;
let orderData = null;
let selectedPaymentMethod = 'bank';

// Get User ID
async function getUserId() {
    try {
        const savedUser = localStorage.getItem('irya_stone_auth_user');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            currentUserId = user.uid;
            return currentUserId;
        }

        let guestId = localStorage.getItem('irya_guest_id');
        if (!guestId) {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user');
            if (urlUserId) {
                guestId = urlUserId;
            } else {
                guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            localStorage.setItem('irya_guest_id', guestId);
        }
        
        currentUserId = guestId;
        return currentUserId;
        
    } catch (error) {
        console.error("Error getting user ID:", error);
        currentUserId = 'guest_' + Date.now();
        return currentUserId;
    }
}

// Load Payment Data
async function loadPaymentData() {
    try {
        showLoading(true);
        
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('order');
        const paymentType = urlParams.get('type');
        const source = urlParams.get('source');
        const amount = urlParams.get('amount');
        
        console.log("URL Parameters:", { orderId, paymentType, source, amount });
        
        // Check localStorage for pending payment data
        const storedPayment = localStorage.getItem('irya_pending_payment_order');
        
        if (storedPayment) {
            paymentData = JSON.parse(storedPayment);
            console.log("Loaded payment data:", paymentData);
            await loadOrderDetails(paymentData.orderId);
        } else if (orderId) {
            paymentData = {
                orderId: orderId,
                orderType: 'existing_order',
                paymentType: paymentType || 'remaining_payment',
                source: source || 'direct_link',
                remainingAmount: parseFloat(amount) || 0
            };
            await loadOrderDetails(orderId);
        } else {
            showError("No Payment Data", "No payment information found.");
            return;
        }
        
        updatePaymentUI();
        showLoading(false);
        document.getElementById('paymentContent').style.display = 'block';
        selectPaymentMethod('bank');
        
    } catch (error) {
        console.error("Error loading payment data:", error);
        showError("Load Error", "Failed to load payment details.");
        showLoading(false);
    }
}

// Load Order Details from Firebase
async function loadOrderDetails(orderId) {
    try {
        console.log("Loading order details for:", orderId);
        
        // Try user-specific collection first
        try {
            const orderDoc = await getDoc(doc(db, "users", currentUserId, "orders", orderId));
            if (orderDoc.exists()) {
                orderData = orderDoc.data();
                orderData.id = orderDoc.id;
                console.log("Order found:", orderData);
                return;
            }
        } catch (error) {
            console.log("Trying main orders collection...");
        }
        
        // Try main orders collection
        const ordersRef = collection(db, "orders");
        const orderQuery = query(ordersRef, where("__name__", "==", orderId));
        const orderSnapshot = await getDocs(orderQuery);
        
        if (!orderSnapshot.empty) {
            orderData = orderSnapshot.docs[0].data();
            orderData.id = orderSnapshot.docs[0].id;
            console.log("Order found in main collection:", orderData);
            return;
        }
        
        // Try by order number
        if (paymentData.orderNumber) {
            const orderNumberQuery = query(ordersRef, where("orderNumber", "==", paymentData.orderNumber));
            const orderNumberSnapshot = await getDocs(orderNumberQuery);
            
            if (!orderNumberSnapshot.empty) {
                orderData = orderNumberSnapshot.docs[0].data();
                orderData.id = orderNumberSnapshot.docs[0].id;
                console.log("Order found by number:", orderData);
                return;
            }
        }
        
        throw new Error("Order not found");
        
    } catch (error) {
        console.error("Error loading order details:", error);
        throw error;
    }
}

// Update Payment UI
function updatePaymentUI() {
    if (!paymentData || !orderData) return;
    
    const orderNumber = orderData.orderNumber || paymentData.orderNumber || orderData.id?.substring(0, 8) || 'N/A';
    const remainingAmount = paymentData.remainingAmount || 
        orderData.remainingPayment || 
        (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    const totalAmount = paymentData.totalAmount || orderData.total || 0;
    const paidAmount = paymentData.paidAmount || orderData.submittedAmount || orderData.advancePayment || 0;
    const subtotal = orderData.subtotal || orderData.total || 0;
    const shipping = orderData.shippingCost || 0;
    const tax = orderData.tax || 0;
    
    // Update order info
    document.getElementById('orderNumber').textContent = orderNumber;
    document.getElementById('remainingAmount').textContent = `£${remainingAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `£${totalAmount.toFixed(2)}`;
    
    // Update bank reference
    const bankReference = `IRYA-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
    document.getElementById('bankReference').textContent = bankReference;
    
    // Update PayPal amount
    document.getElementById('paypalAmount').textContent = `£${remainingAmount.toFixed(2)}`;
    
    // Update order summary
    document.getElementById('subtotalAmount').textContent = `£${subtotal.toFixed(2)}`;
    document.getElementById('shippingAmount').textContent = `£${shipping.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `£${tax.toFixed(2)}`;
    document.getElementById('paidAmount').textContent = `£${paidAmount.toFixed(2)}`;
    document.getElementById('remainingSummary').textContent = `£${remainingAmount.toFixed(2)}`;
    document.getElementById('totalSummary').textContent = `£${totalAmount.toFixed(2)}`;
    
    // Update payment button
    document.getElementById('processPaymentBtn').innerHTML = `Pay Remaining £${remainingAmount.toFixed(2)}`;
    
    // Update order items
    updateOrderItems();
}

// Update Order Items
function updateOrderItems() {
    const orderItemsDiv = document.getElementById('orderItems');
    
    if (!orderData.items || orderData.items.length === 0) {
        orderItemsDiv.innerHTML = '<p>No items found</p>';
        return;
    }
    
    let itemsHTML = '';
    
    orderData.items.forEach(item => {
        const itemName = item.name || item.stoneName || item.productName || 'Product';
        const quantity = item.quantity || 1;
        const price = item.price || 0;
        const totalPrice = item.calculatedPrice || item.totalPrice || price * quantity;
        
        itemsHTML += `
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                <div>
                    <strong>${itemName}</strong><br>
                    <small>Quantity: ${quantity} × £${price.toFixed(2)}</small>
                </div>
                <div>£${totalPrice.toFixed(2)}</div>
            </div>
        `;
    });
    
    orderItemsDiv.innerHTML = itemsHTML;
}

// Select Payment Method
function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // Hide all details
    document.getElementById('bankDetails').style.display = 'none';
    document.getElementById('stripeDetails').style.display = 'none';
    document.getElementById('paypalDetails').style.display = 'none';
    
    // Show selected method details
    document.getElementById(method + 'Details').style.display = 'block';
    
    // Update payment button text
    const remainingAmount = paymentData.remainingAmount || 
        orderData.remainingPayment || 
        (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    
    const buttonText = method === 'bank' ? 'Confirm Bank Transfer' :
                      method === 'stripe' ? 'Pay with Card' :
                      method === 'paypal' ? 'Pay with PayPal' : 'Complete Payment';
    
    document.getElementById('processPaymentBtn').innerHTML = `${buttonText} £${remainingAmount.toFixed(2)}`;
}

// Process Payment
async function processPayment() {
    try {
        if (!paymentData || !orderData) {
            alert("Payment data not loaded properly.");
            return;
        }
        
        const remainingAmount = paymentData.remainingAmount || 
            orderData.remainingPayment || 
            (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
        
        if (remainingAmount <= 0) {
            alert("No remaining amount to pay.");
            return;
        }
        
        const btn = document.getElementById('processPaymentBtn');
        btn.disabled = true;
        btn.innerHTML = 'Processing...';
        
        if (selectedPaymentMethod === 'bank') {
            await submitBankPayment();
        } else if (selectedPaymentMethod === 'stripe') {
            await processStripePayment();
        } else if (selectedPaymentMethod === 'paypal') {
            await processPayPalPayment();
        }
        
    } catch (error) {
        console.error("Error processing payment:", error);
        alert("Failed to process payment. Please try again.");
        document.getElementById('processPaymentBtn').disabled = false;
        document.getElementById('processPaymentBtn').innerHTML = 'Complete Payment';
    }
}

// Submit Bank Payment
async function submitBankPayment() {
    try {
        const remainingAmount = paymentData.remainingAmount || 
            orderData.remainingPayment || 
            (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
        
        const reference = document.getElementById('bankReference').textContent;
        
        // Update order in Firebase
        await updateOrderAfterPayment(remainingAmount, 'bank_transfer', reference);
        
        showSuccessModal({
            amount: remainingAmount,
            method: 'Bank Transfer',
            reference: reference,
            orderNumber: orderData.orderNumber || paymentData.orderNumber || orderData.id?.substring(0, 8)
        });
        
        localStorage.removeItem('irya_pending_payment_order');
        
    } catch (error) {
        console.error("Error submitting bank payment:", error);
        alert("Failed to record bank transfer.");
        throw error;
    }
}

// Process Stripe Payment
async function processStripePayment() {
    try {
        const cardNumber = document.getElementById('cardNumber').value;
        const cardExpiry = document.getElementById('cardExpiry').value;
        const cardCvc = document.getElementById('cardCvc').value;
        const cardName = document.getElementById('cardName').value;
        
        if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
            alert("Please fill in all card details.");
            return;
        }
        
        const remainingAmount = paymentData.remainingAmount || 
            orderData.remainingPayment || 
            (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
        
        const btn = document.getElementById('processPaymentBtn');
        btn.innerHTML = 'Processing with Stripe...';
        
        // Simulate payment processing
        setTimeout(async () => {
            const transactionId = 'stripe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            await updateOrderAfterPayment(remainingAmount, 'stripe', transactionId);
            
            showSuccessModal({
                amount: remainingAmount,
                method: 'Credit/Debit Card',
                reference: transactionId,
                orderNumber: orderData.orderNumber || paymentData.orderNumber || orderData.id?.substring(0, 8)
            });
            
            localStorage.removeItem('irya_pending_payment_order');
        }, 2000);
        
    } catch (error) {
        console.error("Error processing Stripe payment:", error);
        alert("Payment processing failed.");
        throw error;
    }
}

// Process PayPal Payment
async function processPayPalPayment() {
    try {
        const remainingAmount = paymentData.remainingAmount || 
            orderData.remainingPayment || 
            (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
        
        alert(`You will be redirected to PayPal to pay £${remainingAmount.toFixed(2)}.\n\nIn production, this would integrate with PayPal SDK.`);
        
    } catch (error) {
        console.error("Error processing PayPal payment:", error);
        alert("PayPal integration error.");
        throw error;
    }
}

// Update Order After Payment
async function updateOrderAfterPayment(amount, method, transactionId) {
    try {
        const currentPaid = orderData.submittedAmount || orderData.advancePayment || 0;
        const newPaid = currentPaid + amount;
        const total = orderData.total || 0;
        const newRemaining = total - newPaid;
        
        let newPaymentStatus = orderData.paymentStatus || 'advance_paid';
        if (newRemaining <= 0) {
            newPaymentStatus = 'fully_paid';
        }
        
        const paymentEntry = {
            amount: amount,
            method: method,
            transactionId: transactionId,
            date: new Date().toISOString(),
            type: 'remaining_payment',
            status: 'completed'
        };
        
        console.log("Updating order with:", {
            orderId: orderData.id,
            newPaid,
            newRemaining,
            newPaymentStatus,
            paymentEntry
        });
        
        // Note: In production, uncomment this code
        // const orderRef = doc(db, "orders", orderData.id);
        // await updateDoc(orderRef, {
        //     submittedAmount: newPaid,
        //     remainingPayment: newRemaining,
        //     paymentStatus: newPaymentStatus,
        //     paymentHistory: arrayUnion(paymentEntry),
        //     updatedAt: serverTimestamp()
        // });
        
        // Create notification
        await createPaymentNotification(amount, method);
        
    } catch (error) {
        console.error("Error updating order:", error);
        throw error;
    }
}

// Create Payment Notification
async function createPaymentNotification(amount, method) {
    try {
        const notification = {
            userId: currentUserId,
            orderId: orderData.id,
            orderNumber: orderData.orderNumber || paymentData.orderNumber,
            type: 'payment_completed',
            title: `Payment Received - £${amount.toFixed(2)}`,
            message: `Your remaining payment of £${amount.toFixed(2)} has been received via ${method}.`,
            read: false,
            createdAt: new Date().toISOString()
        };
        
        console.log("Payment notification:", notification);
        
        // Save to localStorage for demo
        const notifications = JSON.parse(localStorage.getItem('irya_notifications') || '[]');
        notifications.push(notification);
        localStorage.setItem('irya_notifications', JSON.stringify(notifications));
        
    } catch (error) {
        console.error("Error creating notification:", error);
    }
}

// Show Success Modal
function showSuccessModal(details) {
    const modal = document.getElementById('successModal');
    const detailsDiv = document.getElementById('successDetails');
    
    detailsDiv.innerHTML = `
        <p><strong>Order Number:</strong> ${details.orderNumber}</p>
        <p><strong>Amount Paid:</strong> £${details.amount.toFixed(2)}</p>
        <p><strong>Payment Method:</strong> ${details.method}</p>
        <p><strong>Reference:</strong> ${details.reference}</p>
        <p><strong>Status:</strong> Payment Successful</p>
    `;
    
    modal.style.display = 'flex';
}

// Close Success Modal
function closeSuccessModal() {
    document.getElementById('successModal').style.display = 'none';
    window.location.href = 'orders.html';
}

// View Order
function viewOrder() {
    const orderId = orderData.id || paymentData.orderId;
    window.location.href = `orders.html?order_id=${orderId}`;
}

// Show Loading
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Show Error
function showError(title, message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorState').style.display = 'block';
    document.getElementById('paymentContent').style.display = 'none';
    document.getElementById('loading').style.display = 'none';
}

// Retry Load
function retryLoad() {
    document.getElementById('errorState').style.display = 'none';
    loadPaymentData();
}

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    try {
        await getUserId();
        await loadPaymentData();
        
        // Card input formatting
        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
                let formatted = '';
                for (let i = 0; i < value.length; i++) {
                    if (i > 0 && i % 4 === 0) formatted += ' ';
                    formatted += value[i];
                }
                e.target.value = formatted.substring(0, 19);
            });
        }
        
        const expiryInput = document.getElementById('cardExpiry');
        if (expiryInput) {
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/gi, '');
                if (value.length >= 2) {
                    e.target.value = value.substring(0, 2) + '/' + value.substring(2, 4);
                } else {
                    e.target.value = value;
                }
            });
        }
        
        const cvcInput = document.getElementById('cardCvc');
        if (cvcInput) {
            cvcInput.addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/[^0-9]/gi, '').substring(0, 4);
            });
        }
        
    } catch (error) {
        console.error("Error initializing:", error);
        showError("Initialization Error", "Failed to load payment page.");
    }
});

// Add CSS for spinner animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

// Make functions available globally
window.selectPaymentMethod = selectPaymentMethod;
window.processPayment = processPayment;
window.submitBankPayment = submitBankPayment;
window.processStripePayment = processStripePayment;
window.processPayPalPayment = processPayPalPayment;
window.viewOrder = viewOrder;
window.closeSuccessModal = closeSuccessModal;
window.retryLoad = retryLoad;
</script>

</body>
</html>
