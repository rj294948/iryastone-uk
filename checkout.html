<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Complete Payment | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Payment status colors */
    --payment-pending: #ff6b6b;
    --payment-advance: #ff922b;
    --payment-full: #51cf66;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
    transition: padding-top 0.3s ease;
}

/* ===== HEADER ===== */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.header.hide {
    transform: translateY(-100%);
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    transform: translateY(0);
}

.bottom-nav.hide {
    transform: translateY(100%);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
    transition: padding-top 0.3s ease;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* ===== MAIN CONTAINER ===== */
.container {
    max-width: 800px;
    margin: 30px auto;
    padding: 0 16px;
}

.page-header {
    margin-bottom: 30px;
    text-align: center;
}

.page-header h1 {
    font-size: 28px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 8px;
}

.page-header p {
    color: var(--text-light);
    font-size: 14px;
}

/* ===== PAYMENT INFO CARD ===== */
.payment-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 25px;
    position: relative;
    overflow: hidden;
}

.payment-info-card::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    opacity: 0.2;
    animation: moveBackground 20s linear infinite;
}

@keyframes moveBackground {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.payment-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
    position: relative;
    z-index: 2;
}

.payment-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.payment-label {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.payment-value {
    font-weight: 600;
    font-size: 18px;
    font-family: 'Roboto Slab', serif;
}

.payment-urgent-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: #ff4757;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    animation: pulse 2s infinite;
    box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

/* ===== PAYMENT CARD ===== */
.payment-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    border: 1px solid #f0f0f0;
}

.payment-card-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.payment-card-header i {
    font-size: 24px;
    color: var(--primary-gold);
}

.payment-card-header h2 {
    font-size: 20px;
    font-weight: 600;
    color: var(--stone-dark);
}

.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.payment-method {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px;
    border: 2px solid #f0f0f0;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.payment-method:hover {
    border-color: var(--gold-light);
    background: rgba(201, 162, 39, 0.05);
}

.payment-method.selected {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.1);
}

.method-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.method-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    background: var(--bg-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--primary-gold);
}

.method-details h3 {
    font-size: 16px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.method-details p {
    font-size: 12px;
    color: var(--text-light);
}

.method-check {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.payment-method.selected .method-check {
    background: var(--primary-gold);
    border-color: var(--primary-gold);
}

.payment-method.selected .method-check i {
    color: white;
    font-size: 12px;
}

/* ===== PAYMENT FORM ===== */
.payment-form {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    border: 1px solid #f0f0f0;
    display: none;
}

.payment-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--stone-dark);
    font-size: 14px;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 3px rgba(201, 162, 39, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.card-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--text-light);
}

/* ===== ORDER SUMMARY CARD ===== */
.order-summary-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    border: 1px solid #f0f0f0;
}

.order-summary-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.order-items {
    margin-bottom: 25px;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 10px;
}

.order-item {
    display: flex;
    gap: 15px;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item:last-child {
    border-bottom: none;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-light);
    flex-shrink: 0;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details {
    flex: 1;
}

.item-name {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 5px;
    color: var(--stone-dark);
}

.item-meta {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 5px;
}

.item-price {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 14px;
}

.order-total {
    border-top: 2px solid #f0f0f0;
    padding-top: 20px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 14px;
}

.total-row:last-child {
    margin-bottom: 0;
    font-weight: 600;
    font-size: 18px;
    color: var(--stone-dark);
}

.remaining-amount {
    color: var(--payment-pending);
    font-weight: 600;
}

/* ===== PAYMENT BUTTONS ===== */
.payment-actions {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-md);
    border: 1px solid #f0f0f0;
    position: sticky;
    bottom: 90px;
}

.payment-buttons {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.btn {
    padding: 15px 25px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: var(--transition);
    flex: 1;
    min-width: 200px;
}

.btn-primary {
    background: var(--primary-gold);
    color: var(--white);
}

.btn-primary:hover {
    background: var(--gold-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
}

.btn-secondary {
    background: var(--white);
    color: var(--text-dark);
    border: 1px solid #e0e0e0;
}

.btn-secondary:hover {
    background: var(--bg-light);
    border-color: var(--primary-gold);
}

.btn-success {
    background: var(--payment-full);
    color: white;
}

.btn-success:hover {
    background: #40c057;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(81, 207, 102, 0.3);
}

.btn-danger {
    background: var(--payment-pending);
    color: white;
}

.btn-danger:hover {
    background: #fa5252;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

/* ===== LOADING STATE ===== */
.loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.1);
    border-top-color: var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== SUCCESS MODAL ===== */
.success-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.success-modal-content {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    width: 100%;
    max-width: 500px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    animation: modalSlideIn 0.3s ease;
    text-align: center;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.success-icon {
    width: 80px;
    height: 80px;
    background: var(--payment-full);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin: 0 auto 20px;
    animation: bounce 0.5s ease;
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-30px);}
    60% {transform: translateY(-15px);}
}

.success-modal-header {
    background: linear-gradient(135deg, var(--stone-dark), #2d2d2d);
    color: var(--white);
    padding: 30px;
}

.success-modal-header h2 {
    font-size: 24px;
    margin-bottom: 10px;
}

.success-modal-body {
    padding: 30px;
}

.success-details {
    background: var(--bg-light);
    border-radius: var(--border-radius);
    padding: 20px;
    margin: 20px 0;
    text-align: left;
}

.success-details div {
    margin-bottom: 10px;
    font-size: 14px;
}

.success-details div:last-child {
    margin-bottom: 0;
}

/* ===== ERROR STATE ===== */
.error-state {
    text-align: center;
    padding: 40px 20px;
    background: #fff5f5;
    border-radius: var(--border-radius);
    border: 1px solid #ffcccc;
    margin-bottom: 20px;
}

.error-state i {
    font-size: 48px;
    color: var(--payment-pending);
    margin-bottom: 20px;
}

.error-state h3 {
    color: #c92a2a;
    margin-bottom: 10px;
    font-weight: 600;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .breadcrumb {
        padding: 80px 16px 20px;
    }
    
    .container {
        margin: 20px auto;
    }
    
    .payment-details {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .payment-buttons {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
        min-width: auto;
    }
    
    .payment-urgent-badge {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 15px;
        display: inline-block;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 10px 12px;
    }
    
    .logo span {
        font-size: 16px;
    }
    
    .page-header h1 {
        font-size: 24px;
    }
    
    .payment-card,
    .payment-form,
    .order-summary-card,
    .payment-actions {
        padding: 20px;
    }
    
    .payment-method {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .method-check {
        align-self: flex-end;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 14px;
    }
    
    .item-image {
        width: 50px;
        height: 50px;
    }
}
</style>
</head>

<body>

<!-- Success Modal -->
<div class="success-modal" id="successModal">
    <div class="success-modal-content">
        <div class="success-modal-header">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2>Payment Successful!</h2>
            <p>Your remaining payment has been processed</p>
        </div>
        <div class="success-modal-body">
            <div class="success-details" id="successDetails">
                <!-- Success details will be loaded here -->
            </div>
            <div class="payment-buttons">
                <button class="btn btn-primary" onclick="viewOrder()">
                    <i class="fas fa-box"></i> View Order
                </button>
                <button class="btn btn-secondary" onclick="closeSuccessModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Header -->
<header class="header" id="mainHeader">
  <div class="logo">
    <i class="fa-solid fa-gem"></i>
    <span>IRYA STONE</span>
  </div>
  
  <div class="header-actions">
    <a href="account.html" class="action-btn" title="Account">
      <i class="fas fa-user"></i>
    </a>
    <a href="cart.html" class="action-btn" title="Cart" style="position: relative;">
      <i class="fas fa-shopping-cart"></i>
      <span class="cart-badge" id="cartBadge">0</span>
    </a>
  </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
  <div class="breadcrumb-content">
    <div class="breadcrumb-item">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
    </div>
    <div class="breadcrumb-divider">
      <i class="fas fa-chevron-right"></i>
    </div>
    <div class="breadcrumb-item">
      <a href="orders.html">My Orders</a>
    </div>
    <div class="breadcrumb-divider">
      <i class="fas fa-chevron-right"></i>
    </div>
    <div class="breadcrumb-item active">
      Complete Payment
    </div>
  </div>
</section>

<!-- Main Container -->
<main class="container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>Complete Payment</h1>
    <p>Pay the remaining amount for your order</p>
  </div>
  
  <!-- Payment Info Card -->
  <div class="payment-info-card" id="paymentInfoCard">
    <!-- Urgent badge will be added dynamically -->
    <div class="payment-details">
      <div class="payment-item">
        <div class="payment-label">Order Number</div>
        <div class="payment-value" id="orderNumber">Loading...</div>
      </div>
      <div class="payment-item">
        <div class="payment-label">Remaining Amount</div>
        <div class="payment-value" id="remainingAmount">¬£0.00</div>
      </div>
      <div class="payment-item">
        <div class="payment-label">Total Amount</div>
        <div class="payment-value" id="totalAmount">¬£0.00</div>
      </div>
      <div class="payment-item">
        <div class="payment-label">Already Paid</div>
        <div class="payment-value" id="paidAmount">¬£0.00</div>
      </div>
    </div>
  </div>
  
  <!-- Loading State -->
  <div class="loading" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading payment details...</p>
  </div>
  
  <!-- Error State (Hidden by default) -->
  <div class="error-state" id="errorState" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i>
    <h3 id="errorTitle">Payment Error</h3>
    <p id="errorMessage">An error occurred while loading payment details.</p>
    <button class="btn btn-primary" onclick="retryLoad()" style="margin-top: 20px;">
      <i class="fas fa-redo"></i> Try Again
    </button>
  </div>
  
  <!-- Payment Content (Hidden until loaded) -->
  <div id="paymentContent" style="display: none;">
    
    <!-- Payment Methods -->
    <div class="payment-card">
      <div class="payment-card-header">
        <i class="fas fa-credit-card"></i>
        <h2>Select Payment Method</h2>
      </div>
      <div class="payment-methods">
        <div class="payment-method" onclick="selectPaymentMethod('bank')" id="bankMethod">
          <div class="method-info">
            <div class="method-icon">
              <i class="fas fa-university"></i>
            </div>
            <div class="method-details">
              <h3>Bank Transfer</h3>
              <p>Transfer directly to our bank account</p>
            </div>
          </div>
          <div class="method-check">
            <i class="fas fa-check"></i>
          </div>
        </div>
        
        <div class="payment-method" onclick="selectPaymentMethod('stripe')" id="stripeMethod">
          <div class="method-info">
            <div class="method-icon">
              <i class="fab fa-cc-stripe"></i>
            </div>
            <div class="method-details">
              <h3>Credit/Debit Card</h3>
              <p>Pay securely with Stripe</p>
            </div>
          </div>
          <div class="method-check">
            <i class="fas fa-check"></i>
          </div>
        </div>
        
        <div class="payment-method" onclick="selectPaymentMethod('paypal')" id="paypalMethod">
          <div class="method-info">
            <div class="method-icon">
              <i class="fab fa-paypal"></i>
            </div>
            <div class="method-details">
              <h3>PayPal</h3>
              <p>Pay with your PayPal account</p>
            </div>
          </div>
          <div class="method-check">
            <i class="fas fa-check"></i>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bank Transfer Form -->
    <div class="payment-form" id="bankForm">
      <h3 style="margin-bottom: 20px; color: var(--stone-dark);">
        <i class="fas fa-university"></i> Bank Transfer Details
      </h3>
      
      <div class="form-group">
        <label>Bank Account Details</label>
        <div style="background: var(--bg-light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
          <p><strong>Bank Name:</strong> HSBC UK</p>
          <p><strong>Account Name:</strong> IRYA STONE LTD</p>
          <p><strong>Account Number:</strong> 12345678</p>
          <p><strong>Sort Code:</strong> 40-04-15</p>
          <p><strong>IBAN:</strong> GB29HBUK40127612345678</p>
          <p><strong>SWIFT/BIC:</strong> HBUKGB4B</p>
        </div>
      </div>
      
      <div class="form-group">
        <label>Reference Number (Important!)</label>
        <input type="text" id="bankReference" value="" readonly>
        <small style="color: var(--text-light); display: block; margin-top: 5px;">
          Use this reference when making the transfer
        </small>
      </div>
      
      <div class="form-group">
        <label>Upload Payment Proof (Optional)</label>
        <input type="file" id="paymentProof" accept=".jpg,.jpeg,.png,.pdf">
        <small style="color: var(--text-light); display: block; margin-top: 5px;">
          Upload screenshot or PDF of payment confirmation
        </small>
      </div>
      
      <div class="form-group">
        <label>Additional Notes</label>
        <textarea id="bankNotes" rows="3" placeholder="Add any additional notes about the payment..."></textarea>
      </div>
      
      <div class="payment-buttons" style="margin-top: 30px;">
        <button class="btn btn-primary" onclick="submitBankPayment()">
          <i class="fas fa-paper-plane"></i> Confirm Bank Transfer
        </button>
      </div>
    </div>
    
    <!-- Stripe Card Form -->
    <div class="payment-form" id="stripeForm">
      <h3 style="margin-bottom: 20px; color: var(--stone-dark);">
        <i class="fab fa-cc-stripe"></i> Card Payment
      </h3>
      
      <div class="form-group">
        <label>Card Number</label>
        <div style="position: relative;">
          <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
          <div class="card-icon">
            <i class="far fa-credit-card"></i>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Expiry Date</label>
          <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
        </div>
        <div class="form-group">
          <label>CVC</label>
          <input type="text" id="cardCvc" placeholder="123" maxlength="4">
        </div>
      </div>
      
      <div class="form-group">
        <label>Cardholder Name</label>
        <input type="text" id="cardName" placeholder="John Doe">
      </div>
      
      <div class="payment-buttons" style="margin-top: 30px;">
        <button class="btn btn-primary" onclick="processStripePayment()" id="stripeButton">
          <i class="fas fa-lock"></i> Pay Securely with Stripe
        </button>
      </div>
      
      <div style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-light);">
        <i class="fas fa-shield-alt"></i> Your payment is secured with 256-bit SSL encryption
      </div>
    </div>
    
    <!-- PayPal Form -->
    <div class="payment-form" id="paypalForm">
      <h3 style="margin-bottom: 20px; color: var(--stone-dark);">
        <i class="fab fa-paypal"></i> PayPal Payment
      </h3>
      
      <div style="text-align: center; padding: 30px;">
        <div style="background: var(--bg-light); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px;">
          <p>You will be redirected to PayPal to complete your payment securely.</p>
          <p><strong>Amount:</strong> <span id="paypalAmount">¬£0.00</span></p>
        </div>
        
        <div id="paypal-button-container"></div>
        
        <div style="margin-top: 20px; font-size: 12px; color: var(--text-light);">
          <i class="fas fa-info-circle"></i> After payment, you will be redirected back to track your order
        </div>
      </div>
    </div>
    
    <!-- Order Summary -->
    <div class="order-summary-card">
      <h3>
        <i class="fas fa-box"></i> Order Summary
      </h3>
      
      <div class="order-items" id="orderItems">
        <!-- Order items will be loaded here -->
      </div>
      
      <div class="order-total">
        <div class="total-row">
          <span>Subtotal:</span>
          <span id="subtotalAmount">¬£0.00</span>
        </div>
        <div class="total-row">
          <span>Shipping:</span>
          <span id="shippingAmount">¬£0.00</span>
        </div>
        <div class="total-row">
          <span>Tax:</span>
          <span id="taxAmount">¬£0.00</span>
        </div>
        <div class="total-row">
          <span>Already Paid:</span>
          <span id="paidSummary">¬£0.00</span>
        </div>
        <div class="total-row">
          <span class="remaining-amount">Remaining Amount:</span>
          <span class="remaining-amount" id="remainingSummary">¬£0.00</span>
        </div>
        <div class="total-row">
          <span><strong>Total:</strong></span>
          <span><strong id="totalSummary">¬£0.00</strong></span>
        </div>
      </div>
    </div>
    
    <!-- Payment Actions -->
    <div class="payment-actions">
      <div class="payment-buttons">
        <button class="btn btn-primary" onclick="processPayment()" id="processPaymentBtn">
          <i class="fas fa-money-bill-wave"></i> Complete Payment
        </button>
        <button class="btn btn-secondary" onclick="goBackToOrders()">
          <i class="fas fa-arrow-left"></i> Back to Orders
        </button>
      </div>
      <div style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--text-light);">
        <i class="fas fa-clock"></i> Complete your payment to avoid order cancellation
      </div>
    </div>
  </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="bottomNav">
  <a href="index.html" class="nav-btn">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="products.html" class="nav-btn">
    <i class="fas fa-th-large"></i>
    <span>Products</span>
  </a>
  <a href="orders.html" class="nav-btn active">
    <i class="fas fa-box"></i>
    <span>Orders</span>
  </a>
  <a href="account.html" class="nav-btn">
    <i class="fas fa-user"></i>
    <span>Account</span>
  </a>
</nav>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  doc, 
  getDoc, 
  updateDoc,
  arrayUnion,
  serverTimestamp,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// GLOBAL VARIABLES
// ============================================

let currentUserId = null;
let paymentData = null;
let orderData = null;
let selectedPaymentMethod = 'bank';
let isUrgentPayment = false;

// ============================================
// SCROLL HIDE/SHOW HEADER & FOOTER
// ============================================

let lastScrollTop = 0;
const header = document.getElementById('mainHeader');
const bottomNav = document.getElementById('bottomNav');
const SCROLL_THRESHOLD = 50;

function handleScroll() {
  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
  
  if (scrollTop > lastScrollTop && scrollTop > SCROLL_THRESHOLD) {
    header.classList.add('hide');
    bottomNav.classList.add('hide');
  } else {
    header.classList.remove('hide');
    bottomNav.classList.remove('hide');
  }
  
  lastScrollTop = scrollTop;
}

window.addEventListener('scroll', handleScroll, { passive: true });

// ============================================
// USER ID MANAGEMENT
// ============================================

async function getUserId() {
  try {
    // Check if we have a saved user
    const savedUser = localStorage.getItem('irya_stone_auth_user');
    if (savedUser) {
      const user = JSON.parse(savedUser);
      currentUserId = user.uid;
      console.log("‚úÖ Authenticated user detected:", currentUserId);
      return currentUserId;
    }

    // Check for guest user
    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
      // Check URL parameters for user ID
      const urlParams = new URLSearchParams(window.location.search);
      const urlUserId = urlParams.get('user');
      if (urlUserId) {
        guestId = urlUserId;
      } else {
        guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }
      localStorage.setItem('irya_guest_id', guestId);
    }
    
    currentUserId = guestId;
    console.log("üë§ Guest user detected:", currentUserId);
    
    return currentUserId;
    
  } catch (error) {
    console.error("‚ùå Error getting user ID:", error);
    currentUserId = 'guest_' + Date.now();
    return currentUserId;
  }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log("üí∞ Checkout page loaded for pending payment");
    
    await getUserId();
    await loadPaymentData();
    checkCartBadge();
    
  } catch (error) {
    console.error("‚ùå Error initializing:", error);
    showError("Initialization Error", "Failed to load payment page. Please try again.");
  }
});

// ============================================
// PAYMENT DATA LOADING
// ============================================

async function loadPaymentData() {
  try {
    showLoading(true);
    
    // Check URL parameters first
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order');
    const paymentType = urlParams.get('type');
    const source = urlParams.get('source');
    const amount = urlParams.get('amount');
    
    console.log("üìã URL Parameters:", { orderId, paymentType, source, amount });
    
    // Check localStorage for pending payment data
    const storedPayment = localStorage.getItem('irya_pending_payment_order');
    
    if (storedPayment) {
      paymentData = JSON.parse(storedPayment);
      console.log("üì¶ Loaded payment data from localStorage:", paymentData);
      
      // Check if this is an urgent payment (from notification)
      if (paymentData.source === 'notification' || 
          paymentData.notificationType === 'payment_remaining_warning') {
        isUrgentPayment = true;
        addUrgentBadge();
      }
      
      await loadOrderDetails(paymentData.orderId);
      
    } else if (orderId) {
      // Load from Firebase using orderId
      paymentData = {
        orderId: orderId,
        orderType: 'existing_order',
        paymentType: paymentType || 'remaining_payment',
        source: source || 'direct_link',
        remainingAmount: parseFloat(amount) || 0
      };
      
      await loadOrderDetails(orderId);
      
    } else {
      showError("No Payment Data", "No payment information found. Please go back to your orders.");
      return;
    }
    
    // Update UI with payment data
    updatePaymentUI();
    showLoading(false);
    document.getElementById('paymentContent').style.display = 'block';
    
    // Set default payment method
    selectPaymentMethod('bank');
    
  } catch (error) {
    console.error("‚ùå Error loading payment data:", error);
    showError("Load Error", "Failed to load payment details. Please try again.");
    showLoading(false);
  }
}

async function loadOrderDetails(orderId) {
  try {
    console.log("üîç Loading order details for:", orderId);
    
    // Try user-specific orders collection first
    try {
      const orderDoc = await getDoc(doc(db, "users", currentUserId, "orders", orderId));
      if (orderDoc.exists()) {
        orderData = orderDoc.data();
        orderData.id = orderDoc.id;
        console.log("‚úÖ Order found in user collection:", orderData);
        return;
      }
    } catch (error) {
      console.log("User collection ‡§Æ‡•á‡§Ç order ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ, main collection ‡§Æ‡•á‡§Ç check ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç");
    }
    
    // Try main orders collection
    const ordersRef = collection(db, "orders");
    const orderQuery = query(ordersRef, where("__name__", "==", orderId));
    const orderSnapshot = await getDocs(orderQuery);
    
    if (!orderSnapshot.empty) {
      orderData = orderSnapshot.docs[0].data();
      orderData.id = orderSnapshot.docs[0].id;
      console.log("‚úÖ Order found in main collection:", orderData);
      return;
    }
    
    // If still not found, try by order number
    if (paymentData.orderNumber) {
      const orderNumberQuery = query(ordersRef, where("orderNumber", "==", paymentData.orderNumber));
      const orderNumberSnapshot = await getDocs(orderNumberQuery);
      
      if (!orderNumberSnapshot.empty) {
        orderData = orderNumberSnapshot.docs[0].data();
        orderData.id = orderNumberSnapshot.docs[0].id;
        console.log("‚úÖ Order found by order number:", orderData);
        return;
      }
    }
    
    throw new Error("Order not found");
    
  } catch (error) {
    console.error("‚ùå Error loading order details:", error);
    throw error;
  }
}

function updatePaymentUI() {
  if (!paymentData || !orderData) return;
  
  // Update payment info card
  document.getElementById('orderNumber').textContent = 
    orderData.orderNumber || paymentData.orderNumber || orderData.id.substring(0, 8);
  
  const remainingAmount = paymentData.remainingAmount || 
    orderData.remainingPayment || 
    (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
  
  const totalAmount = paymentData.totalAmount || orderData.total || 0;
  const paidAmount = paymentData.paidAmount || 
    orderData.submittedAmount || 
    orderData.advancePayment || 
    0;
  
  document.getElementById('remainingAmount').textContent = `¬£${remainingAmount.toFixed(2)}`;
  document.getElementById('totalAmount').textContent = `¬£${totalAmount.toFixed(2)}`;
  document.getElementById('paidAmount').textContent = `¬£${paidAmount.toFixed(2)}`;
  
  // Update order summary
  document.getElementById('subtotalAmount').textContent = `¬£${(orderData.subtotal || orderData.total || 0).toFixed(2)}`;
  document.getElementById('shippingAmount').textContent = `¬£${(orderData.shippingCost || 0).toFixed(2)}`;
  document.getElementById('taxAmount').textContent = `¬£${(orderData.tax || 0).toFixed(2)}`;
  document.getElementById('paidSummary').textContent = `¬£${paidAmount.toFixed(2)}`;
  document.getElementById('remainingSummary').textContent = `¬£${remainingAmount.toFixed(2)}`;
  document.getElementById('totalSummary').textContent = `¬£${totalAmount.toFixed(2)}`;
  
  // Update PayPal amount
  document.getElementById('paypalAmount').textContent = `¬£${remainingAmount.toFixed(2)}`;
  
  // Generate bank reference
  const bankReference = `IRYA-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
  document.getElementById('bankReference').value = bankReference;
  
  // Update order items
  updateOrderItems();
  
  // Update payment button
  document.getElementById('processPaymentBtn').innerHTML = `
    <i class="fas fa-money-bill-wave"></i> 
    Pay Remaining ¬£${remainingAmount.toFixed(2)}
  `;
}

function updateOrderItems() {
  const orderItemsDiv = document.getElementById('orderItems');
  
  if (!orderData.items || orderData.items.length === 0) {
    orderItemsDiv.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--text-light);">
        <i class="fas fa-box-open"></i>
        <p>No items found</p>
      </div>
    `;
    return;
  }
  
  let itemsHTML = '';
  
  orderData.items.forEach(item => {
    const itemName = item.name || item.stoneName || item.productName || 'Product';
    const quantity = item.quantity || 1;
    const price = item.price || 0;
    const totalPrice = item.calculatedPrice || item.totalPrice || price * quantity;
    const image = item.image || 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
    
    itemsHTML += `
      <div class="order-item">
        <div class="item-image">
          <img src="${image}" alt="${itemName}" loading="lazy"
               onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80'">
        </div>
        <div class="item-details">
          <div class="item-name">${itemName}</div>
          <div class="item-meta">
            Quantity: ${quantity} ‚Ä¢ Price: ¬£${price.toFixed(2)}
          </div>
          <div class="item-price">Total: ¬£${totalPrice.toFixed(2)}</div>
        </div>
      </div>
    `;
  });
  
  orderItemsDiv.innerHTML = itemsHTML;
}

function addUrgentBadge() {
  const paymentInfoCard = document.getElementById('paymentInfoCard');
  const urgentBadge = document.createElement('div');
  urgentBadge.className = 'payment-urgent-badge';
  urgentBadge.innerHTML = '<i class="fas fa-exclamation-circle"></i> URGENT PAYMENT';
  urgentBadge.style.position = 'absolute';
  urgentBadge.style.top = '-10px';
  urgentBadge.style.right = '-10px';
  urgentBadge.style.zIndex = '3';
  paymentInfoCard.appendChild(urgentBadge);
}

// ============================================
// PAYMENT METHODS
// ============================================

function selectPaymentMethod(method) {
  selectedPaymentMethod = method;
  
  // Update UI
  document.querySelectorAll('.payment-method').forEach(el => {
    el.classList.remove('selected');
  });
  
  document.getElementById(method + 'Method').classList.add('selected');
  
  // Show selected form
  document.querySelectorAll('.payment-form').forEach(form => {
    form.classList.remove('active');
  });
  
  document.getElementById(method + 'Form').classList.add('active');
  
  // Update payment button text
  const remainingAmount = paymentData.remainingAmount || 
    orderData.remainingPayment || 
    (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
  
  const buttonText = method === 'bank' ? 'Confirm Bank Transfer' :
                    method === 'stripe' ? 'Pay with Card' :
                    method === 'paypal' ? 'Pay with PayPal' : 'Complete Payment';
  
  document.getElementById('processPaymentBtn').innerHTML = `
    <i class="fas fa-${method === 'bank' ? 'university' : method === 'stripe' ? 'credit-card' : 'paypal'}"></i> 
    ${buttonText} ¬£${remainingAmount.toFixed(2)}
  `;
}

// ============================================
|  PAYMENT PROCESSING
// ============================================

async function processPayment() {
  try {
    if (!paymentData || !orderData) {
      showError("Payment Error", "Payment data not loaded properly.");
      return;
    }
    
    const remainingAmount = paymentData.remainingAmount || 
      orderData.remainingPayment || 
      (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    
    if (remainingAmount <= 0) {
      showError("Payment Error", "No remaining amount to pay.");
      return;
    }
    
    // Disable button
    const btn = document.getElementById('processPaymentBtn');
    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;
    
    // Process based on selected method
    if (selectedPaymentMethod === 'bank') {
      await submitBankPayment();
    } else if (selectedPaymentMethod === 'stripe') {
      await processStripePayment();
    } else if (selectedPaymentMethod === 'paypal') {
      await processPayPalPayment();
    }
    
  } catch (error) {
    console.error("‚ùå Error processing payment:", error);
    showError("Processing Error", "Failed to process payment. Please try again.");
    
    // Re-enable button
    const btn = document.getElementById('processPaymentBtn');
    btn.disabled = false;
    btn.innerHTML = `<i class="fas fa-money-bill-wave"></i> Complete Payment`;
  }
}

async function submitBankPayment() {
  try {
    const remainingAmount = paymentData.remainingAmount || 
      orderData.remainingPayment || 
      (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    
    const reference = document.getElementById('bankReference').value;
    const notes = document.getElementById('bankNotes').value;
    
    // Create payment record
    const paymentRecord = {
      orderId: orderData.id,
      orderNumber: orderData.orderNumber || paymentData.orderNumber,
      userId: currentUserId,
      amount: remainingAmount,
      paymentMethod: 'bank_transfer',
      reference: reference,
      status: 'pending',
      notes: notes,
      createdAt: new Date().toISOString(),
      type: 'remaining_payment',
      source: paymentData.source || 'checkout_page'
    };
    
    // Save to Firebase
    const userPaymentsRef = collection(db, "users", currentUserId, "payments");
    // Note: In production, you would use addDoc here
    // await addDoc(userPaymentsRef, paymentRecord);
    
    // Update order status
    await updateOrderAfterPayment(remainingAmount, 'bank_transfer', reference);
    
    // Show success
    showSuccessModal({
      amount: remainingAmount,
      method: 'Bank Transfer',
      reference: reference,
      orderNumber: orderData.orderNumber || paymentData.orderNumber
    });
    
    // Clear localStorage
    localStorage.removeItem('irya_pending_payment_order');
    
  } catch (error) {
    console.error("‚ùå Error submitting bank payment:", error);
    showError("Bank Payment Error", "Failed to record bank transfer. Please contact support.");
    throw error;
  }
}

async function processStripePayment() {
  try {
    const cardNumber = document.getElementById('cardNumber').value;
    const cardExpiry = document.getElementById('cardExpiry').value;
    const cardCvc = document.getElementById('cardCvc').value;
    const cardName = document.getElementById('cardName').value;
    
    // Basic validation
    if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
      showError("Validation Error", "Please fill in all card details.");
      return;
    }
    
    const remainingAmount = paymentData.remainingAmount || 
      orderData.remainingPayment || 
      (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    
    // In production, you would integrate with Stripe API here
    // For demo purposes, we'll simulate a successful payment
    
    const stripeBtn = document.getElementById('stripeButton');
    stripeBtn.disabled = true;
    stripeBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing with Stripe...`;
    
    // Simulate API call delay
    setTimeout(async () => {
      const transactionId = 'stripe_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Update order status
      await updateOrderAfterPayment(remainingAmount, 'stripe', transactionId);
      
      // Show success
      showSuccessModal({
        amount: remainingAmount,
        method: 'Credit/Debit Card',
        reference: transactionId,
        orderNumber: orderData.orderNumber || paymentData.orderNumber
      });
      
      // Clear localStorage
      localStorage.removeItem('irya_pending_payment_order');
      
    }, 2000);
    
  } catch (error) {
    console.error("‚ùå Error processing Stripe payment:", error);
    showError("Stripe Error", "Payment processing failed. Please try again.");
    throw error;
  }
}

async function processPayPalPayment() {
  try {
    const remainingAmount = paymentData.remainingAmount || 
      orderData.remainingPayment || 
      (orderData.total - (orderData.submittedAmount || orderData.advancePayment || 0));
    
    // In production, you would integrate with PayPal SDK here
    // For demo purposes, we'll show instructions
    
    showMessage(`PayPal Integration: Amount ¬£${remainingAmount.toFixed(2)}
    
In a production environment, this would redirect to PayPal for payment processing.
After successful payment, PayPal would redirect back with a transaction ID.`, 'info');
    
  } catch (error) {
    console.error("‚ùå Error processing PayPal payment:", error);
    showError("PayPal Error", "PayPal integration error. Please try another method.");
    throw error;
  }
}

async function updateOrderAfterPayment(amount, method, transactionId) {
  try {
    // Calculate new payment totals
    const currentPaid = orderData.submittedAmount || orderData.advancePayment || 0;
    const newPaid = currentPaid + amount;
    const total = orderData.total || 0;
    const newRemaining = total - newPaid;
    
    // Determine new payment status
    let newPaymentStatus = orderData.paymentStatus || 'advance_paid';
    if (newRemaining <= 0) {
      newPaymentStatus = 'fully_paid';
    }
    
    // Create payment history entry
    const paymentEntry = {
      amount: amount,
      method: method,
      transactionId: transactionId,
      date: new Date().toISOString(),
      type: 'remaining_payment',
      status: 'completed'
    };
    
    // Update order in Firebase
    // Note: In production, you would properly update the document
    console.log("üìù Updating order with payment:", {
      orderId: orderData.id,
      newPaid: newPaid,
      newRemaining: newRemaining,
      newPaymentStatus: newPaymentStatus,
      paymentEntry: paymentEntry
    });
    
    // Simulate update for demo
    // await updateDoc(doc(db, "orders", orderData.id), {
    //   submittedAmount: newPaid,
    //   remainingPayment: newRemaining,
    //   paymentStatus: newPaymentStatus,
    //   paymentHistory: arrayUnion(paymentEntry),
    //   updatedAt: serverTimestamp()
    // });
    
    // Create notification for successful payment
    await createPaymentNotification(amount, method);
    
    console.log("‚úÖ Order updated successfully");
    
  } catch (error) {
    console.error("‚ùå Error updating order:", error);
    throw error;
  }
}

async function createPaymentNotification(amount, method) {
  try {
    // In production, you would add this to the notifications collection
    const notification = {
      userId: currentUserId,
      orderId: orderData.id,
      orderNumber: orderData.orderNumber || paymentData.orderNumber,
      type: 'payment_completed',
      title: `Payment Received - ¬£${amount.toFixed(2)}`,
      message: `Your remaining payment of ¬£${amount.toFixed(2)} has been received via ${method}.`,
      read: false,
      createdAt: new Date().toISOString()
    };
    
    console.log("üì¢ Payment notification created:", notification);
    
    // Example: Save to localStorage for demo
    const notifications = JSON.parse(localStorage.getItem('irya_notifications') || '[]');
    notifications.push(notification);
    localStorage.setItem('irya_notifications', JSON.stringify(notifications));
    
  } catch (error) {
    console.error("‚ùå Error creating notification:", error);
  }
}

// ============================================
// UI HELPER FUNCTIONS
// ============================================

function showLoading(show) {
  document.getElementById('loadingState').style.display = show ? 'block' : 'none';
}

function showError(title, message) {
  document.getElementById('errorTitle').textContent = title;
  document.getElementById('errorMessage').textContent = message;
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('paymentContent').style.display = 'none';
  document.getElementById('loadingState').style.display = 'none';
}

function retryLoad() {
  document.getElementById('errorState').style.display = 'none';
  loadPaymentData();
}

function showMessage(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: ${type === 'info' ? 'var(--primary-gold)' : type === 'error' ? 'var(--payment-pending)' : 'var(--payment-full)'};
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
    max-width: 90%;
    word-wrap: break-word;
    white-space: pre-line;
  `;
  
  toast.innerHTML = `
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
    <div style="display: flex; align-items: flex-start; gap: 10px;">
      <i class="fas fa-${type === 'info' ? 'info-circle' : type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 5000);
}

function showSuccessModal(details) {
  const modal = document.getElementById('successModal');
  const detailsDiv = document.getElementById('successDetails');
  
  detailsDiv.innerHTML = `
    <div>
      <strong>Order Number:</strong> ${details.orderNumber}
    </div>
    <div>
      <strong>Amount Paid:</strong> ¬£${details.amount.toFixed(2)}
    </div>
    <div>
      <strong>Payment Method:</strong> ${details.method}
    </div>
    <div>
      <strong>Reference:</strong> ${details.reference}
    </div>
    <div>
      <strong>Status:</strong> 
      <span style="color: var(--payment-full); font-weight: 600;">
        <i class="fas fa-check-circle"></i> Payment Successful
      </span>
    </div>
  `;
  
  modal.style.display = 'flex';
}

function closeSuccessModal() {
  document.getElementById('successModal').style.display = 'none';
  goBackToOrders();
}

function viewOrder() {
  closeSuccessModal();
  
  // Redirect to orders page with the specific order
  const orderId = orderData.id || paymentData.orderId;
  window.location.href = `orders.html?order_id=${orderId}`;
}

function goBackToOrders() {
  window.location.href = 'orders.html';
}

function checkCartBadge() {
  try {
    const userId = localStorage.getItem('irya_guest_id') || 'guest';
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  } catch (error) {
    console.error('‚ùå Error updating cart badge:', error);
  }
}

// ============================================
// CARD INPUT FORMATTING
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  // Card number formatting
  const cardNumberInput = document.getElementById('cardNumber');
  if (cardNumberInput) {
    cardNumberInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
      let formatted = '';
      
      for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) {
          formatted += ' ';
        }
        formatted += value[i];
      }
      
      e.target.value = formatted.substring(0, 19);
    });
  }
  
  // Expiry date formatting
  const expiryInput = document.getElementById('cardExpiry');
  if (expiryInput) {
    expiryInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/[^0-9]/gi, '');
      
      if (value.length >= 2) {
        e.target.value = value.substring(0, 2) + '/' + value.substring(2, 4);
      } else {
        e.target.value = value;
      }
    });
  }
  
  // CVC formatting
  const cvcInput = document.getElementById('cardCvc');
  if (cvcInput) {
    cvcInput.addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^0-9]/gi, '').substring(0, 4);
    });
  }
});

// Make functions available globally
window.selectPaymentMethod = selectPaymentMethod;
window.processPayment = processPayment;
window.submitBankPayment = submitBankPayment;
window.processStripePayment = processStripePayment;
window.processPayPalPayment = processPayPalPayment;
window.goBackToOrders = goBackToOrders;
window.viewOrder = viewOrder;
window.closeSuccessModal = closeSuccessModal;
window.retryLoad = retryLoad;
</script>

</body>
</html>
