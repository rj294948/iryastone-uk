<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Notifications | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Notification colors */
    --info: #339af0;
    --success: #51cf66;
    --warning: #ff922b;
    --danger: #ff6b6b;
    --payment: #cc5de8;
    --shipping: #748ffc;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* ===== HEADER ===== */
.header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* ===== BOTTOM NAV ===== */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* ===== BREADCRUMB ===== */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* ===== MAIN CONTAINER ===== */
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 16px;
}

.page-header {
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.page-header h1 {
    font-size: 28px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 8px;
}

.page-header p {
    color: var(--text-light);
    font-size: 14px;
}

.header-actions-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* ===== NOTIFICATION FILTER ===== */
.notification-filter {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.filter-btn.active {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

.filter-btn i {
    font-size: 12px;
}

/* ===== NOTIFICATIONS LIST ===== */
.notifications-list {
    background: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.notification-item {
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
}

.notification-item:hover {
    background: var(--bg-light);
}

.notification-item.unread {
    background: rgba(201, 162, 39, 0.05);
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.notification-title {
    font-weight: 600;
    font-size: 16px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.notification-type {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.notification-type.payment {
    background: rgba(204, 93, 232, 0.1);
    color: var(--payment);
    border: 1px solid rgba(204, 93, 232, 0.2);
}

.notification-type.order {
    background: rgba(116, 143, 252, 0.1);
    color: var(--shipping);
    border: 1px solid rgba(116, 143, 252, 0.2);
}

.notification-type.system {
    background: rgba(51, 154, 240, 0.1);
    color: var(--info);
    border: 1px solid rgba(51, 154, 240, 0.2);
}

.notification-type.promotion {
    background: rgba(255, 146, 43, 0.1);
    color: var(--warning);
    border: 1px solid rgba(255, 146, 43, 0.2);
}

.notification-time {
    font-size: 12px;
    color: var(--text-light);
    white-space: nowrap;
}

.notification-message {
    color: var(--text-dark);
    margin-bottom: 15px;
    line-height: 1.6;
}

/* ===== PRODUCT IMAGE IN NOTIFICATION ===== */
.notification-product {
    display: flex;
    gap: 15px;
    margin: 15px 0;
    padding: 15px;
    background: var(--bg-light);
    border-radius: 8px;
    border: 1px solid #f0f0f0;
}

.product-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-details {
    flex: 1;
}

.product-name {
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--stone-dark);
}

.product-meta {
    font-size: 12px;
    color: var(--text-light);
    margin-bottom: 8px;
}

.product-price {
    font-weight: 600;
    color: var(--primary-gold);
    font-size: 14px;
}

/* ===== NOTIFICATION ACTIONS ===== */
.notification-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.action-btn-small {
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
    border: 1px solid #e0e0e0;
    background: var(--white);
}

.action-btn-small:hover {
    background: var(--bg-light);
}

.action-btn-small.primary {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

.action-btn-small.primary:hover {
    background: var(--gold-dark);
}

.action-btn-small.success {
    background: var(--success);
    color: var(--white);
    border-color: var(--success);
}

.action-btn-small.success:hover {
    background: #40c057;
}

.action-btn-small.danger {
    background: var(--danger);
    color: var(--white);
    border-color: var(--danger);
}

.action-btn-small.danger:hover {
    background: #fa5252;
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #f0f0f0;
}

.empty-state i {
    font-size: 48px;
    color: #e0e0e0;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: var(--text-light);
    margin-bottom: 10px;
    font-weight: 600;
}

.empty-state p {
    color: var(--text-light);
    margin-bottom: 20px;
}

/* ===== LOADING ===== */
.loading {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-light);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(201, 162, 39, 0.1);
    border-top-color: var(--primary-gold);
    border-radius: 50%;
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== CART BADGE ===== */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ===== TOAST MESSAGE ===== */
.toast {
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--primary-gold);
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
    max-width: 90%;
    word-wrap: break-word;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .breadcrumb {
        padding: 80px 16px 20px;
    }
    
    .container {
        margin: 20px auto;
    }
    
    .notification-filter {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-btn {
        width: 100%;
        justify-content: center;
    }
    
    .notification-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .notification-time {
        align-self: flex-start;
    }
    
    .notification-product {
        flex-direction: column;
    }
    
    .product-image {
        width: 100%;
        height: 150px;
    }
    
    .notification-actions {
        flex-direction: column;
    }
    
    .action-btn-small {
        width: 100%;
        justify-content: center;
    }
}

@media (max-width: 480px) {
    .header {
        padding: 10px 12px;
    }
    
    .logo span {
        font-size: 16px;
    }
    
    .page-header h1 {
        font-size: 24px;
    }
    
    .notification-item {
        padding: 15px;
    }
    
    .notification-title {
        font-size: 14px;
    }
}
</style>
</head>

<body>

<!-- Header -->
<header class="header">
  <a href="index.html" class="action-btn">
    <i class="fas fa-arrow-left"></i>
  </a>
  
  <div class="logo">
    <i class="fa-solid fa-gem"></i>
    <span>IRYA STONE</span>
  </div>
  
  <div class="header-actions">
    <a href="account.html" class="action-btn" title="Account">
      <i class="fas fa-user"></i>
    </a>
    <a href="cart.html" class="action-btn" title="Cart" style="position: relative;">
      <i class="fas fa-shopping-cart"></i>
      <span class="cart-badge" id="cartBadge">0</span>
    </a>
  </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
  <div class="breadcrumb-content">
    <div class="breadcrumb-item">
      <a href="index.html"><i class="fas fa-home"></i> Home</a>
    </div>
    <div class="breadcrumb-divider">
      <i class="fas fa-chevron-right"></i>
    </div>
    <div class="breadcrumb-item active">
      Notifications
    </div>
  </div>
</section>

<!-- Main Container -->
<main class="container">
  <div class="page-header">
    <div>
      <h1>Notifications</h1>
      <p>Stay updated with your orders and activities</p>
    </div>
    <div class="header-actions-container">
      <button class="filter-btn" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Mark all read
      </button>
      <button class="filter-btn" onclick="clearAllNotifications()">
        <i class="fas fa-trash"></i> Clear all
      </button>
    </div>
  </div>
  
  <!-- Notification Filter -->
  <div class="notification-filter">
    <button class="filter-btn active" onclick="filterNotifications('all')">
      <i class="fas fa-bell"></i> All
    </button>
    <button class="filter-btn" onclick="filterNotifications('unread')">
      <i class="fas fa-envelope"></i> Unread
    </button>
    <button class="filter-btn" onclick="filterNotifications('payment')">
      <i class="fas fa-money-bill-wave"></i> Payments
    </button>
    <button class="filter-btn" onclick="filterNotifications('order')">
      <i class="fas fa-box"></i> Orders
    </button>
    <button class="filter-btn" onclick="filterNotifications('system')">
      <i class="fas fa-cog"></i> System
    </button>
  </div>
  
  <!-- Notifications List -->
  <div class="notifications-list" id="notificationsList">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading notifications...</p>
    </div>
  </div>
</main>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-btn">
    <i class="fas fa-home"></i>
    <span>Home</span>
  </a>
  <a href="products.html" class="nav-btn">
    <i class="fas fa-th-large"></i>
    <span>Products</span>
  </a>
  <a href="orders.html" class="nav-btn">
    <i class="fas fa-box"></i>
    <span>Orders</span>
  </a>
  <a href="notifications.html" class="nav-btn active">
    <i class="fas fa-bell"></i>
    <span>Alerts</span>
    <span class="cart-badge" id="bottomNavBadge" style="position: absolute; top: -2px; right: 15px;">0</span>
  </a>
  <a href="account.html" class="nav-btn">
    <i class="fas fa-user"></i>
    <span>Account</span>
  </a>
</nav>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  updateDoc,
  doc,
  deleteDoc,
  where,
  getDocs,
  getDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// USER ID MANAGEMENT
// ============================================

let currentUserId = null;
let currentUserName = null;
let currentUserEmail = null;

async function getUserId() {
  try {
    // Check if we have a saved user
    const savedUser = localStorage.getItem('irya_stone_auth_user');
    if (savedUser) {
      const user = JSON.parse(savedUser);
      currentUserId = user.uid;
      currentUserName = user.name || user.displayName;
      currentUserEmail = user.email;
      console.log("‚úÖ Authenticated user detected:", currentUserId);
      return currentUserId;
    }

    // Check for guest user
    let guestId = localStorage.getItem('irya_guest_id');
    if (!guestId) {
      guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('irya_guest_id', guestId);
    }
    
    currentUserId = guestId;
    console.log("üë§ Guest user detected:", currentUserId);
    
    return currentUserId;
    
  } catch (error) {
    console.error("‚ùå Error getting user ID:", error);
    currentUserId = 'guest_' + Date.now();
    return currentUserId;
  }
}

// ============================================
// GLOBAL VARIABLES
// ============================================

let notifications = [];
let currentFilter = 'all';
let notificationsUnsubscribe = null;

// ============================================
// NOTIFICATIONS MANAGEMENT
// ============================================

async function loadNotifications() {
  try {
    const userId = await getUserId();
    console.log("üì± Loading notifications for user:", userId);
    
    setupNotificationsListener();
    updateCartBadge();
    
  } catch (error) {
    console.error("‚ùå Error loading notifications:", error);
    showEmptyState("Failed to load notifications. Please try again.");
  }
}

async function setupNotificationsListener() {
  const notificationsList = document.getElementById("notificationsList");
  
  if (notificationsUnsubscribe) notificationsUnsubscribe();
  
  // Show loading state
  notificationsList.innerHTML = `
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading notifications...</p>
    </div>
  `;
  
  try {
    // Try user-specific notifications collection
    const notificationsRef = collection(db, "users", currentUserId, "notifications");
    const notificationsQuery = query(notificationsRef, orderBy("createdAt", "desc"));
    
    notificationsUnsubscribe = onSnapshot(notificationsQuery,
      async (snapshot) => {
        notifications = [];
        
        if (snapshot.empty) {
          showEmptyState("No notifications yet");
          updateBadges(0);
          return;
        }
        
        // Process each notification
        const notificationPromises = [];
        
        for (const docSnapshot of snapshot.docs) {
          const notification = docSnapshot.data();
          notification.id = docSnapshot.id;
          
          // Add missing fields for backward compatibility
          if (!notification.type) {
            notification.type = determineNotificationType(notification);
          }
          
          if (!notification.priority) {
            notification.priority = determinePriority(notification);
          }
          
          // Fetch product images if productId is available
          if (notification.productId) {
            notificationPromises.push(fetchProductImage(notification));
          }
          
          notifications.push(notification);
        }
        
        // Wait for all product images to load
        if (notificationPromises.length > 0) {
          await Promise.all(notificationPromises);
        }
        
        console.log(`‚úÖ Loaded ${notifications.length} notifications for user: ${currentUserId}`);
        displayNotifications(notifications);
        
        // Update badges
        const unreadCount = notifications.filter(n => !n.read).length;
        updateBadges(unreadCount);
        
      },
      (error) => {
        console.error("‚ùå Error in notifications listener:", error);
        notificationsList.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Connection Error</h3>
            <p>Please check your internet connection</p>
            <button class="filter-btn active" onclick="loadNotifications()" style="margin-top: 20px;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    );
    
  } catch (error) {
    console.error("‚ùå Setup error:", error);
    showEmptyState("Failed to setup notifications. Please refresh.");
  }
}

// Fetch product image from Firestore
async function fetchProductImage(notification) {
  try {
    if (!notification.productId) return;
    
    const productDoc = await getDoc(doc(db, "products", notification.productId));
    
    if (productDoc.exists()) {
      const productData = productDoc.data();
      
      // Extract image URL from images array
      if (productData.images && Array.isArray(productData.images) && productData.images.length > 0) {
        if (typeof productData.images[0] === 'string') {
          notification.productImage = productData.images[0];
        } else if (productData.images[0].url) {
          notification.productImage = productData.images[0].url;
        } else if (productData.images[0].imageUrl) {
          notification.productImage = productData.images[0].imageUrl;
        }
      } else if (productData.imageUrl) {
        notification.productImage = productData.imageUrl;
      } else if (productData.image) {
        notification.productImage = productData.image;
      }
      
      // Set product details
      notification.productName = productData.name || productData.title || "Stone Product";
      notification.productCategory = productData.category || "Stone";
      notification.productPrice = productData.price || productData.startingPrice || 0;
    }
    
    // If still no image, try stone collection
    if (!notification.productImage) {
      try {
        const stoneDoc = await getDoc(doc(db, "stone", notification.productId));
        if (stoneDoc.exists()) {
          const stoneData = stoneDoc.data();
          notification.productImage = stoneData.imageUrl || stoneData.image;
        }
      } catch (stoneError) {
        console.log("Stone collection ‡§Æ‡•á‡§Ç image ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä");
      }
    }
    
    // Set default image if none found
    if (!notification.productImage) {
      notification.productImage = getDefaultImage(notification.productCategory);
    }
    
  } catch (error) {
    console.warn("‚ö†Ô∏è Product image fetch error:", error);
    notification.productImage = getDefaultImage();
  }
}

function getDefaultImage(category) {
  const categoryLower = (category || '').toLowerCase();
  
  if (categoryLower.includes('sand')) {
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('kota')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('granite')) {
    return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800&q=80';
  } else if (categoryLower.includes('marble')) {
    return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800&q=80';
  }
  
  return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800&q=80';
}

function determineNotificationType(notification) {
  const title = notification.title || '';
  const message = notification.message || '';
  const type = notification.type || '';
  
  if (type) return type;
  
  if (title.toLowerCase().includes('payment') || 
      message.toLowerCase().includes('payment') ||
      message.toLowerCase().includes('paid') ||
      message.toLowerCase().includes('amount') ||
      message.toLowerCase().includes('¬£') ||
      message.toLowerCase().includes('$') ||
      title.toLowerCase().includes('remaining')) {
    return 'payment';
  }
  
  if (title.toLowerCase().includes('order') || 
      message.toLowerCase().includes('order') ||
      message.toLowerCase().includes('shipped') ||
      message.toLowerCase().includes('delivered') ||
      message.toLowerCase().includes('tracking')) {
    return 'order';
  }
  
  if (title.toLowerCase().includes('offer') || 
      message.toLowerCase().includes('offer') ||
      message.toLowerCase().includes('discount') ||
      message.toLowerCase().includes('promo')) {
    return 'promotion';
  }
  
  return 'system';
}

function determinePriority(notification) {
  const title = notification.title || '';
  const message = notification.message || '';
  
  if (title.toLowerCase().includes('urgent') || 
      title.toLowerCase().includes('important') ||
      message.toLowerCase().includes('urgent') ||
      message.toLowerCase().includes('important') ||
      title.toLowerCase().includes('warning')) {
    return 'high';
  }
  
  if (title.toLowerCase().includes('remaining') || 
      message.toLowerCase().includes('remaining')) {
    return 'medium';
  }
  
  return 'low';
}

function displayNotifications(notificationsList) {
  const notificationsListDiv = document.getElementById("notificationsList");
  
  if (!notificationsList || notificationsList.length === 0) {
    showEmptyState("No notifications yet");
    return;
  }
  
  // Apply filter
  let filteredNotifications = notificationsList;
  
  switch(currentFilter) {
    case 'unread':
      filteredNotifications = notificationsList.filter(n => !n.read);
      break;
    case 'payment':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'payment' || 
        (n.title && n.title.toLowerCase().includes('payment')) ||
        (n.message && n.message.toLowerCase().includes('payment'))
      );
      break;
    case 'order':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'order' ||
        (n.title && n.title.toLowerCase().includes('order')) ||
        (n.message && n.message.toLowerCase().includes('order'))
      );
      break;
    case 'system':
      filteredNotifications = notificationsList.filter(n => 
        n.type === 'system' ||
        (!n.type && !n.title?.toLowerCase().includes('payment') && !n.title?.toLowerCase().includes('order'))
      );
      break;
    case 'all':
    default:
      filteredNotifications = notificationsList;
  }
  
  if (filteredNotifications.length === 0) {
    notificationsListDiv.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-bell-slash"></i>
        <h3>No ${currentFilter === 'all' ? '' : currentFilter} notifications</h3>
        <p>${getEmptyMessageForFilter(currentFilter)}</p>
      </div>
    `;
    return;
  }
  
  let notificationsHTML = '';
  
  filteredNotifications.forEach((notification) => {
    const timeAgo = getTimeAgo(notification.createdAt);
    const isUnread = !notification.read;
    const typeClass = `notification-type ${notification.type || 'system'}`;
    const typeText = getTypeText(notification.type);
    
    // Extract order info
    const orderInfo = extractOrderInfo(notification);
    
    // Check if it's a payment remaining notification
    const isPaymentRemaining = notification.type === 'payment' && 
                              (notification.title?.toLowerCase().includes('remaining') ||
                               notification.message?.toLowerCase().includes('remaining'));
    
    notificationsHTML += `
      <div class="notification-item ${isUnread ? 'unread' : ''}" 
           data-id="${notification.id}"
           data-type="${notification.type}"
           data-order-id="${orderInfo.orderId}"
           data-order-number="${orderInfo.orderNumber}"
           onclick="handleNotificationClick('${notification.id}', '${notification.type}', '${orderInfo.orderId}', '${orderInfo.orderNumber}', ${isPaymentRemaining})">
        <div class="notification-header">
          <div class="notification-title">
            ${notification.title || 'Notification'}
            <span class="${typeClass}">${typeText}</span>
          </div>
          <div class="notification-time">
            <i class="far fa-clock"></i> ${timeAgo}
          </div>
        </div>
        
        <div class="notification-message">
          ${notification.message || ''}
        </div>
        
        ${notification.productImage ? `
        <div class="notification-product">
          <div class="product-image">
            <img src="${notification.productImage}" 
                 alt="${notification.productName || 'Product'}" 
                 loading="lazy"
                 onerror="this.src='${getDefaultImage()}'">
          </div>
          <div class="product-details">
            <div class="product-name">${notification.productName || 'Product'}</div>
            <div class="product-meta">${notification.productCategory || 'Stone Product'}</div>
            ${notification.productPrice ? `
            <div class="product-price">¬£${notification.productPrice.toFixed(2)}</div>
            ` : ''}
          </div>
        </div>
        ` : ''}
        
        <div class="notification-actions">
          ${isUnread ? `
          <button class="action-btn-small success" onclick="event.stopPropagation(); markAsRead('${notification.id}')">
            <i class="fas fa-check"></i> Mark as read
          </button>
          ` : ''}
          
          ${isPaymentRemaining ? `
          <button class="action-btn-small primary" onclick="event.stopPropagation(); handlePaymentRemaining('${notification.id}', '${orderInfo.orderId}', '${orderInfo.orderNumber}')">
            <i class="fas fa-money-bill-wave"></i> Pay Remaining
          </button>
          ` : ''}
          
          ${notification.type === 'order' ? `
          <button class="action-btn-small primary" onclick="event.stopPropagation(); handleOrderNotificationAction('${notification.id}', '${orderInfo.orderId}', '${orderInfo.orderNumber}')">
            <i class="fas fa-eye"></i> View Order
          </button>
          ` : ''}
          
          <button class="action-btn-small" onclick="event.stopPropagation(); deleteNotification('${notification.id}')">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </div>
    `;
  });
  
  notificationsListDiv.innerHTML = notificationsHTML;
}

function extractOrderInfo(notification) {
  const title = notification.title || '';
  const message = notification.message || '';
  const orderId = notification.orderId || '';
  const orderNumber = notification.orderNumber || '';
  
  // Extract order number from message if not provided
  let extractedOrderNumber = orderNumber;
  if (!extractedOrderNumber) {
    const extracted = extractOrderInfoFromMessage(message);
    if (extracted && extracted.orderNumber) {
      extractedOrderNumber = extracted.orderNumber;
    }
  }
  
  // Try to extract amount from message
  let amount = 0;
  const amountMatch = message.match(/¬£([\d\.]+)/);
  if (amountMatch && amountMatch[1]) {
    amount = parseFloat(amountMatch[1]);
  }
  
  return {
    orderId: orderId,
    orderNumber: extractedOrderNumber,
    amount: amount
  };
}

function extractOrderInfoFromMessage(message) {
  if (!message) return null;
  
  // Pattern 1: IRYA-Êï∞Â≠ó-Êï∞Â≠ó (e.g., IRYA-1765748514765-1207)
  const pattern1 = message.match(/IRYA[-\s]\d+[-\s]\d+/g);
  if (pattern1 && pattern1[0]) {
    return { orderNumber: pattern1[0] };
  }
  
  // Pattern 2: IRYA-Êï∞Â≠ó (simple version)
  const pattern2 = message.match(/IRYA[-\s]\d+/g);
  if (pattern2 && pattern2[0]) {
    return { orderNumber: pattern2[0] };
  }
  
  // Pattern 3: Order # followed by numbers
  const pattern3 = message.match(/Order[#\s]+\d+/gi);
  if (pattern3 && pattern3[0]) {
    const orderNum = pattern3[0].replace(/Order[#\s]+/i, '').trim();
    return { orderNumber: `IRYA-${orderNum}` };
  }
  
  // Pattern 4: Just find numbers that look like order numbers
  const pattern4 = message.match(/\b\d{10,}\b/g);
  if (pattern4 && pattern4[0]) {
    return { orderNumber: `IRYA-${pattern4[0]}` };
  }
  
  return null;
}

function getTypeText(type) {
  const typeMap = {
    'payment': 'Payment',
    'order': 'Order',
    'system': 'System',
    'promotion': 'Promotion'
  };
  
  return typeMap[type] || 'Notification';
}

function getEmptyMessageForFilter(filter) {
  const messages = {
    'all': 'You will see notifications here when you have new updates.',
    'unread': 'You have no unread notifications.',
    'payment': 'No payment notifications yet.',
    'order': 'No order notifications yet.',
    'system': 'No system notifications yet.'
  };
  
  return messages[filter] || messages['all'];
}

// ============================================
// NOTIFICATION ACTIONS
// ============================================

async function handleNotificationClick(notificationId, type, orderId, orderNumber, isPaymentRemaining) {
  try {
    // First mark as read if unread
    await markAsRead(notificationId);
    
    // Handle based on type
    if (isPaymentRemaining) {
      await handlePaymentRemaining(notificationId, orderId, orderNumber);
    } else if (type === 'order') {
      await handleOrderNotificationAction(notificationId, orderId, orderNumber);
    } else if (type === 'payment') {
      await handlePaymentNotificationAction(notificationId, orderId, orderNumber);
    }
    
  } catch (error) {
    console.error("‚ùå Error handling notification click:", error);
  }
}

// ============================================
// PAYMENT REMAINING NOTIFICATION HANDLING
// ============================================

async function handlePaymentRemaining(notificationId, orderId, orderNumber) {
  console.log("üí∞ Handling payment remaining notification:", { 
    notificationId, 
    orderId, 
    orderNumber 
  });
  
  try {
    // First, let's try to fetch the order details
    let order = null;
    
    if (orderId) {
      try {
        // Try user's orders collection
        const orderDoc = await getDoc(doc(db, "users", currentUserId, "orders", orderId));
        if (orderDoc.exists()) {
          order = orderDoc.data();
          order.id = orderDoc.id;
        }
      } catch (error) {
        // Try main orders collection
        const ordersRef = collection(db, "orders");
        const orderQuery = query(ordersRef, where("__name__", "==", orderId));
        const orderSnapshot = await getDocs(orderQuery);
        
        if (!orderSnapshot.empty) {
          order = orderSnapshot.docs[0].data();
          order.id = orderSnapshot.docs[0].id;
        }
      }
    }
    
    // If we found the order, prepare data for checkout
    if (order) {
      const paidAmount = order.submittedAmount || order.advancePayment || 0;
      const totalAmount = order.total || 0;
      const remainingAmount = order.remainingPayment || (totalAmount - paidAmount);
      
      if (remainingAmount > 0) {
        const checkoutData = {
          orderId: order.id,
          orderNumber: order.orderNumber || orderNumber,
          remainingAmount: remainingAmount,
          totalAmount: totalAmount,
          paidAmount: paidAmount,
          orderType: 'existing_order',
          items: order.items || [],
          userId: currentUserId,
          userEmail: currentUserEmail,
          userName: currentUserName,
          paymentType: 'remaining_payment',
          source: 'notification',
          orderDetails: {
            shippingAddress: order.shippingAddress,
            billingAddress: order.billingAddress,
            paymentMethod: order.paymentMethod,
            status: order.status,
            orderStatus: order.orderStatus,
            createdAt: order.createdAt,
            estimatedDelivery: order.estimatedDelivery
          }
        };
        
        localStorage.setItem('irya_pending_payment_order', JSON.stringify(checkoutData));
        
        // REDIRECT TO notification-checkout.html
        const checkoutUrl = `notification-checkout.html?order_id=${order.id}&type=remaining_payment&user=${currentUserId}&amount=${remainingAmount}`;
        console.log("üîó Redirecting to notification checkout:", checkoutUrl);
        
        // Show loading message
        showMessage("Redirecting to payment page...");
        
        // Redirect after short delay
        setTimeout(() => {
          window.location.href = checkoutUrl;
        }, 500);
        return;
      }
    }
    
    // If no order found or no remaining amount, try to redirect to orders page
    let redirectUrl = 'orders.html';
    
    if (orderId) {
      redirectUrl += `?order_id=${orderId}`;
    } else if (orderNumber) {
      // Save search term for orders page
      localStorage.setItem('irya_search_order_number', orderNumber);
      redirectUrl += `?search=${encodeURIComponent(orderNumber)}`;
    }
    
    showMessage("Redirecting to orders...");
    setTimeout(() => {
      window.location.href = redirectUrl;
    }, 500);
    
  } catch (error) {
    console.error("‚ùå Error in handlePaymentRemaining:", error);
    showMessage("Error processing payment. Please try again.");
  }
}

// ============================================
// ORDER NOTIFICATION HANDLING
// ============================================

async function handleOrderNotificationAction(notificationId, orderId, orderNumber) {
  console.log("üì¶ Handling order notification:", { notificationId, orderId, orderNumber });
  
  let redirectUrl = 'orders.html';
  
  if (orderId) {
    redirectUrl += `?order_id=${orderId}`;
  } else if (orderNumber) {
    // Save search term for orders page
    localStorage.setItem('irya_search_order_number', orderNumber);
    redirectUrl += `?search=${encodeURIComponent(orderNumber)}`;
  }
  
  showMessage("Redirecting to order details...");
  setTimeout(() => {
    window.location.href = redirectUrl;
  }, 500);
}

// ============================================
// GENERAL PAYMENT NOTIFICATION HANDLING
// ============================================

async function handlePaymentNotificationAction(notificationId, orderId, orderNumber) {
  console.log("üí∞ Handling general payment notification:", { notificationId, orderId, orderNumber });
  
  // Check if we have pending payment data
  const pendingPaymentOrder = localStorage.getItem('irya_pending_payment_order');
  
  if (pendingPaymentOrder) {
    try {
      const paymentData = JSON.parse(pendingPaymentOrder);
      
      // Check if this matches our notification
      if ((orderId && paymentData.orderId === orderId) || 
          (orderNumber && paymentData.orderNumber === orderNumber)) {
        
        // Redirect to notification checkout with pending payment
        const checkoutUrl = `notification-checkout.html?order=${paymentData.orderId}&type=remaining_payment`;
        showMessage("Redirecting to payment...");
        setTimeout(() => {
          window.location.href = checkoutUrl;
        }, 500);
        return;
      }
    } catch (error) {
      console.error("Error parsing payment data:", error);
    }
  }
  
  // If no pending payment found, redirect to orders page
  handleOrderNotificationAction(notificationId, orderId, orderNumber);
}

// ============================================
// NOTIFICATION MANAGEMENT FUNCTIONS
// ============================================

async function markAsRead(notificationId) {
  try {
    if (!db || !currentUserId) return;
    
    const notificationRef = doc(db, "users", currentUserId, "notifications", notificationId);
    await updateDoc(notificationRef, {
      read: true,
      readAt: new Date().toISOString()
    });
    
    // Update local state
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
    }
    
    // Update UI
    const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
    if (notificationElement) {
      notificationElement.classList.remove('unread');
      
      // Update the mark as read button
      const markAsReadBtn = notificationElement.querySelector('.action-btn-small.success');
      if (markAsReadBtn) {
        markAsReadBtn.remove();
      }
    }
    
    // Update badges
    const unreadCount = notifications.filter(n => !n.read).length;
    updateBadges(unreadCount);
    
  } catch (error) {
    console.error("‚ùå Error marking as read:", error);
    showMessage("Failed to mark as read");
  }
}

async function markAllAsRead() {
  try {
    if (!db || !currentUserId) return;
    
    const unreadNotifications = notifications.filter(n => !n.read);
    
    for (const notification of unreadNotifications) {
      const notificationRef = doc(db, "users", currentUserId, "notifications", notification.id);
      await updateDoc(notificationRef, {
        read: true,
        readAt: new Date().toISOString()
      });
      
      notification.read = true;
    }
    
    // Update all UI elements
    document.querySelectorAll('.notification-item.unread').forEach(item => {
      item.classList.remove('unread');
      
      // Remove mark as read buttons
      const markAsReadBtn = item.querySelector('.action-btn-small.success');
      if (markAsReadBtn) {
        markAsReadBtn.remove();
      }
    });
    
    updateBadges(0);
    showMessage("All notifications marked as read");
    
  } catch (error) {
    console.error("‚ùå Error marking all as read:", error);
    showMessage("Failed to mark all as read");
  }
}

async function deleteNotification(notificationId) {
  if (!confirm('Are you sure you want to delete this notification?')) return;
  
  try {
    if (!db || !currentUserId) return;
    
    const notificationRef = doc(db, "users", currentUserId, "notifications", notificationId);
    await deleteDoc(notificationRef);
    
    // Remove from local array
    notifications = notifications.filter(n => n.id !== notificationId);
    
    // Update badges
    const unreadCount = notifications.filter(n => !n.read).length;
    updateBadges(unreadCount);
    
    // Re-display notifications
    displayNotifications(notifications);
    
    showMessage("Notification deleted");
    
  } catch (error) {
    console.error("‚ùå Error deleting notification:", error);
    showMessage("Failed to delete notification");
  }
}

async function clearAllNotifications() {
  if (!confirm('Are you sure you want to clear all notifications? This cannot be undone.')) return;
  
  try {
    if (!db || !currentUserId) return;
    
    const notificationsRef = collection(db, "users", currentUserId, "notifications");
    const snapshot = await getDocs(notificationsRef);
    
    const deletePromises = [];
    snapshot.forEach((doc) => {
      deletePromises.push(deleteDoc(doc.ref));
    });
    
    await Promise.all(deletePromises);
    
    notifications = [];
    updateBadges(0);
    showEmptyState("All notifications cleared");
    
    showMessage("All notifications cleared");
    
  } catch (error) {
    console.error("‚ùå Error clearing all notifications:", error);
    showMessage("Failed to clear notifications");
  }
}

// ============================================
// FILTER FUNCTIONS
// ============================================

function filterNotifications(filter) {
  currentFilter = filter;
  
  // Update filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  event?.target.classList.add('active');
  
  // Display filtered notifications
  displayNotifications(notifications);
}

// ============================================
// BADGE MANAGEMENT
// ============================================

function updateBadges(unreadCount) {
  // Update notification badge in bottom nav
  const bottomNavBadge = document.getElementById('bottomNavBadge');
  
  if (bottomNavBadge) {
    if (unreadCount > 0) {
      bottomNavBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      bottomNavBadge.style.display = 'flex';
    } else {
      bottomNavBadge.style.display = 'none';
    }
  }
  
  // Also update in localStorage for other pages
  localStorage.setItem('irya_unread_notifications', unreadCount.toString());
}

function updateCartBadge() {
  try {
    const userId = localStorage.getItem('irya_guest_id') || 'guest';
    const cartKey = 'irya_local_cart_' + userId;
    const cartData = localStorage.getItem(cartKey);
    const cartItems = cartData ? JSON.parse(cartData) : [];
    const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
    
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
      cartBadge.textContent = count;
      cartBadge.style.display = count > 0 ? 'flex' : 'none';
    }
  } catch (error) {
    console.error('‚ùå Error updating cart badge:', error);
  }
}

// ============================================
// HELPER FUNCTIONS
// ============================================

function showEmptyState(message) {
  const notificationsList = document.getElementById("notificationsList");
  notificationsList.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-bell-slash"></i>
      <h3>${message}</h3>
      <p>You will see notifications here when you have new updates.</p>
      <button class="filter-btn active" onclick="loadNotifications()" style="margin-top: 20px;">
        <i class="fas fa-redo"></i> Refresh
      </button>
    </div>
  `;
}

function getTimeAgo(dateString) {
  if (!dateString) return 'Just now';
  
  try {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short'
    });
  } catch (error) {
    return dateString;
  }
}

function showMessage(message) {
  // Remove existing toast
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }
  
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-check-circle"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log("üì± Notifications page loaded");
    
    await loadNotifications();
    
    // Check if we have a search order number from redirect
    const searchOrderNumber = localStorage.getItem('irya_search_order_number');
    if (searchOrderNumber) {
      // Clear it after using
      localStorage.removeItem('irya_search_order_number');
      
      // Filter to show notifications for this order
      const orderNotifications = notifications.filter(n => {
        const orderInfo = extractOrderInfo(n);
        return orderInfo.orderNumber === searchOrderNumber;
      });
      
      if (orderNotifications.length > 0) {
        currentFilter = 'all';
        displayNotifications(orderNotifications);
        showMessage(`Showing notifications for order ${searchOrderNumber}`);
      }
    }
    
  } catch (error) {
    console.error("‚ùå Error initializing:", error);
  }
});

window.addEventListener('beforeunload', () => {
  if (notificationsUnsubscribe) notificationsUnsubscribe();
});

// Make functions available globally
window.filterNotifications = filterNotifications;
window.markAsRead = markAsRead;
window.markAllAsRead = markAllAsRead;
window.deleteNotification = deleteNotification;
window.clearAllNotifications = clearAllNotifications;
window.handlePaymentRemaining = handlePaymentRemaining;
window.handleOrderNotificationAction = handleOrderNotificationAction;
window.handleNotificationClick = handleNotificationClick;
</script>

</body>
</html>
