<!DOCTYPE html>
<html>
<head>
  <title>Update Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial;
      background: #f2f2f2;
      padding: 20px;
    }
    .box {
      max-width: 420px;
      background: white;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    button {
      background: #198754;
      color: white;
      border: none;
      font-size: 16px;
    }
    .msg {
      margin-top: 12px;
      text-align: center;
    }
  </style>
</head>

<body>

<div class="box">
  <h3>Update Order</h3>

  <input id="userId" placeholder="User ID" value="dCVM344so3VCKQGNdsHm2aUZrKA3">
  <input id="orderId" placeholder="Order ID" value="E0R8Beq9JTNTm92PDlB3">

  <select id="status">
    <option value="pending">Pending</option>
    <option value="confirmed">Confirmed</option>
    <option value="completed">Completed</option>
  </select>

  <button onclick="updateOrder()">Update</button>

  <div class="msg" id="msg"></div>
</div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, updateDoc, collection, addDoc } 
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.updateOrder = async () => {
    const userId = userIdInput.value.trim();
    const orderId = orderIdInput.value.trim();
    const status = document.getElementById("status").value;
    const msg = document.getElementById("msg");

    if (!userId || !orderId) {
      msg.innerHTML = "❌ User ID & Order ID required";
      return;
    }

    try {
      // 1️⃣ ORDER UPDATE
      await updateDoc(
        doc(db, "users", userId, "orders", orderId),
        {
          status,
          updatedAt: new Date().toISOString()
        }
      );

      // 2️⃣ USER NOTIFICATION CREATE
      await addDoc(
        collection(db, "users", userId, "notifications"),
        {
          title: "Order Update",
          message: `Your order (${orderId}) status updated to "${status}"`,
          orderId,
          read: false,
          createdAt: new Date().toISOString()
        }
      );

      msg.innerHTML = "✅ Order updated & user notified";
    } catch (e) {
      console.error(e);
      msg.innerHTML = "❌ Error occurred";
    }
  };

  const userIdInput = document.getElementById("userId");
  const orderIdInput = document.getElementById("orderId");
</script>

</body>
</html>
