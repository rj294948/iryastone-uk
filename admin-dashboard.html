<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:20px; margin-bottom:20px; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
button { padding:6px 10px; margin-top:6px; cursor:pointer;}
input, select { width:100%; padding:6px; margin-top:5px; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; color:#fff; }
.advance { background:#ffc107; }
.full { background:#28a745; }
.shipped { background:#17a2b8; }
.pending { background:#6c757d; }
img.product-img { width:60px; height:60px; object-fit:cover; border-radius:5px; margin-right:10px; }
.flex { display:flex; align-items:center; }
h2 { margin-bottom:20px; }
</style>
</head>
<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collectionGroup, getDocs, doc, updateDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersDiv = document.getElementById("orders");

async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));

  // Sorting by createdAt descending
  let orders = [];
  snap.forEach(d => {
    let o = d.data();
    o.docId = d.id;
    orders.push(o);
  });
  orders.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  orders.forEach(o => {
    const remaining = o.total - (o.advancePayment || 0);
    const isFull = remaining <= 0;
    const statusBadge = isFull ? "full" : "advance";
    const shippedBadge = o.shippingStatus==="shipped" ? "shipped" : "pending";

    // Display products with image & title
    const productsHTML = (o.items||[]).map(item=>`
      <div class="flex">
        <img src="${item.image || 'https://via.placeholder.com/60'}" class="product-img" />
        <div>
          <b>${item.name}</b><br/>
          Qty: ${item.quantity} | Price: £${item.price} | Remaining: £${item.remainingPayment || 0}
        </div>
      </div>
    `).join("");

    // Auto-cancel check
    const orderTime = new Date(o.createdAt);
    const now = new Date();
    const hoursDiff = (now - orderTime)/1000/60/60;
    let cancelNotice = "";
    if(!isFull && hoursDiff>24) {
      cancelNotice = `<p style="color:red;">Order auto-cancelled after 24h unpaid. Advance not refundable.</p>`;
      updateDoc(doc(db,"users",o.userId,"orders",o.docId), {status:"cancelled"});
    }

    ordersDiv.innerHTML += `
      <div class="order">
        <b>Order #: ${o.orderNumber}</b>
        <span class="badge ${statusBadge}">${isFull ? "FULL PAID" : "ADVANCE PAID"}</span>
        <span class="badge ${shippedBadge}">${o.shippingStatus || "PENDING"}</span>

        <p>User: ${o.userName} | Email: ${o.userEmail}</p>
        <p>Phone: ${o.shippingAddress?.phone || o.billingAddress?.phone}</p>
        <p>Total: £${o.total} | Paid: £${o.advancePayment || 0} | Remaining: £${remaining}</p>

        <p>Created: ${new Date(o.createdAt).toLocaleString()}</p>
        <p>Shipped: ${o.shippedAt ? new Date(o.shippedAt).toLocaleString() : "-"}</p>
        <p>Delivery: ${o.deliveryDateTime ? new Date(o.deliveryDateTime).toLocaleString() : "-"}</p>

        ${productsHTML}
        ${cancelNotice}

        <select id="pay-${o.docId}">
          <option value="">-- Payment Status --</option>
          <option value="advance_confirmed">Advance Confirmed</option>
          <option value="fully_paid">Fully Paid</option>
        </select>
        <button onclick="updatePayment('${o.userId}','${o.docId}','${o.orderNumber}','${remaining}')">Update Payment</button>

        <input id="track-${o.docId}" placeholder="Tracking Number">
        <input type="datetime-local" id="delivery-${o.docId}">
        <button onclick="updateShipping('${o.userId}','${o.docId}','${o.orderNumber}')">Update Shipping</button>
      </div>
    `;
  });
}

// Payment update
window.updatePayment = async (userId, orderId, orderNumber, remaining) => {
  const status = document.getElementById(`pay-${orderId}`).value;
  if(!status) return alert("Select payment status");

  let newRemaining = remaining;
  if(status==="fully_paid") newRemaining = 0;

  await updateDoc(doc(db,"users",userId,"orders",orderId), {
    paymentStatus: status,
    remainingPayment: newRemaining,
    updatedAt: new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"payment",
    orderId,
    orderNumber,
    title:"Payment Update",
    message: status==="fully_paid"
      ? "Your full payment has been confirmed. Remaining: £0"
      : `Your advance payment has been confirmed. Remaining: £${newRemaining}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated successfully!");
  loadOrders();
}

// Shipping update
window.updateShipping = async (userId, orderId, orderNumber) => {
  const track = document.getElementById(`track-${orderId}`).value;
  const deliveryInput = document.getElementById(`delivery-${orderId}`).value;
  if(!track) return alert("Enter tracking number");

  await updateDoc(doc(db,"users",userId,"orders",orderId), {
    shippingStatus:"shipped",
    trackingNumber:track,
    shippedAt:new Date().toISOString(),
    deliveryDateTime: deliveryInput || null,
    updatedAt:new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"), {
    type:"shipping",
    orderId,
    orderNumber,
    title:"Order Shipped",
    message:`Your order has been shipped. Tracking: ${track}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipping updated successfully!");
  loadOrders();
}

loadOrders();
</script>
</body>
</html>
