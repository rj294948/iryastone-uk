<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE – Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order {
  background:#fff;
  padding:15px;
  margin-bottom:15px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.badge { padding:4px 8px; border-radius:4px; font-size:12px; }
.advance { background:#ffc107; }
.full { background:#28a745; color:#fff; }
.pending { background:#dc3545; color:#fff; }
button {
  padding:7px 10px;
  margin-top:6px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.confirm { background:#198754; color:#fff; }
.ship { background:#0d6efd; color:#fff; }
input { width:100%; padding:6px; margin-top:5px; }
</style>
</head>

<body>

<h2>Admin Orders – IRYA STONE</h2>
<div id="orders">Loading…</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collectionGroup,
  getDocs,
  doc,
  updateDoc,
  addDoc,
  collection
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* ================= LOAD ORDERS ================= */
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));

  snap.forEach(d => {
    const o = d.data();
    const userId = d.ref.parent.parent.id;
    const orderId = d.id;

    const isFull = o.submittedAmount >= o.total;
    const badge = isFull
      ? `<span class="badge full">FULL PAID</span>`
      : `<span class="badge advance">ADVANCE PAID</span>`;

    ordersDiv.innerHTML += `
      <div class="order">
        <b>${o.orderNumber}</b> ${badge}
        <p><b>User:</b> ${o.userName} (${o.userEmail})</p>

        <p><b>Payment Method:</b> ${o.paymentMethod}</p>
        <p><b>Reference:</b> ${o.transactionReference}</p>
        <p><b>Date:</b> ${o.transactionDate}</p>

        <p><b>Paid:</b> £${o.submittedAmount}</p>
        <p><b>Remaining:</b> £${o.remainingPayment}</p>

        <button class="confirm"
          onclick="confirmPayment('${userId}','${orderId}',${o.submittedAmount},${o.total})">
          Confirm Payment
        </button>

        <input placeholder="Tracking Number"
          id="track-${orderId}"
          value="${o.trackingNumber || ""}">

        <button class="ship"
          onclick="updateShipping('${userId}','${orderId}')">
          Update Shipping
        </button>
      </div>
    `;
  });
}

/* ================= PAYMENT CONFIRM ================= */
window.confirmPayment = async (userId, orderId, paid, total) => {
  let paymentStatus = paid >= total ? "fully_paid" : "advance_confirmed";

  await updateDoc(
    doc(db,"users",userId,"orders",orderId),
    {
      paymentStatus,
      status: "payment_confirmed",
      remainingPayment: Math.max(total - paid, 0),
      updatedAt: new Date().toISOString()
    }
  );

  await addDoc(
    collection(db,"users",userId,"notifications"),
    {
      title:"Payment Confirmed",
      message: paymentStatus === "fully_paid"
        ? "Your full payment has been confirmed."
        : "Advance payment confirmed. Remaining payment pending.",
      createdAt:new Date().toISOString(),
      read:false
    }
  );

  alert("Payment updated");
  loadOrders();
};

/* ================= SHIPPING UPDATE ================= */
window.updateShipping = async (userId, orderId) => {
  const track = document.getElementById(`track-${orderId}`).value;

  await updateDoc(
    doc(db,"users",userId,"orders",orderId),
    {
      shippingStatus:"shipped",
      trackingNumber: track,
      shippedAt:new Date().toISOString()
    }
  );

  await addDoc(
    collection(db,"users",userId,"notifications"),
    {
      title:"Order Shipped",
      message:`Your order has been shipped. Tracking: ${track}`,
      createdAt:new Date().toISOString(),
      read:false
    }
  );

  alert("Shipping updated");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>
