<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Order Management | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Admin colors */
    --admin-blue: #1e88e5;
    --admin-green: #43a047;
    --admin-red: #e53935;
    --admin-orange: #fb8c00;
    --admin-purple: #8e24aa;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    font-size: 14px;
}

/* ===== ADMIN HEADER ===== */
.admin-header {
    background: var(--stone-dark);
    color: var(--white);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.admin-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}

.admin-logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.admin-logo span {
    font-size: 20px;
    font-weight: 700;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
}

.admin-logo small {
    font-size: 12px;
    color: var(--gold-light);
    margin-left: 10px;
    background: rgba(255,255,255,0.1);
    padding: 2px 8px;
    border-radius: 10px;
}

.admin-user {
    display: flex;
    align-items: center;
    gap: 12px;
}

.admin-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-gold);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
}

.admin-actions {
    display: flex;
    gap: 10px;
}

.admin-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: var(--primary-gold);
    color: var(--white);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}

.admin-btn:hover {
    background: var(--gold-dark);
}

.admin-btn.secondary {
    background: rgba(255,255,255,0.1);
}

.admin-btn.secondary:hover {
    background: rgba(255,255,255,0.2);
}

/* ===== ADMIN SIDEBAR ===== */
.admin-container {
    display: flex;
    min-height: calc(100vh - 70px);
}

.admin-sidebar {
    width: 250px;
    background: var(--stone-dark);
    color: var(--white);
    padding: 20px 0;
    position: sticky;
    top: 70px;
    height: calc(100vh - 70px);
    overflow-y: auto;
}

.admin-menu {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 0 15px;
}

.menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-radius: 8px;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
}

.menu-item:hover {
    background: rgba(255,255,255,0.1);
    color: var(--white);
}

.menu-item.active {
    background: var(--primary-gold);
    color: var(--white);
}

.menu-item i {
    width: 20px;
    text-align: center;
    font-size: 16px;
}

.menu-section {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    padding: 15px 15px 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 20px;
}

.menu-section:first-child {
    margin-top: 0;
}

/* ===== ADMIN CONTENT ===== */
.admin-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.content-header h1 {
    font-size: 24px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.content-header h1 i {
    color: var(--primary-gold);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: var(--transition);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: var(--white);
}

.stat-icon.pending { background: var(--admin-red); }
.stat-icon.processing { background: var(--admin-orange); }
.stat-icon.shipped { background: var(--admin-blue); }
.stat-icon.delivered { background: var(--admin-green); }
.stat-icon.total { background: var(--admin-purple); }

.stat-info {
    flex: 1;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 12px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-change {
    font-size: 12px;
    color: var(--admin-green);
}

.stat-change.negative {
    color: var(--admin-red);
}

/* ===== ORDER FILTERS ===== */
.order-filters {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--stone-dark);
}

.filter-group select,
.filter-group input {
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    background: var(--white);
    transition: var(--transition);
}

.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.date-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

.date-range input {
    flex: 1;
}

.filter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    padding-top: 15px;
    border-top: 1px solid #f0f0f0;
}

/* ===== ORDERS TABLE ===== */
.orders-table-container {
    background: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.table-responsive {
    overflow-x: auto;
}

.orders-table {
    width: 100%;
    border-collapse: collapse;
}

.orders-table thead {
    background: var(--stone-dark);
    color: var(--white);
}

.orders-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--primary-gold);
}

.orders-table tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: var(--transition);
}

.orders-table tbody tr:hover {
    background: var(--bg-light);
}

.orders-table td {
    padding: 12px 15px;
    font-size: 13px;
    color: var(--text-dark);
}

.order-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.order-number {
    font-weight: 600;
    color: var(--stone-dark);
}

.order-date {
    font-size: 11px;
    color: var(--text-light);
}

.customer-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.customer-name {
    font-weight: 600;
}

.customer-email {
    font-size: 11px;
    color: var(--text-light);
}

.amount-cell {
    font-weight: 600;
    color: var(--stone-dark);
}

.status-cell {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.status-pending { background: #ffebee; color: #c62828; }
.status-payment-confirmed { background: #e8f5e9; color: #2e7d32; }
.status-processing { background: #e3f2fd; color: #1565c0; }
.status-ready-to-ship { background: #fff3e0; color: #ef6c00; }
.status-shipped { background: #e8eaf6; color: #283593; }
.status-out-for-delivery { background: #f3e5f5; color: #6a1b9a; }
.status-delivered { background: #e0f2f1; color: #00695c; }
.status-cancelled { background: #f5f5f5; color: #616161; }

.action-cell {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    border: none;
    background: var(--bg-light);
    color: var(--text-dark);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

.action-btn.view { background: #e3f2fd; color: #1976d2; }
.action-btn.view:hover { background: #1976d2; color: white; }

.action-btn.edit { background: #fff3e0; color: #ef6c00; }
.action-btn.edit:hover { background: #ef6c00; color: white; }

.action-btn.delete { background: #ffebee; color: #d32f2f; }
.action-btn.delete:hover { background: #d32f2f; color: white; }

/* ===== PAGINATION ===== */
.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-top: 1px solid #f0f0f0;
    background: var(--white);
}

.pagination-info {
    font-size: 13px;
    color: var(--text-light);
}

.pagination-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid #e0e0e0;
    background: var(--white);
    border-radius: 6px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 13px;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-pages {
    display: flex;
    gap: 4px;
}

.page-btn {
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    background: var(--white);
    cursor: pointer;
    transition: var(--transition);
    font-size: 13px;
}

.page-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.page-btn.active {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

/* ===== MODAL ===== */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--stone-dark);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    border: none;
    transition: var(--transition);
}

.modal-close:hover {
    background: var(--admin-red);
    transform: rotate(90deg);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    position: sticky;
    top: 0;
    background: var(--white);
    z-index: 1;
}

.modal-header h3 {
    font-size: 20px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-header h3 i {
    color: var(--primary-gold);
}

.modal-body {
    padding: 20px;
}

/* ===== FORM STYLES ===== */
.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: " *";
    color: var(--admin-red);
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

/* ===== TIMELINE EDITOR ===== */
.timeline-editor {
    background: var(--bg-light);
    border-radius: var(--border-radius);
    padding: 20px;
    margin: 20px 0;
}

.timeline-step {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 15px;
    padding: 15px;
    background: var(--white);
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.timeline-step.completed {
    border-color: var(--admin-green);
    background: rgba(67, 160, 71, 0.05);
}

.step-checkbox {
    margin-top: 8px;
}

.step-content {
    flex: 1;
}

.step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.step-title {
    font-weight: 600;
    color: var(--stone-dark);
}

.step-date {
    font-size: 12px;
    color: var(--text-light);
}

.step-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

/* ===== LOADING ===== */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
    .admin-sidebar {
        width: 70px;
    }
    
    .menu-item span {
        display: none;
    }
    
    .menu-section {
        display: none;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .admin-container {
        flex-direction: column;
    }
    
    .admin-sidebar {
        width: 100%;
        height: auto;
        position: static;
        padding: 10px 0;
    }
    
    .admin-menu {
        flex-direction: row;
        overflow-x: auto;
        padding: 10px;
    }
    
    .menu-item {
        flex-direction: column;
        padding: 10px;
        min-width: 70px;
        text-align: center;
    }
    
    .content-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-row {
        grid-template-columns: 1fr;
    }
    
    .date-range {
        flex-direction: column;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Order Edit Modal -->
<div class="modal-overlay" id="orderModal">
    <div class="modal">
        <button class="modal-close" id="modalCloseBtn">
            <i class="fas fa-times"></i>
        </button>
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> <span id="modalTitle">Update Order</span></h3>
        </div>
        <div class="modal-body">
            <form id="orderForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="required">Order Status</label>
                        <select id="orderStatus" required>
                            <option value="payment_pending">Payment Pending</option>
                            <option value="payment_confirmed">Payment Confirmed</option>
                            <option value="processing">Processing</option>
                            <option value="ready_to_ship">Ready to Ship</option>
                            <option value="shipped">Shipped</option>
                            <option value="out_for_delivery">Out for Delivery</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="returned">Returned</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Payment Status</label>
                        <select id="paymentStatus">
                            <option value="pending">Pending</option>
                            <option value="partial">Partial</option>
                            <option value="fully_paid">Fully Paid</option>
                            <option value="refunded">Refunded</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tracking Number</label>
                        <input type="text" id="trackingNumber" placeholder="Enter tracking number">
                    </div>
                    
                    <div class="form-group">
                        <label>Courier Service</label>
                        <select id="courierService">
                            <option value="">Select Courier</option>
                            <option value="dhl">DHL</option>
                            <option value="fedex">FedEx</option>
                            <option value="ups">UPS</option>
                            <option value="royal_mail">Royal Mail</option>
                            <option value="dpd">DPD</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Estimated Delivery</label>
                        <input type="datetime-local" id="estimatedDelivery">
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Admin Notes</label>
                        <textarea id="adminNotes" placeholder="Add internal notes about this order..."></textarea>
                    </div>
                </div>
                
                <!-- Timeline Editor -->
                <div class="timeline-editor">
                    <h4 style="margin-bottom: 15px; color: var(--stone-dark);">
                        <i class="fas fa-history"></i> Update Timeline
                    </h4>
                    
                    <div id="timelineSteps">
                        <!-- Timeline steps will be loaded here -->
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button type="submit" class="admin-btn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button type="button" class="admin-btn secondary" onclick="closeOrderModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Admin Header -->
<header class="admin-header">
    <div class="admin-logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
        <small>ADMIN PANEL</small>
    </div>
    
    <div class="admin-user">
        <div class="admin-avatar" id="adminAvatar">
            A
        </div>
        <div>
            <div style="font-weight: 600;">Admin User</div>
            <div style="font-size: 12px; opacity: 0.8;">Administrator</div>
        </div>
        <div class="admin-actions">
            <button class="admin-btn secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
</header>

<!-- Admin Container -->
<div class="admin-container">
    <!-- Sidebar -->
    <nav class="admin-sidebar">
        <div class="admin-menu">
            <div class="menu-section">Dashboard</div>
            <a href="#" class="menu-item active">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <div class="menu-section">Sales</div>
            <a href="#" class="menu-item">
                <i class="fas fa-shopping-cart"></i>
                <span>Orders</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-box"></i>
                <span>Products</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
            
            <div class="menu-section">Inventory</div>
            <a href="#" class="menu-item">
                <i class="fas fa-warehouse"></i>
                <span>Stock Management</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-truck"></i>
                <span>Shipping</span>
            </a>
            
            <div class="menu-section">Settings</div>
            <a href="#" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-user-shield"></i>
                <span>Admin Users</span>
            </a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-content">
        <div class="content-header">
            <h1><i class="fas fa-tachometer-alt"></i> Order Management Dashboard</h1>
            <div style="display: flex; gap: 10px;">
                <button class="admin-btn" onclick="refreshOrders()">
                    <i class="fas fa-redo"></i> Refresh
                </button>
                <button class="admin-btn" onclick="exportOrders()">
                    <i class="fas fa-file-export"></i> Export
                </button>
            </div>
        </div>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">Pending Orders</div>
                    <div class="stat-change">+0% from yesterday</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon processing">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="processingCount">0</div>
                    <div class="stat-label">Processing</div>
                    <div class="stat-change">+0% from yesterday</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon shipped">
                    <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="shippedCount">0</div>
                    <div class="stat-label">Shipped</div>
                    <div class="stat-change">+0% from yesterday</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon delivered">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="deliveredCount">0</div>
                    <div class="stat-label">Delivered</div>
                    <div class="stat-change">+0% from yesterday</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                    <div class="stat-value" id="totalRevenue">Â£0</div>
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-change">+0% from last month</div>
                </div>
            </div>
        </div>
        
        <!-- Order Filters -->
        <div class="order-filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Status Filter</label>
                    <select id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="payment_pending">Payment Pending</option>
                        <option value="payment_confirmed">Payment Confirmed</option>
                        <option value="processing">Processing</option>
                        <option value="ready_to_ship">Ready to Ship</option>
                        <option value="shipped">Shipped</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Payment Method</label>
                    <select id="paymentFilter">
                        <option value="">All Methods</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="stripe">Credit Card</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Date Range</label>
                    <div class="date-range">
                        <input type="date" id="dateFrom" placeholder="From">
                        <span>to</span>
                        <input type="date" id="dateTo" placeholder="To">
                    </div>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search Orders</label>
                    <input type="text" id="orderSearch" placeholder="Search by order number, customer name or email...">
                </div>
                
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortBy">
                        <option value="createdAt_desc">Newest First</option>
                        <option value="createdAt_asc">Oldest First</option>
                        <option value="total_desc">Amount High to Low</option>
                        <option value="total_asc">Amount Low to High</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="admin-btn" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button class="admin-btn secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="orders-table-container">
            <div class="table-responsive">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order Details</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner" style="display: block; position: static; transform: none; margin: 0 auto 20px;"></div>
                                <p>Loading orders...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">
                    Showing <span id="startRow">0</span>-<span id="endRow">0</span> of <span id="totalRows">0</span> orders
                </div>
                <div class="pagination-controls">
                    <button class="pagination-btn" onclick="previousPage()" id="prevBtn">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <div class="pagination-pages" id="pageNumbers">
                        <!-- Page numbers will be added here -->
                    </div>
                    <button class="pagination-btn" onclick="nextPage()" id="nextBtn">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  where,
  getDoc,
  setDoc,
  deleteDoc,
  Timestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// GLOBAL VARIABLES
// ============================================

let allOrders = [];
let filteredOrders = [];
let currentPage = 1;
const pageSize = 20;
let currentFilters = {};

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  console.log("ðŸ“± Admin panel loaded");
  
  // Load admin user info
  loadAdminInfo();
  
  // Load all orders
  await loadAllOrders();
  
  // Setup real-time updates
  setupRealTimeUpdates();
});

function loadAdminInfo() {
  const adminName = localStorage.getItem('admin_name') || 'Admin';
  const adminAvatar = document.getElementById('adminAvatar');
  adminAvatar.textContent = adminName.charAt(0).toUpperCase();
}

// ============================================
// ORDER MANAGEMENT FUNCTIONS
// ============================================

async function loadAllOrders() {
  try {
    showLoading(true);
    
    console.log("ðŸ”„ Loading all orders...");
    
    // Try to load from main orders collection
    const ordersRef = collection(db, "orders");
    const ordersQuery = query(ordersRef, orderBy("createdAt", "desc"));
    
    const snapshot = await getDocs(ordersQuery);
    
    allOrders = [];
    
    if (snapshot.empty) {
      console.log("ðŸ“­ No orders found in main collection");
      updateStats();
      displayOrders();
      return;
    }
    
    // Process each order
    for (const docSnapshot of snapshot.docs) {
      const orderData = docSnapshot.data();
      orderData.id = docSnapshot.id;
      
      // Ensure order has all required fields
      orderData.orderNumber = orderData.orderNumber || `ORD-${docSnapshot.id.substring(0, 8)}`;
      orderData.status = orderData.status || orderData.orderStatus || 'payment_pending';
      orderData.createdAt = orderData.createdAt || new Date().toISOString();
      
      allOrders.push(orderData);
    }
    
    console.log(`âœ… Loaded ${allOrders.length} orders from main collection`);
    
    // Also try to load from user-specific collections
    await loadUserOrders();
    
    // Update stats and display
    updateStats();
    applyFilters();
    
  } catch (error) {
    console.error("âŒ Error loading orders:", error);
    showError("Failed to load orders");
  } finally {
    showLoading(false);
  }
}

async function loadUserOrders() {
  try {
    // Get all users and their orders
    const usersRef = collection(db, "users");
    const usersSnapshot = await getDocs(usersRef);
    
    for (const userDoc of usersSnapshot.docs) {
      const userId = userDoc.id;
      
      // Skip guest users
      if (userId.startsWith('guest_')) continue;
      
      try {
        const userOrdersRef = collection(db, "users", userId, "orders");
        const userOrdersSnapshot = await getDocs(userOrdersRef);
        
        userOrdersSnapshot.forEach(docSnapshot => {
          const orderData = docSnapshot.data();
          orderData.id = docSnapshot.id;
          orderData.userId = userId;
          
          // Check if order already exists in allOrders
          const existingIndex = allOrders.findIndex(o => o.id === orderData.id);
          
          if (existingIndex === -1) {
            // Add missing fields
            orderData.orderNumber = orderData.orderNumber || `ORD-${docSnapshot.id.substring(0, 8)}`;
            orderData.status = orderData.status || orderData.orderStatus || 'payment_pending';
            orderData.createdAt = orderData.createdAt || new Date().toISOString();
            
            allOrders.push(orderData);
          }
        });
        
      } catch (error) {
        console.warn(`âš ï¸ Could not load orders for user ${userId}:`, error.message);
      }
    }
    
    console.log(`âœ… Total orders after user collections: ${allOrders.length}`);
    
  } catch (error) {
    console.error("âŒ Error loading user orders:", error);
  }
}

function setupRealTimeUpdates() {
  // Listen for new orders in main collection
  const ordersRef = collection(db, "orders");
  const ordersQuery = query(ordersRef, orderBy("createdAt", "desc"));
  
  onSnapshot(ordersQuery, (snapshot) => {
    console.log("ðŸ”„ Real-time order update received");
    
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added" || change.type === "modified") {
        const orderData = change.doc.data();
        orderData.id = change.doc.id;
        
        // Update or add order
        const index = allOrders.findIndex(o => o.id === orderData.id);
        
        if (index === -1) {
          allOrders.unshift(orderData);
        } else {
          allOrders[index] = orderData;
        }
      } else if (change.type === "removed") {
        const orderId = change.doc.id;
        allOrders = allOrders.filter(o => o.id !== orderId);
      }
    });
    
    // Reapply filters and update display
    updateStats();
    applyFilters();
  });
}

// ============================================
// STATISTICS FUNCTIONS
// ============================================

function updateStats() {
  const pendingCount = allOrders.filter(o => o.status === 'payment_pending').length;
  const processingCount = allOrders.filter(o => o.status === 'processing' || o.status === 'payment_confirmed' || o.status === 'ready_to_ship').length;
  const shippedCount = allOrders.filter(o => o.status === 'shipped' || o.status === 'out_for_delivery').length;
  const deliveredCount = allOrders.filter(o => o.status === 'delivered').length;
  
  const totalRevenue = allOrders
    .filter(o => o.status === 'delivered')
    .reduce((sum, order) => sum + (order.total || 0), 0);
  
  document.getElementById('pendingCount').textContent = pendingCount;
  document.getElementById('processingCount').textContent = processingCount;
  document.getElementById('shippedCount').textContent = shippedCount;
  document.getElementById('deliveredCount').textContent = deliveredCount;
  document.getElementById('totalRevenue').textContent = `Â£${totalRevenue.toFixed(2)}`;
}

// ============================================
// FILTER FUNCTIONS
// ============================================

function applyFilters() {
  const statusFilter = document.getElementById('statusFilter').value;
  const paymentFilter = document.getElementById('paymentFilter').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
  const sortBy = document.getElementById('sortBy').value;
  
  filteredOrders = [...allOrders];
  
  // Apply status filter
  if (statusFilter) {
    filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
  }
  
  // Apply payment method filter
  if (paymentFilter) {
    filteredOrders = filteredOrders.filter(order => order.paymentMethod === paymentFilter);
  }
  
  // Apply date range filter
  if (dateFrom) {
    const fromDate = new Date(dateFrom);
    filteredOrders = filteredOrders.filter(order => {
      const orderDate = new Date(order.createdAt);
      return orderDate >= fromDate;
    });
  }
  
  if (dateTo) {
    const toDate = new Date(dateTo);
    toDate.setHours(23, 59, 59, 999);
    filteredOrders = filteredOrders.filter(order => {
      const orderDate = new Date(order.createdAt);
      return orderDate <= toDate;
    });
  }
  
  // Apply search filter
  if (searchTerm) {
    filteredOrders = filteredOrders.filter(order => {
      return (
        (order.orderNumber && order.orderNumber.toLowerCase().includes(searchTerm)) ||
        (order.userName && order.userName.toLowerCase().includes(searchTerm)) ||
        (order.userEmail && order.userEmail.toLowerCase().includes(searchTerm)) ||
        (order.shippingAddress && 
          (order.shippingAddress.name && order.shippingAddress.name.toLowerCase().includes(searchTerm)) ||
          (order.shippingAddress.email && order.shippingAddress.email.toLowerCase().includes(searchTerm)))
      );
    });
  }
  
  // Apply sorting
  filteredOrders.sort((a, b) => {
    const [field, direction] = sortBy.split('_');
    
    let valueA, valueB;
    
    if (field === 'createdAt') {
      valueA = new Date(a.createdAt || 0);
      valueB = new Date(b.createdAt || 0);
    } else if (field === 'total') {
      valueA = a.total || 0;
      valueB = b.total || 0;
    }
    
    if (direction === 'desc') {
      return valueB - valueA;
    } else {
      return valueA - valueB;
    }
  });
  
  currentPage = 1;
  displayOrders();
}

function clearFilters() {
  document.getElementById('statusFilter').value = '';
  document.getElementById('paymentFilter').value = '';
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  document.getElementById('orderSearch').value = '';
  document.getElementById('sortBy').value = 'createdAt_desc';
  
  filteredOrders = [...allOrders];
  currentPage = 1;
  displayOrders();
}

// ============================================
// DISPLAY FUNCTIONS
// ============================================

function displayOrders() {
  const tbody = document.getElementById('ordersTableBody');
  
  if (filteredOrders.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">
          <i class="fas fa-box-open" style="font-size: 48px; color: #e0e0e0; margin-bottom: 15px;"></i>
          <h3 style="color: var(--text-light); margin-bottom: 10px;">No Orders Found</h3>
          <p style="color: var(--text-light);">Try adjusting your filters</p>
        </td>
      </tr>
    `;
    updatePagination();
    return;
  }
  
  // Calculate pagination
  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = Math.min(startIndex + pageSize, filteredOrders.length);
  const pageOrders = filteredOrders.slice(startIndex, endIndex);
  
  let tableHTML = '';
  
  pageOrders.forEach((order) => {
    const orderDate = formatDate(order.createdAt);
    const userName = order.userName || order.shippingAddress?.name || 'Customer';
    const userEmail = order.userEmail || order.shippingAddress?.email || 'N/A';
    const status = order.status || 'payment_pending';
    const statusClass = getStatusClass(status);
    const statusText = getStatusText(status);
    
    tableHTML += `
      <tr>
        <td>
          <div class="order-cell">
            <div class="order-number">${order.orderNumber}</div>
            <div class="order-date">${orderDate}</div>
          </div>
        </td>
        <td>
          <div class="customer-cell">
            <div class="customer-name">${userName}</div>
            <div class="customer-email">${userEmail}</div>
          </div>
        </td>
        <td class="amount-cell">Â£${order.total?.toFixed(2) || '0.00'}</td>
        <td>
          <div class="status-cell">
            <span class="status-badge ${statusClass}">
              <i class="fas ${getStatusIcon(status)}"></i>
              ${statusText}
            </span>
          </div>
        </td>
        <td>
          <div style="font-size: 12px;">
            ${order.paymentMethod === 'bank' ? 'Bank Transfer' : 
              order.paymentMethod === 'stripe' ? 'Credit Card' : 
              order.paymentMethod === 'paypal' ? 'PayPal' : 'N/A'}
            <div style="color: var(--text-light); margin-top: 2px;">
              ${order.paymentStatus || 'Pending'}
            </div>
          </div>
        </td>
        <td>
          <div class="action-cell">
            <button class="action-btn view" onclick="viewOrder('${order.id}')" title="View">
              <i class="fas fa-eye"></i>
            </button>
            <button class="action-btn edit" onclick="editOrder('${order.id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="action-btn delete" onclick="deleteOrder('${order.id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = tableHTML;
  updatePagination();
}

function updatePagination() {
  const totalRows = filteredOrders.length;
  const totalPages = Math.ceil(totalRows / pageSize);
  const startRow = (currentPage - 1) * pageSize + 1;
  const endRow = Math.min(currentPage * pageSize, totalRows);
  
  document.getElementById('startRow').textContent = startRow;
  document.getElementById('endRow').textContent = endRow;
  document.getElementById('totalRows').textContent = totalRows;
  
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageNumbers = document.getElementById('pageNumbers');
  
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage === totalPages || totalPages === 0;
  
  // Generate page numbers
  let pageHTML = '';
  const maxPages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
  let endPage = Math.min(totalPages, startPage + maxPages - 1);
  
  if (endPage - startPage + 1 < maxPages) {
    startPage = Math.max(1, endPage - maxPages + 1);
  }
  
  for (let i = startPage; i <= endPage; i++) {
    pageHTML += `
      <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
        ${i}
      </button>
    `;
  }
  
  pageNumbers.innerHTML = pageHTML;
}

function previousPage() {
  if (currentPage > 1) {
    currentPage--;
    displayOrders();
  }
}

function nextPage() {
  const totalPages = Math.ceil(filteredOrders.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    displayOrders();
  }
}

function goToPage(page) {
  currentPage = page;
  displayOrders();
}

// ============================================
// ORDER CRUD OPERATIONS
// ============================================

async function viewOrder(orderId) {
  try {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;
    
    // Open order in new tab or show details
    showMessage(`Viewing order: ${order.orderNumber}`);
    
    // You could implement a detailed view modal here
    // For now, just show a message
    
  } catch (error) {
    console.error('âŒ Error viewing order:', error);
    showError('Failed to view order details');
  }
}

async function editOrder(orderId) {
  try {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;
    
    currentOrderId = orderId;
    
    // Populate modal
    document.getElementById('modalTitle').textContent = `Edit Order: ${order.orderNumber}`;
    document.getElementById('orderStatus').value = order.status || 'payment_pending';
    document.getElementById('paymentStatus').value = order.paymentStatus || 'pending';
    document.getElementById('trackingNumber').value = order.trackingNumber || '';
    document.getElementById('courierService').value = order.courierService || '';
    document.getElementById('adminNotes').value = order.adminNotes || '';
    
    if (order.estimatedDelivery) {
      const estDate = new Date(order.estimatedDelivery);
      const localDate = estDate.toISOString().slice(0, 16);
      document.getElementById('estimatedDelivery').value = localDate;
    } else {
      document.getElementById('estimatedDelivery').value = '';
    }
    
    // Populate timeline steps
    populateTimelineSteps(order);
    
    // Show modal
    document.getElementById('orderModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    
  } catch (error) {
    console.error('âŒ Error editing order:', error);
    showError('Failed to edit order');
  }
}

function populateTimelineSteps(order) {
  const timelineSteps = document.getElementById('timelineSteps');
  const steps = [
    {
      id: 'paymentConfirmedAt',
      title: 'Payment Confirmed',
      description: 'Mark payment as confirmed',
      icon: 'fa-credit-card',
      date: order.paymentConfirmedAt
    },
    {
      id: 'processingStartAt',
      title: 'Processing Started',
      description: 'Order processing start time',
      icon: 'fa-cogs',
      date: order.processingStartAt
    },
    {
      id: 'readyToShipAt',
      title: 'Ready to Ship',
      description: 'Order packed and ready',
      icon: 'fa-box',
      date: order.readyToShipAt
    },
    {
      id: 'shippedAt',
      title: 'Shipped',
      description: 'Order shipped date',
      icon: 'fa-shipping-fast',
      date: order.shippedAt
    },
    {
      id: 'outForDeliveryAt',
      title: 'Out for Delivery',
      description: 'Out for delivery date',
      icon: 'fa-truck',
      date: order.outForDeliveryAt
    },
    {
      id: 'deliveredAt',
      title: 'Delivered',
      description: 'Order delivered date',
      icon: 'fa-check-circle',
      date: order.deliveredAt
    }
  ];
  
  let stepsHTML = '';
  
  steps.forEach(step => {
    const isCompleted = !!step.date;
    const dateValue = step.date ? new Date(step.date).toISOString().slice(0, 16) : '';
    
    stepsHTML += `
      <div class="timeline-step ${isCompleted ? 'completed' : ''}">
        <div class="step-checkbox">
          <input type="checkbox" id="check_${step.id}" ${isCompleted ? 'checked' : ''} 
                 onchange="toggleTimelineStep('${step.id}', this.checked)">
        </div>
        <div class="step-content">
          <div class="step-header">
            <div class="step-title">
              <i class="fas ${step.icon}"></i> ${step.title}
            </div>
            <div class="step-date">${step.date ? formatDateTime(step.date) : 'Not set'}</div>
          </div>
          <div class="step-desc" style="margin-bottom: 10px; color: var(--text-light); font-size: 12px;">
            ${step.description}
          </div>
          <div class="step-fields">
            <div class="form-group">
              <label>Date & Time</label>
              <input type="datetime-local" id="date_${step.id}" value="${dateValue}" 
                     ${!isCompleted ? 'disabled' : ''}>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <input type="text" id="notes_${step.id}" placeholder="Optional notes" 
                     value="${order[`${step.id}Notes`] || ''}">
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  timelineSteps.innerHTML = stepsHTML;
}

function toggleTimelineStep(stepId, isChecked) {
  const dateInput = document.getElementById(`date_${stepId}`);
  const notesInput = document.getElementById(`notes_${stepId}`);
  
  if (isChecked) {
    dateInput.disabled = false;
    notesInput.disabled = false;
    
    // Set default date to now if not already set
    if (!dateInput.value) {
      const now = new Date();
      const localDate = now.toISOString().slice(0, 16);
      dateInput.value = localDate;
    }
  } else {
    dateInput.disabled = true;
    notesInput.disabled = true;
    dateInput.value = '';
    notesInput.value = '';
  }
}

async function saveOrder(event) {
  event.preventDefault();
  
  try {
    showLoading(true);
    
    const orderId = currentOrderId;
    const order = allOrders.find(o => o.id === orderId);
    
    if (!order) {
      showError('Order not found');
      return;
    }
    
    // Collect form data
    const updates = {
      status: document.getElementById('orderStatus').value,
      paymentStatus: document.getElementById('paymentStatus').value,
      trackingNumber: document.getElementById('trackingNumber').value.trim(),
      courierService: document.getElementById('courierService').value,
      adminNotes: document.getElementById('adminNotes').value.trim(),
      estimatedDelivery: document.getElementById('estimatedDelivery').value || null,
      updatedAt: new Date().toISOString(),
      updatedBy: 'admin'
    };
    
    // Collect timeline updates
    const steps = ['paymentConfirmedAt', 'processingStartAt', 'readyToShipAt', 
                   'shippedAt', 'outForDeliveryAt', 'deliveredAt'];
    
    steps.forEach(stepId => {
      const isChecked = document.getElementById(`check_${stepId}`)?.checked;
      const dateValue = document.getElementById(`date_${stepId}`)?.value;
      const notesValue = document.getElementById(`notes_${stepId}`)?.value;
      
      if (isChecked && dateValue) {
        updates[stepId] = new Date(dateValue).toISOString();
        updates[`${stepId}Notes`] = notesValue || '';
      } else {
        updates[stepId] = null;
        updates[`${stepId}Notes`] = '';
      }
    });
    
    // Update in Firestore
    // Try main orders collection first
    const orderRef = doc(db, "orders", orderId);
    
    try {
      await updateDoc(orderRef, updates);
      console.log(`âœ… Order ${orderId} updated in main collection`);
    } catch (error) {
      console.log(`âš ï¸ Could not update in main collection: ${error.message}`);
      
      // Try user orders collection
      if (order.userId) {
        const userOrderRef = doc(db, "users", order.userId, "orders", orderId);
        await updateDoc(userOrderRef, updates);
        console.log(`âœ… Order ${orderId} updated in user collection`);
      }
    }
    
    // Update local data
    const orderIndex = allOrders.findIndex(o => o.id === orderId);
    if (orderIndex !== -1) {
      allOrders[orderIndex] = { ...allOrders[orderIndex], ...updates };
    }
    
    showMessage('Order updated successfully');
    closeOrderModal();
    updateStats();
    applyFilters();
    
  } catch (error) {
    console.error('âŒ Error saving order:', error);
    showError('Failed to save order changes');
  } finally {
    showLoading(false);
  }
}

async function deleteOrder(orderId) {
  if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
    return;
  }
  
  try {
    showLoading(true);
    
    const order = allOrders.find(o => o.id === orderId);
    
    // Delete from Firestore
    // Try main collection first
    try {
      const orderRef = doc(db, "orders", orderId);
      await deleteDoc(orderRef);
    } catch (error) {
      console.log(`âš ï¸ Could not delete from main collection: ${error.message}`);
    }
    
    // Try user collection
    if (order.userId) {
      try {
        const userOrderRef = doc(db, "users", order.userId, "orders", orderId);
        await deleteDoc(userOrderRef);
      } catch (error) {
        console.log(`âš ï¸ Could not delete from user collection: ${error.message}`);
      }
    }
    
    // Remove from local data
    allOrders = allOrders.filter(o => o.id !== orderId);
    filteredOrders = filteredOrders.filter(o => o.id !== orderId);
    
    showMessage('Order deleted successfully');
    updateStats();
    displayOrders();
    
  } catch (error) {
    console.error('âŒ Error deleting order:', error);
    showError('Failed to delete order');
  } finally {
    showLoading(false);
  }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function refreshOrders() {
  loadAllOrders();
  showMessage('Refreshing orders...');
}

function exportOrders() {
  // Simple CSV export
  const headers = ['Order Number', 'Date', 'Customer', 'Email', 'Amount', 'Status', 'Payment Method', 'Tracking Number'];
  
  const csvData = filteredOrders.map(order => [
    order.orderNumber || '',
    formatDate(order.createdAt),
    order.userName || order.shippingAddress?.name || '',
    order.userEmail || order.shippingAddress?.email || '',
    order.total || 0,
    getStatusText(order.status),
    order.paymentMethod === 'bank' ? 'Bank Transfer' : order.paymentMethod === 'stripe' ? 'Credit Card' : 'PayPal',
    order.trackingNumber || ''
  ]);
  
  const csv = [headers, ...csvData]
    .map(row => row.map(cell => `"${cell}"`).join(','))
    .join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `orders_export_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showMessage('Orders exported successfully');
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('admin_auth');
    window.location.href = 'index.html';
  }
}

function closeOrderModal() {
  document.getElementById('orderModal').classList.remove('active');
  document.body.style.overflow = 'auto';
  currentOrderId = null;
}

function showLoading(show) {
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) {
    spinner.style.display = show ? 'block' : 'none';
  }
}

function showMessage(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--primary-gold);
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
  `;
  
  toast.innerHTML = `
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-check-circle"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function showError(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--admin-red);
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
  `;
  
  toast.innerHTML = `
    <style>
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    </style>
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-exclamation-circle"></i>
      <span>${message}</span>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    return dateString;
  }
}

function getStatusClass(status) {
  const statusMap = {
    'payment_pending': 'status-pending',
    'payment_confirmed': 'status-payment-confirmed',
    'processing': 'status-processing',
    'ready_to_ship': 'status-ready-to-ship',
    'shipped': 'status-shipped',
    'out_for_delivery': 'status-out-for-delivery',
    'delivered': 'status-delivered',
    'cancelled': 'status-cancelled'
  };
  
  return statusMap[status] || 'status-pending';
}

function getStatusText(status) {
  const statusMap = {
    'payment_pending': 'Payment Pending',
    'payment_confirmed': 'Payment Confirmed',
    'processing': 'Processing',
    'ready_to_ship': 'Ready to Ship',
    'shipped': 'Shipped',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled'
  };
  
  return statusMap[status] || status;
}

function getStatusIcon(status) {
  const iconMap = {
    'payment_pending': 'fa-clock',
    'payment_confirmed': 'fa-check-circle',
    'processing': 'fa-cogs',
    'ready_to_ship': 'fa-box',
    'shipped': 'fa-shipping-fast',
    'out_for_delivery': 'fa-truck',
    'delivered': 'fa-check-circle',
    'cancelled': 'fa-times-circle'
  };
  
  return iconMap[status] || 'fa-clock';
}

// ============================================
// EVENT LISTENERS
// ============================================

function initEventListeners() {
  // Order form submit
  const orderForm = document.getElementById('orderForm');
  if (orderForm) {
    orderForm.addEventListener('submit', saveOrder);
  }
  
  // Modal close
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  const orderModal = document.getElementById('orderModal');
  
  if (modalCloseBtn && orderModal) {
    modalCloseBtn.addEventListener('click', closeOrderModal);
    
    orderModal.addEventListener('click', function(e) {
      if (e.target === orderModal) {
        closeOrderModal();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeOrderModal();
      }
    });
  }
  
  // Filter inputs
  document.getElementById('statusFilter').addEventListener('change', applyFilters);
  document.getElementById('paymentFilter').addEventListener('change', applyFilters);
  document.getElementById('dateFrom').addEventListener('change', applyFilters);
  document.getElementById('dateTo').addEventListener('change', applyFilters);
  document.getElementById('orderSearch').addEventListener('input', applyFilters);
  document.getElementById('sortBy').addEventListener('change', applyFilters);
}

// Initialize event listeners
initEventListeners();

// Make functions available globally
window.applyFilters = applyFilters;
window.clearFilters = clearFilters;
window.refreshOrders = refreshOrders;
window.exportOrders = exportOrders;
window.viewOrder = viewOrder;
window.editOrder = editOrder;
window.deleteOrder = deleteOrder;
window.saveOrder = saveOrder;
window.closeOrderModal = closeOrderModal;
window.toggleTimelineStep = toggleTimelineStep;
window.previousPage = previousPage;
window.nextPage = nextPage;
window.goToPage = goToPage;
window.logout = logout;
</script>
</body>
</html>
