<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE – Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Segoe UI;background:#f4f6f8;margin:0;padding:15px}
h2{margin-bottom:10px}
.order{background:#fff;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.flex{display:flex;gap:12px;align-items:center;margin-bottom:6px}
.product-img{width:70px;height:70px;border-radius:6px;object-fit:cover}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;margin-left:6px}
.paid{background:#28a745;color:#fff}
.advance{background:#ffc107}
.processing{background:#6c757d;color:#fff}
.ready{background:#20c997;color:#fff}
.shipped{background:#17a2b8;color:#fff}
.out{background:#fd7e14;color:#fff}
.delivered{background:#007bff;color:#fff}
.cancelled{background:#dc3545;color:#fff}
select,input,button{padding:6px;margin-top:6px;width:100%}
button{cursor:pointer;background:#000;color:#fff;border:none;border-radius:6px}
.timeline{font-size:12px;color:#555;margin-top:8px}
</style>
</head>
<body>
<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs, doc,
  getDoc, updateDoc, addDoc, collection,
  query, orderBy, limit, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);
const box = document.getElementById("orders");

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
  box.innerHTML="";
  const snap = await getDocs(collectionGroup(db,"orders"));
  let orders=[];

  snap.forEach(d=>{
    const o=d.data();
    o._docId=d.id;
    orders.push(o);
  });

  orders.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for(const o of orders){
    if(!o.items?.length) continue;

    // AUTO CANCEL IF ADVANCE NOT PAID IN 24 HRS
    if(o.paymentStatus!=="fully_paid" && o.createdAt){
      const diff=(Date.now()-new Date(o.createdAt).getTime())/3600000;
      if(diff>24 && o.status!=="cancelled"){
        await autoCancel(o);
        continue;
      }
    }

    let badgeClass =
      o.status==="cancelled"?"cancelled":
      o.status==="delivered"?"delivered":
      o.status==="out_for_delivery"?"out":
      o.status==="shipped"?"shipped":
      o.status==="ready_to_ship"?"ready":
      o.status==="processing"?"processing":
      o.paymentStatus==="fully_paid"?"paid":"advance";

    let productsHTML="";
    for(const it of o.items){
      const ps=await getDoc(doc(db,"products",it.id));
      const p=ps.exists()?ps.data():{};
      const img=p.images?.[0]||"https://via.placeholder.com/70";
      const title=p.title||it.name;
      productsHTML+=`
        <div class="flex">
          <img src="${img}" class="product-img">
          <div><b>${title}</b><br>Qty ${it.quantity} | £${it.totalPrice}</div>
        </div>`;
    }

    box.innerHTML+=`
    <div class="order">
      <b>${o.orderNumber}</b>
      <span class="badge ${badgeClass}">${o.status||"pending"}</span>
      <p>${o.userName} – ${o.userEmail}</p>
      <p>Total £${o.total} | Paid £${o.submittedAmount||0} | Remaining £${o.remainingPayment||0}</p>

      ${productsHTML}

      <select id="status-${o._docId}">
        <option value="">Update Status</option>
        <option value="processing">Processing</option>
        <option value="ready_to_ship">Ready to Ship</option>
        <option value="shipped">Shipped</option>
        <option value="out_for_delivery">Out for Delivery</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <input id="track-${o._docId}" placeholder="Tracking Number">

      <button onclick="updateStatus('${o.userId}','${o._docId}','${o.orderNumber}')">Update Order</button>

      <button onclick="confirmFullPayment('${o.userId}','${o._docId}','${o.orderNumber}')">Confirm Full Payment</button>

      <div class="timeline">
        ${(o.statusHistory||[]).map(h=>`• ${h.status} – ${h.at}`).join("<br>")}
      </div>
    </div>`;
  }
}

/* ================= UPDATE STATUS ================= */
window.updateStatus=async(userId,orderId,orderNumber)=>{
  const status=document.getElementById(`status-${orderId}`).value;
  if(!status) return alert("Select status");

  const ref=doc(db,"users",userId,"orders",orderId);
  const snap=await getDoc(ref);
  if(!snap.exists()) return;

  const now=new Date().toISOString();
  const o=snap.data();

  const update={
    status,
    updatedAt:now,
    statusHistory:[...(o.statusHistory||[]),{status,at:now}]
  };

  if(status==="shipped"){
    update.shippingStatus="shipped";
    update.trackingNumber=document.getElementById(`track-${orderId}`).value||"";
  }
  if(status==="delivered") update.deliveredAt=now;
  if(status==="cancelled") update.cancelledAt=now;

  await updateDoc(ref,update);
  await pushNotification(userId,`Order ${orderNumber} is ${status}`);
  loadOrders();
};

/* ================= PAYMENT CONFIRM ================= */
window.confirmFullPayment=async(userId,orderId,orderNumber)=>{
  const ref=doc(db,"users",userId,"orders",orderId);
  const snap=await getDoc(ref);
  if(!snap.exists()) return;

  const o=snap.data();
  const now=new Date().toISOString();

  await updateDoc(ref,{
    paymentStatus:"fully_paid",
    submittedAmount:o.total,
    remainingPayment:0,
    updatedAt:now
  });

  await pushNotification(userId,`Full payment confirmed for ${orderNumber}`);
  loadOrders();
};

/* ================= AUTO CANCEL ================= */
async function autoCancel(o){
  const ref=doc(db,"users",o.userId,"orders",o._docId);
  const now=new Date().toISOString();
  await updateDoc(ref,{status:"cancelled",cancelledAt:now});
  await pushNotification(o.userId,`Order ${o.orderNumber} auto-cancelled (payment not received)`);
}

/* ================= NOTIFICATIONS (MAX 10) ================= */
async function pushNotification(userId,message){
  const ref=collection(db,"users",userId,"notifications");
  await addDoc(ref,{title:"Order Update",message,createdAt:new Date().toISOString(),read:false});

  const q=query(ref,orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  if(snap.size>10){
    snap.docs.slice(10).forEach(d=>deleteDoc(d.ref));
  }
}

loadOrders();
</script>
</body>
</html>
