<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --gold:#c9a227;
  --dark:#1e1e1e;
  --bg:#f4f6f8;
  --white:#fff;
}
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:var(--bg);
}
header{
  background:var(--dark);
  color:#fff;
  padding:15px 20px;
  font-size:20px;
}
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  padding:20px;
}
.card{
  background:var(--white);
  padding:15px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,.08);
}
.card h3{
  margin:0;
  font-size:14px;
  color:#555;
}
.card p{
  margin:5px 0 0;
  font-size:22px;
  font-weight:bold;
}
.orders{
  padding:20px;
}
.order{
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 5px 15px rgba(0,0,0,.06);
}
.row{
  display:flex;
  gap:15px;
  align-items:center;
}
.order img{
  width:90px;
  height:70px;
  object-fit:cover;
  border-radius:8px;
}
.badge{
  padding:4px 8px;
  font-size:12px;
  border-radius:6px;
  font-weight:bold;
}
.advance{background:#ffc107;}
.full{background:#28a745;color:#fff;}
.pending{background:#dc3545;color:#fff;}
select,input,button{
  padding:8px;
  width:100%;
  margin-top:6px;
}
button{
  background:var(--gold);
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
}
button:hover{opacity:.9;}
.disabled{opacity:.5;pointer-events:none;}
</style>
</head>

<body>

<header>Admin Dashboard – IRYA STONE</header>

<section class="stats">
  <div class="card"><h3>Total Orders</h3><p id="stTotal">0</p></div>
  <div class="card"><h3>Advance Orders</h3><p id="stAdvance">0</p></div>
  <div class="card"><h3>Fully Paid</h3><p id="stFull">0</p></div>
  <div class="card"><h3>Pending Amount (£)</h3><p id="stPending">0</p></div>
  <div class="card"><h3>Shipped Orders</h3><p id="stShipped">0</p></div>
</section>

<section class="orders" id="orders"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore,
  collectionGroup,
  getDocs,
  updateDoc,
  addDoc,
  collection,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5"
});
const db = getFirestore(app);

const ordersBox = document.getElementById("orders");

let stats={total:0,advance:0,full:0,pending:0,shipped:0};

async function loadOrders(){
  ordersBox.innerHTML="";
  stats={total:0,advance:0,full:0,pending:0,shipped:0};

  const snap = await getDocs(collectionGroup(db,"orders"));

  for(const d of snap.docs){
    const o=d.data();
    const ref=d.ref;
    stats.total++;

    const advance=o.advancePayment||0;
    const pending=Math.max(0,(o.total||0)-advance);

    if(pending===0) stats.full++; else stats.advance++;
    stats.pending+=pending;
    if(o.shippingStatus==="shipped") stats.shipped++;

    let img="";
    if(o.items?.[0]?.id){
      const p=await getDoc(doc(db,"products",o.items[0].id));
      if(p.exists()) img=p.data().imageUrl;
    }

    ordersBox.innerHTML+=`
    <div class="order">
      <div class="row">
        ${img?`<img src="${img}">`:""}
        <div>
          <b>${o.orderNumber}</b><br>
          <span class="badge ${pending===0?"full":"advance"}">
            ${pending===0?"FULL PAID":"ADVANCE PAID"}
          </span>
        </div>
      </div>

      <p><b>${o.userName}</b> | ${o.userEmail}</p>
      <p>${o.shippingAddress?.address1}, ${o.shippingAddress?.city}</p>

      <p>Total £${o.total} | Advance £${advance} | <b>Pending £${pending}</b></p>

      <select id="pay-${d.id}">
        <option value="">Payment Action</option>
        <option value="advance">Confirm Advance</option>
        <option value="full">Confirm Full Payment</option>
        <option value="reminder">Send Pending Warning</option>
      </select>
      <button onclick="pay('${d.id}')">Update Payment</button>

      <div class="${pending===0?"":"disabled"}">
        <input id="track-${d.id}" placeholder="Tracking Number">
        <input id="date-${d.id}" type="date">
        <button onclick="ship('${d.id}')">Ship Order</button>
      </div>
    </div>
    `;

    window["ref_"+d.id]=ref;
    window["ord_"+d.id]=o;
  }

  document.getElementById("stTotal").innerText=stats.total;
  document.getElementById("stAdvance").innerText=stats.advance;
  document.getElementById("stFull").innerText=stats.full;
  document.getElementById("stPending").innerText=stats.pending.toFixed(2);
  document.getElementById("stShipped").innerText=stats.shipped;
}

window.pay=async(id)=>{
  const o=window["ord_"+id];
  const ref=window["ref_"+id];
  const act=document.getElementById("pay-"+id).value;
  if(!act) return alert("Select action");

  let msg="";
  if(act==="advance"){
    msg=`Advance received. Pending £${o.total-o.advancePayment}. 
    Pay within 24 hours. Advance non-refundable.`;
  }
  if(act==="full"){
    await updateDoc(ref,{paymentStatus:"fully_paid"});
    msg="Full payment confirmed. Preparing shipment.";
  }
  if(act==="reminder"){
    msg=`£${o.total-o.advancePayment} pending. Pay within 24 hours or order may cancel.`;
  }

  await addDoc(collection(db,"users",o.userId,"notifications"),{
    type:"payment",
    message:msg,
    orderNumber:o.orderNumber,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated");
  loadOrders();
};

window.ship=async(id)=>{
  const o=window["ord_"+id];
  const ref=window["ref_"+id];
  const tr=document.getElementById("track-"+id).value;
  const dt=document.getElementById("date-"+id).value;
  if(!tr) return alert("Tracking required");

  await updateDoc(ref,{
    shippingStatus:"shipped",
    trackingNumber:tr,
    deliveryDate:dt
  });

  await addDoc(collection(db,"users",o.userId,"notifications"),{
    type:"shipping",
    message:`Order shipped. Tracking: ${tr}`,
    orderNumber:o.orderNumber,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Order shipped");
  loadOrders();
};

loadOrders();
</script>
</body>
</html>
