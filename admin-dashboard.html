<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Order Management | IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== VARIABLES ===== */
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
    
    /* Status colors */
    --pending: #ffa500;
    --processing: #007185;
    --shipped: #b12704;
    --delivered: #007600;
    --cancelled: #d50000;
    --payment-pending: #ff6b6b;
    --payment-confirmed: #51cf66;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    font-size: 14px;
}

/* ===== ADMIN HEADER ===== */
.admin-header {
    background: var(--stone-dark);
    color: var(--white);
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.admin-logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}

.admin-logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.admin-logo span {
    font-size: 20px;
    font-weight: 700;
    color: var(--white);
    font-family: 'Roboto Slab', serif;
}

.admin-logo small {
    font-size: 12px;
    color: var(--gold-light);
    margin-left: 10px;
    background: rgba(255,255,255,0.1);
    padding: 2px 8px;
    border-radius: 10px;
}

.admin-user {
    display: flex;
    align-items: center;
    gap: 12px;
}

.admin-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--primary-gold);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-weight: 600;
}

.admin-actions {
    display: flex;
    gap: 10px;
}

.admin-btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: var(--primary-gold);
    color: var(--white);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
}

.admin-btn:hover {
    background: var(--gold-dark);
}

.admin-btn.secondary {
    background: rgba(255,255,255,0.1);
}

.admin-btn.secondary:hover {
    background: rgba(255,255,255,0.2);
}

/* ===== ADMIN SIDEBAR ===== */
.admin-container {
    display: flex;
    min-height: calc(100vh - 70px);
}

.admin-sidebar {
    width: 250px;
    background: var(--stone-dark);
    color: var(--white);
    padding: 20px 0;
    position: sticky;
    top: 70px;
    height: calc(100vh - 70px);
    overflow-y: auto;
}

.admin-menu {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 0 15px;
}

.menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    border-radius: 8px;
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    transition: var(--transition);
    cursor: pointer;
}

.menu-item:hover {
    background: rgba(255,255,255,0.1);
    color: var(--white);
}

.menu-item.active {
    background: var(--primary-gold);
    color: var(--white);
}

.menu-item i {
    width: 20px;
    text-align: center;
    font-size: 16px;
}

.menu-section {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    padding: 15px 15px 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 20px;
}

.menu-section:first-child {
    margin-top: 0;
}

/* ===== ADMIN CONTENT ===== */
.admin-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.content-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}

.content-header h1 {
    font-size: 24px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.content-header h1 i {
    color: var(--primary-gold);
}

/* ===== ORDER DETAILS CARD ===== */
.order-details-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 30px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 30px;
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--primary-gold);
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title i {
    color: var(--primary-gold);
}

.order-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.info-label {
    font-size: 12px;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-weight: 600;
    color: var(--text-dark);
}

.info-value.amount {
    color: var(--primary-gold);
    font-size: 18px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending { background: #fff8e1; color: var(--pending); }
.status-processing { background: #e3f2fd; color: var(--processing); }
.status-shipped { background: #f3e5f5; color: var(--shipped); }
.status-delivered { background: #e8f5e8; color: var(--delivered); }
.status-cancelled { background: #ffebee; color: var(--cancelled); }
.status-payment-pending { background: #ffeaa7; color: #856404; }
.status-payment-confirmed { background: #d4edda; color: #155724; }

/* ===== EDIT FORM ===== */
.edit-form {
    background: var(--bg-light);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 30px 0;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--stone-dark);
}

.form-group label.required::after {
    content: " *";
    color: #ff4757;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    transition: var(--transition);
    background: var(--white);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-gold);
    box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 80px;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #e0e0e0;
}

/* ===== ADDRESS SECTIONS ===== */
.address-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 30px;
    margin: 30px 0;
}

.address-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    border: 2px solid #f0f0f0;
}

.address-card.shipping {
    border-color: #4dabf7;
}

.address-card.billing {
    border-color: #69db7c;
}

.address-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #f0f0f0;
}

.address-card-header i {
    font-size: 18px;
}

.address-card.shipping .address-card-header i {
    color: #4dabf7;
}

.address-card.billing .address-card-header i {
    color: #69db7c;
}

.address-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.address-detail-item {
    display: flex;
    gap: 10px;
}

.address-label {
    min-width: 120px;
    font-weight: 500;
    color: var(--text-light);
}

.address-value {
    flex: 1;
    color: var(--text-dark);
}

/* ===== ITEMS TABLE ===== */
.items-table-container {
    background: var(--white);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    margin: 30px 0;
}

.table-responsive {
    overflow-x: auto;
}

.items-table {
    width: 100%;
    border-collapse: collapse;
}

.items-table thead {
    background: var(--stone-dark);
    color: var(--white);
}

.items-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--primary-gold);
}

.items-table tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: var(--transition);
}

.items-table tbody tr:hover {
    background: var(--bg-light);
}

.items-table td {
    padding: 12px 15px;
    font-size: 13px;
    color: var(--text-dark);
}

.item-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background: var(--bg-light);
    flex-shrink: 0;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-info {
    flex: 1;
}

.item-name {
    font-weight: 600;
    margin-bottom: 5px;
}

.item-meta {
    font-size: 12px;
    color: var(--text-light);
}

.amount-cell {
    font-weight: 600;
    color: var(--stone-dark);
}

/* ===== TIMELINE EDITOR ===== */
.timeline-editor {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 30px 0;
    box-shadow: var(--shadow-sm);
}

.timeline-step {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 20px;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 10px;
    border: 2px solid #e0e0e0;
    transition: var(--transition);
}

.timeline-step.completed {
    border-color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.timeline-step.active {
    border-color: #4dabf7;
    background: #e7f5ff;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(77, 171, 247, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(77, 171, 247, 0); }
    100% { box-shadow: 0 0 0 0 rgba(77, 171, 247, 0); }
}

.step-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    font-size: 16px;
    flex-shrink: 0;
}

.timeline-step.completed .step-icon {
    background: var(--primary-gold);
}

.timeline-step.active .step-icon {
    background: #4dabf7;
}

.step-title {
    font-weight: 600;
    color: var(--stone-dark);
    flex: 1;
}

.step-fields {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    flex: 1;
}

/* ===== NOTIFICATION SECTION ===== */
.notification-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 30px 0;
    box-shadow: var(--shadow-sm);
}

.notification-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-type-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.notification-type-btn {
    padding: 8px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: var(--white);
    color: var(--text-dark);
    cursor: pointer;
    transition: var(--transition);
}

.notification-type-btn.active {
    background: var(--primary-gold);
    color: var(--white);
    border-color: var(--primary-gold);
}

.notification-type-btn:hover {
    border-color: var(--primary-gold);
}

.notification-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid var(--primary-gold);
}

/* ===== PAYMENT SECTION ===== */
.payment-section {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 30px 0;
    box-shadow: var(--shadow-sm);
}

.payment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.payment-summary {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
}

.payment-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.payment-item:last-child {
    border-bottom: none;
    font-weight: 600;
    font-size: 16px;
    color: var(--primary-gold);
}

.payment-label {
    color: var(--text-light);
}

.payment-value {
    font-weight: 600;
    color: var(--text-dark);
}

.payment-value.paid {
    color: #28a745;
}

.payment-value.pending {
    color: var(--pending);
}

/* ===== LOADING ===== */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* ===== MODAL ===== */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.modal-overlay.active {
    display: flex;
}

.modal {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalFadeIn 0.3s ease;
}

@keyframes modalFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.modal-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--stone-dark);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    border: none;
    transition: var(--transition);
}

.modal-close:hover {
    background: #ff4757;
    transform: rotate(90deg);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    position: sticky;
    top: 0;
    background: var(--white);
    z-index: 1;
}

.modal-header h3 {
    font-size: 20px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-header h3 i {
    color: var(--primary-gold);
}

.modal-body {
    padding: 20px;
}

/* ===== TOAST NOTIFICATION ===== */
.toast {
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--primary-gold);
    color: var(--white);
    padding: 12px 20px;
    border-radius: var(--border-radius);
    z-index: 1000;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 400px;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
    .admin-sidebar {
        width: 70px;
    }
    
    .menu-item span {
        display: none;
    }
    
    .menu-section {
        display: none;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .address-sections {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .admin-container {
        flex-direction: column;
    }
    
    .admin-sidebar {
        width: 100%;
        height: auto;
        position: static;
        padding: 10px 0;
    }
    
    .admin-menu {
        flex-direction: row;
        overflow-x: auto;
        padding: 10px;
    }
    
    .menu-item {
        flex-direction: column;
        padding: 10px;
        min-width: 70px;
        text-align: center;
    }
    
    .content-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .order-info-grid {
        grid-template-columns: 1fr;
    }
    
    .step-fields {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .admin-content {
        padding: 20px;
    }
    
    .order-details-card {
        padding: 20px;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .admin-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="form-actions">
                <button class="admin-btn" id="confirmYes">
                    <i class="fas fa-check"></i> Yes
                </button>
                <button class="admin-btn secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> No
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Admin Header -->
<header class="admin-header">
    <div class="admin-logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
        <small>ADMIN PANEL</small>
    </div>
    
    <div class="admin-user">
        <div class="admin-avatar" id="adminAvatar">
            A
        </div>
        <div>
            <div style="font-weight: 600;">Admin User</div>
            <div style="font-size: 12px; opacity: 0.8;">Order Management</div>
        </div>
        <div class="admin-actions">
            <button class="admin-btn" onclick="goToOrdersList()">
                <i class="fas fa-list"></i> All Orders
            </button>
            <button class="admin-btn secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
</header>

<!-- Admin Container -->
<div class="admin-container">
    <!-- Sidebar -->
    <nav class="admin-sidebar">
        <div class="admin-menu">
            <div class="menu-section">Dashboard</div>
            <a href="admin-orders.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <div class="menu-section">Orders</div>
            <a href="admin-orders.html" class="menu-item">
                <i class="fas fa-shopping-cart"></i>
                <span>All Orders</span>
            </a>
            <a href="#" class="menu-item active">
                <i class="fas fa-edit"></i>
                <span>Edit Order</span>
            </a>
            
            <div class="menu-section">Management</div>
            <a href="#" class="menu-item">
                <i class="fas fa-users"></i>
                <span>Customers</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-box"></i>
                <span>Products</span>
            </a>
            
            <div class="menu-section">Settings</div>
            <a href="#" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="admin-content">
        <div class="content-header">
            <h1><i class="fas fa-edit"></i> Edit Order</h1>
            <div style="display: flex; gap: 10px;">
                <button class="admin-btn" onclick="refreshOrder()">
                    <i class="fas fa-redo"></i> Refresh
                </button>
                <button class="admin-btn" onclick="saveOrder()" id="saveBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
        
        <!-- Order Details -->
        <div class="order-details-card">
            <h2 class="section-title" id="orderTitle">
                <i class="fas fa-box"></i> Loading Order...
            </h2>
            
            <div class="order-info-grid" id="orderInfo">
                <!-- Order info will be loaded here -->
            </div>
            
            <!-- Edit Form -->
            <div class="edit-form">
                <h3 class="section-title">
                    <i class="fas fa-edit"></i> Edit Order Details
                </h3>
                
                <form id="orderForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Order Status</label>
                            <select id="orderStatus" required>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Shipping Status</label>
                            <select id="shippingStatus" required>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="shipped">Shipped</option>
                                <option value="out_for_delivery">Out for Delivery</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Payment Status</label>
                            <select id="paymentStatus" required>
                                <option value="pending">Pending</option>
                                <option value="advance_paid">Advance Paid</option>
                                <option value="partial_paid">Partial Paid</option>
                                <option value="fully_paid">Fully Paid</option>
                                <option value="refunded">Refunded</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Type</label>
                            <select id="paymentType">
                                <option value="advance">Advance</option>
                                <option value="full">Full</option>
                                <option value="installment">Installment</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Tracking Number</label>
                            <input type="text" id="trackingNumber" placeholder="Enter tracking number">
                        </div>
                        
                        <div class="form-group">
                            <label>Courier Service</label>
                            <input type="text" id="courierService" placeholder="Enter courier service">
                        </div>
                        
                        <div class="form-group">
                            <label>Estimated Delivery</label>
                            <input type="datetime-local" id="estimatedDelivery">
                        </div>
                        
                        <div class="form-group">
                            <label>Shipped Date</label>
                            <input type="datetime-local" id="shippedAt">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Admin Notes</label>
                            <textarea id="adminNotes" placeholder="Add internal notes about this order..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Address Sections -->
            <div class="address-sections" id="addressSections">
                <!-- Address cards will be loaded here -->
            </div>
            
            <!-- Items Table -->
            <div id="itemsSection">
                <!-- Items will be loaded here -->
            </div>
            
            <!-- Payment Section -->
            <div class="payment-section">
                <h3 class="section-title">
                    <i class="fas fa-credit-card"></i> Payment Details
                </h3>
                
                <div class="payment-grid">
                    <div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Advance Payment</label>
                                <input type="number" id="advancePayment" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Amount to Pay</label>
                                <input type="number" id="amountToPay" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Remaining Amount</label>
                                <input type="number" id="remainingAmount" step="0.01" min="0" readonly>
                            </div>
                            
                            <div class="form-group">
                                <label>Remaining Payment</label>
                                <input type="number" id="remainingPayment" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-summary">
                        <div class="payment-item">
                            <span class="payment-label">Subtotal:</span>
                            <span class="payment-value" id="subtotalDisplay">¬£0.00</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Shipping:</span>
                            <span class="payment-value" id="shippingDisplay">¬£0.00</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Tax:</span>
                            <span class="payment-value" id="taxDisplay">¬£0.00</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Total:</span>
                            <span class="payment-value" id="totalDisplay">¬£0.00</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Paid:</span>
                            <span class="payment-value paid" id="paidDisplay">¬£0.00</span>
                        </div>
                        <div class="payment-item">
                            <span class="payment-label">Balance:</span>
                            <span class="payment-value pending" id="balanceDisplay">¬£0.00</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Timeline Editor -->
            <div class="timeline-editor">
                <h3 class="section-title">
                    <i class="fas fa-history"></i> Order Timeline
                </h3>
                
                <div id="timelineSteps">
                    <!-- Timeline steps will be loaded here -->
                </div>
            </div>
            
            <!-- Notification Section -->
            <div class="notification-section">
                <h3 class="section-title">
                    <i class="fas fa-bell"></i> Send Notification
                </h3>
                
                <div class="notification-form">
                    <div class="notification-type-selector">
                        <button type="button" class="notification-type-btn active" onclick="setNotificationType('status_update')">
                            Status Update
                        </button>
                        <button type="button" class="notification-type-btn" onclick="setNotificationType('payment_update')">
                            Payment Update
                        </button>
                        <button type="button" class="notification-type-btn" onclick="setNotificationType('shipping_update')">
                            Shipping Update
                        </button>
                        <button type="button" class="notification-type-btn" onclick="setNotificationType('custom')">
                            Custom Message
                        </button>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Notification Title</label>
                            <input type="text" id="notificationTitle" placeholder="Enter notification title">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Message</label>
                            <textarea id="notificationMessage" placeholder="Enter notification message..." rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="notification-preview" id="notificationPreview">
                        <div style="font-weight: 600; margin-bottom: 5px;">Preview:</div>
                        <div id="previewContent">Your notification will appear here...</div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="admin-btn" onclick="sendNotification()">
                            <i class="fas fa-paper-plane"></i> Send Notification
                        </button>
                        <button type="button" class="admin-btn secondary" onclick="clearNotification()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="form-actions">
                <button class="admin-btn" onclick="saveOrder()" id="saveBtn">
                    <i class="fas fa-save"></i> Save All Changes
                </button>
                <button class="admin-btn secondary" onclick="refreshOrder()">
                    <i class="fas fa-redo"></i> Refresh
                </button>
                <button class="admin-btn" style="background: #ff6b6b;" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete Order
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  query, 
  orderBy, 
  onSnapshot,
  getDocs,
  updateDoc,
  doc,
  where,
  getDoc,
  setDoc,
  deleteDoc,
  Timestamp,
  addDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
  storageBucket: "iryastone-uk.firebasestorage.app",
  messagingSenderId: "110940910896",
  appId: "1:110940910896:web:b25e92127118665e5c84f5",
  measurementId: "G-6YM1FLYN48"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================
// GLOBAL VARIABLES
// ============================================

let currentOrder = null;
let currentOrderId = null;
let notificationType = 'status_update';

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
  console.log("üì± Admin edit page loaded");
  
  // Check admin authentication
  checkAdminAuth();
  
  // Get order ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  currentOrderId = urlParams.get('id');
  
  if (!currentOrderId) {
    showError('No order ID provided');
    setTimeout(() => {
      window.location.href = 'admin-orders.html';
    }, 2000);
    return;
  }
  
  // Load order details
  await loadOrderDetails();
  
  // Setup event listeners
  setupEventListeners();
  
  // Setup auto-save indicator
  setupAutoSave();
});

function checkAdminAuth() {
  const adminAuth = localStorage.getItem('admin_auth');
  if (!adminAuth) {
    window.location.href = 'admin-login.html';
  }
  
  const adminName = localStorage.getItem('admin_name') || 'Admin';
  const adminAvatar = document.getElementById('adminAvatar');
  adminAvatar.textContent = adminName.charAt(0).toUpperCase();
}

// ============================================
// ORDER LOADING FUNCTIONS
// ============================================

async function loadOrderDetails() {
  try {
    showLoading(true);
    
    console.log(`üîÑ Loading order: ${currentOrderId}`);
    
    // Try to load from main orders collection
    const orderRef = doc(db, "orders", currentOrderId);
    const orderSnap = await getDoc(orderRef);
    
    if (orderSnap.exists()) {
      currentOrder = orderSnap.data();
      currentOrder.id = orderSnap.id;
      console.log("‚úÖ Order loaded from main collection");
    } else {
      // Try to find in user orders
      await findOrderInUserCollections();
    }
    
    if (!currentOrder) {
      showError('Order not found');
      setTimeout(() => {
        window.location.href = 'admin-orders.html';
      }, 2000);
      return;
    }
    
    // Display order details
    displayOrderDetails();
    
    // Setup payment calculations
    setupPaymentCalculations();
    
  } catch (error) {
    console.error('‚ùå Error loading order:', error);
    showError('Failed to load order details');
  } finally {
    showLoading(false);
  }
}

async function findOrderInUserCollections() {
  try {
    // Search in users collection
    const usersRef = collection(db, "users");
    const usersSnapshot = await getDocs(usersRef);
    
    for (const userDoc of usersSnapshot.docs) {
      const userId = userDoc.id;
      
      try {
        const userOrderRef = doc(db, "users", userId, "orders", currentOrderId);
        const userOrderSnap = await getDoc(userOrderRef);
        
        if (userOrderSnap.exists()) {
          currentOrder = userOrderSnap.data();
          currentOrder.id = userOrderSnap.id;
          currentOrder.userId = userId;
          console.log(`‚úÖ Order found in user collection: ${userId}`);
          break;
        }
      } catch (error) {
        // Skip this user
      }
    }
  } catch (error) {
    console.error('‚ùå Error searching user collections:', error);
  }
}

function displayOrderDetails() {
  // Update page title
  document.getElementById('orderTitle').innerHTML = `
    <i class="fas fa-box"></i> Order: ${currentOrder.orderNumber || currentOrder.id}
  `;
  
  // Display order info
  displayOrderInfo();
  
  // Populate form fields
  populateFormFields();
  
  // Display addresses
  displayAddresses();
  
  // Display items
  displayItems();
  
  // Display timeline
  displayTimeline();
}

function displayOrderInfo() {
  const orderInfo = document.getElementById('orderInfo');
  const createdAt = formatDateTime(currentOrder.createdAt);
  const updatedAt = formatDateTime(currentOrder.updatedAt);
  const shippedAt = formatDateTime(currentOrder.shippedAt);
  
  orderInfo.innerHTML = `
    <div class="info-item">
      <div class="info-label">Order Number</div>
      <div class="info-value">${currentOrder.orderNumber || 'N/A'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Order Date</div>
      <div class="info-value">${createdAt}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Order Status</div>
      <div class="status-badge ${getStatusClass(currentOrder.status)}">
        <i class="fas ${getStatusIcon(currentOrder.status)}"></i>
        ${getStatusText(currentOrder.status)}
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Shipping Status</div>
      <div class="status-badge ${getStatusClass(currentOrder.shippingStatus)}">
        <i class="fas ${getStatusIcon(currentOrder.shippingStatus)}"></i>
        ${getStatusText(currentOrder.shippingStatus)}
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Payment Status</div>
      <div class="status-badge ${getPaymentStatusClass(currentOrder.paymentStatus)}">
        <i class="fas ${getPaymentStatusIcon(currentOrder.paymentStatus)}"></i>
        ${getPaymentStatusText(currentOrder.paymentStatus)}
      </div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Customer</div>
      <div class="info-value">${currentOrder.userName || 'N/A'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Email</div>
      <div class="info-value">${currentOrder.userEmail || currentOrder.billingAddress?.email || 'N/A'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Phone</div>
      <div class="info-value">${currentOrder.shippingAddress?.phone || currentOrder.billingAddress?.phone || 'N/A'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Total Amount</div>
      <div class="info-value amount">¬£${currentOrder.total?.toFixed(2) || '0.00'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Tracking Number</div>
      <div class="info-value">${currentOrder.trackingNumber || 'Not assigned'}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Last Updated</div>
      <div class="info-value">${updatedAt}</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Shipped Date</div>
      <div class="info-value">${shippedAt || 'Not shipped yet'}</div>
    </div>
  `;
}

function populateFormFields() {
  // Basic fields
  document.getElementById('orderStatus').value = currentOrder.status || 'pending';
  document.getElementById('shippingStatus').value = currentOrder.shippingStatus || 'pending';
  document.getElementById('paymentStatus').value = currentOrder.paymentStatus || 'pending';
  document.getElementById('paymentType').value = currentOrder.paymentType || 'advance';
  document.getElementById('trackingNumber').value = currentOrder.trackingNumber || '';
  document.getElementById('courierService').value = currentOrder.courierService || '';
  document.getElementById('adminNotes').value = currentOrder.adminNotes || '';
  
  // Date fields
  if (currentOrder.estimatedDelivery) {
    const estDate = new Date(currentOrder.estimatedDelivery);
    const localEstDate = estDate.toISOString().slice(0, 16);
    document.getElementById('estimatedDelivery').value = localEstDate;
  }
  
  if (currentOrder.shippedAt) {
    const shippedDate = new Date(currentOrder.shippedAt);
    const localShippedDate = shippedDate.toISOString().slice(0, 16);
    document.getElementById('shippedAt').value = localShippedDate;
  }
  
  // Payment fields
  document.getElementById('advancePayment').value = currentOrder.advancePayment || 0;
  document.getElementById('amountToPay').value = currentOrder.amountToPay || 0;
  document.getElementById('remainingAmount').value = currentOrder.remainingAmount || 0;
  document.getElementById('remainingPayment').value = currentOrder.remainingPayment || 0;
  
  // Update payment display
  document.getElementById('subtotalDisplay').textContent = `¬£${currentOrder.subtotal?.toFixed(2) || '0.00'}`;
  document.getElementById('shippingDisplay').textContent = `¬£${currentOrder.shipping?.toFixed(2) || '0.00'}`;
  document.getElementById('taxDisplay').textContent = `¬£${currentOrder.tax?.toFixed(2) || '0.00'}`;
  document.getElementById('totalDisplay').textContent = `¬£${currentOrder.total?.toFixed(2) || '0.00'}`;
  
  const paidAmount = currentOrder.advancePayment || 0;
  const balance = (currentOrder.total || 0) - paidAmount;
  
  document.getElementById('paidDisplay').textContent = `¬£${paidAmount.toFixed(2)}`;
  document.getElementById('balanceDisplay').textContent = `¬£${balance.toFixed(2)}`;
}

function displayAddresses() {
  const addressSections = document.getElementById('addressSections');
  
  let shippingHTML = '';
  let billingHTML = '';
  
  // Shipping Address
  if (currentOrder.shippingAddress) {
    const addr = currentOrder.shippingAddress;
    shippingHTML = `
      <div class="address-card shipping">
        <div class="address-card-header">
          <i class="fas fa-truck"></i>
          <h3>Shipping Address</h3>
        </div>
        <div class="address-details">
          <div class="address-detail-item">
            <span class="address-label">Name:</span>
            <span class="address-value">${addr.fullName || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Phone:</span>
            <span class="address-value">${addr.phone || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Email:</span>
            <span class="address-value">${addr.email || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Address:</span>
            <span class="address-value">${addr.address1 || ''} ${addr.address2 || ''}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">City:</span>
            <span class="address-value">${addr.city || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">State:</span>
            <span class="address-value">${addr.state || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Postal Code:</span>
            <span class="address-value">${addr.postalCode || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Country:</span>
            <span class="address-value">${addr.country || 'N/A'}</span>
          </div>
          ${addr.instructions ? `
          <div class="address-detail-item">
            <span class="address-label">Instructions:</span>
            <span class="address-value">${addr.instructions}</span>
          </div>
          ` : ''}
        </div>
      </div>
    `;
  }
  
  // Billing Address
  if (currentOrder.billingAddress) {
    const addr = currentOrder.billingAddress;
    billingHTML = `
      <div class="address-card billing">
        <div class="address-card-header">
          <i class="fas fa-file-invoice"></i>
          <h3>Billing Address</h3>
        </div>
        <div class="address-details">
          <div class="address-detail-item">
            <span class="address-label">Name:</span>
            <span class="address-value">${addr.fullName || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Phone:</span>
            <span class="address-value">${addr.phone || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Email:</span>
            <span class="address-value">${addr.email || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Address:</span>
            <span class="address-value">${addr.address1 || ''} ${addr.address2 || ''}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">City:</span>
            <span class="address-value">${addr.city || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">State:</span>
            <span class="address-value">${addr.state || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Postal Code:</span>
            <span class="address-value">${addr.postalCode || 'N/A'}</span>
          </div>
          <div class="address-detail-item">
            <span class="address-label">Country:</span>
            <span class="address-value">${addr.country || 'N/A'}</span>
          </div>
        </div>
      </div>
    `;
  }
  
  addressSections.innerHTML = shippingHTML + billingHTML;
}

function displayItems() {
  const itemsSection = document.getElementById('itemsSection');
  
  if (!currentOrder.items || currentOrder.items.length === 0) {
    itemsSection.innerHTML = `
      <div class="notification-section">
        <h3 class="section-title">
          <i class="fas fa-box-open"></i> No Items Found
        </h3>
        <p>This order doesn't contain any items.</p>
      </div>
    `;
    return;
  }
  
  let itemsHTML = '';
  
  currentOrder.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td>
          <div class="item-cell">
            <div class="item-image">
              <img src="https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=200&q=80" 
                   alt="${item.name || item.stoneName}" 
                   onerror="this.src='https://images.unsplash.com/photo-1544931170-3ca1337cce88?w=200&q=80'">
            </div>
            <div class="item-info">
              <div class="item-name">${item.name || item.stoneName || 'Product'}</div>
              <div class="item-meta">
                Quantity: ${item.quantity || 1} ‚Ä¢ 
                ${item.calculationData?.unit || 'unit'} ‚Ä¢ 
                Area: ${item.calculationData?.area || 0} sqft
              </div>
              <div class="item-meta">
                ${item.customRequirements ? `Requirements: ${item.customRequirements}` : ''}
              </div>
            </div>
          </div>
        </td>
        <td class="amount-cell">¬£${item.price?.toFixed(2) || '0.00'}</td>
        <td class="amount-cell">¬£${item.totalPrice?.toFixed(2) || item.calculatedPrice?.toFixed(2) || '0.00'}</td>
        <td>
          <div style="font-size: 12px;">
            <div>Advance: ¬£${item.advancePayment?.toFixed(2) || '0.00'}</div>
            <div>Remaining: ¬£${item.remainingPayment?.toFixed(2) || '0.00'}</div>
          </div>
        </td>
      </tr>
    `;
  });
  
  itemsSection.innerHTML = `
    <div class="items-table-container">
      <h3 class="section-title" style="padding: 20px 20px 0;">
        <i class="fas fa-boxes"></i> Order Items (${currentOrder.items.length})
      </h3>
      <div class="table-responsive">
        <table class="items-table">
          <thead>
            <tr>
              <th>Item Details</th>
              <th>Unit Price</th>
              <th>Total Price</th>
              <th>Payment</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>
      </div>
    </div>
  `;
}

function displayTimeline() {
  const timelineSteps = document.getElementById('timelineSteps');
  
  const steps = [
    {
      id: 'orderCreated',
      title: 'Order Created',
      description: 'Order was placed by customer',
      icon: 'fa-shopping-cart',
      date: currentOrder.createdAt,
      field: 'createdAt',
      editable: false
    },
    {
      id: 'paymentReceived',
      title: 'Payment Received',
      description: 'Payment was received from customer',
      icon: 'fa-credit-card',
      date: currentOrder.paymentReceivedAt,
      field: 'paymentReceivedAt',
      editable: true
    },
    {
      id: 'orderConfirmed',
      title: 'Order Confirmed',
      description: 'Order was confirmed by admin',
      icon: 'fa-check-circle',
      date: currentOrder.orderConfirmedAt,
      field: 'orderConfirmedAt',
      editable: true
    },
    {
      id: 'processingStarted',
      title: 'Processing Started',
      description: 'Order processing started',
      icon: 'fa-cogs',
      date: currentOrder.processingStartedAt,
      field: 'processingStartedAt',
      editable: true
    },
    {
      id: 'readyToShip',
      title: 'Ready to Ship',
      description: 'Order packed and ready for shipping',
      icon: 'fa-box',
      date: currentOrder.readyToShipAt,
      field: 'readyToShipAt',
      editable: true
    },
    {
      id: 'shipped',
      title: 'Shipped',
      description: 'Order was shipped',
      icon: 'fa-shipping-fast',
      date: currentOrder.shippedAt,
      field: 'shippedAt',
      editable: true
    },
    {
      id: 'outForDelivery',
      title: 'Out for Delivery',
      description: 'Order is out for delivery',
      icon: 'fa-truck',
      date: currentOrder.outForDeliveryAt,
      field: 'outForDeliveryAt',
      editable: true
    },
    {
      id: 'delivered',
      title: 'Delivered',
      description: 'Order was delivered to customer',
      icon: 'fa-check-double',
      date: currentOrder.deliveredAt,
      field: 'deliveredAt',
      editable: true
    }
  ];
  
  let timelineHTML = '';
  
  steps.forEach(step => {
    const isCompleted = !!step.date;
    const dateValue = step.date ? new Date(step.date).toISOString().slice(0, 16) : '';
    const displayDate = step.date ? formatDateTime(step.date) : 'Not set';
    
    timelineHTML += `
      <div class="timeline-step ${isCompleted ? 'completed' : ''}">
        <div class="step-header">
          <div class="step-icon">
            <i class="fas ${step.icon}"></i>
          </div>
          <div class="step-title">${step.title}</div>
        </div>
        <div class="step-description" style="margin-bottom: 15px; color: var(--text-light); font-size: 13px;">
          ${step.description}
        </div>
        <div class="step-fields">
          <div class="form-group">
            <label>Status</label>
            <select class="timeline-status" data-field="${step.field}" ${!step.editable ? 'disabled' : ''}>
              <option value="pending" ${!isCompleted ? 'selected' : ''}>Pending</option>
              <option value="completed" ${isCompleted ? 'selected' : ''}>Completed</option>
            </select>
          </div>
          <div class="form-group">
            <label>Date & Time</label>
            <input type="datetime-local" 
                   class="timeline-date" 
                   data-field="${step.field}" 
                   value="${dateValue}"
                   ${!step.editable ? 'disabled' : ''}>
          </div>
        </div>
        <div class="step-date" style="margin-top: 10px; font-size: 12px; color: var(--text-light);">
          <i class="far fa-clock"></i> ${displayDate}
        </div>
      </div>
    `;
  });
  
  timelineSteps.innerHTML = timelineHTML;
  
  // Add event listeners to timeline controls
  document.querySelectorAll('.timeline-status').forEach(select => {
    select.addEventListener('change', function() {
      const dateInput = this.closest('.timeline-step').querySelector('.timeline-date');
      if (this.value === 'completed') {
        dateInput.disabled = false;
        if (!dateInput.value) {
          const now = new Date();
          dateInput.value = now.toISOString().slice(0, 16);
        }
      } else {
        dateInput.disabled = true;
        dateInput.value = '';
      }
    });
  });
}

// ============================================
// PAYMENT CALCULATIONS
// ============================================

function setupPaymentCalculations() {
  // Calculate remaining amount
  function updateRemainingAmount() {
    const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
    const total = parseFloat(currentOrder.total) || 0;
    const remaining = total - advance;
    
    document.getElementById('remainingAmount').value = remaining.toFixed(2);
    document.getElementById('paidDisplay').textContent = `¬£${advance.toFixed(2)}`;
    document.getElementById('balanceDisplay').textContent = `¬£${remaining.toFixed(2)}`;
  }
  
  // Add event listeners
  document.getElementById('advancePayment').addEventListener('input', updateRemainingAmount);
  document.getElementById('amountToPay').addEventListener('input', function() {
    const amountToPay = parseFloat(this.value) || 0;
    const advance = parseFloat(document.getElementById('advancePayment').value) || 0;
    const remainingPayment = amountToPay - advance;
    
    document.getElementById('remainingPayment').value = remainingPayment > 0 ? remainingPayment.toFixed(2) : '0.00';
    updateRemainingAmount();
  });
  
  // Initial calculation
  updateRemainingAmount();
}

// ============================================
// NOTIFICATION FUNCTIONS
// ============================================

function setNotificationType(type) {
  notificationType = type;
  
  // Update button states
  document.querySelectorAll('.notification-type-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Update preview
  updateNotificationPreview();
}

function updateNotificationPreview() {
  const title = document.getElementById('notificationTitle').value;
  const message = document.getElementById('notificationMessage').value;
  const preview = document.getElementById('previewContent');
  
  let previewHTML = '';
  
  if (!title && !message) {
    previewHTML = 'Your notification will appear here...';
  } else {
    previewHTML = `
      <div style="margin-bottom: 10px;">
        <strong>${title || 'Notification'}</strong>
      </div>
      <div>${message || 'No message provided'}</div>
    `;
  }
  
  preview.innerHTML = previewHTML;
}

async function sendNotification() {
  try {
    const title = document.getElementById('notificationTitle').value.trim();
    const message = document.getElementById('notificationMessage').value.trim();
    
    if (!title || !message) {
      showError('Please provide both title and message');
      return;
    }
    
    if (!currentOrder.userId) {
      showError('Cannot send notification: User ID not found');
      return;
    }
    
    showLoading(true);
    
    // Create notification in user's notifications collection
    const notificationData = {
      title: title,
      message: message,
      type: notificationType,
      orderId: currentOrderId,
      orderNumber: currentOrder.orderNumber,
      read: false,
      createdAt: new Date().toISOString(),
      createdBy: 'admin'
    };
    
    const notificationsRef = collection(db, "users", currentOrder.userId, "notifications");
    await addDoc(notificationsRef, notificationData);
    
    showSuccess('Notification sent successfully');
    
    // Clear form
    clearNotification();
    
    // Update preview
    updateNotificationPreview();
    
  } catch (error) {
    console.error('‚ùå Error sending notification:', error);
    showError('Failed to send notification');
  } finally {
    showLoading(false);
  }
}

function clearNotification() {
  document.getElementById('notificationTitle').value = '';
  document.getElementById('notificationMessage').value = '';
  updateNotificationPreview();
}

// ============================================
// SAVE ORDER FUNCTIONS
// ============================================

async function saveOrder() {
  try {
    if (!confirm('Save all changes to this order?')) {
      return;
    }
    
    showLoading(true);
    
    // Collect updated data
    const updates = {
      // Status updates
      status: document.getElementById('orderStatus').value,
      shippingStatus: document.getElementById('shippingStatus').value,
      paymentStatus: document.getElementById('paymentStatus').value,
      paymentType: document.getElementById('paymentType').value,
      
      // Shipping info
      trackingNumber: document.getElementById('trackingNumber').value.trim(),
      courierService: document.getElementById('courierService').value.trim(),
      adminNotes: document.getElementById('adminNotes').value.trim(),
      updatedAt: new Date().toISOString(),
      updatedBy: 'admin'
    };
    
    // Date fields
    const estimatedDelivery = document.getElementById('estimatedDelivery').value;
    if (estimatedDelivery) {
      updates.estimatedDelivery = new Date(estimatedDelivery).toISOString();
    }
    
    const shippedAt = document.getElementById('shippedAt').value;
    if (shippedAt) {
      updates.shippedAt = new Date(shippedAt).toISOString();
    }
    
    // Payment updates
    updates.advancePayment = parseFloat(document.getElementById('advancePayment').value) || 0;
    updates.amountToPay = parseFloat(document.getElementById('amountToPay').value) || 0;
    updates.remainingAmount = parseFloat(document.getElementById('remainingAmount').value) || 0;
    updates.remainingPayment = parseFloat(document.getElementById('remainingPayment').value) || 0;
    
    // Timeline updates
    document.querySelectorAll('.timeline-step').forEach(step => {
      const statusSelect = step.querySelector('.timeline-status');
      const dateInput = step.querySelector('.timeline-date');
      
      if (statusSelect && dateInput && !statusSelect.disabled) {
        const field = statusSelect.dataset.field;
        if (statusSelect.value === 'completed' && dateInput.value) {
          updates[field] = new Date(dateInput.value).toISOString();
        } else {
          updates[field] = null;
        }
      }
    });
    
    console.log('üìù Saving updates:', updates);
    
    // Update in Firestore
    let updateSuccess = false;
    
    // Try main orders collection
    try {
      const orderRef = doc(db, "orders", currentOrderId);
      await updateDoc(orderRef, updates);
      updateSuccess = true;
      console.log('‚úÖ Updated in main orders collection');
    } catch (error) {
      console.log('‚ö†Ô∏è Could not update in main collection:', error.message);
    }
    
    // Try user orders collection
    if (!updateSuccess && currentOrder.userId) {
      try {
        const userOrderRef = doc(db, "users", currentOrder.userId, "orders", currentOrderId);
        await updateDoc(userOrderRef, updates);
        updateSuccess = true;
        console.log('‚úÖ Updated in user orders collection');
      } catch (error) {
        console.log('‚ö†Ô∏è Could not update in user collection:', error.message);
      }
    }
    
    if (updateSuccess) {
      // Update local order data
      currentOrder = { ...currentOrder, ...updates };
      
      // Send status update notification
      await sendStatusUpdateNotification();
      
      showSuccess('Order updated successfully!');
      
      // Refresh display
      displayOrderDetails();
      
    } else {
      showError('Failed to save changes');
    }
    
  } catch (error) {
    console.error('‚ùå Error saving order:', error);
    showError('Failed to save order changes');
  } finally {
    showLoading(false);
  }
}

async function sendStatusUpdateNotification() {
  try {
    if (!currentOrder.userId) return;
    
    const oldStatus = currentOrder.status;
    const newStatus = document.getElementById('orderStatus').value;
    
    if (oldStatus === newStatus) return;
    
    const notificationData = {
      title: 'Order Status Updated',
      message: `Your order ${currentOrder.orderNumber} status has been updated from ${getStatusText(oldStatus)} to ${getStatusText(newStatus)}`,
      type: 'status_update',
      orderId: currentOrderId,
      orderNumber: currentOrder.orderNumber,
      read: false,
      createdAt: new Date().toISOString(),
      createdBy: 'admin'
    };
    
    const notificationsRef = collection(db, "users", currentOrder.userId, "notifications");
    await addDoc(notificationsRef, notificationData);
    
    console.log('üìß Status update notification sent');
    
  } catch (error) {
    console.error('‚ùå Error sending status notification:', error);
  }
}

// ============================================
// DELETE ORDER
// ============================================

async function confirmDelete() {
  if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
    return;
  }
  
  try {
    showLoading(true);
    
    let deleteSuccess = false;
    
    // Try main orders collection
    try {
      const orderRef = doc(db, "orders", currentOrderId);
      await deleteDoc(orderRef);
      deleteSuccess = true;
      console.log('‚úÖ Deleted from main orders collection');
    } catch (error) {
      console.log('‚ö†Ô∏è Could not delete from main collection:', error.message);
    }
    
    // Try user orders collection
    if (!deleteSuccess && currentOrder.userId) {
      try {
        const userOrderRef = doc(db, "users", currentOrder.userId, "orders", currentOrderId);
        await deleteDoc(userOrderRef);
        deleteSuccess = true;
        console.log('‚úÖ Deleted from user orders collection');
      } catch (error) {
        console.log('‚ö†Ô∏è Could not delete from user collection:', error.message);
      }
    }
    
    if (deleteSuccess) {
      showSuccess('Order deleted successfully');
      setTimeout(() => {
        window.location.href = 'admin-orders.html';
      }, 1500);
    } else {
      showError('Failed to delete order');
    }
    
  } catch (error) {
    console.error('‚ùå Error deleting order:', error);
    showError('Failed to delete order');
  } finally {
    showLoading(false);
  }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function refreshOrder() {
  loadOrderDetails();
  showMessage('Refreshing order details...');
}

function goToOrdersList() {
  window.location.href = 'admin-orders.html';
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('admin_auth');
    window.location.href = 'admin-login.html';
  }
}

function closeModal() {
  document.getElementById('confirmModal').classList.remove('active');
}

function showLoading(show) {
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) {
    spinner.style.display = show ? 'block' : 'none';
  }
}

function showSuccess(message) {
  showMessage(message, 'success');
}

function showError(message) {
  showMessage(message, 'error');
}

function showMessage(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  
  const icon = type === 'success' ? 'fa-check-circle' : 
               type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
  
  const bgColor = type === 'success' ? '#51cf66' : 
                  type === 'error' ? '#ff6b6b' : '#339af0';
  
  toast.style.background = bgColor;
  
  toast.innerHTML = `
    <i class="fas ${icon}"></i>
    <span>${message}</span>
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

function formatDateTime(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    return dateString;
  }
}

function getStatusClass(status) {
  if (!status) return 'status-pending';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing')) return 'status-processing';
  if (statusLower.includes('shipped')) return 'status-shipped';
  if (statusLower.includes('delivered')) return 'status-delivered';
  if (statusLower.includes('cancelled')) return 'status-cancelled';
  return 'status-pending';
}

function getStatusText(status) {
  if (!status) return 'Pending';
  
  const statusMap = {
    'pending': 'Pending',
    'processing': 'Processing',
    'shipped': 'Shipped',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled'
  };
  
  return statusMap[status.toLowerCase()] || status;
}

function getStatusIcon(status) {
  if (!status) return 'fa-clock';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('processing')) return 'fa-cog';
  if (statusLower.includes('shipped')) return 'fa-shipping-fast';
  if (statusLower.includes('delivered')) return 'fa-check-circle';
  if (statusLower.includes('cancelled')) return 'fa-times-circle';
  return 'fa-clock';
}

function getPaymentStatusClass(status) {
  if (!status) return 'status-payment-pending';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('advance_paid') || statusLower.includes('partial_paid')) return 'status-payment-confirmed';
  if (statusLower.includes('fully_paid')) return 'status-delivered';
  if (statusLower.includes('refunded')) return 'status-cancelled';
  return 'status-payment-pending';
}

function getPaymentStatusText(status) {
  if (!status) return 'Payment Pending';
  
  const statusMap = {
    'pending': 'Payment Pending',
    'advance_paid': 'Advance Paid',
    'partial_paid': 'Partial Paid',
    'fully_paid': 'Fully Paid',
    'refunded': 'Refunded'
  };
  
  return statusMap[status.toLowerCase()] || status;
}

function getPaymentStatusIcon(status) {
  if (!status) return 'fa-clock';
  
  const statusLower = status.toLowerCase();
  if (statusLower.includes('advance_paid') || statusLower.includes('partial_paid')) return 'fa-check-circle';
  if (statusLower.includes('fully_paid')) return 'fa-check-double';
  if (statusLower.includes('refunded')) return 'fa-undo';
  return 'fa-clock';
}

// ============================================
// EVENT LISTENERS
// ============================================

function setupEventListeners() {
  // Notification form listeners
  document.getElementById('notificationTitle').addEventListener('input', updateNotificationPreview);
  document.getElementById('notificationMessage').addEventListener('input', updateNotificationPreview);
  
  // Auto-save indicators
  const formElements = document.querySelectorAll('#orderForm input, #orderForm select, #orderForm textarea');
  formElements.forEach(element => {
    element.addEventListener('change', function() {
      showMessage('Changes detected - click Save to update', 'info');
    });
  });
}

function setupAutoSave() {
  // Check for changes periodically
  setInterval(() => {
    // You could implement auto-save here if needed
  }, 30000); // Check every 30 seconds
}

// Make functions available globally
window.setNotificationType = setNotificationType;
window.sendNotification = sendNotification;
window.clearNotification = clearNotification;
window.saveOrder = saveOrder;
window.refreshOrder = refreshOrder;
window.confirmDelete = confirmDelete;
window.goToOrdersList = goToOrdersList;
window.logout = logout;
window.closeModal = closeModal;
</script>

</body>
</html>
