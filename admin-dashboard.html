<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f2f4f7;padding:15px}
.order{background:#fff;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:bold}
.advance{background:#ffc107}
.full{background:#28a745;color:#fff}
.pending{background:#dc3545;color:#fff}
img{width:70px;height:70px;border-radius:6px;object-fit:cover}
button{padding:6px 12px;margin-top:6px;cursor:pointer}
input{width:100%;padding:6px;margin-top:6px}
hr{margin:10px 0}
</style>
</head>

<body>
<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, updateDoc, addDoc, collection, getDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

async function loadOrders(){
  ordersDiv.innerHTML="";
  const snap = await getDocs(collectionGroup(db,"orders"));

  snap.forEach(async d=>{
    const o = d.data();
    if(!o.userId) return;

    const total = Number(o.total||0);
    const advance = Number(o.advancePayment||0);
    const remaining = Math.max(total-advance,0);

    let payStatus="unpaid", badge="pending";
    if(advance>0 && remaining>0){ payStatus="advance_paid"; badge="advance"; }
    if(remaining===0){ payStatus="fully_paid"; badge="full"; }

    await updateDoc(doc(db,"users",o.userId,"orders",d.id),{
      remainingAmount: remaining,
      paymentStatus: payStatus
    });

    const imgRef = doc(db,"products",o.items?.[0]?.id||"");
    let img="";
    try{
      const p = await getDoc(imgRef);
      img = p.exists()?p.data().image:"";
    }catch{}

    ordersDiv.innerHTML+=`
    <div class="order">
      <span class="badge ${badge}">${payStatus.replace("_"," ").toUpperCase()}</span>
      <h3>${o.orderNumber}</h3>

      <img src="${img||'https://via.placeholder.com/70'}">

      <p><b>${o.userName}</b> (${o.userEmail})</p>
      <p>Total: £${total}</p>
      <p>Advance Paid: £${advance}</p>
      <p><b>Remaining: £${remaining}</b></p>

      <hr>

      <input id="track-${d.id}" placeholder="Tracking Number">
      <input id="eta-${d.id}" placeholder="Delivery ETA (date/time)">

      <button onclick="ship('${o.userId}','${d.id}','${o.orderNumber}')">
        Confirm Shipping
      </button>
    </div>`;
  });
}

window.ship = async (uid, oid, orderNo)=>{
  const track = document.getElementById(`track-${oid}`).value;
  const eta = document.getElementById(`eta-${oid}`).value;

  const ref = doc(db,"users",uid,"orders",oid);
  const snap = await getDoc(ref);

  if(snap.data().remainingAmount>0){
    alert("❌ Full payment required before shipping");
    return;
  }

  await updateDoc(ref,{
    shippingStatus:"shipped",
    trackingNumber:track,
    deliveryETA:eta,
    shippedAt:new Date().toISOString()
  });

  await addDoc(collection(db,"users",uid,"notifications"),{
    type:"shipping",
    title:"Order Shipped",
    message:`Order ${orderNo} shipped. Tracking: ${track}`,
    read:false,
    createdAt:new Date().toISOString()
  });

  alert("✅ Shipping Updated");
};

loadOrders();
</script>
</body>
</html>
