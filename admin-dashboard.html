<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE – Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Segoe UI;background:#f4f6f8;margin:0;padding:15px}
h2{margin-bottom:10px}
.order{background:#fff;border-radius:10px;padding:15px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.flex{display:flex;gap:12px;align-items:center}
.product-img{width:70px;height:70px;border-radius:6px;object-fit:cover}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;margin-right:5px}
.paid{background:#28a745;color:#fff}
.advance{background:#ffc107}
.pending{background:#6c757d;color:#fff}
.shipped{background:#17a2b8;color:#fff}
.delivered{background:#007bff;color:#fff}
.cancelled{background:#dc3545;color:#fff}
select,input,button{padding:6px;margin-top:5px;width:100%}
button{cursor:pointer;background:#000;color:#fff;border:none;border-radius:6px}
.timeline{font-size:12px;color:#555;margin-top:8px}
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs, doc,
  getDoc, updateDoc, addDoc, collection
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);
const box = document.getElementById("orders");

/* ---------------- LOAD ORDERS ---------------- */
async function loadOrders(){
  box.innerHTML="";
  const snap = await getDocs(collectionGroup(db,"orders"));
  let orders=[];

  snap.forEach(d=>{
    const o=d.data();
    o._docId=d.id;
    orders.push(o);
  });

  orders.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for(const o of orders){
    if(!o.items?.length) continue;

    let badge=o.status==="delivered"?"delivered":
      o.status==="cancelled"?"cancelled":
      o.paymentStatus==="fully_paid"?"paid":
      "advance";

    let productsHTML="";
    for(const it of o.items){
      const ps=await getDoc(doc(db,"products",it.id));
      const p=ps.exists()?ps.data():{};
      const img=p.images?.[0]||"https://via.placeholder.com/70";
      const title=p.title||it.name;
      productsHTML+=`
        <div class="flex">
          <img src="${img}" class="product-img">
          <div>
            <b>${title}</b><br>
            Qty ${it.quantity} | £${it.totalPrice}
          </div>
        </div>`;
    }

    box.innerHTML+=`
    <div class="order">
      <b>${o.orderNumber}</b>
      <span class="badge ${badge}">${o.status}</span>
      <p>${o.userName} – ${o.userEmail}</p>
      <p>Total £${o.total} | Paid £${o.submittedAmount||0} | Remaining £${o.remainingPayment||0}</p>

      ${productsHTML}

      <select id="status-${o._docId}">
        <option value="">Update Status</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="out_for_delivery">Out for Delivery</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <input id="track-${o._docId}" placeholder="Tracking Number">
      <input type="datetime-local" id="delivery-${o._docId}">

      <button onclick="updateStatus('${o.userId}','${o._docId}','${o.orderNumber}')">
        Update Order
      </button>

      <div class="timeline">
        ${(o.statusHistory||[]).map(h=>`• ${h.status} – ${h.at}`).join("<br>")}
      </div>
    </div>`;
  }
}

/* ---------------- UPDATE STATUS ---------------- */
window.updateStatus=async(userId,orderId,orderNumber)=>{
  const status=document.getElementById(`status-${orderId}`).value;
  if(!status) return alert("Select status");

  const ref=doc(db,"users",userId,"orders",orderId);
  const snap=await getDoc(ref);
  if(!snap.exists()) return;

  const now=new Date().toISOString();
  const o=snap.data();

  const update={
    status,
    updatedAt:now,
    statusHistory:[...(o.statusHistory||[]),{status,at:now}]
  };

  if(status==="shipped"){
    update.shippingStatus="shipped";
    update.trackingNumber=document.getElementById(`track-${orderId}`).value||"";
  }
  if(status==="delivered"){
    update.deliveredAt=now;
  }
  if(status==="cancelled"){
    update.cancelledAt=now;
  }

  await updateDoc(ref,update);

  await addDoc(collection(db,"users",userId,"notifications"),{
    title:"Order Update",
    message:`Order ${orderNumber} is now ${status.replaceAll("_"," ")}`,
    createdAt:now,
    read:false
  });

  loadOrders();
};

loadOrders();
</script>
</body>
</html>
