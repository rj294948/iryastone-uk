<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f4f6f8; padding:15px; }
.order { background:#fff; padding:15px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; }
button { padding:6px 10px; margin-top:6px; cursor:pointer; }
input, select { width:100%; padding:6px; margin-top:5px; }
.badge { padding:4px 8px; border-radius:4px; font-size:12px; margin-right:5px; }
.advance { background:#ffc107; color:#000; }
.full { background:#28a745; color:#fff; }
.shipped { background:#17a2b8; color:#fff; }
.pending { background:#6c757d; color:#fff; }
.product-img { width:60px; height:60px; object-fit:cover; margin-right:10px; border-radius:4px; }
.flex { display:flex; align-items:center; margin-top:5px; }
</style>
</head>
<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collectionGroup, getDocs, doc, updateDoc, addDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

// Load orders
async function loadOrders() {
  ordersDiv.innerHTML = "";
  const snap = await getDocs(collectionGroup(db, "orders"));
  let orderList = [];
  
  snap.forEach(d => {
    let o = d.data();
    o.docId = d.id;
    orderList.push(o);
  });

  // Sort by latest
  orderList.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));

  for(const o of orderList){
    // Avoid duplicate orders
    if(!o.items || o.items.length===0) continue;

    const totalPaid = o.advancePayment || 0;
    const remaining = (o.total || 0) - totalPaid;
    const isFull = remaining <= 0;
    const statusBadge = isFull ? "full" : "advance";
    const shippedBadge = o.shippingStatus==="shipped" ? "shipped" : "pending";

    // Products HTML
    let productsHTML = "";
    for(const item of o.items){
      // Fetch product info by id
      let productSnap = await getDoc(doc(db,"products",item.id));
      let product = productSnap.exists() ? productSnap.data() : {};
      let img = product.images?.[0] || 'https://via.placeholder.com/60';
      let name = product.title || product.name || item.name;
      productsHTML += `
        <div class="flex">
          <img src="${img}" class="product-img" />
          <div>
            <b>${name}</b><br/>
            Qty: ${item.quantity} | Price: £${item.price} | Remaining: £${item.remainingPayment || remaining}
          </div>
        </div>
      `;
    }

    ordersDiv.innerHTML += `
      <div class="order">
        <b>Order #: ${o.orderNumber}</b>
        <span class="badge ${statusBadge}">${isFull ? "FULL PAID" : "ADVANCE PAID"}</span>
        <span class="badge ${shippedBadge}">${o.shippingStatus || "PENDING"}</span>
        <p>User: ${o.userName} | Email: ${o.userEmail}</p>
        <p>Phone: ${o.shippingAddress?.phone || o.billingAddress?.phone}</p>
        <p>Total: £${o.total} | Paid: £${totalPaid} | Remaining: £${remaining}</p>
        ${productsHTML}

        <select id="pay-${o.docId}">
          <option value="">-- Update Payment --</option>
          <option value="advance_confirmed">Advance Confirmed</option>
          <option value="fully_paid">Fully Paid</option>
        </select>
        <button onclick="updatePayment('${o.userId}','${o.docId}','${o.orderNumber}', ${o.total})">Update Payment</button>

        <input id="track-${o.docId}" placeholder="Tracking Number">
        <input type="datetime-local" id="delivery-${o.docId}" placeholder="Delivery Date & Time">
        <button onclick="updateShipping('${o.userId}','${o.docId}','${o.orderNumber}')">Update Shipping</button>
      </div>
    `;
  }
}

// Update Payment
window.updatePayment = async (userId, orderId, orderNumber, total) => {
  const status = document.getElementById(`pay-${orderId}`).value;
  if(!status) return alert("Select payment status");

  const paidAmount = status==="fully_paid" ? total : total*0.3;

  await updateDoc(doc(db,"users",userId,"orders",orderId),{
    paymentStatus: status,
    advancePayment: paidAmount,
    remainingPayment: total - paidAmount,
    updatedAt: new Date().toISOString()
  });

  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"payment",
    orderId,
    orderNumber,
    title:"Payment Update",
    message: status==="fully_paid"
      ? `Your full payment of £${total} has been confirmed.`
      : `Advance payment of £${paidAmount} received. Remaining £${total-paidAmount}. Please complete payment within 24 hours or order will auto-cancel. Advance is non-refundable.`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Payment updated");
  loadOrders();
}

// Update Shipping
window.updateShipping = async (userId, orderId, orderNumber) => {
  const track = document.getElementById(`track-${orderId}`).value;
  const delivery = document.getElementById(`delivery-${orderId}`).value;
  if(!track) return alert("Enter tracking number");
  if(!delivery) return alert("Set delivery date & time");

  await updateDoc(doc(db,"users",userId,"orders",orderId),{
    shippingStatus:"shipped",
    trackingNumber: track,
    shippedAt: new Date().toISOString(),
    deliveryDateTime: delivery
  });

  await addDoc(collection(db,"users",userId,"notifications"),{
    type:"shipping",
    orderId,
    orderNumber,
    title:"Order Shipped",
    message: `Your order has been shipped. Tracking No: ${track}. Expected Delivery: ${delivery}`,
    createdAt:new Date().toISOString(),
    read:false
  });

  alert("Shipping updated");
  loadOrders();
}

loadOrders();
</script>
</body>
</html>
