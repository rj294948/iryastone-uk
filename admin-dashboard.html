<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>IRYA STONE – Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<h2>✅ Fully Paid Orders</h2>
<p id="paidSummary"></p>
<div id="paidOrders"></div>

<hr>

<h2>⏳ Advance / Pending Payment Orders</h2>
<p id="pendingSummary"></p>
<div id="pendingOrders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, getDoc, updateDoc, addDoc,
  collection, query, orderBy, limit, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNW...",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});
const db = getFirestore(app);

const paidBox = document.getElementById("paidOrders");
const pendingBox = document.getElementById("pendingOrders");

/* ---------- UTIL ---------- */
const nowISO = ()=> new Date().toISOString();

/* ---------- NOTIFICATION (MAX 10) ---------- */
async function notify(userId,title,msg){
  const ref = collection(db,"users",userId,"notifications");
  await addDoc(ref,{ title, message:msg, createdAt:nowISO(), read:false });

  const q = query(ref, orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  let i=0;
  for(const d of snap.docs){
    i++;
    if(i>10) await deleteDoc(d.ref);
  }
}

/* ---------- BUILD ORDER HTML ---------- */
function buildOrderHTML(o){
return `
<div style="border:1px solid #ccc;padding:15px;margin-bottom:15px">
<b>Order:</b> ${o.orderNumber}<br>
<b>Status:</b> ${o.status}<br>
<b>Payment:</b> ${o.paymentStatus}<br>
<b>Total:</b> £${o.total} |
<b>Paid:</b> £${o.submittedAmount||0} |
<b>Remaining:</b> £${o.remainingPayment||0}<br>

<b>Tracking:</b> ${o.trackingNumber||"-"}<br><br>

<b>Shipping Address</b><br>
${o.shippingAddress?.fullName||""}<br>
${o.shippingAddress?.address1||""}, ${o.shippingAddress?.city||""}<br>
${o.shippingAddress?.state||""} ${o.shippingAddress?.postalCode||""}<br>
${o.shippingAddress?.country||""}<br><br>

<select id="pay-${o._id}">
<option value="">Payment Type</option>
<option value="advance">Advance</option>
<option value="full">Full</option>
</select>

<input id="paid-${o._id}" placeholder="Paid Amount">
<input id="txn-${o._id}" placeholder="Reference Number">

<button onclick="updatePayment('${o.userId}','${o._id}','${o.orderNumber}',${o.total})">
Confirm Payment
</button>

<hr>

<select id="status-${o._id}">
<option value="">Select Status</option>
<option value="processing">Processing</option>
<option value="ready_to_ship">Ready to Ship</option>
<option value="shipped">Shipped</option>
<option value="out_for_delivery">Out for Delivery</option>
<option value="delivered">Delivered</option>
<option value="cancelled">Cancelled</option>
</select>

<input id="track-${o._id}" placeholder="Tracking Number">

<button onclick="updateStatus('${o.userId}','${o._id}','${o.orderNumber}')">
Update Status
</button>
</div>`;
}

/* ---------- LOAD ORDERS ---------- */
async function loadOrders(){
paidBox.innerHTML=""; pendingBox.innerHTML="";
let pT=0,pR=0,pC=0;
let nT=0,nR=0,nRem=0,nC=0;

const snap = await getDocs(collectionGroup(db,"orders"));
for(const d of snap.docs){
  const o=d.data(); o._id=d.id;

  if(o.paymentStatus==="fully_paid"){
    pC++; pT+=o.total||0; pR+=o.submittedAmount||0;
    paidBox.innerHTML+=buildOrderHTML(o);
  }else{
    nC++; nT+=o.total||0; nR+=o.submittedAmount||0; nRem+=o.remainingPayment||0;
    pendingBox.innerHTML+=buildOrderHTML(o);
  }
}

paidSummary.innerHTML=`Orders ${pC} | Total £${pT} | Received £${pR}`;
pendingSummary.innerHTML=`Orders ${nC} | Total £${nT} | Paid £${nR} | Remaining £${nRem}`;
}

/* ---------- PAYMENT UPDATE ---------- */
window.updatePayment = async (userId,id,ord,total)=>{
const type=document.getElementById(`pay-${id}`).value;
const paid=Number(document.getElementById(`paid-${id}`).value);
const ref=document.getElementById(`txn-${id}`).value||"";

if(!type||!paid) return alert("Enter payment");

let remaining=Math.max(total-paid,0);
await updateDoc(doc(db,"users",userId,"orders",id),{
paymentStatus:type==="full"?"fully_paid":"advance_paid",
submittedAmount:paid,
remainingPayment:remaining,
transactionReference:ref,
updatedAt:nowISO()
});

await notify(userId,"Payment Confirmed",
type==="full"
?`Full payment £${paid} confirmed.\nRef: ${ref}`
:`Advance £${paid} received.\nRemaining £${remaining}\nRef: ${ref}`);

loadOrders();
};

/* ---------- STATUS UPDATE (TRACKING EVERY STATUS) ---------- */
window.updateStatus = async (userId,id,ord)=>{
const st=document.getElementById(`status-${id}`).value;
const tr=document.getElementById(`track-${id}`).value||"";
if(!st) return;

const ref=doc(db,"users",userId,"orders",id);
const snap=await getDoc(ref);
const o=snap.data();

await updateDoc(ref,{
status:st,
trackingNumber:tr,
updatedAt:nowISO(),
statusHistory:[...(o.statusHistory||[]),{status:st,at:nowISO()}]
});

await notify(userId,"Order Update",`Order ${ord} is now ${st}`);
loadOrders();
};

loadOrders();
</script>
</body>
</html>
