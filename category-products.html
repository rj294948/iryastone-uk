<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoneCraft UK | Premium Stone Products</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ===== SLIM HEADER ===== */
        header {
            background-color: #ffffff;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            height: 70px; /* Slim height */
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            padding: 0 10px;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 24px;
            color: #333;
            font-weight: 700;
        }
        
        .logo span {
            color: #b8860b;
        }
        
        /* Search Bar */
        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 30px;
        }
        
        .search-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 45px 10px 20px;
            border: 1px solid #e1e5e9;
            border-radius: 25px;
            font-size: 14px;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #b8860b;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.1);
        }
        
        .search-button {
            position: absolute;
            right: 8px;
            background: #b8860b;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .search-button:hover {
            background: #a3780a;
        }
        
        /* User Icons */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #555;
            font-size: 11px;
            transition: color 0.3s;
        }
        
        .user-action:hover {
            color: #b8860b;
        }
        
        .user-action i {
            font-size: 18px;
            margin-bottom: 3px;
        }

        /* User Profile */
        .user-profile {
            position: relative;
        }

        .profile-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .profile-toggle:hover {
            background: #f8f9fa;
        }

        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #b8860b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            display: none;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.active {
            display: block;
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }

        .dropdown-header .user-email {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .dropdown-menu {
            list-style: none;
            padding: 8px 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
            color: #b8860b;
        }

        .dropdown-item i {
            width: 16px;
            text-align: center;
            color: #666;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 8px 0;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-top: 90px;
            padding: 30px 0;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            font-size: 36px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .page-header .breadcrumb {
            color: #666;
            font-size: 16px;
        }
        
        .page-header .breadcrumb a {
            color: #b8860b;
            text-decoration: none;
            font-weight: 500;
        }
        
        .page-header .breadcrumb span {
            margin: 0 8px;
            color: #999;
        }
        
        /* ===== MAIN LAYOUT ===== */
        .main-layout {
            display: flex;
            gap: 30px;
        }
        
        /* ===== PRODUCTS SECTION ===== */
        .products-section {
            flex: 1;
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .products-count {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }
        
        /* ===== PRODUCT GRID ===== */
        #products-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 products per row on desktop */
            gap: 25px;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .product-img-box {
            width: 100%;
            height: 220px;
            overflow: hidden;
            position: relative;
        }
        
        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }
        
        .product-card:hover .product-img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 18px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-description {
            font-size: 15px;
            color: #222;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 8px;
            min-height: 42px;
        }
        
        .product-rate {
            font-size: 18px;
            font-weight: 700;
            color: #b8860b;
            margin-bottom: 12px;
        }
        
        .details-btn {
            display: inline-block;
            padding: 10px 16px;
            font-size: 14px;
            background: #b8860b;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
            border: none;
            cursor: pointer;
            margin-top: auto;
        }
        
        .details-btn:hover {
            background: #a3780a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.3);
        }
        
        /* ===== COMPACT FILTERS SIDEBAR ===== */
        .filters-sidebar {
            flex: 0 0 280px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 100px;
        }
        
        .filter-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .filter-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-title i {
            color: #b8860b;
            font-size: 16px;
        }
        
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 6px;
            transition: background 0.3s;
        }
        
        .filter-option:hover {
            background: #f8f9fa;
        }
        
        .filter-option.active {
            background: #f8f6f0;
        }
        
        .filter-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .filter-option.active .filter-checkbox {
            background: #b8860b;
            border-color: #b8860b;
        }
        
        .filter-option.active .filter-checkbox::after {
            content: 'âœ“';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .filter-label {
            font-size: 14px;
            color: #555;
            font-weight: 500;
            flex: 1;
        }
        
        .filter-count {
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }
        
        .filter-option.active .filter-label {
            color: #b8860b;
            font-weight: 600;
        }
        
        /* ===== ACTIVE FILTERS ===== */
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            align-items: center;
        }
        
        .active-filters-title {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .active-filter {
            background: #e9ecef;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .remove-filter {
            cursor: pointer;
            color: #666;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .remove-filter:hover {
            color: #dc3545;
        }
        
        .clear-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-left: auto;
            transition: background 0.3s;
        }
        
        .clear-all-btn:hover {
            background: #c82333;
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            #products-list {
                grid-template-columns: repeat(3, 1fr); /* 3 products per row on smaller desktop */
            }
        }
        
        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column;
            }
            
            .filters-sidebar {
                flex: none;
                width: 100%;
                position: static;
            }
            
            #products-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
            }
            
            .logo {
                order: 1;
            }
            
            .search-container {
                order: 3;
                flex-basis: 100%;
                margin: 10px 0 0;
                max-width: 100%;
            }
            
            .user-actions {
                order: 2;
            }
            
            .main-content {
                margin-top: 110px;
            }
            
            #products-list {
                grid-template-columns: repeat(2, 1fr); /* 2 products per row on tablet */
            }
            
            .product-img-box {
                height: 200px;
            }
        }
        
        @media (max-width: 576px) {
            #products-list {
                grid-template-columns: 1fr; /* 1 product per row on mobile */
            }
            
            .product-img-box {
                height: 250px;
            }
            
            .user-action span {
                display: none;
            }
            
            .user-actions {
                gap: 15px;
            }
        }
        
        /* ===== NO PRODUCTS STATE ===== */
        .no-products {
            text-align: center;
            padding: 60px 20px;
            grid-column: 1 / -1;
        }
        
        .no-products i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .no-products h3 {
            font-size: 24px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .no-products p {
            color: #888;
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* ===== LOADING STATES ===== */
        .loading-products {
            text-align: center;
            padding: 60px;
            grid-column: 1 / -1;
            color: #666;
        }

        .loading-categories {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- ===== SLIM HEADER ===== -->
    <header>
        <div class="container">
            <div class="header-content">
                <!-- Logo -->
                <div class="logo">
                    <a href="index.html" style="text-decoration: none; color: inherit;">
                        <h1>Stone<span>Craft</span></h1>
                    </a>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-input-container">
                        <input type="text" class="search-input" id="searchInput" placeholder="Search for stones, products...">
                        <button class="search-button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <!-- User Icons -->
                <div class="user-actions">
                    <!-- Dynamic User Profile -->
                    <div class="user-profile" id="userProfile" style="display: none;">
                        <button class="profile-toggle" id="profileToggle">
                            <div class="profile-avatar" id="profileAvatar">U</div>
                            <span class="profile-name" id="profileName">User</span>
                            <i class="fas fa-chevron-down" style="font-size: 12px;"></i>
                        </button>
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="dropdown-header">
                                <div class="profile-name" id="dropdownUserName">User Name</div>
                                <div class="user-email" id="dropdownUserEmail">user@example.com</div>
                            </div>
                            <ul class="dropdown-menu">
                                <li><a href="dashboard.html" class="dropdown-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                                <li><a href="add.html" class="dropdown-item"><i class="fas fa-plus-circle"></i> Add Product</a></li>
                                <li><a href="edit-profile.html" class="dropdown-item"><i class="fas fa-user-edit"></i> Edit Profile</a></li>
                                <li><a href="wishlist.html" class="dropdown-item"><i class="fas fa-heart"></i> My Wishlist</a></li>
                                <li><a href="billing.html" class="dropdown-item"><i class="fas fa-address-card"></i> Billing/Shipping</a></li>
                                <li><a href="orders.html" class="dropdown-item"><i class="fas fa-history"></i> Order History</a></li>
                                <li class="dropdown-divider"></li>
                                <li><a href="#" class="dropdown-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Add Product Button -->
                    <a href="add.html" class="user-action" id="addProductButton" style="display: none;">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add Product</span>
                    </a>
                    
                    <!-- Login Button -->
                    <a href="login.html" class="user-action" id="loginButton">
                        <i class="fas fa-user"></i>
                        <span>Sign In</span>
                    </a>
                    
                    <a href="#" class="user-action">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Cart (0)</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h1 id="pageTitle">Premium Stone Collection</h1>
                <div class="breadcrumb" id="breadcrumb">
                    <a href="index.html">Home</a>
                    <span>></span>
                    <span>Products</span>
                </div>
            </div>
            
            <!-- Active Filters Display -->
            <div class="active-filters" id="activeFilters" style="display: none;">
                <span class="active-filters-title">Active Filters:</span>
                <!-- Active filters will show here -->
            </div>
            
            <!-- Main Layout with Products and Filters -->
            <div class="main-layout">
                <!-- Products Section -->
                <div class="products-section">
                    <div class="products-header">
                        <div class="products-count" id="productsCount">
                            Loading products...
                        </div>
                    </div>
                    
                    <!-- Product Grid -->
                    <div id="products-list">
                        <div class="loading-products">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading products from Firestore...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Compact Filters Sidebar -->
                <div class="filters-sidebar">
                    <!-- Categories Filter -->
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-layer-group"></i>
                            Categories
                        </h3>
                        <div class="filter-options" id="categoryFilters">
                            <div class="loading-categories">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading categories...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stone Types Filter -->
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-gem"></i>
                            Stone Types
                        </h3>
                        <div class="filter-options" id="stoneTypeFilters">
                            <div class="loading-categories">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading stone types...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Colors Filter -->
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-palette"></i>
                            Colors
                        </h3>
                        <div class="filter-options" id="colorFilters">
                            <div class="loading-categories">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading colors...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usage Filter -->
                    <div class="filter-section">
                        <h3 class="filter-title">
                            <i class="fas fa-home"></i>
                            Usage
                        </h3>
                        <div class="filter-options" id="usageFilters">
                            <div class="loading-categories">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading usage options...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… FIREBASE CONFIG SCRIPT -->
    <script type="module" src="firebase-config.js"></script>

    <script type="module">
        // ===== IMPORT FIREBASE CONFIG =====
        import { 
            db, 
            auth, 
            collection, 
            getDocs, 
            onSnapshot,
            onAuthStateChanged, 
            signOut 
        } from './firebase-config.js';

        // ===== ORIGINAL PROGRAMMING LOGIC =====
        const appState = {
            products: [],
            filteredProducts: [],
            currentUsage: null,
            currentStoneName: null,
            currentCategory: null,
            filters: {
                categories: [],
                stoneTypes: [],
                colors: [],
                usage: [],
                sortBy: 'name'
            },
            user: null,
            searchQuery: ''
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Initializing Category Products Page...');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            appState.currentUsage = urlParams.get('usage');
            appState.currentStoneName = urlParams.get('stone') || urlParams.get('stone_name');
            appState.currentCategory = urlParams.get('category');
            
            console.log('ðŸ“‹ URL Parameters:', {
                usage: appState.currentUsage,
                stone_name: appState.currentStoneName,
                category: appState.currentCategory
            });
            
            // Initialize the page
            initializePage();
            initializeAuth();
            initializeUI();
        });

        // ===== PAGE INITIALIZATION =====
        async function initializePage() {
            try {
                console.log('ðŸ”„ Starting page initialization...');
                await loadProductsFromFirestore();
                updatePageTitle();
                generateQuickFilters();
                applyAutoFilter();
                initializeSorting();
                initializeFilters();
                console.log('âœ… Page initialization completed successfully!');
            } catch (error) {
                console.error('âŒ Error initializing page:', error);
            }
        }

        // ===== REAL FIREBASE/FIRESTORE INTEGRATION =====
        async function loadProductsFromFirestore() {
            try {
                console.log('ðŸ”¥ Loading products from REAL Firestore...');
                
                // âœ… REAL Firestore Query
                const querySnapshot = await getDocs(collection(db, "products"));
                appState.products = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('ðŸ“„ Firestore Document Data:', data);
                    
                    // âœ… Handle additional_fields array properly
                    let processedData = { ...data };
                    
                    if (data.additional_fields && Array.isArray(data.additional_fields)) {
                        data.additional_fields.forEach(field => {
                            if (field && typeof field === 'object') {
                                processedData = { ...processedData, ...field };
                            }
                        });
                    }
                    
                    appState.products.push({
                        id: doc.id,
                        ...processedData
                    });
                });
                
                console.log('âœ… REAL Firestore products loaded successfully:', appState.products.length);
                console.log('ðŸ“¦ Sample product data:', appState.products[0]);
                
                // âœ… Real-time listener for Firestore updates
                onSnapshot(collection(db, "products"), (snapshot) => {
                    console.log('ðŸ”„ Real-time Firestore update received');
                    const updatedProducts = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        let processedData = { ...data };
                        
                        if (data.additional_fields && Array.isArray(data.additional_fields)) {
                            data.additional_fields.forEach(field => {
                                if (field && typeof field === 'object') {
                                    processedData = { ...processedData, ...field };
                                }
                            });
                        }
                        
                        updatedProducts.push({
                            id: doc.id,
                            ...processedData
                        });
                    });
                    appState.products = updatedProducts;
                    console.log('ðŸ”„ Products updated in real-time:', updatedProducts.length);
                    generateQuickFilters();
                    applyAutoFilter();
                });
                
            } catch (error) {
                console.error('âŒ Error loading products from REAL Firestore:', error);
                console.log('ðŸ”„ Using sample data as fallback...');
                // Fallback to sample data if Firebase fails
                appState.products = getSampleProducts();
            }
        }

        // ===== UI INITIALIZATION =====
        function initializeUI() {
            initializeSearch();
            initializeUserProfile();
        }

        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });
            
            function performSearch() {
                appState.searchQuery = searchInput.value.trim();
                applyManualFilters();
            }
        }

        function initializeUserProfile() {
            const profileToggle = document.getElementById('profileToggle');
            const profileDropdown = document.getElementById('profileDropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (!profileToggle || !profileDropdown) return;
            
            profileToggle.addEventListener('click', function(event) {
                event.stopPropagation();
                profileDropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function() {
                profileDropdown.classList.remove('active');
            });
            
            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(event) {
                    event.preventDefault();
                    signOut(auth).then(() => {
                        console.log('User signed out');
                    }).catch((error) => {
                        console.error('Sign out error:', error);
                    });
                });
            }
        }

        // ===== AUTHENTICATION =====
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    appState.user = {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    updateUserInterface();
                } else {
                    appState.user = null;
                    updateUserInterface();
                }
            });
        }

        function updateUserInterface() {
            if (appState.user) {
                // User is logged in
                document.getElementById('userProfile').style.display = 'block';
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('addProductButton').style.display = 'flex';
                
                // Update user info
                document.getElementById('profileName').textContent = appState.user.name;
                document.getElementById('profileAvatar').textContent = appState.user.name.charAt(0).toUpperCase();
                document.getElementById('dropdownUserName').textContent = appState.user.name;
                document.getElementById('dropdownUserEmail').textContent = appState.user.email;
            } else {
                // User is not logged in
                document.getElementById('userProfile').style.display = 'none';
                document.getElementById('loginButton').style.display = 'flex';
                document.getElementById('addProductButton').style.display = 'none';
            }
        }

        // ===== PAGE TITLE UPDATE =====
        function updatePageTitle() {
            const pageTitle = document.getElementById('pageTitle');
            const breadcrumb = document.getElementById('breadcrumb');
            
            // âœ… FIXED: Dynamic page title based on URL parameters
            if (appState.currentUsage && appState.currentStoneName) {
                pageTitle.textContent = `${formatText(appState.currentStoneName)} ${formatText(appState.currentUsage)} Stones`;
                breadcrumb.innerHTML = `
                    <a href="index.html">Home</a>
                    <span>></span>
                    <a href="category-products.html?usage=${appState.currentUsage}">${formatText(appState.currentUsage)}</a>
                    <span>></span>
                    <span>${formatText(appState.currentStoneName)}</span>
                `;
            } else if (appState.currentUsage) {
                pageTitle.textContent = `${formatText(appState.currentUsage)} Stones`;
                breadcrumb.innerHTML = `
                    <a href="index.html">Home</a>
                    <span>></span>
                    <span>${formatText(appState.currentUsage)} Stones</span>
                `;
            } else if (appState.currentStoneName) {
                pageTitle.textContent = `${formatText(appState.currentStoneName)} Stones`;
                breadcrumb.innerHTML = `
                    <a href="index.html">Home</a>
                    <span>></span>
                    <span>${formatText(appState.currentStoneName)} Stones</span>
                `;
            } else if (appState.currentCategory) {
                pageTitle.textContent = `${formatText(appState.currentCategory)} Collection`;
                breadcrumb.innerHTML = `
                    <a href="index.html">Home</a>
                    <span>></span>
                    <span>${formatText(appState.currentCategory)}</span>
                `;
            } else {
                pageTitle.textContent = 'All Stone Products';
                breadcrumb.innerHTML = `
                    <a href="index.html">Home</a>
                    <span>></span>
                    <span>All Products</span>
                `;
            }

            // Update document title
            document.title = `${pageTitle.textContent} - StoneCraft UK`;
        }

        function formatText(text) {
            if (!text) return '';
            return text.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // ===== AUTO FILTER =====
        function applyAutoFilter() {
            console.log('ðŸ”„ Applying auto filter from URL...');
            
            let filteredProducts = [...appState.products];
            
            // âœ… FIXED: Auto-filter based on URL parameters
            if (appState.currentUsage) {
                filteredProducts = filteredProducts.filter(product => 
                    product.uses && 
                    product.uses.toLowerCase().replace(/\s+/g, '-') === appState.currentUsage.toLowerCase()
                );
                console.log(`âœ… After usage filter (${appState.currentUsage}):`, filteredProducts.length);
            }
            
            if (appState.currentStoneName) {
                filteredProducts = filteredProducts.filter(product => 
                    product.stone_name && 
                    product.stone_name.toLowerCase().replace(/\s+/g, '-') === appState.currentStoneName.toLowerCase()
                );
                console.log(`âœ… After stone name filter (${appState.currentStoneName}):`, filteredProducts.length);
            }
            
            if (appState.currentCategory) {
                filteredProducts = filteredProducts.filter(product => 
                    product.category && 
                    product.category.toLowerCase().replace(/\s+/g, '-') === appState.currentCategory.toLowerCase()
                );
                console.log(`âœ… After category filter (${appState.currentCategory}):`, filteredProducts.length);
            }
            
            appState.filteredProducts = filteredProducts;
            displayProducts();
            updateProductsCount();
            updateActiveFilters();
        }

        // ===== QUICK FILTERS GENERATION =====
        function generateQuickFilters() {
            generateCategoryFilters();
            generateStoneTypeFilters();
            generateColorFilters();
            generateUsageFilters();
        }

        function generateCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            const categories = [...new Set(appState.products
                .filter(product => product.category && product.category.trim() !== '')
                .map(product => product.category.trim())
            )].sort();
            
            container.innerHTML = categories.map(category => {
                const count = appState.products.filter(product => 
                    product.category && product.category.trim() === category
                ).length;
                
                const isActive = appState.filters.categories.includes(category);
                
                return `
                    <div class="filter-option ${isActive ? 'active' : ''}" data-filter="categories" data-value="${category}">
                        <div class="filter-checkbox"></div>
                        <span class="filter-label">${category}</span>
                        <span class="filter-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function generateStoneTypeFilters() {
            const container = document.getElementById('stoneTypeFilters');
            const stoneTypes = [...new Set(appState.products
                .filter(product => product.stone_name && product.stone_name.trim() !== '')
                .map(product => product.stone_name.trim())
            )].sort();
            
            container.innerHTML = stoneTypes.map(stoneType => {
                const count = appState.products.filter(product => 
                    product.stone_name && product.stone_name.trim() === stoneType
                ).length;
                
                const isActive = appState.filters.stoneTypes.includes(stoneType);
                
                return `
                    <div class="filter-option ${isActive ? 'active' : ''}" data-filter="stoneTypes" data-value="${stoneType}">
                        <div class="filter-checkbox"></div>
                        <span class="filter-label">${stoneType}</span>
                        <span class="filter-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function generateColorFilters() {
            const container = document.getElementById('colorFilters');
            const colors = [...new Set(appState.products
                .filter(product => product.color && product.color.trim() !== '')
                .map(product => product.color.trim())
            )].sort();
            
            container.innerHTML = colors.map(color => {
                const count = appState.products.filter(product => 
                    product.color && product.color.trim() === color
                ).length;
                
                const isActive = appState.filters.colors.includes(color);
                
                return `
                    <div class="filter-option ${isActive ? 'active' : ''}" data-filter="colors" data-value="${color}">
                        <div class="filter-checkbox"></div>
                        <span class="filter-label">${color}</span>
                        <span class="filter-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        function generateUsageFilters() {
            const container = document.getElementById('usageFilters');
            const usageOptions = [...new Set(appState.products
                .filter(product => product.uses && product.uses.trim() !== '')
                .map(product => product.uses.trim())
            )].sort();
            
            container.innerHTML = usageOptions.map(usage => {
                const count = appState.products.filter(product => 
                    product.uses && product.uses.trim() === usage
                ).length;
                
                const isActive = appState.filters.usage.includes(usage);
                
                return `
                    <div class="filter-option ${isActive ? 'active' : ''}" data-filter="usage" data-value="${usage}">
                        <div class="filter-checkbox"></div>
                        <span class="filter-label">${usage}</span>
                        <span class="filter-count">${count}</span>
                    </div>
                `;
            }).join('');
        }

        // ===== FILTERS INITIALIZATION =====
        function initializeFilters() {
            // Add event listeners to all filter options
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    const value = this.getAttribute('data-value');
                    toggleFilter(filterType, value);
                });
            });
        }

        function toggleFilter(filterType, value) {
            const filterArray = appState.filters[filterType];
            const index = filterArray.indexOf(value);
            
            if (index > -1) {
                filterArray.splice(index, 1);
            } else {
                filterArray.push(value);
            }
            
            applyManualFilters();
            updateFilterUI(filterType, value);
            updateActiveFilters();
        }

        function applyManualFilters() {
            let filteredProducts = [...appState.products];
            
            console.log('Applying manual filters:', appState.filters);
            
            // Filter by categories
            if (appState.filters.categories.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    product.category && 
                    appState.filters.categories.includes(product.category.trim())
                );
            }
            
            // Filter by stone types
            if (appState.filters.stoneTypes.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    product.stone_name && 
                    appState.filters.stoneTypes.includes(product.stone_name.trim())
                );
            }
            
            // Filter by colors
            if (appState.filters.colors.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    product.color && 
                    appState.filters.colors.includes(product.color.trim())
                );
            }
            
            // Filter by usage
            if (appState.filters.usage.length > 0) {
                filteredProducts = filteredProducts.filter(product => 
                    product.uses && 
                    appState.filters.usage.includes(product.uses.trim())
                );
            }
            
            // Apply search query
            if (appState.searchQuery) {
                const query = appState.searchQuery.toLowerCase();
                filteredProducts = filteredProducts.filter(product => 
                    (product.stone_name && product.stone_name.toLowerCase().includes(query)) ||
                    (product.description && product.description.toLowerCase().includes(query)) ||
                    (product.category && product.category.toLowerCase().includes(query))
                );
            }
            
            // Sort products
            filteredProducts = sortProducts(filteredProducts);
            
            appState.filteredProducts = filteredProducts;
            displayProducts();
            updateProductsCount();
            updateActiveFilters();
        }

        function updateFilterUI(filterType, value) {
            const option = document.querySelector(`[data-filter="${filterType}"][data-value="${value}"]`);
            if (option) {
                const isActive = appState.filters[filterType].includes(value);
                if (isActive) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            }
        }

        // ===== SORTING =====
        function initializeSorting() {
            // Sorting functionality can be added here
        }

        function sortProducts(products) {
            switch (appState.filters.sortBy) {
                case 'name':
                    return products.sort((a, b) => (a.stone_name || '').localeCompare(b.stone_name || ''));
                case 'price-low':
                    return products.sort((a, b) => (a.price || 0) - (b.price || 0));
                case 'price-high':
                    return products.sort((a, b) => (b.price || 0) - (a.price || 0));
                default:
                    return products;
            }
        }

        // ===== PRODUCT DISPLAY =====
        function displayProducts() {
            const productsContainer = document.getElementById("products-list");
            
            if (!appState.filteredProducts.length) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <i class="fas fa-search"></i>
                        <h3>No Products Found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                `;
                return;
            }

            productsContainer.innerHTML = appState.filteredProducts.map(product => {
                const imageUrl = product.images?.[0] || getDefaultImage(product.category);
                const description = product.description || product.stone_name || "Premium Stone Product";
                const rate = product.price ? `Â£${product.price}` : "Price on request";
                const detailsLink = product.pageUrl || `product-details.html?id=${product.id}`;

                return `
                    <div class="product-card">
                        <a href="${detailsLink}">
                            <div class="product-img-box">
                                <img src="${imageUrl}" alt="${description}" class="product-img">
                            </div>
                        </a>
                        <div class="product-info">
                            <p class="product-description">${description}</p>
                            <p class="product-rate">${rate}</p>
                            <a href="${detailsLink}" class="details-btn">View Details</a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getDefaultImage(category) {
            const defaultImages = {
                'marble': 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80',
                'granite': 'https://images.unsplash.com/photo-1595428774223-ef52624120d2?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80',
                'limestone': 'https://images.unsplash.com/photo-1611273426858-450d8e3c9fce?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80',
                'sandstone': 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80'
            };
            
            const cat = category ? category.toLowerCase() : 'marble';
            return defaultImages[cat] || defaultImages.marble;
        }

        // ===== ACTIVE FILTERS =====
        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            const filters = [];
            
            // Category filters
            appState.filters.categories.forEach(category => {
                filters.push(`
                    <div class="active-filter">
                        Category: ${category}
                        <span class="remove-filter" data-type="categories" data-value="${category}">Ã—</span>
                    </div>
                `);
            });
            
            // Stone type filters
            appState.filters.stoneTypes.forEach(stoneType => {
                filters.push(`
                    <div class="active-filter">
                        Stone: ${stoneType}
                        <span class="remove-filter" data-type="stoneTypes" data-value="${stoneType}">Ã—</span>
                    </div>
                `);
            });
            
            // Color filters
            appState.filters.colors.forEach(color => {
                filters.push(`
                    <div class="active-filter">
                        Color: ${color}
                        <span class="remove-filter" data-type="colors" data-value="${color}">Ã—</span>
                    </div>
                `);
            });
            
            // Usage filters
            appState.filters.usage.forEach(usage => {
                filters.push(`
                    <div class="active-filter">
                        Usage: ${usage}
                        <span class="remove-filter" data-type="usage" data-value="${usage}">Ã—</span>
                    </div>
                `);
            });
            
            if (filters.length > 0) {
                activeFiltersContainer.innerHTML = `
                    <span class="active-filters-title">Active Filters:</span>
                    ${filters.join('')}
                    <button class="clear-all-btn" id="clearAllFilters">Clear All</button>
                `;
                activeFiltersContainer.style.display = 'flex';
                
                // Add remove functionality
                document.querySelectorAll('.remove-filter').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const value = this.getAttribute('data-value');
                        removeFilter(type, value);
                    });
                });
                
                // Add clear all functionality
                document.getElementById('clearAllFilters').addEventListener('click', clearAllFilters);
            } else {
                activeFiltersContainer.style.display = 'none';
            }
        }

        function removeFilter(filterType, value) {
            const filterArray = appState.filters[filterType];
            const index = filterArray.indexOf(value);
            
            if (index > -1) {
                filterArray.splice(index, 1);
                applyManualFilters();
                updateFilterUI(filterType, value);
                updateActiveFilters();
            }
        }

        function clearAllFilters() {
            appState.filters = {
                categories: [],
                stoneTypes: [],
                colors: [],
                usage: [],
                sortBy: 'name'
            };
            
            applyManualFilters();
            updateActiveFilters();
            
            // Update all filter options UI
            document.querySelectorAll('.filter-option').forEach(option => {
                option.classList.remove('active');
            });
        }

        // ===== PRODUCT COUNT UPDATE =====
        function updateProductsCount() {
            const productsCount = document.getElementById('productsCount');
            const totalCount = appState.products.length;
            const filteredCount = appState.filteredProducts.length;
            
            let countText = `Showing ${filteredCount} of ${totalCount} products`;
            
            if (filteredCount < totalCount) {
                countText += ` (${totalCount - filteredCount} hidden by filters)`;
            }
            
            productsCount.textContent = countText;
        }

        // ===== SAMPLE DATA FALLBACK =====
        function getSampleProducts() {
            return [
                {
                    id: '1',
                    stone_name: 'RED SAND STONE',
                    category: 'Red Sand Stone',
                    type: 'Natural',
                    color: 'Red',
                    uses: 'Flooring',
                    price: 100,
                    description: 'Premium red sandstone with excellent durability and natural beauty',
                    additional_fields: [
                        { density: '2.4 g/cmÂ³' },
                        { finish: 'Natural' },
                        { water_absorption: 'Low' }
                    ],
                    images: ['https://images.unsplash.com/photo-1541140532154-b024d705b90a?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80'],
                    pageUrl: 'product-details.html?id=1'
                }
            ];
        }

        // Make clearAllFilters available globally
        window.clearAllFilters = clearAllFilters;

        console.log('âœ… All functions defined successfully!');
    </script>
</body>
</html>
