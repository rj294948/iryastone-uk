<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Details | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary-gold: #c9a227;
    --gold-light: #f0d77c;
    --gold-dark: #9c7c1f;
    --stone-dark: #1a1a1a;
    --stone-light: #f4f6f4;
    --bg-light: #f7f9fc;
    --text-dark: #222222;
    --text-light: #666666;
    --white: #ffffff;
    --shadow-sm: 0 2px 10px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.15);
    --transition: all 0.3s ease;
    --border-radius: 12px;
    --border-radius-lg: 20px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
}

body {
    background: var(--bg-light);
    color: var(--text-dark);
    padding-bottom: 80px;
    font-size: 14px;
}

/* Header */
header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: var(--white);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow-sm);
    z-index: 1000;
    gap: 10px;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    min-width: 140px;
}

.logo i {
    color: var(--primary-gold);
    font-size: 24px;
}

.logo span {
    font-size: 18px;
    font-weight: 700;
    color: var(--stone-dark);
    font-family: 'Roboto Slab', serif;
}

.action-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-light);
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-dark);
    font-size: 16px;
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    text-decoration: none;
}

.action-btn:hover {
    background: var(--primary-gold);
    color: var(--white);
}

/* Breadcrumb */
.breadcrumb {
    padding: 90px 16px 20px;
    background: var(--white);
    border-bottom: 1px solid #f0f0f0;
}

.breadcrumb-content {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--text-light);
    font-size: 14px;
}

.breadcrumb-item a {
    color: var(--text-light);
    text-decoration: none;
    transition: var(--transition);
}

.breadcrumb-item a:hover {
    color: var(--primary-gold);
}

.breadcrumb-item.active {
    color: var(--primary-gold);
    font-weight: 500;
}

.breadcrumb-divider {
    color: var(--text-light);
}

/* Order Details Container */
.order-details-container {
    padding: 30px 16px;
    max-width: 1200px;
    margin: 0 auto;
}

/* Order Header */
.order-header-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-bottom: 20px;
}

.order-header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.order-header-info h1 {
    font-size: 24px;
    font-weight: 700;
    color: var(--stone-dark);
    margin-bottom: 5px;
}

.order-header-info h1 span {
    color: var(--primary-gold);
}

.order-header-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 10px;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.meta-label {
    font-size: 12px;
    color: var(--text-light);
}

.meta-value {
    font-weight: 600;
    color: var(--stone-dark);
}

.order-status-badge {
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.status-processing {
    background: #cce5ff;
    color: #004085;
}

.status-shipped {
    background: #d4edda;
    color: #155724;
}

.status-delivered {
    background: #d1ecf1;
    color: #0c5460;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.status-pending_bank_transfer {
    background: #ffeaa7;
    color: #856404;
}

/* Order Content Grid */
.order-content-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

/* Order Items */
.order-items-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.card-header h2 {
    font-size: 18px;
    font-weight: 600;
    color: var(--stone-dark);
}

.card-header i {
    color: var(--primary-gold);
    font-size: 18px;
}

.order-item-detail {
    display: flex;
    gap: 15px;
    padding: 20px 0;
    border-bottom: 1px solid #f0f0f0;
}

.order-item-detail:last-child {
    border-bottom: none;
}

.item-image {
    width: 100px;
    height: 100px;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-details {
    flex: 1;
}

.item-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--stone-dark);
}

.item-category {
    font-size: 13px;
    color: var(--text-light);
    margin-bottom: 10px;
}

.item-specs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.spec-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.spec-label {
    font-size: 12px;
    color: var(--text-light);
}

.spec-value {
    font-weight: 500;
    color: var(--stone-dark);
}

.item-price {
    font-size: 18px;
    font-weight: 700;
    color: var(--primary-gold);
}

/* Order Summary */
.order-summary-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    height: fit-content;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item.total {
    font-weight: 700;
    font-size: 18px;
    color: var(--primary-gold);
    padding-top: 15px;
    border-top: 2px solid #e0e0e0;
    margin-top: 10px;
}

.summary-label {
    color: var(--text-dark);
}

.summary-value {
    font-weight: 600;
}

/* Payment Info */
.payment-info-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-top: 20px;
}

.payment-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.payment-detail {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.payment-label {
    font-size: 12px;
    color: var(--text-light);
}

.payment-value {
    font-weight: 600;
    color: var(--stone-dark);
}

.bank-transfer-box {
    background: #fff3cd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #ffc107;
}

.bank-transfer-box h4 {
    color: #856404;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.bank-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    font-size: 13px;
}

.bank-detail-item {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.bank-detail-label {
    color: #856404;
    font-weight: 500;
}

.bank-detail-value {
    color: var(--stone-dark);
    font-weight: 600;
}

/* Shipping & Billing */
.address-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.address-card {
    background: var(--bg-light);
    border-radius: 10px;
    padding: 20px;
}

.address-card h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--stone-dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.address-card h3 i {
    color: var(--primary-gold);
}

.address-content {
    font-size: 14px;
    line-height: 1.6;
    color: var(--text-dark);
}

.address-content .name {
    font-weight: 600;
    margin-bottom: 5px;
}

/* Order Actions */
.order-actions-card {
    background: var(--white);
    border-radius: var(--border-radius);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    margin-top: 20px;
}

.order-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.order-action-btn {
    padding: 12px 20px;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.order-action-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.order-action-btn.primary {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.order-action-btn.primary:hover {
    background: var(--gold-dark);
}

.order-action-btn.danger {
    color: #ff4757;
    border-color: #ff4757;
}

.order-action-btn.danger:hover {
    background: #ff4757;
    color: white;
}

/* Admin Actions (Visible only to admin) */
.admin-actions {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    border-left: 4px solid var(--primary-gold);
}

.admin-actions h3 {
    color: var(--stone-dark);
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.admin-actions h3 i {
    color: var(--primary-gold);
}

.admin-action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.admin-action-btn {
    padding: 10px 15px;
    border-radius: 6px;
    border: 1px solid #e0e0e0;
    background: var(--white);
    color: var(--text-dark);
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 5px;
}

.admin-action-btn:hover {
    border-color: var(--primary-gold);
    color: var(--primary-gold);
}

.admin-action-btn.approve {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}

.admin-action-btn.approve:hover {
    background: #c3e6cb;
}

.admin-action-btn.ship {
    background: #cce5ff;
    color: #004085;
    border-color: #b8daff;
}

.admin-action-btn.ship:hover {
    background: #b8daff;
}

.admin-action-btn.deliver {
    background: #d1ecf1;
    color: #0c5460;
    border-color: #bee5eb;
}

.admin-action-btn.deliver:hover {
    background: #bee5eb;
}

.admin-action-btn.cancel {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

.admin-action-btn.cancel:hover {
    background: #f5c6cb;
}

/* Loading */
.loading-spinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    border: 3px solid rgba(201, 162, 39, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-gold);
    animation: spin 1s ease-in-out infinite;
    z-index: 9999;
}

@keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Bottom Navigation */
.bottom-nav {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--white);
    display: flex;
    justify-content: space-around;
    padding: 12px 0;
    border-top: 1px solid #eee;
    z-index: 999;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.nav-btn {
    text-align: center;
    font-size: 11px;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: var(--transition);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 10px;
    min-width: 70px;
    text-decoration: none;
}

.nav-btn:hover {
    color: var(--primary-gold);
    background: rgba(201, 162, 39, 0.05);
}

.nav-btn.active {
    color: var(--primary-gold);
}

.nav-btn i {
    font-size: 18px;
}

/* Cart Badge */
.cart-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: var(--white);
    font-size: 10px;
    font-weight: 600;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive */
@media (max-width: 992px) {
    .order-content-grid {
        grid-template-columns: 1fr;
    }
    
    .address-info-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .order-header-content {
        flex-direction: column;
        gap: 15px;
    }
    
    .order-item-detail {
        flex-direction: column;
    }
    
    .item-image {
        width: 100%;
        height: 200px;
    }
    
    .admin-action-buttons {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .order-details-container {
        padding: 20px 12px;
    }
    
    .order-items-card, .order-summary-card, .payment-info-card {
        padding: 20px;
    }
}
</style>
</head>

<body>

<!-- Loading Spinner -->
<div class="loading-spinner" id="loadingSpinner"></div>

<!-- Header -->
<header>
    <div class="logo">
        <i class="fa-solid fa-gem"></i>
        <span>IRYA STONE</span>
    </div>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="cart.html" class="action-btn" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">0</span>
        </a>
        <a href="orders.html" class="action-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>
</header>

<!-- Breadcrumb -->
<section class="breadcrumb">
    <div class="breadcrumb-content">
        <div class="breadcrumb-item">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item">
            <a href="orders.html">My Orders</a>
        </div>
        <div class="breadcrumb-divider">
            <i class="fas fa-chevron-right"></i>
        </div>
        <div class="breadcrumb-item active" id="breadcrumbOrder">
            Order Details
        </div>
    </div>
</section>

<!-- Order Details Container -->
<section class="order-details-container">
    <!-- Order Header -->
    <div class="order-header-card">
        <div class="order-header-content">
            <div class="order-header-info">
                <h1>Order #<span id="orderNumber">Loading...</span></h1>
                <div class="order-header-meta">
                    <div class="meta-item">
                        <div class="meta-label">Order Date</div>
                        <div class="meta-value" id="orderDate">Loading...</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Order ID</div>
                        <div class="meta-value" id="orderId">Loading...</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Customer</div>
                        <div class="meta-value" id="customerName">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="order-status-badge" id="orderStatusBadge">
                Loading...
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="order-content-grid">
        <!-- Left Column -->
        <div>
            <!-- Order Items -->
            <div class="order-items-card">
                <div class="card-header">
                    <i class="fas fa-box"></i>
                    <h2>Order Items</h2>
                </div>
                <div id="orderItemsList">
                    <!-- Order items will be loaded here -->
                </div>
            </div>
            
            <!-- Payment Information -->
            <div class="payment-info-card">
                <div class="card-header">
                    <i class="fas fa-credit-card"></i>
                    <h2>Payment Information</h2>
                </div>
                <div id="paymentInfo">
                    <!-- Payment info will be loaded here -->
                </div>
            </div>
            
            <!-- Shipping & Billing Address -->
            <div class="payment-info-card">
                <div class="card-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <h2>Shipping & Billing Address</h2>
                </div>
                <div class="address-info-grid">
                    <div class="address-card">
                        <h3><i class="fas fa-truck"></i> Shipping Address</h3>
                        <div class="address-content" id="shippingAddress">
                            Loading...
                        </div>
                    </div>
                    <div class="address-card">
                        <h3><i class="fas fa-file-invoice"></i> Billing Address</h3>
                        <div class="address-content" id="billingAddress">
                            Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div>
            <!-- Order Summary -->
            <div class="order-summary-card">
                <div class="card-header">
                    <i class="fas fa-receipt"></i>
                    <h2>Order Summary</h2>
                </div>
                <div id="orderSummary">
                    <!-- Order summary will be loaded here -->
                </div>
            </div>
            
            <!-- Order Actions -->
            <div class="order-actions-card">
                <div class="card-header">
                    <i class="fas fa-cog"></i>
                    <h2>Order Actions</h2>
                </div>
                <div class="order-actions-grid" id="orderActions">
                    <!-- Order actions will be loaded here -->
                </div>
            </div>
            
            <!-- Admin Actions (Hidden by default, shown only to admin) -->
            <div class="admin-actions" id="adminActions" style="display: none;">
                <h3><i class="fas fa-user-shield"></i> Admin Actions</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                    These actions are only visible to administrators
                </p>
                <div class="admin-action-buttons" id="adminActionButtons">
                    <!-- Admin action buttons will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Bottom Menu -->
<div class="bottom-nav">
    <a href="index.html" class="nav-btn">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </a>
    <a href="products.html" class="nav-btn">
        <i class="fas fa-th-large"></i>
        <span>Products</span>
    </a>
    <a href="orders.html" class="nav-btn active">
        <i class="fas fa-box"></i>
        <span>Orders</span>
    </a>
    <a href="account.html" class="nav-btn">
        <i class="fas fa-user"></i>
        <span>Account</span>
    </a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
// ============================================
// FIREBASE CONFIGURATION
// ============================================

const firebaseConfig = {
    apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
    authDomain: "iryastone-uk.firebaseapp.com",
    projectId: "iryastone-uk",
    storageBucket: "iryastone-uk.firebasestorage.app",
    messagingSenderId: "110940910896",
    appId: "1:110940910896:web:b25e92127118665e5c84f5",
    measurementId: "G-6YM1FLYN48"
};

let firebaseApp, firebaseDB, firebaseAuth;
let authSystem = null;
let currentOrder = null;
let isAdmin = false;

// ============================================
// AUTHENTICATION SYSTEM
// ============================================

class OrderDetailsAuthSystem {
    constructor() {
        this.currentUser = null;
        this.authKey = 'irya_stone_auth_user';
        this.guestIdKey = 'irya_guest_id';
    }
    
    async init() {
        try {
            await this.initializeFirebase();
            
            return new Promise((resolve) => {
                firebaseAuth.onAuthStateChanged(async (user) => {
                    console.log("üì± Auth State Changed:", user ? user.uid : "No user");
                    
                    if (user) {
                        // Firebase authenticated user
                        this.currentUser = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL,
                            providerId: user.providerId,
                            isFirebaseUser: true
                        };
                        
                        localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        
                        // Check if user is admin
                        await this.checkIfAdmin();
                        
                    } else {
                        // No Firebase user, check localStorage
                        const storedUser = this.getUserFromStorage();
                        
                        if (storedUser && storedUser.isFirebaseUser) {
                            this.currentUser = storedUser;
                        } else {
                            // Create guest user
                            this.currentUser = this.createGuestUser();
                            localStorage.setItem(this.authKey, JSON.stringify(this.currentUser));
                        }
                    }
                    
                    resolve(this.currentUser);
                });
            });
            
        } catch (error) {
            console.error('‚ùå Auth init error:', error);
            this.currentUser = this.getUserFromStorage() || this.createGuestUser();
            return this.currentUser;
        }
    }
    
    async initializeFirebase() {
        try {
            if (typeof firebase === 'undefined') {
                throw new Error('Firebase SDK not loaded');
            }
            
            if (!firebase.apps.length) {
                firebaseApp = firebase.initializeApp(firebaseConfig);
            } else {
                firebaseApp = firebase.app();
            }
            
            firebaseDB = firebase.firestore();
            firebaseAuth = firebase.auth();
            
            console.log('‚úÖ Firebase initialized successfully');
            return true;
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            throw error;
        }
    }
    
    async checkIfAdmin() {
        try {
            if (!firebaseDB || !this.currentUser) return false;
            
            // Check if user is in admin collection
            const adminDoc = await firebaseDB.collection('admins').doc(this.currentUser.uid).get();
            
            if (adminDoc.exists) {
                isAdmin = true;
                console.log('‚úÖ User is admin');
                return true;
            }
            
            // Check by email (alternative method)
            const adminByEmail = await firebaseDB.collection('admins')
                .where('email', '==', this.currentUser.email)
                .limit(1)
                .get();
                
            if (!adminByEmail.empty) {
                isAdmin = true;
                console.log('‚úÖ User is admin (by email)');
                return true;
            }
            
            isAdmin = false;
            return false;
            
        } catch (error) {
            console.error('‚ùå Error checking admin status:', error);
            isAdmin = false;
            return false;
        }
    }
    
    getUserFromStorage() {
        const userData = localStorage.getItem(this.authKey);
        if (userData) {
            try {
                return JSON.parse(userData);
            } catch (e) {
                console.error('‚ùå Error parsing user data:', e);
                return null;
            }
        }
        return null;
    }
    
    createGuestUser() {
        let guestId = localStorage.getItem(this.guestIdKey);
        if (!guestId) {
            guestId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem(this.guestIdKey, guestId);
        }
        
        return {
            uid: guestId,
            displayName: 'Guest',
            email: '',
            photoURL: '',
            providerId: 'guest',
            isFirebaseUser: false,
            isGuest: true
        };
    }
    
    getUserId() {
        if (!this.currentUser) {
            return this.createGuestUser().uid;
        }
        return this.currentUser.uid;
    }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', async function() {
    console.log("üì± Order Details page loaded");
    
    // Get order ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    
    if (!orderId) {
        showError('Order ID not found in URL');
        window.location.href = 'orders.html';
        return;
    }
    
    console.log("üîÑ Loading order details for:", orderId);
    
    // Initialize Auth System
    authSystem = new OrderDetailsAuthSystem();
    await authSystem.init();
    
    // Load order details
    await loadOrderDetails(orderId);
    
    // Update cart badge
    updateCartBadge();
});

// ============================================
// LOAD ORDER DETAILS
// ============================================

async function loadOrderDetails(orderId) {
    try {
        showLoading(true);
        
        const userId = authSystem.getUserId();
        console.log("üîÑ Loading order:", orderId, "for user:", userId);
        
        // Initialize Firebase if not already
        if (!firebaseDB) {
            await authSystem.initializeFirebase();
        }
        
        if (!firebaseDB) {
            showError('Database not available');
            return;
        }
        
        // Try multiple collection paths
        let orderData = null;
        
        // 1. Try users/{userId}/orders/{orderId}
        try {
            console.log("1Ô∏è‚É£ Trying users/{userId}/orders/{orderId}");
            const orderDoc = await firebaseDB.collection('users').doc(userId).collection('orders').doc(orderId).get();
            
            if (orderDoc.exists) {
                orderData = orderDoc.data();
                console.log("‚úÖ Order found in users/{userId}/orders");
            }
        } catch (error) {
            console.log("‚ùå Error in users collection:", error.message);
        }
        
        // 2. Try main orders collection
        if (!orderData) {
            try {
                console.log("2Ô∏è‚É£ Trying main orders collection");
                const orderDoc = await firebaseDB.collection('orders').doc(orderId).get();
                
                if (orderDoc.exists) {
                    orderData = orderDoc.data();
                    console.log("‚úÖ Order found in main orders");
                }
            } catch (error) {
                console.log("‚ùå Error in main orders:", error.message);
            }
        }
        
        // 3. Try userOrders collection
        if (!orderData) {
            try {
                console.log("3Ô∏è‚É£ Trying userOrders collection");
                const orderDoc = await firebaseDB.collection('userOrders').doc(userId).collection('orders').doc(orderId).get();
                
                if (orderDoc.exists) {
                    orderData = orderDoc.data();
                    console.log("‚úÖ Order found in userOrders");
                }
            } catch (error) {
                console.log("‚ùå Error in userOrders:", error.message);
            }
        }
        
        if (!orderData) {
            showError('Order not found');
            window.location.href = 'orders.html';
            return;
        }
        
        currentOrder = {
            id: orderId,
            ...orderData
        };
        
        console.log("‚úÖ Order data loaded:", currentOrder);
        
        // Display order details
        displayOrderDetails();
        
        // Show admin actions if user is admin
        if (isAdmin) {
            showAdminActions();
        }
        
    } catch (error) {
        console.error('‚ùå Error loading order details:', error);
        showError('Failed to load order details: ' + error.message);
        window.location.href = 'orders.html';
    } finally {
        showLoading(false);
    }
}

// ============================================
// DISPLAY ORDER DETAILS
// ============================================

function displayOrderDetails() {
    if (!currentOrder) return;
    
    // Update breadcrumb
    document.getElementById('breadcrumbOrder').textContent = `Order #${currentOrder.orderNumber || currentOrder.id.substring(0, 8)}`;
    
    // Update header
    document.getElementById('orderNumber').textContent = currentOrder.orderNumber || currentOrder.id.substring(0, 8).toUpperCase();
    document.getElementById('orderDate').textContent = formatDate(currentOrder.createdAt);
    document.getElementById('orderId').textContent = currentOrder.id;
    document.getElementById('customerName').textContent = currentOrder.userName || currentOrder.shippingAddress?.fullName || 'Customer';
    
    // Update status badge
    const statusBadge = document.getElementById('orderStatusBadge');
    statusBadge.textContent = getStatusText(currentOrder.status || 'pending');
    statusBadge.className = `order-status-badge status-${currentOrder.status || 'pending'}`;
    
    // Display order items
    displayOrderItems();
    
    // Display payment information
    displayPaymentInfo();
    
    // Display addresses
    displayAddresses();
    
    // Display order summary
    displayOrderSummary();
    
    // Display order actions
    displayOrderActions();
}

function displayOrderItems() {
    const orderItemsList = document.getElementById('orderItemsList');
    
    if (!currentOrder.items || currentOrder.items.length === 0) {
        orderItemsList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <i class="fas fa-box-open" style="font-size: 48px; color: var(--text-light); opacity: 0.5;"></i>
                <p style="color: var(--text-light); margin-top: 10px;">No items found</p>
            </div>
        `;
        return;
    }
    
    const itemsHTML = currentOrder.items.map(item => {
        const calculationInfo = getCalculationInfo(item);
        const imageUrl = item.image || getDefaultImage(item.category);
        
        return `
            <div class="order-item-detail">
                <div class="item-image">
                    <img src="${imageUrl}" 
                         alt="${item.name}" 
                         onerror="this.src='${getDefaultImage(item.category)}'">
                </div>
                <div class="item-details">
                    <div class="item-name">${item.name || 'Product'}</div>
                    <div class="item-category">${item.category || 'General'}</div>
                    
                    <div class="item-specs">
                        <div class="spec-item">
                            <div class="spec-label">Quantity</div>
                            <div class="spec-value">${item.quantity || 1}</div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-label">Price</div>
                            <div class="spec-value">¬£${item.price?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="spec-item">
                            <div class="spec-label">Unit</div>
                            <div class="spec-value">${item.priceUnit || 'piece'}</div>
                        </div>
                        ${item.calculationData ? `
                            <div class="spec-item">
                                <div class="spec-label">Calculation</div>
                                <div class="spec-value">${calculationInfo}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${item.customRequirements ? `
                        <div style="margin-top: 10px;">
                            <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">Custom Requirements:</div>
                            <div style="font-size: 13px; color: var(--text-dark); padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                ${item.customRequirements}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="item-price" style="margin-top: 15px;">
                        ¬£${item.calculatedPrice ? parseFloat(item.calculatedPrice).toFixed(2) : ((item.price || 0) * (item.quantity || 1)).toFixed(2)}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    orderItemsList.innerHTML = itemsHTML;
}

function displayPaymentInfo() {
    const paymentInfo = document.getElementById('paymentInfo');
    
    let paymentStatusHTML = '';
    let paymentDetailsHTML = '';
    let bankTransferHTML = '';
    
    // Payment status
    const paymentStatus = currentOrder.paymentStatus || 'pending';
    const paymentMethod = currentOrder.paymentMethod || 'N/A';
    const paymentType = currentOrder.paymentType || 'full';
    
    paymentStatusHTML = `
        <div class="payment-details-grid">
            <div class="payment-detail">
                <div class="payment-label">Payment Status</div>
                <div class="payment-value">
                    <span class="order-status-badge status-${paymentStatus}" style="padding: 4px 10px; font-size: 12px;">
                        ${getPaymentStatusText(paymentStatus)}
                    </span>
                </div>
            </div>
            <div class="payment-detail">
                <div class="payment-label">Payment Method</div>
                <div class="payment-value">${paymentMethod.toUpperCase()}</div>
            </div>
            <div class="payment-detail">
                <div class="payment-label">Payment Type</div>
                <div class="payment-value">${paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</div>
            </div>
            ${currentOrder.paymentType === 'advance' ? `
                <div class="payment-detail">
                    <div class="payment-label">Advance Paid</div>
                    <div class="payment-value">¬£${currentOrder.advancePayment?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="payment-detail">
                    <div class="payment-label">Remaining</div>
                    <div class="payment-value">¬£${currentOrder.remainingPayment?.toFixed(2) || '0.00'}</div>
                </div>
            ` : ''}
        </div>
    `;
    
    // Bank transfer details
    if (paymentMethod === 'bank' && paymentStatus === 'pending_bank_transfer') {
        const bankDetails = currentOrder.bankTransferDetails || {
            accountName: 'IRYA STONE LTD',
            accountNumber: '12345678',
            sortCode: '04-00-04',
            iban: 'GB29NWBK60161331926819',
            swift: 'NWBKGB2L',
            reference: currentOrder.orderNumber || currentOrder.id,
            amount: currentOrder.amountToPay || currentOrder.advancePayment || currentOrder.total || 0
        };
        
        bankTransferHTML = `
            <div class="bank-transfer-box">
                <h4><i class="fas fa-university"></i> Bank Transfer Instructions</h4>
                <div class="bank-details">
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">Account Name</div>
                        <div class="bank-detail-value">${bankDetails.accountName}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">Account Number</div>
                        <div class="bank-detail-value">${bankDetails.accountNumber}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">Sort Code</div>
                        <div class="bank-detail-value">${bankDetails.sortCode}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">IBAN</div>
                        <div class="bank-detail-value" style="font-size: 11px;">${bankDetails.iban}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">SWIFT/BIC</div>
                        <div class="bank-detail-value">${bankDetails.swift}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">Reference</div>
                        <div class="bank-detail-value">${bankDetails.reference}</div>
                    </div>
                    <div class="bank-detail-item">
                        <div class="bank-detail-label">Amount</div>
                        <div class="bank-detail-value" style="color: var(--primary-gold); font-size: 16px;">
                            ¬£${bankDetails.amount.toFixed(2)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    paymentInfo.innerHTML = paymentStatusHTML + bankTransferHTML;
}

function displayAddresses() {
    const shippingAddress = document.getElementById('shippingAddress');
    const billingAddress = document.getElementById('billingAddress');
    
    // Shipping address
    if (currentOrder.shippingAddress) {
        const addr = currentOrder.shippingAddress;
        shippingAddress.innerHTML = `
            <div class="name">${addr.fullName}</div>
            <div>${addr.address1}</div>
            ${addr.address2 ? `<div>${addr.address2}</div>` : ''}
            <div>${addr.city}, ${addr.state} ${addr.postalCode}</div>
            <div>${getCountryName(addr.country)}</div>
            <div>Phone: ${addr.phone}</div>
            ${addr.email ? `<div>Email: ${addr.email}</div>` : ''}
        `;
    } else {
        shippingAddress.innerHTML = 'Not available';
    }
    
    // Billing address (use shipping if billing not available)
    if (currentOrder.billingAddress) {
        const addr = currentOrder.billingAddress;
        billingAddress.innerHTML = `
            <div class="name">${addr.fullName}</div>
            <div>${addr.address1}</div>
            ${addr.address2 ? `<div>${addr.address2}</div>` : ''}
            <div>${addr.city}, ${addr.state} ${addr.postalCode}</div>
            <div>${getCountryName(addr.country)}</div>
            <div>Phone: ${addr.phone}</div>
        `;
    } else if (currentOrder.shippingAddress) {
        billingAddress.innerHTML = '<em>Same as shipping address</em>';
    } else {
        billingAddress.innerHTML = 'Not available';
    }
}

function displayOrderSummary() {
    const orderSummary = document.getElementById('orderSummary');
    
    const subtotal = currentOrder.subtotal || 0;
    const shipping = currentOrder.shipping || 0;
    const tax = currentOrder.tax || 0;
    const total = currentOrder.total || 0;
    const advancePayment = currentOrder.advancePayment || 0;
    const remainingPayment = currentOrder.remainingPayment || 0;
    
    orderSummary.innerHTML = `
        <div class="summary-item">
            <div class="summary-label">Subtotal</div>
            <div class="summary-value">¬£${subtotal.toFixed(2)}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Shipping</div>
            <div class="summary-value">${shipping === 0 ? 'FREE' : `¬£${shipping.toFixed(2)}`}</div>
        </div>
        <div class="summary-item">
            <div class="summary-label">Tax (VAT)</div>
            <div class="summary-value">¬£${tax.toFixed(2)}</div>
        </div>
        ${currentOrder.paymentType === 'advance' ? `
            <div class="summary-item">
                <div class="summary-label">Advance Paid (30%)</div>
                <div class="summary-value">¬£${advancePayment.toFixed(2)}</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">Remaining (70%)</div>
                <div class="summary-value">¬£${remainingPayment.toFixed(2)}</div>
            </div>
        ` : ''}
        <div class="summary-item total">
            <div class="summary-label">Total Amount</div>
            <div class="summary-value">¬£${total.toFixed(2)}</div>
        </div>
    `;
}

function displayOrderActions() {
    const orderActions = document.getElementById('orderActions');
    
    let actionsHTML = '';
    
    // Common actions for all users
    actionsHTML += `
        <button class="order-action-btn" onclick="downloadInvoice()">
            <i class="fas fa-file-invoice"></i>
            Download Invoice
        </button>
        
        <button class="order-action-btn" onclick="window.print()">
            <i class="fas fa-print"></i>
            Print Order
        </button>
        
        <button class="order-action-btn" onclick="window.location.href='orders.html'">
            <i class="fas fa-arrow-left"></i>
            Back to Orders
        </button>
    `;
    
    // Actions based on order status
    const status = currentOrder.status;
    const paymentStatus = currentOrder.paymentStatus;
    
    if (paymentStatus === 'pending_bank_transfer') {
        actionsHTML += `
            <button class="order-action-btn primary" onclick="markPaymentComplete()">
                <i class="fas fa-check-circle"></i>
                Mark Payment Sent
            </button>
            
            <button class="order-action-btn danger" onclick="cancelOrder()">
                <i class="fas fa-times"></i>
                Cancel Order
            </button>
        `;
    }
    
    if (status === 'pending' && paymentStatus !== 'pending_bank_transfer') {
        actionsHTML += `
            <button class="order-action-btn danger" onclick="cancelOrder()">
                <i class="fas fa-times"></i>
                Cancel Order
            </button>
        `;
    }
    
    if (status === 'shipped' && currentOrder.tracking?.url) {
        actionsHTML += `
            <button class="order-action-btn primary" onclick="trackOrder()">
                <i class="fas fa-map-marker-alt"></i>
                Track Order
            </button>
        `;
    }
    
    orderActions.innerHTML = actionsHTML;
}

// ============================================
// ADMIN ACTIONS
// ============================================

function showAdminActions() {
    const adminActions = document.getElementById('adminActions');
    const adminActionButtons = document.getElementById('adminActionButtons');
    
    adminActions.style.display = 'block';
    
    let adminButtonsHTML = '';
    
    const status = currentOrder.status;
    const paymentStatus = currentOrder.paymentStatus;
    
    // Payment confirmation
    if (paymentStatus === 'pending_bank_transfer') {
        adminButtonsHTML += `
            <button class="admin-action-btn approve" onclick="confirmPayment()">
                <i class="fas fa-check"></i>
                Confirm Payment
            </button>
        `;
    }
    
    if (paymentStatus === 'payment_received') {
        adminButtonsHTML += `
            <button class="admin-action-btn approve" onclick="updateOrderStatus('processing')">
                <i class="fas fa-cogs"></i>
                Start Processing
            </button>
        `;
    }
    
    // Order status updates
    if (status === 'processing') {
        adminButtonsHTML += `
            <button class="admin-action-btn ship" onclick="updateOrderStatus('shipped')">
                <i class="fas fa-shipping-fast"></i>
                Mark as Shipped
            </button>
        `;
    }
    
    if (status === 'shipped') {
        adminButtonsHTML += `
            <button class="admin-action-btn deliver" onclick="updateOrderStatus('delivered')">
                <i class="fas fa-home"></i>
                Mark as Delivered
            </button>
        `;
    }
    
    // Cancel order
    if (status !== 'cancelled' && status !== 'delivered') {
        adminButtonsHTML += `
            <button class="admin-action-btn cancel" onclick="adminCancelOrder()">
                <i class="fas fa-ban"></i>
                Cancel Order
            </button>
        `;
    }
    
    // Add tracking info
    if (status === 'processing' || status === 'shipped') {
        adminButtonsHTML += `
            <button class="admin-action-btn" onclick="addTrackingInfo()">
                <i class="fas fa-barcode"></i>
                Add Tracking
            </button>
        `;
    }
    
    adminActionButtons.innerHTML = adminButtonsHTML;
}

// ============================================
// ADMIN FUNCTIONS
// ============================================

async function confirmPayment() {
    if (!isAdmin) {
        showError('Admin access required');
        return;
    }
    
    if (!confirm('Confirm that payment has been received for this order?')) return;
    
    try {
        showLoading(true);
        
        // Update payment status
        await updateOrderPaymentStatus('payment_received');
        
        // Update order status to processing
        await updateOrderStatus('processing');
        
        // Send notification to user
        await sendNotificationToUser('payment_confirmed');
        
        showNotification('‚úÖ Payment confirmed and order moved to processing');
        
        // Reload page to show updated status
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error confirming payment:', error);
        showError('Failed to confirm payment: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function updateOrderStatus(newStatus) {
    if (!isAdmin) {
        showError('Admin access required');
        return;
    }
    
    if (!confirm(`Change order status to "${getStatusText(newStatus)}"?`)) return;
    
    try {
        showLoading(true);
        
        const updateData = {
            status: newStatus,
            updatedAt: new Date().toISOString()
        };
        
        // Add timestamp for specific status
        if (newStatus === 'processing') {
            updateData.processingAt = new Date().toISOString();
        } else if (newStatus === 'shipped') {
            updateData.shippedAt = new Date().toISOString();
        } else if (newStatus === 'delivered') {
            updateData.deliveredAt = new Date().toISOString();
        }
        
        // Update in all collections
        await updateOrderInAllCollections(updateData);
        
        // Send notification to user
        await sendNotificationToUser('status_updated', newStatus);
        
        showNotification(`‚úÖ Order status updated to "${getStatusText(newStatus)}"`);
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error updating order status:', error);
        showError('Failed to update order status: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function adminCancelOrder() {
    if (!isAdmin) {
        showError('Admin access required');
        return;
    }
    
    if (!confirm('Cancel this order? This action cannot be undone.')) return;
    
    try {
        showLoading(true);
        
        const updateData = {
            status: 'cancelled',
            paymentStatus: 'cancelled',
            cancelledAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        // Update in all collections
        await updateOrderInAllCollections(updateData);
        
        // Send notification to user
        await sendNotificationToUser('order_cancelled');
        
        showNotification('‚úÖ Order cancelled');
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error cancelling order:', error);
        showError('Failed to cancel order: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function addTrackingInfo() {
    if (!isAdmin) {
        showError('Admin access required');
        return;
    }
    
    const trackingId = prompt('Enter tracking ID:');
    if (!trackingId) return;
    
    const carrier = prompt('Enter carrier name (e.g., DHL, FedEx):', 'DHL');
    if (!carrier) return;
    
    const trackingUrl = prompt('Enter tracking URL (optional):');
    
    try {
        showLoading(true);
        
        const updateData = {
            tracking: {
                id: trackingId,
                carrier: carrier,
                url: trackingUrl || `https://www.${carrier.toLowerCase()}.com/track/${trackingId}`,
                addedAt: new Date().toISOString()
            },
            updatedAt: new Date().toISOString()
        };
        
        // Update in all collections
        await updateOrderInAllCollections(updateData);
        
        // Send notification to user
        await sendNotificationToUser('tracking_added');
        
        showNotification('‚úÖ Tracking information added');
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error adding tracking:', error);
        showError('Failed to add tracking: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// ============================================
// USER FUNCTIONS
// ============================================

async function markPaymentComplete() {
    if (!confirm('Have you successfully transferred the payment?')) return;
    
    try {
        showLoading(true);
        
        const updateData = {
            paymentStatus: 'payment_received',
            updatedAt: new Date().toISOString(),
            paymentConfirmedAt: new Date().toISOString()
        };
        
        // Update in user's collection
        const userId = authSystem.getUserId();
        await firebaseDB.collection('users').doc(userId).collection('orders').doc(currentOrder.id).update(updateData);
        
        // Also update in main collection
        try {
            await firebaseDB.collection('orders').doc(currentOrder.id).update(updateData);
        } catch (error) {
            console.log("Could not update main collection:", error.message);
        }
        
        // Send notification to admin
        await sendNotificationToAdmin('payment_sent_by_customer');
        
        showNotification('‚úÖ Payment status updated. Admin will now process your order.');
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error updating payment status:', error);
        showError('Failed to update payment status: ' + error.message);
    } finally {
        showLoading(false);
    }
}

async function cancelOrder() {
    if (!confirm('Are you sure you want to cancel this order?')) return;
    
    try {
        showLoading(true);
        
        const updateData = {
            status: 'cancelled',
            paymentStatus: 'cancelled',
            cancelledAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        // Update in user's collection
        const userId = authSystem.getUserId();
        await firebaseDB.collection('users').doc(userId).collection('orders').doc(currentOrder.id).update(updateData);
        
        // Also update in main collection
        try {
            await firebaseDB.collection('orders').doc(currentOrder.id).update(updateData);
        } catch (error) {
            console.log("Could not update main collection:", error.message);
        }
        
        // Send notification to admin
        await sendNotificationToAdmin('order_cancelled_by_customer');
        
        showNotification('‚úÖ Order cancelled');
        
        // Reload page
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('‚ùå Error cancelling order:', error);
        showError('Failed to cancel order: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function trackOrder() {
    if (currentOrder.tracking && currentOrder.tracking.url) {
        window.open(currentOrder.tracking.url, '_blank');
    } else if (currentOrder.tracking && currentOrder.tracking.id) {
        alert(`Tracking ID: ${currentOrder.tracking.id}\nCarrier: ${currentOrder.tracking.carrier || 'Not specified'}`);
    } else {
        alert('Tracking information not available yet.');
    }
}

function downloadInvoice() {
    if (!currentOrder) return;
    
    // Create invoice content
    const invoiceContent = `
        IRYA STONE - INVOICE
        =====================
        
        Invoice Number: ${currentOrder.orderNumber || currentOrder.id}
        Order Date: ${formatDate(currentOrder.createdAt)}
        Order ID: ${currentOrder.id}
        
        CUSTOMER DETAILS:
        ${currentOrder.shippingAddress?.fullName || 'Customer'}
        ${currentOrder.shippingAddress?.address1 || ''}
        ${currentOrder.shippingAddress?.address2 || ''}
        ${currentOrder.shippingAddress?.city || ''}, ${currentOrder.shippingAddress?.state || ''} ${currentOrder.shippingAddress?.postalCode || ''}
        ${currentOrder.shippingAddress?.country || ''}
        Phone: ${currentOrder.shippingAddress?.phone || ''}
        Email: ${currentOrder.userEmail || ''}
        
        ORDER ITEMS:
        ${(currentOrder.items || []).map((item, index) => `
        ${index + 1}. ${item.name || 'Product'}
           Category: ${item.category || 'General'}
           Quantity: ${item.quantity || 1} ${item.priceUnit || 'pieces'}
           ${getCalculationInfo(item)}
           Price: ¬£${item.calculatedPrice ? parseFloat(item.calculatedPrice).toFixed(2) : ((item.price || 0) * (item.quantity || 1)).toFixed(2)}
        `).join('')}
        
        ${currentOrder.customRequirements ? `
        CUSTOM REQUIREMENTS:
        ${currentOrder.customRequirements}
        ` : ''}
        
        ORDER SUMMARY:
        Subtotal: ¬£${currentOrder.subtotal?.toFixed(2) || '0.00'}
        Shipping: ${currentOrder.shipping === 0 ? 'FREE' : `¬£${currentOrder.shipping?.toFixed(2) || '0.00'}`}
        Tax (VAT): ¬£${currentOrder.tax?.toFixed(2) || '0.00'}
        Total: ¬£${currentOrder.total?.toFixed(2) || '0.00'}
        
        PAYMENT INFORMATION:
        Payment Method: ${currentOrder.paymentMethod || 'Bank Transfer'}
        Payment Type: ${currentOrder.paymentType === 'advance' ? '30% Advance Payment' : 'Full Payment'}
        Payment Status: ${getPaymentStatusText(currentOrder.paymentStatus || 'pending')}
        Order Status: ${getStatusText(currentOrder.status || 'pending')}
        
        ${currentOrder.paymentType === 'advance' ? `
        ADVANCE PAYMENT DETAILS:
        Advance Paid (30%): ¬£${currentOrder.advancePayment?.toFixed(2) || '0.00'}
        Remaining (70%): ¬£${currentOrder.remainingPayment?.toFixed(2) || '0.00'}
        ` : ''}
        
        ${currentOrder.tracking ? `
        TRACKING INFORMATION:
        Tracking ID: ${currentOrder.tracking.id || 'N/A'}
        Carrier: ${currentOrder.tracking.carrier || 'N/A'}
        ${currentOrder.tracking.url ? `Tracking URL: ${currentOrder.tracking.url}` : ''}
        ` : ''}
        
        Thank you for your business!
        IRYA STONE - Premium Natural Stone Products
        Email: info@iryastone.com
        Phone: +44 1234 567890
        Website: www.iryastone.com
    `;
    
    // Create download link
    const blob = new Blob([invoiceContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `IRYA-INVOICE-${currentOrder.orderNumber || currentOrder.id}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

async function sendNotificationToUser(type, data = null) {
    try {
        if (!firebaseDB) return;
        
        const notification = {
            type: type,
            orderId: currentOrder.id,
            orderNumber: currentOrder.orderNumber,
            userId: currentOrder.userId,
            title: getNotificationTitle(type, data),
            message: getNotificationMessage(type, data),
            isRead: false,
            createdAt: new Date().toISOString(),
            data: data
        };
        
        // Save notification to user's notifications collection
        await firebaseDB.collection('users').doc(currentOrder.userId)
            .collection('notifications').add(notification);
            
        console.log('‚úÖ Notification sent to user');
        
    } catch (error) {
        console.error('‚ùå Error sending notification to user:', error);
    }
}

async function sendNotificationToAdmin(type) {
    try {
        if (!firebaseDB) return;
        
        const notification = {
            type: type,
            orderId: currentOrder.id,
            orderNumber: currentOrder.orderNumber,
            userId: currentOrder.userId,
            userName: currentOrder.userName || 'Customer',
            title: getAdminNotificationTitle(type),
            message: getAdminNotificationMessage(type),
            isRead: false,
            createdAt: new Date().toISOString(),
            requiresAction: true
        };
        
        // Get all admins
        const adminSnapshot = await firebaseDB.collection('admins').get();
        
        if (!adminSnapshot.empty) {
            const batch = firebaseDB.batch();
            
            adminSnapshot.forEach(doc => {
                const adminId = doc.id;
                const adminNotificationRef = firebaseDB.collection('users').doc(adminId)
                    .collection('adminNotifications').doc();
                batch.set(adminNotificationRef, notification);
            });
            
            await batch.commit();
            console.log('‚úÖ Notification sent to all admins');
        }
        
    } catch (error) {
        console.error('‚ùå Error sending notification to admin:', error);
    }
}

function getNotificationTitle(type, data = null) {
    const titles = {
        'payment_confirmed': 'Payment Confirmed',
        'status_updated': 'Order Status Updated',
        'order_cancelled': 'Order Cancelled',
        'tracking_added': 'Tracking Information Added',
        'order_shipped': 'Order Shipped'
    };
    
    return titles[type] || 'Order Update';
}

function getNotificationMessage(type, data = null) {
    const messages = {
        'payment_confirmed': `Your payment for order #${currentOrder.orderNumber} has been confirmed. Your order is now being processed.`,
        'status_updated': `Your order #${currentOrder.orderNumber} status has been updated to "${getStatusText(data)}".`,
        'order_cancelled': `Your order #${currentOrder.orderNumber} has been cancelled.`,
        'tracking_added': `Tracking information has been added to your order #${currentOrder.orderNumber}.`,
        'order_shipped': `Your order #${currentOrder.orderNumber} has been shipped. Tracking information is available.`
    };
    
    return messages[type] || 'Your order has been updated.';
}

function getAdminNotificationTitle(type) {
    const titles = {
        'payment_sent_by_customer': 'Payment Notification',
        'order_cancelled_by_customer': 'Order Cancelled',
        'new_order': 'New Order Placed'
    };
    
    return titles[type] || 'Admin Notification';
}

function getAdminNotificationMessage(type) {
    const messages = {
        'payment_sent_by_customer': `Customer has marked payment as sent for order #${currentOrder.orderNumber}. Please verify and confirm payment.`,
        'order_cancelled_by_customer': `Customer has cancelled order #${currentOrder.orderNumber}.`,
        'new_order': `New order #${currentOrder.orderNumber} has been placed by ${currentOrder.userName || 'Customer'}.`
    };
    
    return messages[type] || 'Action required for order.';
}

// ============================================
// HELPER FUNCTIONS
// ============================================

async function updateOrderInAllCollections(updateData) {
    try {
        const userId = currentOrder.userId || authSystem.getUserId();
        
        // Update in users/{userId}/orders
        await firebaseDB.collection('users').doc(userId).collection('orders')
            .doc(currentOrder.id).update(updateData);
        
        // Update in main orders collection
        try {
            await firebaseDB.collection('orders').doc(currentOrder.id).update(updateData);
        } catch (error) {
            console.log("Main orders update skipped:", error.message);
        }
        
        // Update in userOrders collection if exists
        try {
            await firebaseDB.collection('userOrders').doc(userId).collection('orders')
                .doc(currentOrder.id).update(updateData);
        } catch (error) {
            console.log("userOrders update skipped:", error.message);
        }
        
        // Update local data
        currentOrder = { ...currentOrder, ...updateData };
        
    } catch (error) {
        console.error('‚ùå Error updating order:', error);
        throw error;
    }
}

async function updateOrderPaymentStatus(newStatus) {
    const updateData = {
        paymentStatus: newStatus,
        updatedAt: new Date().toISOString()
    };
    
    if (newStatus === 'payment_received') {
        updateData.paymentConfirmedAt = new Date().toISOString();
    }
    
    await updateOrderInAllCollections(updateData);
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_received': 'Payment Received',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Bank Transfer',
        'payment_received': 'Payment Received',
        'paid': 'Paid',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function getCalculationInfo(item) {
    if (!item.calculationData) return '';
    
    const unit = item.calculationData.unit || 'piece';
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft √ó ${item.calculationData.width || 1}ft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m √ó ${item.calculationData.width || 1}m`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1}kg`;
    } else {
        return `Quantity: ${item.quantity || 1} pieces`;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        }) + ' ' + date.toLocaleTimeString('en-GB', {
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString;
    }
}

function getCountryName(countryCode) {
    const countries = {
        'GB': 'United Kingdom',
        'US': 'United States',
        'CA': 'Canada',
        'AU': 'Australia',
        'IN': 'India',
        'DE': 'Germany',
        'FR': 'France',
        'IT': 'Italy',
        'ES': 'Spain',
        'AE': 'United Arab Emirates'
    };
    
    return countries[countryCode] || countryCode;
}

function getDefaultImage(category) {
    const categoryLower = (category || '').toLowerCase();
    
    if (categoryLower.includes('sand')) {
        return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('kota')) {
        return 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?auto=format&fit=crop&w=800';
    } else if (categoryLower.includes('granite')) {
        return 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?auto=format&fit=crop&w=800';
    }
    
    return 'https://images.unsplash.com/photo-1544931170-3ca1337cce88?auto=format&fit=crop&w=800';
}

function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-gold);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow-lg);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <style>
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        </style>
        <div>${message}</div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

function showError(message) {
    alert('‚ùå ' + message);
}

function updateCartBadge() {
    try {
        const userId = authSystem.getUserId();
        const cartKey = 'irya_local_cart_' + userId;
        const cartData = localStorage.getItem(cartKey);
        const cartItems = cartData ? JSON.parse(cartData) : [];
        const count = cartItems.reduce((total, item) => total + (item.quantity || 0), 0);
        
        const cartBadge = document.getElementById('cartBadge');
        if (cartBadge) {
            cartBadge.textContent = count;
            cartBadge.style.display = count > 0 ? 'flex' : 'none';
        }
    } catch (error) {
        console.error('‚ùå Error updating cart badge:', error);
    }
}

// Make functions available globally
window.markPaymentComplete = markPaymentComplete;
window.cancelOrder = cancelOrder;
window.trackOrder = trackOrder;
window.downloadInvoice = downloadInvoice;
window.confirmPayment = confirmPayment;
window.updateOrderStatus = updateOrderStatus;
window.adminCancelOrder = adminCancelOrder;
window.addTrackingInfo = addTrackingInfo;
</script>
</body>
</html>
