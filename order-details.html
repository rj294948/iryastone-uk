<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Details | IRYA STONE</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Copy all CSS from orders.html */
/* Add specific styles for order details */
.order-details-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    color: var(--text-dark);
    text-decoration: none;
    font-weight: 500;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: var(--primary-gold);
    color: white;
    border-color: var(--primary-gold);
}

.detail-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.detail-section h2 {
    color: var(--stone-dark);
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-label {
    font-size: 13px;
    color: var(--text-light);
    font-weight: 500;
}

.detail-value {
    font-size: 15px;
    color: var(--text-dark);
    font-weight: 600;
}

.detail-value.gold {
    color: var(--primary-gold);
}

.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.items-table th {
    background: #f8f9fa;
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: var(--stone-dark);
    border-bottom: 2px solid #e0e0e0;
}

.items-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
}

.item-image {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
</style>
</head>
<body>

<!-- Header and Breadcrumb same as orders.html -->
<!-- Add your header and breadcrumb code here -->

<div class="order-details-container">
    <a href="orders.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Orders
    </a>
    
    <div id="orderDetailsContent">
        <!-- Order details will be loaded here -->
    </div>
</div>

<script>
// Get order ID from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('id');

if (!orderId) {
    window.location.href = 'orders.html';
}

// Load order details
async function loadOrderDetails() {
    try {
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
            authDomain: "iryastone-uk.firebaseapp.com",
            projectId: "iryastone-uk",
            storageBucket: "iryastone-uk.firebasestorage.app",
            messagingSenderId: "110940910896",
            appId: "1:110940910896:web:b25e92127118665e5c84f5",
            measurementId: "G-6YM1FLYN48"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const firebaseDB = firebase.firestore();
        const firebaseAuth = firebase.auth();
        
        // Get current user
        const user = firebaseAuth.currentUser;
        const userId = user ? user.uid : localStorage.getItem('irya_guest_id');
        
        // Try to get order from user's collection
        let order = null;
        
        try {
            const orderDoc = await firebaseDB.collection('users').doc(userId)
                .collection('orders').doc(orderId).get();
            
            if (orderDoc.exists) {
                order = orderDoc.data();
            }
        } catch (error) {
            console.log("Could not get from user collection");
        }
        
        // If not found, try main orders collection
        if (!order) {
            const orderDoc = await firebaseDB.collection('orders').doc(orderId).get();
            if (orderDoc.exists) {
                order = orderDoc.data();
            }
        }
        
        if (!order) {
            document.getElementById('orderDetailsContent').innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ffc107; margin-bottom: 20px;"></i>
                    <h2>Order Not Found</h2>
                    <p>This order does not exist or you don't have permission to view it.</p>
                    <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                        <i class="fas fa-arrow-left"></i>
                        Back to Orders
                    </a>
                </div>
            `;
            return;
        }
        
        // Display order details
        displayOrderDetails(order);
        
    } catch (error) {
        console.error('Error loading order details:', error);
        document.getElementById('orderDetailsContent').innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
                <h2>Error Loading Order</h2>
                <p>${error.message}</p>
                <a href="orders.html" class="back-btn" style="margin-top: 20px;">
                    <i class="fas fa-arrow-left"></i>
                    Back to Orders
                </a>
            </div>
        `;
    }
}

function displayOrderDetails(order) {
    const content = document.getElementById('orderDetailsContent');
    
    content.innerHTML = `
        <!-- Order Summary -->
        <div class="detail-section">
            <h2><i class="fas fa-receipt"></i> Order Summary</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Order Number</div>
                    <div class="detail-value">${order.orderNumber || order.id}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Date</div>
                    <div class="detail-value">${formatDate(order.createdAt)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Order Status</div>
                    <div class="detail-value">${getStatusText(order.status)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Status</div>
                    <div class="detail-value">${getPaymentStatusText(order.paymentStatus)}</div>
                </div>
            </div>
        </div>
        
        <!-- Customer Information -->
        <div class="detail-section">
            <h2><i class="fas fa-user"></i> Customer Information</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Name</div>
                    <div class="detail-value">${order.userName || 'Customer'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Email</div>
                    <div class="detail-value">${order.userEmail || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">User ID</div>
                    <div class="detail-value">${order.userId.substring(0, 10)}...</div>
                </div>
            </div>
        </div>
        
        <!-- Order Items -->
        <div class="detail-section">
            <h2><i class="fas fa-box"></i> Order Items (${order.items?.length || 0})</h2>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Details</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${(order.items || []).map(item => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="item-image">
                                        <img src="${item.image || 'https://via.placeholder.com/60'}" 
                                             alt="${item.name}">
                                    </div>
                                    <div>
                                        <div style="font-weight: 600;">${item.name}</div>
                                        <div style="font-size: 13px; color: var(--text-light);">${item.category || 'General'}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="font-size: 13px;">
                                    ${item.calculationData ? getCalculationInfo(item) : `Standard item`}
                                    ${item.customRequirements ? `<div style="color: var(--primary-gold); margin-top: 5px;"><i class="fas fa-edit"></i> Custom requirements</div>` : ''}
                                </div>
                            </td>
                            <td>${item.quantity || 1}</td>
                            <td>£${item.price?.toFixed(2) || '0.00'}</td>
                            <td class="detail-value gold">£${item.calculatedPrice?.toFixed(2) || '0.00'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        
        <!-- Payment Details -->
        <div class="detail-section">
            <h2><i class="fas fa-credit-card"></i> Payment Details</h2>
            <div class="detail-grid">
                <div class="detail-item">
                    <div class="detail-label">Payment Method</div>
                    <div class="detail-value">${order.paymentMethod || 'Bank Transfer'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Payment Type</div>
                    <div class="detail-value">${order.paymentType === 'advance' ? '30% Advance' : 'Full Payment'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Subtotal</div>
                    <div class="detail-value">£${order.subtotal?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Shipping</div>
                    <div class="detail-value">${order.shipping === 0 ? 'FREE' : `£${order.shipping?.toFixed(2) || '0.00'}`}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Tax</div>
                    <div class="detail-value">£${order.tax?.toFixed(2) || '0.00'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Amount</div>
                    <div class="detail-value gold">£${order.total?.toFixed(2) || '0.00'}</div>
                </div>
            </div>
        </div>
        
        <!-- Shipping Address -->
        <div class="detail-section">
            <h2><i class="fas fa-map-marker-alt"></i> Shipping Address</h2>
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
                ${order.shippingAddress ? `
                    <p style="font-weight: 600; margin-bottom: 10px;">${order.shippingAddress.fullName}</p>
                    <p>${order.shippingAddress.address1}</p>
                    ${order.shippingAddress.address2 ? `<p>${order.shippingAddress.address2}</p>` : ''}
                    <p>${order.shippingAddress.city}, ${order.shippingAddress.state} ${order.shippingAddress.postalCode}</p>
                    <p>${order.shippingAddress.country}</p>
                    <p style="margin-top: 10px;"><strong>Phone:</strong> ${order.shippingAddress.phone || 'N/A'}</p>
                    ${order.shippingAddress.instructions ? `
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                            <strong>Special Instructions:</strong>
                            <p>${order.shippingAddress.instructions}</p>
                        </div>
                    ` : ''}
                ` : 'No shipping address provided'}
            </div>
        </div>
        
        <!-- Bank Transfer Details (if applicable) -->
        ${order.paymentMethod === 'bank' && order.bankTransferDetails ? `
            <div class="detail-section">
                <h2><i class="fas fa-university"></i> Bank Transfer Details</h2>
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Account Name</div>
                        <div class="detail-value">${order.bankTransferDetails.accountName}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Account Number</div>
                        <div class="detail-value">${order.bankTransferDetails.accountNumber}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Sort Code</div>
                        <div class="detail-value">${order.bankTransferDetails.sortCode}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Reference</div>
                        <div class="detail-value gold">${order.bankTransferDetails.reference}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Amount to Pay</div>
                        <div class="detail-value gold">£${order.bankTransferDetails.amount?.toFixed(2) || '0.00'}</div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Order Timeline -->
        <div class="detail-section">
            <h2><i class="fas fa-history"></i> Order Timeline</h2>
            <div style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 20px; position: relative; padding-left: 30px;">
                    <div style="position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--primary-gold);"></div>
                    
                    <div style="position: relative;">
                        <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                        <div>
                            <div style="font-weight: 600; color: var(--stone-dark);">Order Placed</div>
                            <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.createdAt)}</div>
                        </div>
                    </div>
                    
                    ${order.paymentVerifiedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Payment Verified</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.paymentVerifiedAt)}</div>
                                ${order.paymentVerifiedBy ? `<div style="font-size: 12px; color: var(--text-light);">Verified by: ${order.paymentVerifiedBy}</div>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.shippedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Order Shipped</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.shippedAt)}</div>
                                ${order.tracking ? `
                                    <div style="margin-top: 5px;">
                                        <a href="${order.tracking.url || '#'}" target="_blank" 
                                           style="color: var(--primary-gold); text-decoration: none; font-size: 13px;">
                                            <i class="fas fa-shipping-fast"></i> Track Package
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.deliveredAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Order Delivered</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.deliveredAt)}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.updatedAt ? `
                        <div style="position: relative;">
                            <div style="position: absolute; left: -36px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: var(--primary-gold);"></div>
                            <div>
                                <div style="font-weight: 600; color: var(--stone-dark);">Last Updated</div>
                                <div style="font-size: 13px; color: var(--text-light);">${formatDate(order.updatedAt)}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button onclick="downloadInvoice()" 
                    style="padding: 15px 25px; background: var(--primary-gold); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-pdf"></i>
                Download Invoice
            </button>
            
            ${order.tracking?.url ? `
                <button onclick="window.open('${order.tracking.url}', '_blank')" 
                        style="padding: 15px 25px; background: #17a2b8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shipping-fast"></i>
                    Track Order
                </button>
            ` : ''}
            
            <button onclick="window.print()" 
                    style="padding: 15px 25px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-print"></i>
                Print Details
            </button>
        </div>
    `;
}

// Helper functions (same as in orders.html)
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-GB', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return dateString;
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'Pending',
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || status;
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending_bank_transfer': 'Awaiting Payment',
        'payment_submitted': 'Payment Submitted',
        'payment_verified': 'Payment Verified',
        'paid': 'Paid',
        'cancelled': 'Cancelled'
    };
    return statusMap[status] || 'Pending';
}

function getCalculationInfo(item) {
    if (!item.calculationData) return `Quantity: ${item.quantity || 1} pieces`;
    
    const unit = item.calculationData.unit || 'piece';
    
    if (unit === 'sqft') {
        return `Area: ${item.calculationData.length || 1}ft × ${item.calculationData.width || 1}ft`;
    } else if (unit === 'sqm') {
        return `Area: ${item.calculationData.length || 1}m × ${item.calculationData.width || 1}m`;
    } else if (unit === 'weight') {
        return `Weight: ${item.calculationData.weight || 1}kg`;
    } else {
        return `Quantity: ${item.quantity || 1} pieces`;
    }
}

// Load order details when page loads
document.addEventListener('DOMContentLoaded', loadOrderDetails);
</script>
</body>
</html> 
